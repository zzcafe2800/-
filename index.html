<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¿’æ…£ã•ãŒã—</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --line:#e6e6e6;
      --text:#111111;
      --muted:#7a7a7a;
      --muted2:#9a9a9a;

      --red:#e00000;

      --r:14px;
      --gap:10px;
      --shadow: 0 4px 14px rgba(0,0,0,.06);
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      --catTint: #ffffff;
      --catLine: #e6e6e6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ===== Layout ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 310px 1fr;
      background:#fff;
    }

    @media (max-width: 980px){
      body{overflow:auto}
      .app{grid-template-columns: 92px 1fr; height:auto; min-height:100%}
      .nav{padding:10px 8px}
      .nav .label{display:none}
      .nav .brandName{display:none}
      .nav .navBtn{justify-content:center}
      .content{padding:12px}
      .tagWrap{grid-template-columns:1fr 1fr;}
      .sideList{max-height: calc(100vh - 340px)}
      .sideItem{padding: 10px;border-radius: 12px;}
      .btnMini{font-size: 11px; padding: 9px 10px}
      .feedGrid{grid-template-columns: 1fr;} /* å¸¸ã«ç¸¦1åˆ— */
    }

    @media (max-width: 520px){
      .feedGrid{grid-template-columns: 1fr;}
    }

    /* ===== Left ===== */
    .nav{
      border-right:1px solid var(--line);
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:4px 6px 10px;
    }
    .logo{
      width:34px; height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      display:grid; place-items:center;
      font-weight:1000;
    }
    .brandName{
      font-size:14px;
      font-weight:1000;
      letter-spacing:.06em;
      white-space:nowrap;
    }

    .navBtn{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      transition:.12s transform, .12s background;
      user-select:none;
    }
    .navBtn:hover{transform: translateY(-1px); background:#fafafa}
    .navBtn.active{background:#f4f4f4}
    .navBtn .ico{width:26px; display:grid; place-items:center}
    .navBtn .label{font-weight:1000; letter-spacing:.03em}

    .sep{height:1px; background:var(--line); margin:6px 0}

    /* ===== User header + Lv ring ===== */
    .userBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      display:flex; gap:10px; align-items:center;
      background:#fff;
      min-width:0;
      box-shadow: var(--shadow);
    }

    .lvRingWrap{
      width:46px;height:46px;
      position:relative;
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .lvRingSvg{
      position:absolute;
      inset:0;
      transform: rotate(-90deg);
    }
    .lvRingSvg circle{
      fill:none;
      stroke-width:6;
      stroke-linecap:round;
    }
    .lvRingBg{
      stroke: #e9e9e9;
    }
    .lvRingFg{
      stroke: #10a85a; /* çµŒé¨“å€¤ãƒªãƒ³ã‚°ï¼ˆç·‘ï¼‰ */
      stroke-dasharray: 999;
      stroke-dashoffset: 999;
      transition: stroke-dashoffset .35s ease;
    }

    .avatar{
      width:34px; height:34px;
      border:1px solid var(--line);
      border-radius:50%;
      background:#fff;
      overflow:hidden;
      display:grid; place-items:center;
      font-weight:1000;
      user-select:none;
      z-index:2;
    }

    .lvNum{
      position:absolute;
      inset:auto;
      bottom:-6px;
      right:-6px;
      width:22px;
      height:22px;
      border-radius:999px;
      border:2px solid #fff;
      background:#111;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      font-weight:1100;
      display:grid;
      place-items:center;
      z-index:3;
      user-select:none;
    }

    .xpPop{
      position:absolute;
      top:-18px;
      left:50%;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index:5;
      white-space:nowrap;
    }
    .xpPop.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .userMeta{min-width:0}
    .userNameRow{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .userName{
      font-weight:1000; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 150px;
    }
    .followerMini{
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      font-family:var(--mono);
      font-size:12px; /* â€œåå‰ãã‚‰ã„â€ã«å¯„ã›ã¦å°‘ã—ä¸Šã’ã‚‹ */
      font-weight:1100;
      color:#111;
      background:#fff;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .userSmall{font-size:11px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* XP block (å°ã•ã‚/æ§ãˆã‚) */
    .xpBlock{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .xpTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .hBadge{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-weight:1000;
      font-size:12px;
      font-family:var(--mono);
      background:#fff;
      white-space:nowrap;
    }
    .xpText{
      font-family:var(--mono);
      font-size:12px;
      font-weight:1100;
      color:#111;
      white-space:nowrap;
    }
    .miniLinkBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      font-weight:1000;
      padding:8px 10px;
      cursor:pointer;
      opacity:.85; /* ç›®ç«‹ãŸãªã„ã‚ˆã†ã« */
    }
    .miniLinkBtn:hover{background:#fafafa; opacity:1}

    .sideTitle{
      font-weight:1000;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.06em;
      padding: 2px 4px 0;
    }
    .sideList{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      padding-right:2px;
      max-height: calc(100vh - 430px);
    }
    .sideItem{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .sideTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      min-width:0;
    }
    /* ç´°ã„æ™‚ã«å‹æ‰‹ã«æ½°ã‚Œãªã„ã‚ˆã†ã€æ ã«å¿œã˜ã¦ç¸®ã‚€ */
    .sideHabit{
      font-weight:1100;
      font-size: clamp(11px, 1.6vw, 13px);
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-width:0;
      flex:1 1 auto;
    }
    .sideMeta{
      font-size: clamp(10px, 1.4vw, 11px);
      color:var(--muted);
      font-family:var(--mono);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .sideCare{
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 8px;
      font-family:var(--mono);
      font-weight:1100;
      font-size: clamp(10px, 1.4vw, 11px);
      color:#111;
      background:#fff;
      white-space:nowrap;
    }
    .sideBtns{
      display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btnMini{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:1100;
      user-select:none;
    }
    .btnMini:hover{background:#fafafa}
    .btnMini:disabled{opacity:.6; cursor:not-allowed}

    /* ===== Main ===== */
    .content{
      height:100%;
      overflow:auto;
      padding:14px;
      position:relative;
      background:#fff;
    }
    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background:#fff;
      box-shadow: var(--shadow);
    }

    .headerBar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px;
      border-bottom:1px solid var(--line);
    }
    .hTitle{
      font-weight:1100;
      letter-spacing:.06em;
      font-size:16px; /* ã‚¿ã‚¤ãƒˆãƒ«å°‘ã—å¤§ãã */
      display:flex; align-items:center; gap:10px;
      white-space:nowrap;
      flex-wrap:wrap;
    }

    /* å³å´ï¼šæœ¬æ—¥é”æˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®å³ï¼‰ */
    .todayBadge{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      white-space:nowrap;
    }

    /* ===== Tag ranking: æ¨ªä¸€åˆ—ï¼ˆ2åˆ†å‰²ï¼‰ ===== */
    .tagWrap{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .rankBox{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding:10px;
      box-shadow: var(--shadow);
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .rankTitle{
      font-size:13px;
      font-weight:1100;
      letter-spacing:.06em;
      color: #111;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0;
    }
    .rankGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
      align-items:stretch;
    }
    .rankChip{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:#fff;
      user-select:none;
      min-width:0;
    }
    .rankChip:hover{background:#fafafa}
    .rankChip.active{background:#f2f2f2}
    .rk{
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      flex:0 0 auto;
    }
    .tagName{
      font-weight:1100;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    /* ===== Search row: æ¤œç´¢+ã‚«ãƒ†ã‚´ãƒª+ã‚¿ã‚°è§£é™¤ ===== */
    .searchRow{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:8px;
      align-items:stretch;
      flex-wrap:nowrap;
    }
    @media (max-width: 980px){
      .searchRow{flex-wrap:wrap}
    }
    .searchBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:0 10px;
      background:#fff;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex: 1 1 auto;
      height:44px;
    }
    .searchInput{
      border:none;
      outline:none;
      font-size:14px;
      background:transparent;
      width:100%;
      min-width:0;
      height:100%;
    }
    .searchBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding:0 10px;
      cursor:pointer;
      font-weight:1100;
      white-space:nowrap;
      height:32px;
    }
    .searchBtn:hover{background:#fafafa}

    .ctrlBtn, .ctrlSel{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      height:44px;
      padding:0 10px;
      font-weight:1100;
      cursor:pointer;
      display:flex;
      align-items:center;
      white-space:nowrap;
    }
    .ctrlSel{padding:0 8px}
    .ctrlBtn:hover, .ctrlSel:hover{background:#fafafa}

    /* ===== Feed ===== */
    .feedArea{padding:12px}
    .feedHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px 0;
    }
    .feedHeadLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .feedLabel{
      font-weight:1100;
      letter-spacing:.06em;
      color: var(--muted);
      font-size:12px;
      margin:0;
    }
    .countSmall{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      color:#111;
    }
/* ===== Feed ===== */
.feedGrid{
  display:grid;
  grid-template-columns: repeat(4, 1fr); /* PCã¯4åˆ— */
  gap: 10px;
  align-items:stretch;
}
@media (max-width: 980px){
  .feedGrid{ grid-template-columns: repeat(2, 1fr); } /* ã‚¹ãƒãƒ›/ã‚¿ãƒ–ã¯2åˆ— */
}
@media (max-width: 520px){
  .feedGrid{ grid-template-columns: repeat(2, 1fr); } /* å°ã•ãã¦ã‚‚2åˆ—ç¶­æŒ */
}

    /* ===== Card ===== */
    .habitCard{
      border:1px solid var(--catLine);
      border-radius: 12px;
      background: linear-gradient(0deg, #fff 0%, #fff 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      min-width:0;
    }

    .thumb{
      aspect-ratio: 16 / 9;
      background: var(--catTint);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
      border-bottom:1px solid var(--catLine);
      user-select:none;
    }


/* ===== é¸æŠä¸­/ãƒ›ãƒãƒ¼ä¸­ã®â€œã†ã£ã™ã‚‰é»’ãƒ•ã‚§ã‚¤ãƒ‰â€ ===== */
/* ãƒ•ã‚§ã‚¤ãƒ‰ã¯ thumb ã®ä¸Šã«ä¹—ã›ã‚‹ï¼ˆã§ã‚‚ãƒœã‚¿ãƒ³ã‚ˆã‚Šä¸‹ï¼‰ */
.habitCard .thumb::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(
    to bottom,
    rgba(0,0,0,.10) 0%,
    rgba(0,0,0,.04) 35%,
    rgba(0,0,0,0) 80%
  );
  opacity:0;
  pointer-events:none;
  transition: opacity .12s ease;
  z-index:2; /* ã‚¿ã‚¤ãƒˆãƒ«/æ–‡å­—ã‚ˆã‚Šä¸Šã«ã—ãŸã„ãªã‚‰ 2ã€ãƒœã‚¿ãƒ³ã¯3ãªã®ã§è¢«ã‚‰ãªã„ */
}

/* PCï¼šãƒ›ãƒãƒ¼ã§ãƒ•ã‚§ã‚¤ãƒ‰ */
@media (hover:hover) and (pointer:fine){
  .habitCard:hover .thumb::after{ opacity:1; }
}

/* ã‚¹ãƒãƒ›ï¼šé¸æŠï¼ˆis-activeï¼‰ã§ãƒ•ã‚§ã‚¤ãƒ‰ */
.habitCard.is-active .thumb::after{ opacity:1; }

    
    .thumbTitle{
      font-size:22px; /* ã‚¿ã‚¤ãƒˆãƒ«å¤§ãã‚ */
      font-weight:1100;
      letter-spacing:.02em;
      line-height:1.12;
      margin:0;
      text-align:center;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      z-index:2;
    }
    .thumbAction{
      position:absolute;
      right:10px;
      bottom:8px;
      font-size:12px;
      color: var(--muted2);
      z-index:2;
      max-width: 70%;
      text-align:right;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .mascotBg{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-size: 84px;
      opacity: .09;
      pointer-events:none;
      transform: translateY(8px);
      user-select:none;
      z-index:1;
    }

    .thumbActions{
      position:absolute;
      top:8px;
      right:8px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:3;
    }
    /* ===== ã‚«ãƒ¼ãƒ‰å³ä¸Šãƒœã‚¿ãƒ³ï¼šæ™®æ®µã¯éè¡¨ç¤º ===== */
.thumbActions{
  opacity: 0;
  pointer-events: none;
  transform: translateY(-2px);
  transition: opacity .12s ease, transform .12s ease;
}

/* PCï¼šãƒ›ãƒãƒ¼ä¸­ã¯è¡¨ç¤ºï¼ˆhoverã§ãã‚‹ç«¯æœ«ã ã‘ï¼‰ */
@media (hover:hover) and (pointer:fine){
  .habitCard:hover .thumbActions{
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }
}

/* ã‚¹ãƒãƒ›ï¼šJSã§ä»˜ã‘ã‚‹ .is-active ã®æ™‚ã ã‘è¡¨ç¤º */
.habitCard.is-active .thumbActions{
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

    .tipBtn{position:relative}
    .tipBtn[data-tip]::after{
      content: attr(data-tip);
      position:absolute;
      bottom: calc(100% + 6px);
      left:50%;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
      font-weight:1100;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease;
      z-index:10;
    }
    .tipBtn:hover::after{opacity:1; transform: translateX(-50%) translateY(-2px)}

    .iconBtn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius: 10px;
      padding:8px 9px;
      cursor:pointer;
      display:grid;
      place-items:center;
      min-width:38px;
      user-select:none;
    }
    .iconBtn:hover{background:#fafafa}
    .iconBtn.on{background:#111; color:#fff; border-color:#111}
    .iconBtn svg{display:block}

    .reviewBtn{
      position:relative;
    }
    .badgeCount{
      position:absolute;
      top:-6px;
      right:-6px;
      width:18px;
      height:18px;
      border-radius:999px;
      background: var(--red);
      color:#fff;
      font-family: var(--mono);
      font-size:11px;
      font-weight:1100;
      display:grid;
      place-items:center;
      border:2px solid #fff;
      pointer-events:none;
    }

    /* JOIN buttonï¼ˆå‚åŠ â†’ç™½ã€å‚åŠ ä¸­â†’ç™½+èµ¤æ–‡å­—ã€ãƒœã‚¿ãƒ³å°‘ã—å¤§ãã‚ï¼‰ */
    .joinBtn{
      border:1px solid var(--red);
      background: var(--red);
      color:#fff;
      border-radius: 12px;
      padding:12px 16px; /* å°‘ã—å¤§ãã */
      cursor:pointer;
      font-weight:1100;
      min-width: 84px;
      user-select:none;
      font-size:14px;
    }
    .joinBtn:hover{filter:brightness(1.03)}
    .joinBtn.activeMode{
      background:#fff;
      color:var(--red);
    }
    .joinBtn:disabled{opacity:.6; cursor:not-allowed}

    .metaBar{
      padding:10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      min-height: 72px;
      background:#fff;
      position:relative;
    }
    .creatorCol{
      display:flex;
      gap:10px;
      min-width:0;
    }
    .miniAva{
      width:28px; height:28px;
      border:1px solid var(--line);
      border-radius:50%;
      overflow:hidden;
      background:#fff;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      font-weight:1100;
      color:#111;
      cursor:pointer;
    }
    .miniAva img{width:100%; height:100%; object-fit:cover}
    .creatorText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .creatorName{
      font-size:12px;
      font-weight:1100;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 190px;
      cursor:pointer;
    }
    .followSmall{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding:6px 10px;
      font-weight:1100;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      width: fit-content;
    }
    .followSmall.on{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .statsRow{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      min-width:0;
    }
   .statPill{
  border:1px solid var(--line);
  border-radius:999px;
  padding:7px 11px;   /* å°‘ã—å¤§ãã */
  background:#fff;
  font-family:var(--mono);
  font-weight:1100;
  font-size:13px;     /* å°‘ã—å¤§ãã */
  color:#111;
  white-space:nowrap;
}
.statLine{gap:8px;}

    /* createdAt bottom-right subtleï¼ˆå³ä¸‹ãƒ»è–„ãï¼‰ */
    .createdAt{
      position:absolute;
      right:10px;
      bottom:10px;
      font-size:11px;
      color: var(--muted2);
      font-family: var(--mono);
      pointer-events:none;
      opacity:.8;
    }


    

  

    /* ===== Fixed Post Button ===== */
    .fab{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:90;
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 16px;
      padding:16px 18px; /* å°‘ã—å¤§ãã */
      font-weight:1100;
      cursor:pointer;
      box-shadow: var(--shadow);
      min-width: 110px;
      font-size:15px;
      display:none;
    }
    .fab:hover{filter:brightness(1.03)}
    .fab.show{display:block}

    /* ===== Modals ===== */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.40);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:120;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(820px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h2{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .modalFooter{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:1100;
    }
    .btn:hover{background:#fafafa}
    .btn.primary{border-color:#111; background:#111; color:#fff}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .fieldRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .fieldRow{grid-template-columns:1fr} }

    .lineInput{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
    }
    .lineArea{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
      resize:vertical;
      min-height: 72px;
    }
    .selectKeep{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 10px;
      outline:none;
      background:#fff;
      font-weight:1100;
      min-height: 40px;
      cursor:pointer;
    }

    /* æ˜Ÿè©•ä¾¡ï¼ˆâ˜…/â˜†ï¼‰ */
    .starsRow{display:flex; gap:6px; margin-top:10px; flex-wrap:wrap;}
    .starBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      padding:10px 10px;
      cursor:pointer;
      font-weight:1100;
      text-align:center;
      user-select:none;
      min-width:44px;
      font-size:18px;
    }
    .starBtn.active{background:#111; color:#fff; border-color:#111}

  .reviewList{
  margin-top:12px;
  border-top:1px solid var(--line);
  padding-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;

  /* â˜…5ä»¶ã¶ã‚“è¦‹ãˆã‚‹ãã‚‰ã„ã®é«˜ã•ï¼ˆè¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
  max-height: 360px;
  overflow:auto;
}
    .review{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
    }
    .reviewTop{display:flex; justify-content:space-between; gap:10px}
    .reviewName{font-weight:1100; font-size:12px}
    .reviewMeta{font-size:12px; color:var(--muted); font-family:var(--mono)}
    .reviewText{margin-top:8px; font-size:13px; color:#111; white-space:pre-wrap; line-height:1.5}
    .counter{font-family:var(--mono); font-size:11px; color:var(--muted);}

    /* Gate */
    .gate{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:200;
      background: rgba(0,0,0,.35);
      padding:18px;
    }
    .gate.show{display:flex}
    .gateCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .gateTitle{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .gateActions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
    .gateBtn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
    }

    /* ===== Training view ===== */
    .trainWrap{padding:12px}
    .trainCard{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .trainTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .trainMid{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:center;
    }
    .arrowBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
      user-select:none;
      min-width:44px;
    }
    .arrowBtn:hover{background:#fafafa}
    .creatureBox{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding:14px;
      min-height: 220px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .creatureEmoji{font-size: 74px; line-height:1;}
    .pct{font-family:var(--mono); font-weight:1100; font-size:18px;}
    .thin{color:var(--muted); font-size:12px; font-weight:1100;}
    .trainBar{
      width: min(520px, 90%);
      height: 14px;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
    }
    .trainFill{
      height:100%;
      width:0%;
      background:#111;
      transition: width .35s ease;
    }
    .careUnder{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      background:#fff;
      color:#111;
    }

    /* Creator modal */
    .creatorHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .creatorBig{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .bigAva{
      width:42px;height:42px;border:1px solid var(--line);border-radius:50%;
      display:grid;place-items:center;font-weight:1100;
      overflow:hidden;background:#fff;
    }
    .bigAva img{width:100%;height:100%;object-fit:cover}
    .creatorBigName{
      font-weight:1100;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 380px;
    }





/* Lvã‚„XPã®æ•°å­—è¡¨ç¤ºã¯éè¡¨ç¤ºï¼ˆè¦æ±‚ï¼‰ */
#levelBadge, #xpText, #xpRemain { display:none !important; }

/* ã‚­ãƒ£ãƒ©ä¸€è¦§ãƒœã‚¿ãƒ³ã ã‘æ§ãˆã‚ã«æ®‹ã™ */
.xpTop{justify-content:flex-end;}
#openCharList{
  font-size:11px !important;
  padding:7px 9px !important;
  opacity:.75;
}






    @media (max-width: 980px){
  #anaStatusGrid, #anaInsights{ grid-template-columns: repeat(2,1fr) !important; }
}
@media (max-width: 520px){
  #anaStatusGrid, #anaInsights{ grid-template-columns: 1fr !important; }
}
    /* ===== Home å·¦ä¸‹ï¼š3ã¤ã®ãƒ‡ãƒƒã‚­ã‚«ãƒ¼ãƒ‰ï¼ˆQuick Deckï¼‰ ===== */
:root{
  --navW: 310px; /* PC */
}
@media (max-width: 980px){
  :root{ --navW: 92px; } /* ã‚¹ãƒãƒ› */
}

.quickDeck{
  position: fixed;
  left: calc(var(--navW) + 16px);
  bottom: 16px;
  z-index: 60;
  width: min(520px, 48vw);
  display: none; /* Homeä»¥å¤–ã¯éè¡¨ç¤º */
  pointer-events: none; /* èƒŒé¢ï¼ˆä¸€è¦§ï¼‰ã‚’æ“ä½œã§ãã‚‹ */
}
.quickDeck.show{ display:block; }

.quickDeckInner{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  align-items: stretch;
}

.qCard{
  position: relative;
  height: 140px;
  border: 1px solid var(--line);
  border-radius: 14px;
  background: #fff;
  box-shadow: var(--shadow);
  overflow: hidden;

  opacity: .22;            /* ã‹ãªã‚Šè–„ã‚ */
  transition: opacity .12s ease, transform .12s ease;
  pointer-events: none;    /* ã‚«ãƒ¼ãƒ‰æœ¬ä½“ã¯å½“ãŸã‚Šåˆ¤å®šãªã— */
}

.quickDeck.is-focus .qCard{
  opacity: .78;            /* ã©ã‚Œã‹ã«è§¦ã‚ŒãŸã‚‰3ã¤ã¨ã‚‚æ¿ƒã */
}

/* ä¸­èº«ãŒã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã‚‚ã€åŸºæœ¬ã¯è–„ã‚ï¼ˆè£ãŒè¦‹ãˆã‚‹æ„Ÿã˜ï¼‰ */
.qCard.hasItem{
  opacity: .22;
}
.quickDeck.is-focus .qCard.hasItem{
  opacity: .78;
}

/* ä¸­å¤®ï¼šè¦‹å‡ºã—ï¼‹ã‚„ã‚‹ã“ã¨ */
.qMain{
  position: absolute;
  inset: 12px 12px 12px 12px;
  display: grid;
  grid-template-rows: 1fr auto;
  gap: 6px;
  pointer-events: none;
}
.qTitle{
  align-self: center;
  justify-self: center;
  font-weight: 1100;
  letter-spacing: .02em;
  font-size: clamp(14px, 2.0vw, 20px);
  line-height: 1.12;
  white-space: nowrap;     /* æ¨ª1åˆ—ã§åã‚ã‚‹ */
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  text-align: center;
}
.qAction{
  justify-self: center;
  font-size: 12px;
  color: var(--muted2);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* ï¼‹ï¼ˆå°ã•ã‚ãƒ»ã‚«ãƒ¼ãƒ‰ã‚ˆã‚Šæ¿ƒã„ï¼‰ */
.qPlusBtn{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  pointer-events: auto; /* ã“ã“ã ã‘å½“ãŸã‚Šåˆ¤å®šã‚ã‚Š */
  background: transparent;
  border: none;
  cursor: pointer;
}
.qPlus{
  width: 32px; height: 32px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(17,17,17,.08);
  display: grid;
  place-items: center;
  font-size: 18px;
  font-weight: 1100;
  color: rgba(17,17,17,.75);
  user-select: none;
}

/* ã€Œä¸­å¤®ã‚‰ã¸ã‚“ã€ã ã‘ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å½“ãŸã‚Šåˆ¤å®šï¼ˆèª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ã§å°ã•ã‚ï¼‰ */
.qFocusZone{
  position: absolute;
  left: 50%;
  top: 50%;
  width: 56px;
  height: 56px;
  transform: translate(-50%, -55%);
  pointer-events: auto;   /* ã“ã“ã ã‘å½“ãŸã‚Šåˆ¤å®šã‚ã‚Š */
  background: transparent;
  border: none;
  cursor: default;
}

/* å³ä¸Šï¼šÃ—ï¼ˆä¸­èº«ãŒã‚ã‚‹æ™‚ã ã‘ & ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã ã‘ï¼‰ */
.qCloseBtn{
  position: absolute;
  top: 8px;
  right: 8px;
  width: 28px;
  height: 28px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: #fff;
  color: #111;
  display: grid;
  place-items: center;
  font-weight: 1100;
  cursor: pointer;

  opacity: 0;
  pointer-events: none;
  transform: translateY(-2px);
  transition: opacity .12s ease, transform .12s ease;
}

/* PCï¼šãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¾ãƒ¼ãƒ³ hover ä¸­ã ã‘å‡ºã™ */
@media (hover:hover) and (pointer:fine){
  .quickDeck.is-focus .qCard.hasItem .qFocusZone:hover ~ .qCloseBtn{
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }
}

/* ã‚¹ãƒãƒ›ï¼šé¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ã ã‘å‡ºã™ */
.qCard.is-picked .qCloseBtn{
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

/* å³ä¸‹ï¼šã‚­ãƒ£ãƒ©ä¸¸ */
.qChar{
  position: absolute;
  right: 10px;
  bottom: 10px;
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: #fff;
  display: grid;
  place-items: center;
  font-size: 18px;
  pointer-events: none;
}

/* å³å´ï¼šè©•ä¾¡ â˜…â˜†â˜†â˜†â˜† */
.qStars{
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 1100;
  color: rgba(17,17,17,.8);
  pointer-events: none;
}


    
  </style>
</head>

<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã‚²ãƒ¼ãƒˆ -->
  <div class="gate" id="loginGate">
    <div class="gateCard">
      <p class="gateTitle">ãƒ­ã‚°ã‚¤ãƒ³</p>
      <div class="gateActions">
        <button class="gateBtn" id="gateLoginBtn">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- ===== Left ===== -->
    <aside class="nav">
   <div class="brand">
  <div class="logo">â–¡</div>
  <div style="display:flex; align-items:center; gap:8px; min-width:0">
    <div class="brandName">ç¿’æ…£ã•ãŒã—</div>
    <div class="todayBadge" id="todayDoneBadge" style="padding:5px 9px; font-size:11px;">æœ¬æ—¥ 0 äººãŒé”æˆ</div>
  </div>
</div>

      <button class="navBtn active" id="navHome">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/></svg>
        </div>
        <div class="label">ãƒ›ãƒ¼ãƒ </div>
      </button>



      
<button class="navBtn" id="navCalendar">
  <div class="ico">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M8 2v3M16 2v3"/><path d="M3 7h18"/><path d="M5 7v14a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7"/>
      <path d="M7 11h4"/><path d="M7 15h6"/>
    </svg>
  </div>
  <div class="label">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
</button>

<button class="navBtn" id="navAnalytics">
  <div class="ico">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 19V5"/><path d="M4 19h16"/><path d="M8 17v-6"/><path d="M12 17v-10"/><path d="M16 17v-4"/>
    </svg>
  </div>
  <div class="label">åˆ†æ</div>
</button>



      <button class="navBtn" id="navTrain">
   <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4"/><path d="M12 18v4"/><path d="M4 12H2"/><path d="M22 12h-2"/>
            <path d="M5 5l2.5 2.5"/><path d="M19 19l-2.5-2.5"/><path d="M19 5l-2.5 2.5"/><path d="M5 19l2.5-2.5"/>
            <circle cx="12" cy="12" r="4"/>
          </svg>
        </div>
        <div class="label">è‚²æˆ</div>
      </button>

      <button class="navBtn" id="navRecords">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v3M16 2v3"/><path d="M3 7h18"/><path d="M5 7v14a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7"/><path d="M8 11h3"/><path d="M8 15h6"/></svg>
        </div>
        <div class="label">é”æˆè¨˜éŒ²</div>
      </button>

      <button class="navBtn" id="navBookmarks">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/></svg>
        </div>
        <div class="label">ä¿å­˜</div>
      </button>

      <button class="navBtn" id="navProfile">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div class="label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
      </button>

      <div class="sep"></div>

      <div class="userBox">
        <!-- Lvãƒªãƒ³ã‚° + ã‚¢ã‚¤ã‚³ãƒ³ -->
        <div class="lvRingWrap" title="ãƒ¬ãƒ™ãƒ« / çµŒé¨“å€¤">
          <svg class="lvRingSvg" width="46" height="46" viewBox="0 0 46 46" aria-hidden="true">
            <circle class="lvRingBg" cx="23" cy="23" r="18"></circle>
            <circle class="lvRingFg" id="lvRingFg" cx="23" cy="23" r="18"></circle>
          </svg>
          <div class="xpPop" id="xpPop">+0</div>
          <div class="avatar" id="userAvatar">â–¡</div>
          <div class="lvNum" id="lvNum">1</div>
        </div>

        <div class="userMeta">
          <div class="userNameRow">
            <div class="userName" id="userName">â€”</div>
            <div class="followerMini" id="followerMini">ãƒ•ã‚©ãƒ­ãƒ¼ 0</div>
          </div>
          <div class="userSmall" id="userSmall">â€”</div>
        </div>
      </div>

      <!-- XP / Lv detail -->
      <div class="xpBlock">
        <div class="xpTop">
          <span class="hBadge" id="levelBadge">Lv 1</span>
          <button class="miniLinkBtn" id="openCharList">ã‚­ãƒ£ãƒ©ä¸€è¦§</button>
        </div>
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
          <span class="xpText" id="xpText">0 / 100</span>
          <span class="xpText" id="xpRemain">æ¬¡ã¾ã§ 100</span>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sideTitle">ä¾é ¼ï¼ˆæŒ‘æˆ¦ä¸­ï¼‰</div>
      <div class="sideList" id="sideActiveList"></div>
    </aside>

    <!-- ===== Right ===== -->
    <main class="content">

      <!-- ===== Home ===== -->
      <section class="panel" id="viewHome">
<div class="headerBar">
  <div class="hTitle">ç¿’æ…£æ¢ã—</div>
  <div class="hBadge">â€”</div>
</div>

        <!-- TOP tags -->
        <div class="tagWrap">
          <div class="rankBox">
            <div class="rankTitle"><span>ãŠã™ã™ã‚TOP</span></div>
            <div class="rankGrid" id="rankReco"></div>
          </div>
          <div class="rankBox">
            <div class="rankTitle"><span>äººæ°—TOP</span></div>
            <div class="rankGrid" id="rankTop"></div>
          </div>
        </div>

        <!-- Search + category + tag reset -->
        <div class="searchRow">
          <div class="searchBox">
            <input class="searchInput" id="q" placeholder="æ¤œç´¢" />
            <button class="searchBtn" id="btnSearch">æ¤œç´¢</button>
          </div>

          <select class="ctrlSel" id="categoryFilter" title="ã‚«ãƒ†ã‚´ãƒª">
            <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆã™ã¹ã¦ï¼‰</option>
            <option>ãƒ¡ãƒ³ã‚¿ãƒ«</option><option>ç¡çœ </option><option>é‹å‹•</option><option>å¥åº·</option>
            <option>ç”Ÿæ´»</option><option>å‹‰å¼·</option><option>è‹±èª</option><option>ä»•äº‹</option><option>ãã®ä»–</option>
          </select>


          
<!-- ===== Home å·¦ä¸‹ï¼šQuick Deckï¼ˆ3ã‚«ãƒ¼ãƒ‰ï¼‰ ===== -->
<div class="quickDeck" id="quickDeck">
  <div class="quickDeckInner" id="quickDeckInner"></div>
</div>

          
          <button class="ctrlBtn" id="btnClearTag" title="ã‚¿ã‚°è§£é™¤">ã‚¿ã‚°è§£é™¤</button>
        </div>

        <!-- list -->
        <div class="feedArea">
          <div class="feedHead">
            <div class="feedHeadLeft">
              <p class="feedLabel">ä¸€è¦§</p>

              <!-- ä¸¦ã³æ›¿ãˆã‚’ã€Œä¸€è¦§ã€æ¨ª -->
              <select class="ctrlSel" id="sortBy" title="ä¸¦ã³æ›¿ãˆ">
                <option value="new">æ–°ç€</option>
                <option value="rating">è©•ä¾¡</option>
                <option value="favCreators">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®äºº</option>
              </select>

              <div class="countSmall">è¡¨ç¤º <span id="countShown">0</span></div>
            </div>
          </div>
          <div class="feedGrid" id="feed"></div>
        </div>
      </section>

      <!-- ===== Training ===== -->


      

<!-- ===== Calendar ===== -->
<section class="panel" id="viewCalendar" style="display:none">
  <div class="headerBar">
    <div class="hTitle">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <select class="ctrlSel" id="calChallengeSel" title="è‚²æˆã‚’é¸æŠ"></select>
      <button class="ctrlBtn" id="calPrev">â—€</button>
      <button class="ctrlBtn" id="calNext">â–¶</button>
    </div>
  </div>
  <div style="padding:12px">
    <div class="hBadge" id="calTitle">â€”</div>
    <div id="calGrid" style="margin-top:10px; display:grid; grid-template-columns: repeat(7,1fr); gap:6px;"></div>
    <div style="margin-top:10px; color:var(--muted); font-size:12px;">
      â€»ã€Œã‚„ã£ãŸã€ã®æ™‚ã«é¸ã‚“ã çµµæ–‡å­—ï¼ˆğŸ˜Š/ğŸ™‚/ğŸ˜…ï¼‰ãŒã€ãã®æ—¥ã®ãƒã‚¹ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>
  </div>
</section>

<!-- ===== Analytics ===== -->
<section class="panel" id="viewAnalytics" style="display:none">
  <div class="headerBar">
    <div class="hTitle">åˆ†æ</div>
    <div class="hBadge" id="anaHint">â€”</div>
  </div>

  <div style="padding:12px; display:grid; gap:10px;">
    <!-- ä¸Šï¼šè‚²æˆä¸­/å®Œäº†/ãƒªã‚¿ã‚¤ã‚¢ 3ã‚«ãƒ¼ãƒ‰ï¼ˆPC3åˆ—/ã‚¹ãƒãƒ›2åˆ—ç›¸å½“ï¼‰ -->
    <div id="anaStatusGrid" style="display:grid; grid-template-columns: repeat(3,1fr); gap:10px;"></div>

    <!-- ä¸­ï¼šã‚°ãƒ©ãƒ• -->
    <div class="review" style="margin:0">
      <div class="reviewTop">
        <div class="reviewName">ç¶šãã‚„ã™ã•æ¯”è¼ƒï¼ˆã‚«ãƒ†ã‚´ãƒª / ä½œæˆè€… / æ‚©ã¿ã‚¿ã‚°ï¼‰</div>
        <div class="reviewMeta">è‡ªåˆ†ã®å‚¾å‘</div>
      </div>
      <div style="margin-top:10px; display:grid; gap:10px;">
        <canvas id="anaBar" height="160" style="width:100%;"></canvas>
        <canvas id="anaLines" height="220" style="width:100%;"></canvas>
      </div>
      <div style="margin-top:10px; color:var(--muted); font-size:12px;">
        æ£’ï¼šã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æˆåŠŸç‡ / æŠ˜ã‚Œç·šï¼šã‚«ãƒ†ã‚´ãƒªãƒ»ä½œæˆè€…ãƒ»ã‚¿ã‚°ã®æˆåŠŸç‡ã‚’åŒæ™‚æ¯”è¼ƒï¼ˆç·šè‰²ã¯è‡ªå‹•ï¼‰ã€‚
      </div>
    </div>

    <!-- ä¸‹ï¼šç™ºè¦‹ã‚«ãƒ¼ãƒ‰3ã¤ -->
    <div id="anaInsights" style="display:grid; grid-template-columns: repeat(3,1fr); gap:10px;"></div>
  </div>
</section>






      
      <section class="panel" id="viewTrain" style="display:none">
        <div class="headerBar">
          <div class="hTitle">è‚²æˆ</div>
          <div class="hBadge" id="trainHint">â€”</div>
        </div>

        <div class="trainWrap">
          <div class="trainCard">
            <div class="trainTop">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="hBadge" id="trainSlot">1 / 1</span>
                <span class="hBadge" id="trainHabitTitle">â€”</span>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="hBadge" id="trainPctText">0%</span>
                <button class="miniLinkBtn" id="btnSetAvatar" disabled>ã“ã®å­ã‚’ã‚¢ã‚¤ã‚³ãƒ³ã«</button>
              </div>
            </div>

            <div class="trainMid">
              <button class="arrowBtn" id="trainPrev">&lt;</button>

              <div class="creatureBox">
                <div class="pct" id="trainPct">0%</div>
                <div class="trainBar"><div class="trainFill" id="trainFill"></div></div>
                <div class="creatureEmoji" id="trainEmoji">ğŸ¥š</div>
                <div class="thin" id="trainStage">â€”</div>
                <div class="careUnder" id="trainCare">æ¬¡ã®ãŠä¸–è©±ã¾ã§ 00:00:00</div>
              </div>

              <button class="arrowBtn" id="trainNext">&gt;</button>
            </div>
          </div>
        </div>
      </section>


      
      <!-- ===== Records ===== -->
      <section class="panel" id="viewRecords" style="display:none">
        <div class="headerBar">
          <div class="hTitle">é”æˆè¨˜éŒ²</div>
          <div class="hBadge">â€”</div>
        </div>
        <div style="padding:12px" id="recordList"></div>
      </section>

      <!-- ===== Bookmarks ===== -->
      <section class="panel" id="viewBookmarks" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ä¿å­˜</div>
          <div class="hBadge">ä»¶æ•° <span id="bmCount">0</span></div>
        </div>
        <div style="padding:12px">
          <div class="feedGrid" id="bmFeed"></div>
        </div>
      </section>

      <!-- ===== Profile ===== -->
      <section class="panel" id="viewProfile" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
          <div class="hBadge" id="profileLv">Lv 1</div>
        </div>
        <div style="padding:12px" id="profileList"></div>

        <div style="padding:12px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap">
          <button class="btn primary" id="btnLogin">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="btn" id="btnLogout" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </section>
    </main>
  </div>

  <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ï¼ˆå³ä¸‹å›ºå®š / Homeã®ã¿è¡¨ç¤ºï¼‰ -->
  <button class="fab" id="openPost">æŠ•ç¨¿</button>

  <!-- ===== åå‰ç™»éŒ² + è‰²é¸æŠ ===== -->
  <div class="modalBg" id="nameBg">
    <div class="modal">
      <h2>åå‰</h2>

      <div class="fieldRow" style="margin-top:10px; grid-template-columns: 1fr auto;">
        <div>
          <input class="lineInput" id="nameInput" placeholder="åå‰" maxlength="16" />
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <span class="counter">è‰²</span>
            <select class="selectKeep" id="colorPick" title="è‰²">
              <option value="#111111">é»’</option>
              <option value="#e00000">èµ¤</option>
              <option value="#0b6cff">é’</option>
              <option value="#00a86b">ç·‘</option>
              <option value="#ff8a00">æ©™</option>
            </select>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:flex-start">
          <div class="avatar" id="nameAvatar" style="width:46px;height:46px">â–¡</div>
          <div class="counter">ç¾åœ¨</div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn primary" id="nameSave" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ===== åˆå›ã‚«ãƒ†ã‚´ãƒªé¸æŠ ===== -->
  <div class="modalBg" id="catBg">
    <div class="modal">
      <h2>ã‚«ãƒ†ã‚´ãƒª</h2>
      <div class="fieldRow" id="catList" style="margin-top:10px"></div>
      <div class="modalFooter">
        <button class="btn" id="catClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="catSave" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ===== æŠ•ç¨¿ ===== -->
  <div class="modalBg" id="postBg">
    <div class="modal">
      <h2>æŠ•ç¨¿</h2>

      <div style="margin-top:10px">
        <div class="counter" id="postCounter">0 / 40</div>
        <input class="lineInput" id="newTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" maxlength="40" />
        <textarea class="lineArea" id="newAction" placeholder="ã‚„ã‚‹ã“ã¨ï¼ˆ40æ–‡å­—ï¼‰" maxlength="40"></textarea>
      </div>

      <div class="fieldRow">
        <input class="lineInput" id="newTags" placeholder="æ‚©ã¿ã‚¿ã‚°ï¼ˆä¾‹ï¼šä¸å®‰,å¯ã¤ãï¼‰" />
        <select class="selectKeep" id="newCategory">
          <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</option>
          <option>ãƒ¡ãƒ³ã‚¿ãƒ«</option><option>ç¡çœ </option><option>é‹å‹•</option><option>å¥åº·</option>
          <option>ç”Ÿæ´»</option><option>å‹‰å¼·</option><option>è‹±èª</option><option>ä»•äº‹</option><option>ãã®ä»–</option>
        </select>
      </div>

      <div class="modalFooter">
        <button class="btn" id="postClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btnPost">æŠ•ç¨¿</button>
      </div>
    </div>
  </div>

  <!-- ===== é›£æ˜“åº¦ï¼ˆ3æŠï¼‰ ===== -->
  <div class="modalBg" id="diffBg">
    <div class="modal">
      <h2 id="diffTitle">é›£æ˜“åº¦</h2>
      <div class="fieldRow" style="grid-template-columns:1fr 1fr 1fr; margin-top:12px">
        <button class="btn" data-diff="easy">ğŸ˜Šæ¥½</button>
        <button class="btn" data-diff="mid">ğŸ™‚ã¡ã‚‡ã†ã©ã„ã„</button>
        <button class="btn" data-diff="hard">ğŸ˜…ã—ã‚“ã©ã„</button>
      </div>
      <div class="modalFooter">
        <button class="btn" id="diffClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ===== è©•ä¾¡ï¼ˆâ˜…â˜†ï¼‰ ===== -->
  <div class="modalBg" id="ratingBg">
    <div class="modal">
      <h2 id="ratingTitle">è©•ä¾¡</h2>

      <div class="starsRow" id="starsRow"></div>
      <textarea class="lineArea" id="commentBox" placeholder="å£ã‚³ãƒŸï¼ˆçŸ­æ–‡ï¼‰" style="margin-top:10px"></textarea>

      <div class="modalFooter">
        <button class="btn" id="ratingClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="ratingSave">é€ä¿¡</button>
      </div>

      <div class="reviewList" id="reviewList"></div>
    </div>
  </div>

  <!-- ===== ä½œæˆè€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ===== -->
  <div class="modalBg" id="creatorBg">
    <div class="modal">
      <h2>ä½œæˆè€…</h2>

      <div class="creatorHeader">
        <div class="creatorBig">
          <div class="bigAva" id="creatorAva">â–¡</div>
          <div class="creatorBigName" id="creatorName">â€”</div>
        </div>
        <button class="btn" id="creatorClose">é–‰ã˜ã‚‹</button>
      </div>

      <div class="reviewList" id="creatorPosts" style="margin-top:12px; border-top:none; padding-top:0"></div>
    </div>
  </div>

  <!-- ===== ã‚­ãƒ£ãƒ©ä¸€è¦§ ===== -->
  <div class="modalBg" id="charBg">
    <div class="modal">
      <h2>ã‚­ãƒ£ãƒ©ä¸€è¦§ï¼ˆåµ/ç¨®ã ã‘è¡¨ç¤ºï¼‰</h2>
      <div class="reviewList" id="charList"></div>
      <div class="modalFooter">
        <button class="btn" id="charClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>


<!-- ===== 3æ—¥ã‚¯ãƒªã‚¢ï¼š2æŠã‚²ãƒ¼ãƒˆ ===== -->
<div class="gate" id="clearGate">
  <div class="gateCard">
    <p class="gateTitle" id="clearGateTitle">ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼ï¼</p>
    <div style="margin-top:8px; color:var(--muted); font-size:12px;" id="clearGateSub">â€”</div>
    <div class="gateActions" style="justify-content:space-between">
      <button class="gateBtn" id="clearNewBtn" style="background:#fff;color:#111;border-color:var(--line);">æ–°ã—ã„ç¿’æ…£ã«æŒ‘æˆ¦</button>
      <button class="gateBtn" id="clearKeepBtn">æœ€å¾Œã¾ã§è‚²æˆï¼ˆæ®‹ã‚Š4æ—¥ï¼‰</button>
    </div>
  </div>
</div>


  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    import {
      getFirestore,
      collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      getDocs, query, orderBy, limit, serverTimestamp,
      runTransaction, increment
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvdaEW4o2y8rljlafXQJbGE-nuGQn9Q88",
      authDomain: "zuzutomo-d8fa0.firebaseapp.com",
      projectId: "zuzutomo-d8fa0",
      storageBucket: "zuzutomo-d8fa0.firebasestorage.app",
      messagingSenderId: "637121353766",
      appId: "1:637121353766:web:dbfb13f85bfaf521616ee7",
      measurementId: "G-C6K64YE13X"
    };

    const app = initializeApp(firebaseConfig);
    try{ getAnalytics(app); }catch(e){}
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

    const nowLocal = () => new Date();
    const fmtYMD = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };
    const parseYMD = (s) => {
      const raw = String(s||"").slice(0,10);
      if(!/^\d{4}-\d{2}-\d{2}$/.test(raw)) return null;
      const [y,m,d] = raw.split("-").map(Number);
      return new Date(y, m-1, d);
    };
    const daysBetween = (a, b) => {
      const A = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
      const B = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
      return Math.round((B - A) / 86400000);
    };
    const msToMidnight = () => {
      const n = nowLocal();
      const next = new Date(n.getFullYear(), n.getMonth(), n.getDate()+1, 0,0,0,0);
      return Math.max(0, next.getTime() - n.getTime());
    };
    const fmtCountdown = (ms) => {
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,"0");
      const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    };

    // ===== Category color (è–„ã‚) =====
  const CAT_COLORS = {
  "ãƒ¡ãƒ³ã‚¿ãƒ«": { tint:"#f4f6ff", line:"#b9c3ff" },
  "ç¡çœ ":     { tint:"#f2fff5", line:"#a8e7b6" },
  "é‹å‹•":     { tint:"#fff2f6", line:"#ffb3cb" },
  "å¥åº·":     { tint:"#f2ffff", line:"#9fe5e5" },
  "ç”Ÿæ´»":     { tint:"#fffdf0", line:"#eadf9a" },
  "å‹‰å¼·":     { tint:"#f3f6ff", line:"#b7c4ff" },
  "è‹±èª":     { tint:"#f1fbff", line:"#9fdcff" },
  "ä»•äº‹":     { tint:"#f6f6f6", line:"#d9d9d9" },
  "ãã®ä»–":   { tint:"#ffffff", line:"#e6e6e6" }
};
    function applyCatVars(el, cat){
      const c = CAT_COLORS[String(cat||"")] || { tint:"#ffffff", line:"#e6e6e6" };
      el.style.setProperty("--catTint", c.tint);
      el.style.setProperty("--catLine", c.line);
    }

    // ===== Hourly mascot (æŠ•ç¨¿å¾Œã‚‚1æ™‚é–“ãŠãã«å¤‰ã‚ã‚‹) =====
    function hourKey(){
      const d = nowLocal();
      return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}-${d.getHours()}`;
    }
    function hash32(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0);
    }
    function mascotEmojiFromHabitId(habitId){
      const k = habitId + ":" + hourKey();
      const v = hash32(k) % 6;
      return ["ğŸ¥š","ğŸ¥šâœ¨","ğŸ¥šâ–","ğŸŒ°","ğŸŒ°âœ¨","ğŸŒ°â–"][v];
    }

    // ===== Elements =====
// ===== Quick Deck (Homeå·¦ä¸‹3ã‚«ãƒ¼ãƒ‰) =====
const quickDeck = $("quickDeck");
const quickDeckInner = $("quickDeckInner");

let __habitsMapForDeck = new Map();       // habitId -> habit data
let __activeChallengesCache = [];         // active challenges cache
let __deckFocusedByTouch = false;         // ã‚¹ãƒãƒ›ã®â€œæŠ¼ã—ã¦ã‚‹çŠ¶æ…‹â€
let __pickedSlotKey = "";                 // ã‚¹ãƒãƒ›ã§é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰

const navCalendar = $("navCalendar");
const navAnalytics = $("navAnalytics");

const viewCalendar = $("viewCalendar");
const viewAnalytics = $("viewAnalytics");

const calChallengeSel = $("calChallengeSel");
const calPrev = $("calPrev");
const calNext = $("calNext");
const calTitle = $("calTitle");
const calGrid = $("calGrid");

const anaHint = $("anaHint");
const anaStatusGrid = $("anaStatusGrid");
const anaInsights = $("anaInsights");
const anaBar = $("anaBar");
const anaLines = $("anaLines");




const clearGate = $("clearGate");
const clearGateTitle = $("clearGateTitle");
const clearGateSub = $("clearGateSub");
const clearNewBtn = $("clearNewBtn");
const clearKeepBtn = $("clearKeepBtn");




    
    const navHome = $("navHome");
    const navTrain = $("navTrain");
    const navRecords = $("navRecords");
    const navBookmarks = $("navBookmarks");
    const navProfile = $("navProfile");

    const viewHome = $("viewHome");
    const viewTrain = $("viewTrain");
    const viewRecords = $("viewRecords");
    const viewBookmarks = $("viewBookmarks");
    const viewProfile = $("viewProfile");

    const loginGate = $("loginGate");
    const gateLoginBtn = $("gateLoginBtn");

    const userName = $("userName");
    const userSmall = $("userSmall");
    const userAvatar = $("userAvatar");
    const followerMini = $("followerMini");

    const levelBadge = $("levelBadge");
    const xpText = $("xpText");
    const xpRemain = $("xpRemain");
    const todayDoneBadge = $("todayDoneBadge");
    const openCharList = $("openCharList");

    const lvRingFg = $("lvRingFg");
    const lvNum = $("lvNum");
    const xpPop = $("xpPop");

    const sideActiveList = $("sideActiveList");

    // Home
    const feed = $("feed");
    const qInput = $("q");
    const btnSearch = $("btnSearch");
    const categoryFilter = $("categoryFilter");
    const sortBy = $("sortBy");
    const btnClearTag = $("btnClearTag");
    const rankReco = $("rankReco");
    const rankTop = $("rankTop");
    const countShown = $("countShown");

    // FAB
    const openPost = $("openPost");

    // Post modal
    const postBg = $("postBg");
    const postClose = $("postClose");
    const btnPost = $("btnPost");
    const newTitle = $("newTitle");
    const newAction = $("newAction");
    const newTags = $("newTags");
    const newCategory = $("newCategory");
    const postCounter = $("postCounter");

    // Name modal
    const nameBg = $("nameBg");
    const nameInput = $("nameInput");
    const nameSave = $("nameSave");
    const colorPick = $("colorPick");
    const nameAvatar = $("nameAvatar");

    // Category modal
    const catBg = $("catBg");
    const catList = $("catList");
    const catClose = $("catClose");
    const catSave = $("catSave");

    // Difficulty
    const diffBg = $("diffBg");
    const diffTitle = $("diffTitle");
    const diffClose = $("diffClose");

    // Records/bookmarks/profile
    const recordList = $("recordList");
    const bmFeed = $("bmFeed");
    const bmCount = $("bmCount");
    const profileList = $("profileList");
    const profileLv = $("profileLv");

    // Profile auth buttons
    const btnLogin = $("btnLogin");
    const btnLogout = $("btnLogout");

    // Rating
    const ratingBg = $("ratingBg");
    const ratingTitle = $("ratingTitle");
    const starsRow = $("starsRow");
    const commentBox = $("commentBox");
    const ratingClose = $("ratingClose");
    const ratingSave = $("ratingSave");
    const reviewList = $("reviewList");

    // Creator modal
    const creatorBg = $("creatorBg");
    const creatorClose = $("creatorClose");
    const creatorAva = $("creatorAva");
    const creatorName = $("creatorName");
    const creatorPosts = $("creatorPosts");

    // Char list
    const charBg = $("charBg");
    const charList = $("charList");
    const charClose = $("charClose");

    // Training
    const trainHint = $("trainHint");
    const trainSlot = $("trainSlot");
    const trainHabitTitle = $("trainHabitTitle");
    const trainPctText = $("trainPctText");
    const trainPct = $("trainPct");
    const trainFill = $("trainFill");
    const trainEmoji = $("trainEmoji");
    const trainStage = $("trainStage");
    const trainPrev = $("trainPrev");
    const trainNext = $("trainNext");
    const btnSetAvatar = $("btnSetAvatar");
    const trainCare = $("trainCare");

    // ===== State =====
    const CATS = ["ãƒ¡ãƒ³ã‚¿ãƒ«","ç¡çœ ","é‹å‹•","å¥åº·","ç”Ÿæ´»","å‹‰å¼·","è‹±èª","ä»•äº‹","ãã®ä»–"];

    let currentUser = null;
    let myProfile = null;

    let selectedTag = "";
    let cachedFavCreators = new Set();
    let cachedBookmarks = new Set();

    let activeHabitIds = new Set();

    let diffTargetChallenge = null;

    let ratingTargetHabit = null;
    let ratingStars = 0;

    let trainChallenges = [];
    let trainIndex = 0;

    // ===== Character system (ä¸€è¦§ã§åµ/ç¨®ã ã‘) =====
    // â€»ç¨®é¡ã‚’å¢—ã‚„ã™ãªã‚‰ï¼šã“ã“ã«emojiã¨minLvã‚’è¿½åŠ ã—ã¦ã„ãã ã‘ã§OK
    const CHAR_TIERS = [
      { minLv: 1, name: "åµ", emoji: "ğŸ¥š", type:"egg" },
      { minLv: 2, name: "æ°´ç‰åµ", emoji: "ğŸ¥šğŸ«§", type:"egg" },
      { minLv: 3, name: "å…‰ã‚‹åµ", emoji: "ğŸ¥šâœ¨", type:"egg" },
      { minLv: 4, name: "é‡‘ã®åµ", emoji: "ğŸ¥šğŸŸ¡", type:"egg" },
      { minLv: 5, name: "ä¸æ€è­°ãªåµ", emoji: "ğŸ¥šâ–", type:"egg" },
      { minLv: 1, name: "ç¨®", emoji: "ğŸŒ°", type:"seed" },
      { minLv: 2, name: "èŠ½ã®ç¨®", emoji: "ğŸŒ°ğŸŒ±", type:"seed" },
      { minLv: 3, name: "å…‰ã‚‹ç¨®", emoji: "ğŸŒ°âœ¨", type:"seed" },
      { minLv: 4, name: "èŠ±ã®ç¨®", emoji: "ğŸŒ°ğŸŒ¸", type:"seed" },
      { minLv: 5, name: "ä¸æ€è­°ãªç¨®", emoji: "ğŸŒ°â–", type:"seed" },
    ];

    // 7æ®µéšï¼ˆè‚²æˆç”»é¢ã®ä»®ï¼šçµµæ–‡å­—/è¨˜å·ã§ä»£ç”¨ï¼‰
    const GROW_STAGES = [
      { max: 0,   label:"çœ ã‚Š" , emoji:"ğŸ¥š" },
      { max: 15,  label:"ç›®è¦šã‚", emoji:"ğŸ¥šğŸŒ¤ï¸" },
      { max: 30,  label:"ã‚ˆã¡ã‚ˆã¡", emoji:"ğŸ£" },
      { max: 45,  label:"è‚²ã¡", emoji:"ğŸ¤" },
      { max: 60,  label:"æº–å‚™", emoji:"âœ¨" },
      { max: 75,  label:"é€²åŒ–å‰", emoji:"â–" },
      { max: 100, label:"å®Œæˆ", emoji:"ğŸ‘‘" },
    ];

    // ===== XP / Level =====
    function needXpForLevel(lv){ return 100 + Math.max(0, lv-1)*40; }
    function computeLevelFromXp(totalXp){
      let lv = 1;
      let xp = Math.max(0, Number(totalXp||0));
      while(true){
        const need = needXpForLevel(lv);
        if(xp >= need){ xp -= need; lv++; continue; }
        return { lv, cur: xp, need };
      }
    }

    function setRingProgress(pct){
      const r = 18;
      const C = 2 * Math.PI * r;
      const p = Math.max(0, Math.min(1, pct));
      lvRingFg.style.strokeDasharray = String(C);
      lvRingFg.style.strokeDashoffset = String(C * (1 - p));
    }

    function popXp(add){
      if(!xpPop) return;
      xpPop.textContent = `+${add}`;
      xpPop.classList.add("show");
      setTimeout(()=> xpPop.classList.remove("show"), 2000);
    }

    function setXpUI(){
      const total = Number(myProfile?.xpTotal||0);
      const { lv, cur, need } = computeLevelFromXp(total);

      myProfile.level = lv;
      myProfile.xpCur = cur;
      myProfile.xpNeed = need;

      levelBadge.textContent = `Lv ${lv}`;
      profileLv.textContent = `Lv ${lv}`;
      lvNum.textContent = String(lv);

      xpText.textContent = `${cur} / ${need}`;
      xpRemain.textContent = `æ¬¡ã¾ã§ ${Math.max(0, need - cur)}`;

      setRingProgress(need ? (cur/need) : 0);
    }

    async function addXp(amount){
      const add = Math.max(0, Math.floor(amount||0));
      if(!add) return;

      popXp(add);

      await runTransaction(db, async (tx)=>{
        const uref = doc(db, "users", currentUser.uid);
        const us = await tx.get(uref);
        if(!us.exists()) return;
        const u = us.data();
        tx.update(uref, { xpTotal: Number(u.xpTotal||0) + add, updatedAt: serverTimestamp() });
      });

      const snap = await getDoc(doc(db,"users",currentUser.uid));
      myProfile = snap.data();
      setXpUI();
      applyUserHeader();
    }

    // ===== Helpers =====
    function setAvatarColor(el, color){
      el.style.background = String(color||"#111111");
      el.style.color = "#fff";
      el.textContent = "â–¡";
    }

    
function showOnly(section){
  viewHome.style.display = section==="home" ? "" : "none";
  viewTrain.style.display = section==="train" ? "" : "none";
  viewCalendar.style.display = section==="calendar" ? "" : "none";
  viewAnalytics.style.display = section==="analytics" ? "" : "none";
  viewRecords.style.display = section==="records" ? "" : "none";
  viewBookmarks.style.display = section==="bookmarks" ? "" : "none";
  viewProfile.style.display = section==="profile" ? "" : "none";

  navHome.classList.toggle("active", section==="home");
  navTrain.classList.toggle("active", section==="train");
  navCalendar.classList.toggle("active", section==="calendar");
  navAnalytics.classList.toggle("active", section==="analytics");
  navRecords.classList.toggle("active", section==="records");
  navBookmarks.classList.toggle("active", section==="bookmarks");
  navProfile.classList.toggle("active", section==="profile");

  openPost.classList.toggle("show", section==="home");

  if(section==="records") refreshRecords();
  if(section==="bookmarks") refreshBookmarksView();
  if(section==="profile") refreshProfile();
  if(section==="train") refreshTrain();
  if(section==="calendar") refreshCalendar();
  if(section==="analytics") refreshAnalytics();
    // QuickDeckï¼šHomeã ã‘è¡¨ç¤º
  updateDeckVisibility();
}























function flyToBadge(fromEl){
  const toEl = $("todayDoneBadge");
  if(!fromEl || !toEl) return;

  const a = fromEl.getBoundingClientRect();
  const b = toEl.getBoundingClientRect();

  const ax = a.left + a.width * 0.5;
  const ay = a.top  + a.height * 0.5;
  const bx = b.left + b.width * 0.5;
  const by = b.top  + b.height * 0.5;

  const dx = bx - ax;
  const dy = by - ay;

  // ---- utilities ----
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
  const rand  = (min,max)=> min + Math.random()*(max-min);

  // é€Ÿåº¦ã«å¿œã˜ã¦å°‘ã—æ™‚é–“å¤‰ãˆã‚‹ï¼ˆé ã„ã»ã©å°‘ã—é•·ã‚ï¼‰
  const dist = Math.hypot(dx, dy);
  const travelMs = clamp(850 + dist * 0.35, 900, 1400); // æœ€åˆ/æœ€å¾Œã‚†ã£ãã‚Šä½“æ„Ÿ

  // ç”»é¢ä¸Šã«å›ºå®šã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚ã‚ºãƒ¬ãªã„ï¼‰
  const layer = document.createElement("div");
  layer.style.position = "fixed";
  layer.style.left = "0";
  layer.style.top  = "0";
  layer.style.width = "100vw";
  layer.style.height = "100vh";
  layer.style.pointerEvents = "none";
  layer.style.zIndex = "9999";
  document.body.appendChild(layer);

  // å°ã•ã„ã‚¹ãƒ‘ãƒ¼ã‚¯ã‚’æ•£ã‚‰ã™ï¼ˆé–‹å§‹/çµ‚äº†ç”¨ï¼‰
  function burst(x, y, strength=1){
    const count = Math.round(10 + 10*strength);
    for(let i=0;i<count;i++){
      const p = document.createElement("div");
      const size = rand(2, 5) * (0.9 + strength*0.25);

      p.style.position = "absolute";
      p.style.left = x + "px";
      p.style.top  = y + "px";
      p.style.width = size + "px";
      p.style.height = size + "px";
      p.style.borderRadius = "999px";

      // é»’ä¸¸ã˜ã‚ƒãªãâ€œç™ºå…‰ç²’å­â€ã£ã½ãï¼ˆç™½ã€œé‡‘ã®ã‚°ãƒ©ãƒ‡ï¼‰
      const hue = rand(35, 55); // é‡‘è‰²å¯„ã‚Š
      p.style.background = `radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95) 0%, hsla(${hue}, 95%, 70%, 0.9) 35%, rgba(255,255,255,0) 70%)`;
      p.style.boxShadow  = `0 0 ${Math.round(10+10*strength)}px rgba(255,220,140,0.6)`;

      p.style.transform = "translate(-50%,-50%) scale(0.6)";
      p.style.opacity = "0.0";

      layer.appendChild(p);

      const ang = rand(0, Math.PI*2);
      const spd = rand(18, 60) * (0.8 + strength*0.35);
      const ox  = Math.cos(ang) * spd;
      const oy  = Math.sin(ang) * spd;

      // 1) ãµã‚ã£ã¨å‡ºã‚‹ 2) é£›ã¶ 3) æ¶ˆãˆã‚‹ï¼ˆæœ€åˆã¨æœ€å¾ŒãŒã‚†ã£ãã‚Šå¯„ã‚Šï¼‰
      p.animate([
        { transform: "translate(-50%,-50%) scale(0.6)", opacity: 0.0, filter: "blur(0px)" },
        { transform: "translate(-50%,-50%) scale(1.15)", opacity: 1.0, filter: "blur(0px)", offset: 0.18 },
        { transform: `translate(calc(-50% + ${ox}px), calc(-50% + ${oy}px)) scale(0.9)`, opacity: 0.0, filter: "blur(0.6px)" }
      ],{
        duration: 520 + rand(-60, 120),
        easing: "cubic-bezier(.18,.9,.2,1)", // ç«‹ã¡ä¸ŠãŒã‚Šã‚†ã£ãã‚Šâ†’å¼¾ã‚€
        fill: "forwards"
      });

      setTimeout(()=> p.remove(), 800);
    }
  }

  // â€œé£›ã‚“ã§ã„ãæœ¬ä½“â€ï¼å°ã•ãªå½—æ˜Ÿ(ã‚³ãƒ¡ãƒƒãƒˆ)ã£ã½ã„ç²’å­
  const comet = document.createElement("div");
  comet.style.position = "absolute";
  comet.style.left = ax + "px";
  comet.style.top  = ay + "px";
  comet.style.width = "18px";
  comet.style.height = "18px";
  comet.style.borderRadius = "999px";
  comet.style.transform = "translate(-50%,-50%)";
  comet.style.background = "radial-gradient(circle at 30% 30%, rgba(255,255,255,0.98) 0%, rgba(255,235,170,0.95) 35%, rgba(255,255,255,0) 70%)";
  comet.style.boxShadow = "0 0 18px rgba(255,220,140,0.65)";
  layer.appendChild(comet);

  // å°¾ï¼ˆãƒˆãƒ¬ã‚¤ãƒ«ï¼‰ã‚’CSSã§è¡¨ç¾
  const tail = document.createElement("div");
  tail.style.position = "absolute";
  tail.style.left = "50%";
  tail.style.top  = "50%";
  tail.style.width = "46px";
  tail.style.height = "10px";
  tail.style.transformOrigin = "0 50%";
  tail.style.transform = "translate(2px,-50%)";
  tail.style.borderRadius = "999px";
  tail.style.background = "linear-gradient(90deg, rgba(255,230,160,0.85) 0%, rgba(255,230,160,0.35) 45%, rgba(255,230,160,0) 100%)";
  tail.style.filter = "blur(0.3px)";
  comet.appendChild(tail);

  // æ–¹å‘ã«åˆã‚ã›ã¦å°¾ã‚’å›è»¢
  const angleDeg = Math.atan2(dy, dx) * 180 / Math.PI;
  tail.style.rotate = angleDeg + "deg";

  // é–‹å§‹ãƒãƒ¼ã‚¹ãƒˆï¼ˆã¯ã˜ã‘ã‚‹ï¼‰
  burst(ax, ay, 1.0);

  // ç§»å‹•ã‚¢ãƒ‹ãƒ¡ï¼ˆæœ€åˆã¨æœ€å¾ŒãŒã‚†ã£ãã‚Šï¼‰
  const move = comet.animate([
    { transform: "translate(-50%,-50%) scale(0.75)", left: ax+"px", top: ay+"px", opacity: 1 },
    { transform: "translate(-50%,-50%) scale(1.05)", left: (ax + dx*0.18)+"px", top: (ay + dy*0.18)+"px", opacity: 1, offset: 0.22 },
    { transform: "translate(-50%,-50%) scale(0.95)", left: (ax + dx*0.78)+"px", top: (ay + dy*0.78)+"px", opacity: 1, offset: 0.86 },
    { transform: "translate(-50%,-50%) scale(0.70)", left: bx+"px", top: by+"px", opacity: 0.0 }
  ],{
    duration: travelMs,
    easing: "cubic-bezier(.35,0,.15,1)", // ã„ã¡ã°ã‚“ã€Œæœ€åˆã¨æœ€å¾Œã‚†ã£ãã‚Šã€æ„ŸãŒå‡ºã‚‹
    fill: "forwards"
  });

  // é£›è¡Œä¸­ã«å°ç²’å­ã‚’å°‘ã—ãšã¤è½ã¨ã™ï¼ˆå°¾ãŒâ€œã‚¨ãƒ•ã‚§ã‚¯ãƒˆã£ã½ã„â€ï¼‰
  const start = performance.now();
  let rafId = 0;
  function drip(t){
    const p = move.effect.getComputedTiming();
    const prog = (p && typeof p.progress === "number") ? p.progress : clamp((t - start)/travelMs, 0, 1);

    // ç¾åœ¨åº§æ¨™ï¼ˆã»ã¼ç·šå½¢ã§OKã€‚è¦‹ãŸç›®ã¯easingãŒåŠ¹ã„ã¦ã‚‹ï¼‰
    const x = ax + dx * prog;
    const y = ay + dy * prog;

    // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã§0ã€œ2ç²’ãã‚‰ã„è½ã¨ã™
    const drops = Math.random() < 0.6 ? 1 : 0;
    for(let i=0;i<drops;i++){
      const d = document.createElement("div");
      const s = rand(2, 4.5);
      d.style.position = "absolute";
      d.style.left = (x + rand(-4,4)) + "px";
      d.style.top  = (y + rand(-4,4)) + "px";
      d.style.width = s + "px";
      d.style.height = s + "px";
      d.style.borderRadius = "999px";
      const hue = rand(35, 60);
      d.style.background = `radial-gradient(circle, rgba(255,255,255,0.9) 0%, hsla(${hue}, 95%, 70%, 0.8) 45%, rgba(255,255,255,0) 72%)`;
      d.style.boxShadow  = "0 0 10px rgba(255,220,140,0.45)";
      d.style.transform = "translate(-50%,-50%)";
      layer.appendChild(d);

      const ox = rand(-18, 18);
      const oy = rand(-8, 22);
      d.animate([
        { transform: "translate(-50%,-50%) scale(1)", opacity: 0.9 },
        { transform: `translate(calc(-50% + ${ox}px), calc(-50% + ${oy}px)) scale(0.6)`, opacity: 0.0 }
      ],{
        duration: 420 + rand(-80, 140),
        easing: "cubic-bezier(.2,.8,.2,1)",
        fill: "forwards"
      });
      setTimeout(()=> d.remove(), 700);
    }

    if(prog < 1){
      rafId = requestAnimationFrame(drip);
    }
  }
  rafId = requestAnimationFrame(drip);

  move.onfinish = ()=>{
    // çµ‚ç‚¹ãƒãƒ¼ã‚¹ãƒˆï¼ˆã¯ã˜ã‘ã‚‹ï¼‰
    burst(bx, by, 1.15);

    // ç‰‡ä»˜ã‘
    cancelAnimationFrame(rafId);
    comet.remove();
    setTimeout(()=> layer.remove(), 900);
  };
}












let clearGateChallengeId = null;

function openClearGate(ch){
  clearGateChallengeId = ch.habitId;
  clearGateTitle.textContent = "ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼ï¼";
  clearGateSub.textContent = `${ch.habitTitle || ""}ï¼š3æ—¥ã‚¯ãƒªã‚¢é”æˆã€‚ç¶šã‘ã¾ã™ã‹ï¼Ÿ`;
  clearGate.classList.add("show");
}
function closeClearGate(){
  clearGate.classList.remove("show");
  clearGateChallengeId = null;
}
clearGate.addEventListener("click",(e)=>{ if(e.target===clearGate){} }); // èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§é–‰ã˜ãªã„ï¼ˆå¼·åˆ¶ï¼‰




clearNewBtn.addEventListener("click", async ()=>{
  if(!clearGateChallengeId) return;
  const ref = doc(db, "userChallenges", currentUser.uid, "items", clearGateChallengeId);
  await updateDoc(ref, { status:"cleared", phase:"short_cleared", updatedAt: serverTimestamp() });

  // 3æ—¥ã§çµ‚äº† â†’ å£ã‚³ãƒŸï¼ˆå¼·åˆ¶ã«è¿‘ã„é‹ç”¨ï¼šã“ã“ã§é–‹ãï¼‰
  const snap = await getDoc(ref);
  const ch = snap.exists() ? snap.data() : null;
  closeClearGate();
  if(ch) await openRatingModalByChallenge({ ...ch, habitId: clearGateChallengeId }, "finish");
  await afterLoginWarm();
});

clearKeepBtn.addEventListener("click", async ()=>{
  if(!clearGateChallengeId) return;
  const ref = doc(db, "userChallenges", currentUser.uid, "items", clearGateChallengeId);
  // 7æ—¥ã¸å»¶é•·
  await updateDoc(ref, { targetDays:7, phase:"long", updatedAt: serverTimestamp() });
  closeClearGate();
  await afterLoginWarm();
});

    
 
    // ===== Auth =====
    async function login(){
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }
    async function logout(){
      await signOut(auth);
    }
    gateLoginBtn.addEventListener("click", async ()=>{ try{ await login(); }catch(e){ alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); } });
    btnLogin.addEventListener("click", async ()=>{ try{ await login(); }catch(e){ alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); } });
    btnLogout.addEventListener("click", async ()=>{ try{ await logout(); }catch(e){ alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—"); } });

    // ===== Name modal =====
    function openNameModal(){
      nameInput.value = "";
      nameSave.disabled = true;
      const c = myProfile?.avatarColor || "#111111";
      colorPick.value = c;
      setAvatarColor(nameAvatar, c);
      nameBg.classList.add("show");
    }
    function closeNameModal(){ nameBg.classList.remove("show"); }
    nameInput.addEventListener("input", ()=>{ nameSave.disabled = nameInput.value.trim().length<1; });
    colorPick.addEventListener("change", ()=> setAvatarColor(nameAvatar, colorPick.value));

    nameSave.addEventListener("click", async ()=>{
      const nm = nameInput.value.trim().slice(0,16);
      if(!nm) return;
      const color = colorPick.value || "#111111";

      await updateDoc(doc(db,"users",currentUser.uid), { name: nm, avatarColor: color, updatedAt: serverTimestamp() });
      myProfile.name = nm;
      myProfile.avatarColor = color;

      closeNameModal();

      if(!(myProfile?.preferredCategory||"")) openCategoryModal();
      await afterLoginWarm();
    });

    // ===== Category modal =====
    let catSelected = "";
    function openCategoryModal(){
      catSelected = "";
      catSave.disabled = true;
      catList.innerHTML = "";
      for(const c of CATS){
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = c;
        applyCatButton(b, c, false);
        b.addEventListener("click", ()=>{
          catSelected = c;
          [...catList.querySelectorAll(".btn")].forEach(x=>{
            x.classList.remove("primary");
            x.style.borderColor = "var(--line)";
            x.style.background = "#fff";
          });
          b.classList.add("primary");
          applyCatButton(b, c, true);
          catSave.disabled = false;
        });
        catList.appendChild(b);
      }
      catBg.classList.add("show");
    }
    function applyCatButton(btn, cat, selected){
      const c = CAT_COLORS[String(cat)] || { tint:"#fff", line:"#e6e6e6" };
      btn.style.borderColor = c.line;
      btn.style.background = selected ? c.line : "#fff";
    }
    function closeCategoryModal(){ catBg.classList.remove("show"); }
    catClose.addEventListener("click", closeCategoryModal);
    catSave.addEventListener("click", async ()=>{
      if(!catSelected) return;
      await updateDoc(doc(db,"users",currentUser.uid), { preferredCategory: catSelected, updatedAt: serverTimestamp() });
      myProfile.preferredCategory = catSelected;
      closeCategoryModal();

      categoryFilter.value = catSelected;
      await refreshHome();
    });

    // ===== Post modal =====
    function openPostModal(){
      newTitle.value = "";
      newTags.value = "";
      newCategory.value = "";
      newAction.value = "";
      updatePostCounter();
      postBg.classList.add("show");
    }
    function closePostModal(){ postBg.classList.remove("show"); }
    openPost.addEventListener("click", ()=> openPostModal());
    postClose.addEventListener("click", closePostModal);
    postBg.addEventListener("click", (e)=>{ if(e.target===postBg) closePostModal(); });

    function updatePostCounter(){ postCounter.textContent = `${newAction.value.length} / 40`; }
    newAction.addEventListener("input", updatePostCounter);

    btnPost.addEventListener("click", async ()=>{
      const title = newTitle.value.trim();
      const action = newAction.value.trim();
      const tags = newTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(newCategory.value||"").trim();

      if(title.length<2){ alert("ã‚¿ã‚¤ãƒˆãƒ«çŸ­ã„"); return; }
      if(action.length<2){ alert("ã‚„ã‚‹ã“ã¨çŸ­ã„"); return; }
      if(action.length>40){ alert("40æ–‡å­—ä»¥å†…"); return; }

      try{
        const created = nowLocal();
        await addDoc(collection(db, "habits"), {
          title, action, tags, category,
          creatorUid: currentUser.uid,
          creatorName: myProfile?.name || (currentUser.displayName || "ä½œæˆè€…"),
          creatorPhoto: currentUser.photoURL || "",
          creatorColor: myProfile?.avatarColor || "#111111",

          createdAt: serverTimestamp(),
          createdAtYMD: fmtYMD(created),
          updatedAt: serverTimestamp(),

          avgRating: 0,
          ratingCount: 0,
          participantsCount: 0,
          avgDays: 0,
          successRate: 0,

          baseHabitId: "",
          version: 1
        });

        await addXp(8);

        closePostModal();
        await refreshHome();
        await refreshProfile();
      }catch(e){
        alert("æŠ•ç¨¿å¤±æ•—");
      }
    });

    // ===== Profile doc =====
    async function ensureProfile(){
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const initial = {
          name: "",
          photoURL: currentUser.photoURL || "",
          avatarColor: "#111111",
          preferredCategory: "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          clearCount: 0,
          totalChallenges: 0,
          ratingRank: 1,
          xpTotal: 0,
          followerCount: 0
        };
        await setDoc(ref, initial);
        myProfile = initial;
      }else{
        myProfile = snap.data();
      }
      setXpUI();
      applyUserHeader();
    }

    function applyUserHeader(){
      const nm = (myProfile?.name || "").trim();
      userName.textContent = nm || "â€”";
      userSmall.textContent = currentUser.email || "â€”";
      setAvatarColor(userAvatar, myProfile?.avatarColor || "#111111");
      followerMini.textContent = `ãƒ•ã‚©ãƒ­ãƒ¼ ${Number(myProfile?.followerCount||0)}`;
    }

    async function warmCaches(){
      cachedFavCreators = new Set();
      cachedBookmarks = new Set();

      {
        const qs = await getDocs(query(
          collection(db, "userCreatorFavs", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(300)
        ));
        qs.forEach(s=> cachedFavCreators.add(s.id));
      }
      {
        const qs = await getDocs(query(
          collection(db, "userBookmarks", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(500)
        ));
        qs.forEach(s=> cachedBookmarks.add(s.id));
      }
    }

    // ===== Daily done count =====
    function dailyDocId(){ return fmtYMD(nowLocal()); }
    async function ensureDailyStatsDoc(){
      const ref = doc(db, "dailyStats", dailyDocId());
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { doneCount: 0, date: dailyDocId(), updatedAt: serverTimestamp() });
      }
    }
    async function refreshDailyDoneCount(){
      try{
        const ref = doc(db, "dailyStats", dailyDocId());
        const snap = await getDoc(ref);
        const done = snap.exists() ? Number(snap.data().doneCount||0) : 0;
        todayDoneBadge.textContent = `æœ¬æ—¥ ${done} äººãŒé”æˆ`;
      }catch(e){
        todayDoneBadge.textContent = `æœ¬æ—¥ 0 äººãŒé”æˆ`;
      }
    }
    async function incDailyDoneCount(){
      await runTransaction(db, async (tx)=>{
        const ref = doc(db, "dailyStats", dailyDocId());
        const snap = await tx.get(ref);
        if(!snap.exists()){
          tx.set(ref, { doneCount: 1, date: dailyDocId(), updatedAt: serverTimestamp() });
        }else{
          tx.update(ref, { doneCount: increment(1), updatedAt: serverTimestamp() });
        }
      });
      await refreshDailyDoneCount();
    }

    async function afterLoginWarm(){
      await warmCaches();
      await autoRetireIfMissed();
      await ensureDailyStatsDoc();
      await refreshDailyDoneCount();

      await refreshActiveHabitIds();
      await refreshSideActive();
      await refreshHome();
      await refreshRecords();
      await refreshBookmarksView();
      await refreshProfile();
      await refreshTrain();
      await refreshCalendar();
await refreshAnalytics();
    }

    // ===== Active set for cards =====
async function refreshActiveHabitIds(){
  activeHabitIds = new Set();
  const actives = await loadActiveChallenges();

  __activeChallengesCache = actives;   // â˜…è¿½åŠ ï¼šQuickDeckç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°

  for(const ch of actives) activeHabitIds.add(ch.habitId);
}

    // ===== Auth state =====
    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;

      if(!currentUser){
        loginGate.classList.add("show");
        btnLogout.disabled = true;

        userName.textContent = "â€”";
        userSmall.textContent = "â€”";
        followerMini.textContent = "ãƒ•ã‚©ãƒ­ãƒ¼ 0";
        userAvatar.textContent = "â–¡";
        userAvatar.style.background = "#fff";
        userAvatar.style.color = "#111";

        sideActiveList.innerHTML = "";
        feed.innerHTML = "";
        recordList.innerHTML = "";
        bmFeed.innerHTML = "";
        bmCount.textContent = "0";
        profileList.innerHTML = "";

        cachedFavCreators = new Set();
        cachedBookmarks = new Set();
        activeHabitIds = new Set();

        showOnly("home");
            updateDeckVisibility();
    renderQuickDeck();
        return;
      }

      loginGate.classList.remove("show");
      btnLogout.disabled = false;

      await ensureProfile();

      const nm = (myProfile?.name || "").trim();
      if(!nm){
        openNameModal();
        return;
      }
      if(!(myProfile?.preferredCategory||"")){
        openCategoryModal();
      }else{
        categoryFilter.value = myProfile.preferredCategory;
      }

      await afterLoginWarm();
    });

    // ===== ãƒŠãƒ“ã‚¯ãƒªãƒƒã‚¯è¿½åŠ  =====
    navHome.addEventListener("click", ()=> showOnly("home"));
    navTrain.addEventListener("click", ()=> showOnly("train"));
    navRecords.addEventListener("click", ()=> showOnly("records"));
    navBookmarks.addEventListener("click", ()=> showOnly("bookmarks"));
    navProfile.addEventListener("click", ()=> showOnly("profile"));


    
navCalendar.addEventListener("click", ()=> showOnly("calendar"));
navAnalytics.addEventListener("click", ()=> showOnly("analytics"));


    
    // ===== Search/filters =====
    btnSearch.addEventListener("click", refreshHome);
    qInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshHome(); });
    categoryFilter.addEventListener("change", refreshHome);
    sortBy.addEventListener("change", refreshHome);
    btnClearTag.addEventListener("click", async ()=>{
      selectedTag = "";
      highlightRankChips();
      await refreshHome();
    });
let activeCardEl = null; // ã‚¹ãƒãƒ›ç”¨ï¼šæœ€å¾Œã«é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰
    // ===== Home =====
    async function refreshHome(){
      if(!currentUser) return;

      await refreshActiveHabitIds();

      const keyword = qInput.value.trim().toLowerCase();
      const cat = categoryFilter.value.trim();
      const sort = sortBy.value;

      let habits = [];
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(300)));
      qs.forEach(s=> habits.push({ id:s.id, ...s.data() }));

      
      // QuickDeckç”¨ï¼šhabits ã‚’ map åŒ–ï¼ˆè¡¨ç¤ºç”¨ï¼‰
      __habitsMapForDeck = new Map(habits.map(h=>[h.id, h]));

      
      // tag ranking
      const tagCounts = new Map();
      for(const h of habits){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          tagCounts.set(k, (tagCounts.get(k)||0)+1);
        });
      }
      const top3 = [...tagCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);

      // recoï¼šè‡ªåˆ†ã®ã‚«ãƒ†ã‚´ãƒªå„ªå…ˆ
      const pref = (myProfile?.preferredCategory||"").trim();
      const pool = pref ? habits.filter(h => String(h.category||"").trim() === pref) : habits;
      const recoCounts = new Map();
      for(const h of pool){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          recoCounts.set(k, (recoCounts.get(k)||0)+1);
        });
      }
      const reco3 = [...recoCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);

      renderRank(rankReco, reco3);
      renderRank(rankTop, top3);
      highlightRankChips();

      // filter
      let filtered = habits.filter(h=>{
        const hCat = String(h.category||"").trim();
        if(cat && hCat !== cat) return false;
        if(selectedTag && !(h.tags||[]).includes(selectedTag)) return false;
        if(keyword){
          const blob = [h.title, h.action, (h.tags||[]).join(" "), h.category, h.creatorName].join(" ").toLowerCase();
          if(!blob.includes(keyword)) return false;
        }
        if(sort==="favCreators"){
          return cachedFavCreators.has(h.creatorUid);
        }
        return true;
      });

      // sort
      filtered.sort((a,b)=>{
        const ca = a.createdAt?.seconds ? a.createdAt.seconds : 0;
        const cb = b.createdAt?.seconds ? b.createdAt.seconds : 0;

        const ra = Number(a.avgRating||0);
        const rb = Number(b.avgRating||0);

        if(sort==="rating") return (rb-ra) || (cb-ca);
        return (cb-ca);
      });

      countShown.textContent = String(filtered.length);

      feed.innerHTML = "";
      for(const h of filtered){
        feed.appendChild(renderHabitCard(h));
      }

            // QuickDeckï¼šä¸€è¦§æ›´æ–°ã«åˆã‚ã›ã¦å†æç”»
      renderQuickDeck();
    }

    function renderRank(container, tags){
      container.innerHTML = "";
      const list = (tags||[]).slice(0,3);
      for(let i=0;i<list.length;i++){
        const t = list[i];
        const chip = document.createElement("div");
        chip.className = "rankChip";
        chip.dataset.tag = t;
        chip.innerHTML = `<span class="rk">${i+1}ä½</span><span class="tagName">#${escapeHtml(t)}</span>`;
        chip.addEventListener("click", async ()=>{
          selectedTag = t;
          highlightRankChips();
          await refreshHome();
        });
        container.appendChild(chip);
      }
      for(let i=list.length;i<3;i++){
        const dummy = document.createElement("div");
        dummy.className = "rankChip";
        dummy.style.opacity = "0.25";
        dummy.style.pointerEvents = "none";
        dummy.innerHTML = `<span class="rk">${i+1}ä½</span><span class="tagName">â€”</span>`;
        container.appendChild(dummy);
      }
    }
    function highlightRankChips(){
      document.querySelectorAll(".rankChip").forEach(el=>{
        el.classList.toggle("active", (el.dataset.tag||"") === selectedTag);
      });
    }

    function bookmarkSvg(filled){
      if(filled){
        return `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/>
          </svg>`;
      }
      return `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/>
        </svg>`;
    }

    function bubbleSvg(){
      return `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/>
        </svg>`;
    }

    function renderHabitCard(h){
      const card = document.createElement("div");
      card.className = "habitCard";

      const isMine = h.creatorUid === currentUser.uid;
      const bookmarked = cachedBookmarks.has(h.id);
      const creatorFav = cachedFavCreators.has(h.creatorUid);
      const isActive = activeHabitIds.has(h.id);

      const avgRating = Number(h.avgRating||0);
      const ratingCount = Number(h.ratingCount||0);
      const participants = Number(h.participantsCount||0);

      const createdAtStr = String(h.createdAtYMD||"") || "";

      const avgDays = Math.max(0, Math.min(14, Number(h.avgDays||0)));
      const successRate = Math.max(0, Math.min(100, Number(h.successRate||0)));
      const daysPct = Math.max(0, Math.min(100, (avgDays/14)*100));

      applyCatVars(card, h.category);

      card.innerHTML = `
        <div class="thumb">
          <div class="mascotBg">${escapeHtml(mascotEmojiFromHabitId(h.id))}</div>

          <p class="thumbTitle">${escapeHtml(h.title||"")}</p>
          <div class="thumbAction">${escapeHtml(h.action||"")}</div>

          <div class="thumbActions">
            <button class="iconBtn tipBtn reviewBtn" data-act="reviews" data-tip="å£ã‚³ãƒŸ">
              ${bubbleSvg()}
              <span class="badgeCount">${Math.min(99, ratingCount)}</span>
            </button>

            <button class="iconBtn tipBtn ${bookmarked ? "on":""}" data-act="bookmark" data-tip="ä¿å­˜">
              ${bookmarkSvg(bookmarked)}
            </button>

            ${isMine
              ? `<button class="joinBtn tipBtn activeMode" data-act="edit" data-tip="ç·¨é›†">ç·¨é›†</button>`
              : `<button class="joinBtn tipBtn ${isActive ? "activeMode":""}" data-act="join" data-tip="${isActive ? "è‚²æˆä¸­" : "å‚åŠ "}">${isActive ? "è‚²æˆä¸­" : "å‚åŠ "}</button>`
            }
          </div>

      
        </div>

        <div class="metaBar">
          <div class="creatorCol">
            <div class="miniAva" data-act="creator">${h.creatorPhoto ? `<img src="${escapeHtml(h.creatorPhoto)}" alt="">` : "â–¡"}</div>
            <div class="creatorText">
              <div class="creatorName" data-act="creator">${escapeHtml(h.creatorName||"ä½œæˆè€…")}</div>
              <button class="followSmall ${creatorFav ? "on":""}" data-act="follow">ãƒ•ã‚©ãƒ­ãƒ¼</button>
            </div>
          </div>

          <div class="statsRow">
            <div class="statLine">
              <span class="statPill">å‚åŠ è€… ${participants}</span>
              <span class="statPill">è©•ä¾¡ ${avgRating ? avgRating.toFixed(1) : "â€”"}</span>
            </div>
          </div>

          <div class="createdAt">${escapeHtml(createdAtStr)}</div>
        </div>
      `;

 

      card.querySelectorAll('[data-act="creator"]').forEach(el=>{
        el.addEventListener("click", ()=> openCreatorModal(h.creatorUid, h.creatorName, h.creatorPhoto, h.creatorColor));
      });

      card.querySelector('[data-act="follow"]').addEventListener("click", async (e)=>{
        e.stopPropagation();
        await toggleCreatorFav(h.creatorUid);
      });

      card.querySelector('[data-act="bookmark"]').addEventListener("click", async (e)=>{
        e.stopPropagation();
        await toggleBookmark(h.id);
      });

      card.querySelector('[data-act="reviews"]').addEventListener("click", async (e)=>{
        e.stopPropagation();
        await openRatingsViewer(h.id);
      });

      const joinBtn = card.querySelector('[data-act="join"]');
      if(joinBtn) joinBtn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        if(isActive) return;
        await startChallenge(h);
      });

      const editBtn = card.querySelector('[data-act="edit"]');
      if(editBtn) editBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        alert("ç·¨é›†ã¯æ¬¡æ®µéšã§ã€‚ä»Šã¯è‡ªåˆ†ã®æŠ•ç¨¿ã¯å‚åŠ ãŒå‡ºãªã„çŠ¶æ…‹ã§ã™ã€‚");
      });
      // ===== ã‚¹ãƒãƒ›ç”¨ï¼šã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—ã§ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’å›ºå®šï¼ˆä»–ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¾ã§ç¶­æŒï¼‰ =====
      const isTouchUI = window.matchMedia("(hover: none)").matches;

      if(isTouchUI){
        card.addEventListener("click", (e)=>{
          // ãƒœã‚¿ãƒ³é¡ã‚’æŠ¼ã—ãŸæ™‚ã¯ã€Œé¸æŠåˆ‡ã‚Šæ›¿ãˆã€ã‚’ã—ãªã„ï¼ˆèª¤å‹•ä½œé˜²æ­¢ï¼‰
          if(e.target.closest("button, a, input, textarea, select, [data-act]")) return;

          if(activeCardEl && activeCardEl !== card){
            activeCardEl.classList.remove("is-active");
          }
          card.classList.add("is-active");
          activeCardEl = card;
        });
      }

      return card;

    
    }

    // ===== Fav/Bookmark =====
    async function toggleCreatorFav(creatorUid){
      if(!creatorUid) return;
      const ref = doc(db, "userCreatorFavs", currentUser.uid, "items", creatorUid);
      if(cachedFavCreators.has(creatorUid)){
        await deleteDoc(ref);
        cachedFavCreators.delete(creatorUid);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedFavCreators.add(creatorUid);
      }
      await refreshHome();
      await refreshProfile();
    }

    async function toggleBookmark(habitId){
      if(!habitId) return;
      const ref = doc(db, "userBookmarks", currentUser.uid, "items", habitId);
      if(cachedBookmarks.has(habitId)){
        await deleteDoc(ref);
        cachedBookmarks.delete(habitId);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedBookmarks.add(habitId);
      }
      await refreshHome();
      await refreshBookmarksView();
      await refreshProfile();
    }

    // ===== Challenges =====
    async function loadChallenges(limitN=200){
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(limitN)
      ));
      const arr = [];
      qs.forEach(s=> arr.push({ id:s.id, ...s.data() }));
      return arr;
    }
    async function loadActiveChallenges(){
      const all = await loadChallenges(200);
      return all.filter(x => x.status === "active").slice(0, 50);
    }

    function canCareToday(ch){
      const today = fmtYMD(nowLocal());
      const last = String(ch.lastActionYMD||"").slice(0,10);
      return last !== today;
    }

    function growthPctDynamic(ch){
      const day = Number(ch.day||1);
      const base = Math.max(0, Math.min(7, day-1)) / 7 * 100;

      const today = fmtYMD(nowLocal());
      const cared = String(ch.lastActionYMD||"").slice(0,10) === today;

      const totalMs = 86400000;
      const remain = msToMidnight();
      const elapsed = Math.max(0, Math.min(totalMs, totalMs - remain));
      const frac = elapsed / totalMs;

      const add = cared ? (frac * (100/7)) : 0;
      return Math.max(0, Math.min(100, base + add));
    }

    async function startChallenge(h){
      const actives = await loadActiveChallenges();
      if(actives.length >= 3){ alert("ä¾é ¼ã¯æœ€å¤§3"); return; }
      if(h.creatorUid === currentUser.uid){ return; }

      const today = fmtYMD(nowLocal());
      const ref = doc(db, "userChallenges", currentUser.uid, "items", h.id);
      const snap = await getDoc(ref);
      if(snap.exists() && snap.data()?.status === "active") return;

    await setDoc(ref, {
  habitId: h.id,
  habitTitle: h.title || "",
  creatorUid: h.creatorUid || "",
  status: "active",
  startDate: today,
  day: 1,
  successDays: 0,
  restDays: 0,
  lastActionYMD: "",
  streakMiss: 0,
  difficulty: { easy:0, mid:0, hard:0 },
  ratingSubmitted: false,

  targetDays: 3,
  phase: "short",
  dailyEmojis: {}, // YYYY-MM-DD -> çµµæ–‡å­—

  updatedAt: serverTimestamp(),
});

      await runTransaction(db, async (tx)=>{
        const href = doc(db, "habits", h.id);
        const hs = await tx.get(href);
        if(!hs.exists()) return;
        const cur = hs.data();
        tx.update(href, { participantsCount: Number(cur.participantsCount||0)+1, updatedAt: serverTimestamp() });
      });

      await runTransaction(db, async (tx)=>{
        const uref = doc(db,"users",currentUser.uid);
        const us = await tx.get(uref);
        if(!us.exists()) return;
        const u = us.data();
        tx.update(uref, { totalChallenges: Number(u.totalChallenges||0)+1, updatedAt: serverTimestamp() });
      });

      await refreshActiveHabitIds();
      await refreshSideActive();
      await refreshRecords();
      await refreshHome();
      await refreshProfile();
      await refreshTrain();
    }

    // ===== Side active list =====
    let countdownTimer = null;
    async function refreshSideActive(){
      if(!currentUser) return;

      const actives = await loadActiveChallenges();
      activeHabitIds = new Set(actives.map(x=>x.habitId));

      sideActiveList.innerHTML = "";

      if(countdownTimer) clearInterval(countdownTimer);
// 1ç§’ã”ã¨ï¼šUIã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã ã‘æ›´æ–°ï¼ˆDBã¯èª­ã¾ãªã„ï¼‰
countdownTimer = setInterval(()=>{
  const txt = `æ¬¡ã®ãŠä¸–è©±ã¾ã§ ${fmtCountdown(msToMidnight())}`;
  document.querySelectorAll("[data-care]").forEach(el=> el.textContent = txt);
  if(trainCare) trainCare.textContent = txt;

  // æ—¥ä»˜åˆ‡ã‚Šæ›¿ã‚ã‚Šç›´å‰ã ã‘ã€ã¾ã¨ã‚ã¦å†å–å¾—ï¼ˆ1å›ã ã‘ï¼‰
  if(msToMidnight() < 900){
    if(!window.__midnightRefreshed){
      window.__midnightRefreshed = true;
      Promise.resolve().then(async ()=>{
        await refreshDailyDoneCount();
        await refreshActiveHabitIds();
        await refreshSideActive();
        await refreshHome();
        await refreshTrain();
        await refreshCalendar();
        await refreshAnalytics();
        // å°‘ã—å¾…ã£ã¦ãƒ•ãƒ©ã‚°è§£é™¤ï¼ˆæ·±å¤œã«ä½•åº¦ã‚‚èµ°ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
        setTimeout(()=>{ window.__midnightRefreshed = false; }, 20000);
      });
    }
  }
}, 1000);

      for(const ch of actives){
        const box = document.createElement("div");
        box.className = "sideItem";

        const can = canCareToday(ch);
        const care = `æ¬¡ã®ãŠä¸–è©±ã¾ã§ ${fmtCountdown(msToMidnight())}`;

const targetDays = Number(ch.targetDays || 3);             // 3 or 7
const dayRaw = Number(ch.day || 1);
const day = Math.max(1, Math.min(targetDays + 1, dayRaw)); // 1ã€œtargetDays+1(ã‚¯ãƒªã‚¢ç”¨)
const prog = growthPctDynamic(ch);
const remaining = Math.max(0, targetDays - (Math.min(day, targetDays) - 1)); // è¡¨ç¤ºç”¨
box.innerHTML = `
  <div class="sideTop">
    <div class="sideHabit">${escapeHtml(ch.habitTitle||"")}</div>
<div class="sideMeta">${Math.min(day, targetDays)}/${targetDays}æ—¥ç›®</div>
  </div>

  <div class="sideTop" style="align-items:center">
    <div class="sideCare" data-care="1">${care}</div>
  </div>

  <div class="sideBtns">
    <button class="btnMini" data-act="done" ${can ? "" : "disabled"}>ã‚„ã£ãŸ</button>
    <button class="btnMini" data-act="rest" ${can ? "" : "disabled"}>ä¼‘ã‚€</button>
    <button class="btnMini" data-act="retire">ãƒªã‚¿ã‚¤ã‚¢</button>
    <button class="btnMini" data-act="rate" ${ch.ratingSubmitted ? "disabled" : ""}>æ„Ÿæƒ³</button>
  </div>
`;

        box.querySelector('[data-act="done"]').addEventListener("click", (e)=> {
  flyToBadge(e.currentTarget);
  openDiffModal(ch);
});
        box.querySelector('[data-act="rest"]').addEventListener("click", ()=> applyReport(ch, { type:"rest" }));
        box.querySelector('[data-act="retire"]').addEventListener("click", async ()=>{
          if(!confirm("ãƒªã‚¿ã‚¤ã‚¢ï¼Ÿ")) return;
          await applyReport(ch, { type:"retire" });
        });
        box.querySelector('[data-act="rate"]').addEventListener("click", async ()=>{
          await openRatingModalByChallenge(ch, "manual");
        });

        sideActiveList.appendChild(box);
      }
    }

    function openDiffModal(ch){
      diffTargetChallenge = ch;
      diffTitle.textContent = ch.habitTitle || "é›£æ˜“åº¦";
      diffBg.classList.add("show");
    }
    function closeDiffModal(){
      diffTargetChallenge = null;
      diffBg.classList.remove("show");
    }
    diffClose.addEventListener("click", closeDiffModal);
    diffBg.addEventListener("click", (e)=>{ if(e.target===diffBg) closeDiffModal(); });
    diffBg.querySelectorAll("[data-diff]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!diffTargetChallenge) return;
        await applyReport(diffTargetChallenge, { type:"done", diff: btn.dataset.diff });
        closeDiffModal();
      });
    });

    // ===== Apply report =====
  // ===== Apply report =====
async function applyReport(ch, payload){
  const today = fmtYMD(nowLocal());
  const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const cur = snap.data();

  // åŒæ—¥2å›é˜²æ­¢ï¼ˆdone/restï¼‰
  if((payload.type==="done" || payload.type==="rest") && String(cur.lastActionYMD||"") === today){
    return;
  }

  // ã¾ãš retire ã¯å³å‡¦ç†ã—ã¦çµ‚ã‚ã‚‹ï¼ˆæ—¢å­˜ä»•æ§˜ã‚’ç¶­æŒï¼‰
  if(payload.type==="retire"){
    await updateDoc(ref, { status:"retired", updatedAt: serverTimestamp() });

    await maybePromptRating(ch.habitId, { ...cur, habitId: ch.habitId }, "retire");
    await refreshActiveHabitIds();
    await refreshSideActive();
    await refreshRecords();
    await refreshHome();
    await refreshProfile();
    await refreshTrain();
    return;
  }

  // done/rest ã®æ›´æ–°ã‚’çµ„ã¿ç«‹ã¦
  const update = {};

  const curDay = Math.max(1, Number(cur.day || 1));
  const targetDays = Number(cur.targetDays || 3); // 3 or 7
  const nextDay = Math.min(targetDays + 1, curDay + 1); // ä¾‹: target=3ãªã‚‰4ã¾ã§

  if(payload.type==="done"){
    const diffEmoji = payload.diff==="easy" ? "ğŸ˜Š" : payload.diff==="mid" ? "ğŸ™‚" : "ğŸ˜…";

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ï¼šYYYY-MM-DD -> çµµæ–‡å­—
    const daily = Object.assign({}, cur.dailyEmojis || {});
    daily[today] = diffEmoji;
    update.dailyEmojis = daily;

    update.successDays = Number(cur.successDays||0) + 1;
    update.lastActionYMD = today;
    update.streakMiss = 0;

    const d = cur.difficulty || {easy:0,mid:0,hard:0};
    d[payload.diff] = Number(d[payload.diff]||0) + 1;
    update.difficulty = d;

    await incDailyDoneCount();
    await addXp(12);
  }

  if(payload.type==="rest"){
    update.restDays = Number(cur.restDays||0) + 1;
    update.lastActionYMD = today;
    update.streakMiss = 0;

    await addXp(3);
  }

  // dayé€²è¡Œï¼ˆdone/restå…±é€šï¼‰
  update.day = nextDay;
  update.updatedAt = serverTimestamp();
  await updateDoc(ref, update);

  // ===== ã‚¯ãƒªã‚¢åˆ¤å®š =====
  // nextDay ãŒ targetDays+1 ã«ãªã£ãŸç¬é–“ã«ã€Œåˆ°é”ã€
  if(nextDay === targetDays + 1){

    // 3æ—¥ã‚¯ãƒªã‚¢ï¼šå¼·åˆ¶2æŠã‚²ãƒ¼ãƒˆ
    if(targetDays === 3){
      await updateDoc(ref, { phase:"short_cleared_wait", updatedAt: serverTimestamp() });

      const finalSnap = await getDoc(ref);
      const finalCh = finalSnap.exists() ? finalSnap.data() : cur;
      openClearGate({ ...finalCh, habitId: ch.habitId });

      await refreshActiveHabitIds();
      await refreshSideActive();
      await refreshRecords();
      await refreshHome();
      await refreshProfile();
      await refreshTrain();
      return;
    }

    // 7æ—¥çµ‚äº†ï¼šã‚¯ãƒªã‚¢ + å¼·åˆ¶å£ã‚³ãƒŸ
    await updateDoc(ref, { status:"cleared", updatedAt: serverTimestamp() });

    await runTransaction(db, async (tx)=>{
      const uref = doc(db, "users", currentUser.uid);
      const us = await tx.get(uref);
      if(!us.exists()) return;
      const u = us.data();
      tx.update(uref, { clearCount: Number(u.clearCount||0)+1, updatedAt: serverTimestamp() });
    });

    const finalSnap = await getDoc(ref);
    const finalCh = finalSnap.exists() ? finalSnap.data() : cur;
    await openRatingModalByChallenge({ ...finalCh, habitId: ch.habitId }, "finish");

    await refreshActiveHabitIds();
    await refreshSideActive();
    await refreshRecords();
    await refreshHome();
    await refreshProfile();
    await refreshTrain();
    return;
  }

  // é€šå¸¸æ›´æ–°
  await refreshActiveHabitIds();
  await refreshSideActive();
  await refreshRecords();
  await refreshHome();
  await refreshProfile();
  await refreshTrain();
}
    // ===== Auto retire (3æ—¥æœªå ±å‘Š) =====
    async function autoRetireIfMissed(){
      const today = nowLocal();
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(200)
      ));
      const updates = [];
      qs.forEach(s=>{
        const ch = s.data();
        if(ch.status !== "active") return;

        const startD = parseYMD(ch.startDate);
        const lastD = parseYMD(ch.lastActionYMD);

        let miss = 0;
        if(lastD){
          const gap = daysBetween(lastD, today);
          miss = Math.max(0, gap - 1);
        }else if(startD){
          const gap = daysBetween(startD, today);
          miss = Math.max(0, gap - 1);
        }

        const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
        if(miss >= 3){
          updates.push(updateDoc(ref, {
            status:"retired",
            streakMiss: miss,
            updatedAt: serverTimestamp()
          }));
        }else{
          updates.push(updateDoc(ref, { streakMiss: miss, updatedAt: serverTimestamp() }));
        }
      });
      await Promise.allSettled(updates);
    }

    // ===== Records =====
    async function refreshRecords(){
      if(!currentUser) return;
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(150)
      ));
      const items = [];
      qs.forEach(s=> items.push(s.data()));

      recordList.innerHTML = "";
      for(const ch of items){
        const row = document.createElement("div");
        row.className = "review";
       const td = Number(ch.targetDays||3);
const day = Math.max(1, Math.min(td, Number(ch.day||1)));
        row.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(ch.habitTitle||"")}</div>
            <div class="reviewMeta">${escapeHtml(String(ch.status||""))}</div>
          </div>
          <div class="reviewText">${day}/${td} / æˆåŠŸ ${Number(ch.successDays||0)} / ä¼‘ ${Number(ch.restDays||0)} / æœªå ±å‘Š ${Number(ch.streakMiss||0)} / è‚²æˆ ${growthPctDynamic(ch).toFixed(0)}%</div>
        `;
        recordList.appendChild(row);
      }
    }

    // ===== Bookmarks =====
    async function refreshBookmarksView(){
      if(!currentUser) return;
      bmCount.textContent = String(cachedBookmarks.size);
      bmFeed.innerHTML = "";
      if(cachedBookmarks.size === 0) return;

      await refreshActiveHabitIds();

      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(300)));
      const habits = [];
      qs.forEach(s=> habits.push({ id:s.id, ...s.data() }));
      const filtered = habits.filter(h => cachedBookmarks.has(h.id));
      bmCount.textContent = String(filtered.length);
      for(const h of filtered){
        bmFeed.appendChild(renderHabitCard(h));
      }
    }

    // ===== Profile =====
    async function refreshProfile(){
      if(!currentUser) return;

      const actives = await loadActiveChallenges();
      const myPosts = await countMyPosts();

      const total = Number(myProfile?.xpTotal||0);
      const { lv, cur, need } = computeLevelFromXp(total);
      profileLv.textContent = `Lv ${lv}`;

      profileList.innerHTML = `
        <div class="review">
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(myProfile?.name||"â€”")}</div>
            <div class="reviewMeta">Lv ${lv}</div>
          </div>
          <div class="reviewText">
            XP ${cur} / ${need}
            \næ¬¡ã¾ã§ ${Math.max(0, need-cur)}
            \nã‚¯ãƒªã‚¢ ${Number(myProfile?.clearCount||0)} / æŒ‘æˆ¦ä¸­ ${actives.length} / ç·æŒ‘æˆ¦ ${Number(myProfile?.totalChallenges||0)}
            \nãƒ•ã‚©ãƒ­ãƒ¼ ${cachedFavCreators.size} / ä¿å­˜ ${cachedBookmarks.size} / æŠ•ç¨¿ ${myPosts}
            \nãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ ${Number(myProfile?.followerCount||0)}
          </div>
        </div>

        <div class="review">
          <div class="reviewTop">
            <div class="reviewName">è‰²</div>
            <div class="reviewMeta">â€”</div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px">
            <select class="selectKeep" id="profileColor">
              <option value="#111111">é»’</option>
              <option value="#e00000">èµ¤</option>
              <option value="#0b6cff">é’</option>
              <option value="#00a86b">ç·‘</option>
              <option value="#ff8a00">æ©™</option>
            </select>
            <button class="btn primary" id="saveProfileColor">ä¿å­˜</button>
          </div>
        </div>
      `;

      const profileColor = document.getElementById("profileColor");
      const saveProfileColor = document.getElementById("saveProfileColor");
      if(profileColor && saveProfileColor){
        profileColor.value = myProfile?.avatarColor || "#111111";
        saveProfileColor.addEventListener("click", async ()=>{
          const c = profileColor.value || "#111111";
          await updateDoc(doc(db,"users",currentUser.uid), { avatarColor: c, updatedAt: serverTimestamp() });
          const snap = await getDoc(doc(db,"users",currentUser.uid));
          myProfile = snap.data();
          setXpUI();
          applyUserHeader();
          await refreshHome();
        });
      }
    }

    async function countMyPosts(){
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(450)));
      let c = 0;
      qs.forEach(s=>{
        const h = s.data();
        if(h.creatorUid === currentUser.uid) c++;
      });
      return c;
    }

    // ===== Rating rules =====


// â˜… å£ã‚³ãƒŸUIã‚’ã€ŒæŠ•ç¨¿ãƒ¢ãƒ¼ãƒ‰ / é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã€ã§åˆ‡æ›¿
function setRatingUIMode(mode){
  const isViewer = (mode === "viewer");

  // å…¥åŠ›UIï¼ˆâ˜…ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»é€ä¿¡ï¼‰
  starsRow.style.display   = isViewer ? "none" : "flex";
  commentBox.style.display = isViewer ? "none" : "block";
  ratingSave.style.display = isViewer ? "none" : "inline-flex";

  // ä¸€è¦§ï¼ˆä»–äººå£ã‚³ãƒŸè¡¨ç¤ºï¼‰
  reviewList.style.display = isViewer ? "flex" : "none";
}











    
    async function canRate(habitId, ch){
      const didAny = (Number(ch.successDays||0) + Number(ch.restDays||0)) > 0;
      const finishedLike = ["cleared","finished","retired"].includes(String(ch.status||""));
      return didAny || finishedLike;
    }

    async function maybePromptRating(habitId, ch, reason){
      const ref = doc(db, "userChallenges", currentUser.uid, "items", habitId);
      const snap = await getDoc(ref);
      if(snap.exists() && snap.data()?.ratingSubmitted) return;

      if(!(await canRate(habitId, ch))) return;

      const rref = doc(db, "habits", habitId, "ratings", currentUser.uid);
      const rsnap = await getDoc(rref);
      if(rsnap.exists()) {
        await updateDoc(ref, { ratingSubmitted: true, updatedAt: serverTimestamp() });
        return;
      }

      await openRatingModalByChallenge(ch, reason);
    }

    function openRatingModal(){
      ratingStars = 0;
      commentBox.value = "";
      renderStars();
       setRatingUIMode("writer"); // â˜…è¿½åŠ 
      ratingBg.classList.add("show");
    }
    function closeRatingModal(){
      ratingBg.classList.remove("show");
      ratingTargetHabit = null;
    }
    ratingClose.addEventListener("click", closeRatingModal);
    ratingBg.addEventListener("click", (e)=>{ if(e.target===ratingBg) closeRatingModal(); });

    function renderStars(){
      starsRow.innerHTML = "";
      for(let i=1;i<=5;i++){
        const b = document.createElement("div");
        b.className = "starBtn";
        b.textContent = i<=ratingStars ? "â˜…" : "â˜†";
        b.classList.toggle("active", i<=ratingStars);
        b.addEventListener("click", ()=>{
          ratingStars = i;
          renderStars();
        });
        starsRow.appendChild(b);
      }
    }

    async function openRatingModalByChallenge(ch, reason){
      const ok = await canRate(ch.habitId, ch);
      if(!ok){ alert("å‚åŠ è€…ã®ã¿"); return; }

      ratingTargetHabit = ch.habitId;

      ratingTitle.textContent = reason==="retire" ? `è©•ä¾¡ï¼ˆãƒªã‚¿ã‚¤ã‚¢ï¼‰` :
                                reason==="finish" ? `è©•ä¾¡ï¼ˆ7æ—¥çµ‚äº†ï¼‰` :
                                `è©•ä¾¡`;

openRatingModal();
setRatingUIMode("writer");   // â˜…ã“ã“è¿½åŠ ï¼šæŠ•ç¨¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆä»–äººå£ã‚³ãƒŸã¯éš ã™ï¼‰
// await loadRatingsList(ch.habitId);  // â˜…å‰Šé™¤ï¼šä»–äººå£ã‚³ãƒŸã‚’å‡ºã•ãªã„






      

      ratingSave.onclick = async ()=>{
        if(ratingStars < 1){ alert("æ˜Ÿã‚’é¸ã¶"); return; }

        await setDoc(doc(db, "habits", ch.habitId, "ratings", currentUser.uid), {
          uid: currentUser.uid,
          displayName: myProfile?.name || currentUser.displayName || "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
          photoURL: currentUser.photoURL || "",
          stars: ratingStars,
          comment: (commentBox.value || "").trim().slice(0, 300),
          updatedAt: serverTimestamp()
        }, { merge:true });

        await updateDoc(doc(db, "userChallenges", currentUser.uid, "items", ch.habitId), {
          ratingSubmitted: true,
          updatedAt: serverTimestamp()
        });

        await recomputeRatingAgg(ch.habitId);

        closeRatingModal();
        await refreshHome();
        await refreshProfile();
      };
    }

async function loadRatingsList(habitId, opts={}){
  const onlyOthers = !!opts.onlyOthers;
  const limitView = Number.isFinite(opts.limitView) ? opts.limitView : 5; // â˜…åˆæœŸè¡¨ç¤º5ä»¶
  const sort = String(opts.sort || "stars"); // "stars" or "new"

  reviewList.innerHTML = "";

  // Firestoreå´ã§ stars ã§ orderBy ã™ã‚‹ã«ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç­‰ãŒå¿…è¦ã«ãªã‚ŠãŒã¡ãªã®ã§
  // ã“ã“ã§ã¯å–å¾— â†’ JSã§ä¸¦ã³æ›¿ãˆ ã«ã—ã¾ã™ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿï¼‰
  const qs = await getDocs(query(
    collection(db, "habits", habitId, "ratings"),
    orderBy("updatedAt","desc"),
    limit(120)
  ));

  let arr = [];
  qs.forEach(s=> arr.push(s.data()));

  // ä»–äººã ã‘
  if(onlyOthers){
    const myUid = String(currentUser?.uid || "");
    arr = arr.filter(r => String(r.uid||"") !== myUid);
  }

  // ä¸¦ã³æ›¿ãˆï¼ˆåŸºæœ¬ï¼šâ˜…é«˜ã„é † â†’ åŒç‚¹ã¯æ–°ã—ã„é †ï¼‰
  if(sort === "stars"){
    arr.sort((a,b)=>{
      const sa = Number(a.stars||0), sb = Number(b.stars||0);
      const ta = a.updatedAt?.seconds ? a.updatedAt.seconds : 0;
      const tb = b.updatedAt?.seconds ? b.updatedAt.seconds : 0;
      return (sb - sa) || (tb - ta);
    });
  }else{
    // æ–°ã—ã„é †
    arr.sort((a,b)=>{
      const ta = a.updatedAt?.seconds ? a.updatedAt.seconds : 0;
      const tb = b.updatedAt?.seconds ? b.updatedAt.seconds : 0;
      return tb - ta;
    });
  }

  if(arr.length === 0){
    const empty = document.createElement("div");
    empty.className = "review";
    empty.innerHTML = `<div class="reviewText">ã¾ã å£ã‚³ãƒŸãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    reviewList.appendChild(empty);
    return;
  }

  // â˜…åˆæœŸè¡¨ç¤ºã¯æœ€å¤§5ä»¶ã ã‘ï¼ˆãã‚Œä»¥ä¸Šã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¦‹ãˆã‚‹ï¼‰
  // â€»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã€Œç¶šãã€ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€å®Ÿã¯â€œå…¨éƒ¨æç”»â€ã—ã¦OKã€‚
  //   ãŸã ã—è¦æœ›ãŒã€Œæœ€å¤§5å€‹ã¾ã§è¡¨ç¤ºã€ãªã®ã§ã€åˆæœŸè¡¨ç¤ºã¯5ä»¶ã ã‘ã«ã—ã¦ã€
  //   ä¸‹ã«ã€Œã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆå…¨è¡¨ç¤ºï¼‰ã€ã‚’ç½®ãæ–¹å¼ã«ã—ã¾ã™ã€‚
  const showing = arr.slice(0, Math.max(0, limitView));

  for(const r of showing){
    const box = document.createElement("div");
    box.className = "review";
    const stars = "â˜…".repeat(Math.max(0, Math.min(5, Number(r.stars||0))))
                + "â˜†".repeat(Math.max(0, 5-Number(r.stars||0)));
    box.innerHTML = `
      <div class="reviewTop">
        <div class="reviewName">${escapeHtml(r.displayName||"ãƒ¦ãƒ¼ã‚¶ãƒ¼")}</div>
        <div class="reviewMeta">${stars}</div>
      </div>
      <div class="reviewText">${escapeHtml(r.comment||"")}</div>
    `;
    reviewList.appendChild(box);
  }

  // 5ä»¶ã‚ˆã‚Šå¤šã„å ´åˆã¯ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆæŠ¼ã—ãŸã‚‰å…¨ä»¶æç”»ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
  if(arr.length > limitView){
    const more = document.createElement("button");
    more.className = "btn";
    more.style.width = "100%";
    more.textContent = `ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ®‹ã‚Š ${arr.length - limitView}ï¼‰`;
    more.addEventListener("click", ()=>{
      reviewList.innerHTML = "";
      for(const r of arr){
        const box = document.createElement("div");
        box.className = "review";
        const stars = "â˜…".repeat(Math.max(0, Math.min(5, Number(r.stars||0))))
                    + "â˜†".repeat(Math.max(0, 5-Number(r.stars||0)));
        box.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(r.displayName||"ãƒ¦ãƒ¼ã‚¶ãƒ¼")}</div>
            <div class="reviewMeta">${stars}</div>
          </div>
          <div class="reviewText">${escapeHtml(r.comment||"")}</div>
        `;
        reviewList.appendChild(box);
      }
    });
    reviewList.appendChild(more);
  }
}

    async function recomputeRatingAgg(habitId){
      const rs = await getDocs(query(collection(db, "habits", habitId, "ratings"), limit(500)));
      let sum = 0;
      let cnt = 0;
      rs.forEach(s=>{
        const r = s.data();
        const stars = Number(r.stars||0);
        if(stars>=1 && stars<=5){
          sum += stars;
          cnt += 1;
        }
      });
      const avg = cnt ? (sum/cnt) : 0;

      await updateDoc(doc(db, "habits", habitId), {
        avgRating: Number.isFinite(avg) ? avg : 0,
        ratingCount: cnt,
        updatedAt: serverTimestamp()
      });
    }

async function openRatingsViewer(habitId){
  ratingTitle.textContent = "å£ã‚³ãƒŸï¼ˆä»–ã®äººï¼‰";
  ratingSave.onclick = null;

  setRatingUIMode("viewer");
  ratingBg.classList.add("show");

  await loadRatingsList(habitId, { onlyOthers:true, sort:"stars", limitView:5 });
}

    // ===== Creator modal =====
    function openCreatorModal(uid, name, photo, color){
      creatorName.textContent = name || "â€”";
      creatorAva.innerHTML = "";
      if(photo){
        const img = document.createElement("img");
        img.src = photo;
        creatorAva.appendChild(img);
      }else{
        creatorAva.textContent = "â–¡";
        creatorAva.style.background = color || "#111111";
        creatorAva.style.color = "#fff";
      }
      creatorPosts.innerHTML = "";
      creatorBg.classList.add("show");
      loadCreatorPosts(uid);
    }
    function closeCreatorModal(){ creatorBg.classList.remove("show"); }
    creatorClose.addEventListener("click", closeCreatorModal);
    creatorBg.addEventListener("click", (e)=>{ if(e.target===creatorBg) closeCreatorModal(); });

    async function loadCreatorPosts(uid){
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(300)));
      const arr = [];
      qs.forEach(s=>{
        const h = s.data();
        if(h.creatorUid === uid) arr.push({ id:s.id, ...h });
      });

      if(arr.length===0){
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = `<div class="reviewText">æŠ•ç¨¿ãªã—</div>`;
        creatorPosts.appendChild(box);
        return;
      }

      for(const h of arr){
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(h.title||"")}</div>
            <div class="reviewMeta">${escapeHtml(String(h.createdAtYMD||""))}</div>
          </div>
          <div class="reviewText">${escapeHtml(h.action||"")}</div>
        `;
        creatorPosts.appendChild(box);
      }
    }

    // ===== Char list modal =====
    function openCharModal(){
      const lv = Number(myProfile?.level||1);
      charList.innerHTML = "";

      const maxLv = Math.max(10, lv+2);
      for(let L=1; L<=maxLv; L++){
        const eggs = CHAR_TIERS.filter(x=>x.type==="egg" && x.minLv<=L);
        const seeds = CHAR_TIERS.filter(x=>x.type==="seed" && x.minLv<=L);
        const eggShow = eggs.length ? eggs[eggs.length-1] : null;
        const seedShow = seeds.length ? seeds[seeds.length-1] : null;

        const row = document.createElement("div");
        row.className = "review";
        row.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">Lv ${L}</div>
            <div class="reviewMeta">${L===lv ? "ç¾åœ¨" : ""}</div>
          </div>
          <div class="reviewText">
            åµï¼š${eggShow ? `${eggShow.emoji} ${eggShow.name}` : "â€”"}
            \nç¨®ï¼š${seedShow ? `${seedShow.emoji} ${seedShow.name}` : "â€”"}
            \næ¬¡ã®Lvï¼š${L+1}
          </div>
        `;
        charList.appendChild(row);
      }

      charBg.classList.add("show");
    }
    function closeCharModal(){ charBg.classList.remove("show"); }
    openCharList.addEventListener("click", openCharModal);
    charClose.addEventListener("click", closeCharModal);
    charBg.addEventListener("click", (e)=>{ if(e.target===charBg) closeCharModal(); });

    // ===== Training view =====
    function growthStageInfo(pct){
      const p = Math.max(0, Math.min(100, Math.floor(pct||0)));
      for(const s of GROW_STAGES){
        if(p <= s.max) return s;
      }
      return GROW_STAGES[GROW_STAGES.length-1];
    }

    async function refreshTrain(){
      if(!currentUser) return;
      trainChallenges = await loadActiveChallenges();
      if(trainChallenges.length===0){
        trainHint.textContent = "æŒ‘æˆ¦ä¸­ãªã—";
        trainSlot.textContent = "â€”";
        trainHabitTitle.textContent = "â€”";
        trainPctText.textContent = "0%";
        trainPct.textContent = "0%";
        trainFill.style.width = "0%";
        trainEmoji.textContent = "ğŸ¥š";
        trainStage.textContent = "â€”";
        trainCare.textContent = `æ¬¡ã®ãŠä¸–è©±ã¾ã§ ${fmtCountdown(msToMidnight())}`;
        btnSetAvatar.disabled = true;
        return;
      }

      trainHint.textContent = `æŒ‘æˆ¦ä¸­ ${trainChallenges.length} / 3`;
      trainIndex = Math.max(0, Math.min(trainIndex, trainChallenges.length-1));
      renderTrainCurrent();
    }

    function renderTrainCurrent(){
      const ch = trainChallenges[trainIndex];
      const slot = `${trainIndex+1} / ${trainChallenges.length}`;

      const pct = growthPctDynamic(ch);
      const info = growthStageInfo(pct);

      const td = Number(ch.targetDays||3);
const day = Math.max(1, Math.min(td, Number(ch.day||1)));
      trainSlot.textContent = slot;
     trainHabitTitle.textContent = `${ch.habitTitle || "â€”"}ï¼ˆ${day}/${td}ï¼‰`;
      trainPctText.textContent = `${pct.toFixed(0)}%`;
      trainPct.textContent = `${pct.toFixed(0)}%`;
      trainFill.style.width = `${pct}%`;
      trainStage.textContent = info.label;
      trainCare.textContent = `æ¬¡ã®ãŠä¸–è©±ã¾ã§ ${fmtCountdown(msToMidnight())}`;

      // ä»®ã‚¤ãƒ©ã‚¹ãƒˆï¼šæ®µéšã”ã¨ã«çµµæ–‡å­—å¤‰åŒ–
      const base = mascotEmojiFromHabitId(ch.habitId);
      trainEmoji.textContent = pct>=100 ? "ğŸ‘‘" : (pct<15 ? base : info.emoji);

      const canSet = (String(ch.status||"")==="cleared") || (pct>=100);
      btnSetAvatar.disabled = !canSet;

      btnSetAvatar.onclick = async ()=>{
        if(!canSet) return;
        await updateDoc(doc(db,"users",currentUser.uid), {
          avatarSetFrom:"creature",
          avatarCreature: String(trainEmoji.textContent||""),
          updatedAt: serverTimestamp()
        });
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆå°†æ¥ã“ã®å­ã®ç”»åƒã‚’ã‚¢ã‚¤ã‚³ãƒ³ã«ã§ãã¾ã™ï¼‰");
      };
    }

    trainPrev.addEventListener("click", ()=>{
      if(trainChallenges.length===0) return;
      trainIndex = (trainIndex - 1 + trainChallenges.length) % trainChallenges.length;
      renderTrainCurrent();
    });
    trainNext.addEventListener("click", ()=>{
      if(trainChallenges.length===0) return;
      trainIndex = (trainIndex + 1) % trainChallenges.length;
      renderTrainCurrent();
    });

    // ===== Init + timers =====
    setInterval(()=>{
      if(!currentUser) return;
      refreshDailyDoneCount();
      refreshHome(); // 1æ™‚é–“ãŠãåµå¤‰åŒ–ã«ã‚‚è¿½å¾“
    }, 3600000);

    showOnly("home");
    updatePostCounter();
    openPost.classList.add("show");






    let calCursor = new Date(); // è¡¨ç¤ºä¸­ã®æœˆ
let calChallengesCache = [];

function jpDowLabel(i){ return ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][i]; }

function renderCalendarGrid(year, month0, dailyEmojis){
  calGrid.innerHTML = "";

  // æ›œæ—¥ãƒ˜ãƒƒãƒ€
  for(let i=0;i<7;i++){
    const h = document.createElement("div");
    h.style.textAlign="center";
    h.style.fontWeight="1100";
    h.style.color="var(--muted)";
    h.style.padding="6px 0";
    h.textContent = jpDowLabel(i);
    calGrid.appendChild(h);
  }

  const first = new Date(year, month0, 1);
  const last  = new Date(year, month0+1, 0);
  const startPad = first.getDay();
  const days = last.getDate();

  // ç©ºç™½
  for(let i=0;i<startPad;i++){
    const d = document.createElement("div");
    d.style.border="1px solid var(--line)";
    d.style.borderRadius="10px";
    d.style.height="56px";
    d.style.opacity="0.35";
    calGrid.appendChild(d);
  }

  const todayYMD = fmtYMD(nowLocal());

  for(let day=1; day<=days; day++){
    const dt = new Date(year, month0, day);
    const ymd = fmtYMD(dt);
    const cell = document.createElement("div");
    cell.style.border="1px solid var(--line)";
    cell.style.borderRadius="12px";
    cell.style.height="56px";
    cell.style.display="flex";
    cell.style.flexDirection="column";
    cell.style.justifyContent="space-between";
    cell.style.padding="6px 8px";
    cell.style.background = (ymd===todayYMD) ? "#f6f6f6" : "#fff";

    const top = document.createElement("div");
    top.style.display="flex";
    top.style.justifyContent="space-between";
    top.style.alignItems="center";

    const num = document.createElement("div");
    num.style.fontFamily="var(--mono)";
    num.style.fontWeight="1100";
    num.style.fontSize="12px";
    num.textContent = String(day);

    const em = document.createElement("div");
    em.style.fontSize="18px";
    em.textContent = (dailyEmojis && dailyEmojis[ymd]) ? dailyEmojis[ymd] : "";

    top.appendChild(num);
    top.appendChild(em);

    const bot = document.createElement("div");
    bot.style.fontSize="10px";
    bot.style.color="var(--muted2)";
    bot.textContent = "";

    cell.appendChild(top);
    cell.appendChild(bot);
    calGrid.appendChild(cell);
  }
}

async function refreshCalendar(){
  if(!currentUser) return;

  calChallengesCache = await loadChallenges(200);
  const activeOrAny = calChallengesCache.filter(x=> ["active","cleared","finished","retired"].includes(String(x.status||"")));

  calChallengeSel.innerHTML = "";
  for(const ch of activeOrAny){
    const opt = document.createElement("option");
    opt.value = ch.habitId;
    opt.textContent = `${ch.habitTitle || "â€”"}ï¼ˆ${String(ch.status||"")}ï¼‰`;
    calChallengeSel.appendChild(opt);
  }
  if(activeOrAny.length===0){
    calTitle.textContent = "è‚²æˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
    calGrid.innerHTML = "";
    return;
  }

  // æ—¢å®šï¼šä¸€ç•ªæ–°ã—ã„
  if(!calChallengeSel.value) calChallengeSel.value = activeOrAny[0].habitId;

  const year = calCursor.getFullYear();
  const month0 = calCursor.getMonth();
  calTitle.textContent = `${year}å¹´ ${month0+1}æœˆ`;

  const chosen = activeOrAny.find(x=>x.habitId===calChallengeSel.value) || activeOrAny[0];
  renderCalendarGrid(year, month0, chosen.dailyEmojis || {});
}

calPrev.addEventListener("click", ()=>{ calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()-1, 1); refreshCalendar(); });
calNext.addEventListener("click", ()=>{ calCursor = new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1); refreshCalendar(); });
calChallengeSel.addEventListener("change", refreshCalendar);




















    function drawBarChart(canvas, labels, values){
  const ctx = canvas.getContext("2d");
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = canvas.getAttribute("height") * devicePixelRatio;
  ctx.clearRect(0,0,W,H);

  const padL = 36*devicePixelRatio, padR = 12*devicePixelRatio, padT = 10*devicePixelRatio, padB = 34*devicePixelRatio;
  const maxV = Math.max(1, ...values);
  const n = labels.length;
  const areaW = W - padL - padR;
  const areaH = H - padT - padB;

  // axis
  ctx.globalAlpha = 0.25;
  ctx.strokeStyle = "#111";
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, padT+areaH);
  ctx.lineTo(padL+areaW, padT+areaH);
  ctx.stroke();
  ctx.globalAlpha = 1;

  const bw = areaW / Math.max(1,n) * 0.7;
  for(let i=0;i<n;i++){
    const v = values[i];
    const x = padL + (areaW/n)*i + (areaW/n - bw)/2;
    const h = (v/maxV) * areaH;
    const y = padT + areaH - h;

    ctx.fillStyle = "#111";
    ctx.globalAlpha = 0.12;
    ctx.fillRect(x, y, bw, h);
    ctx.globalAlpha = 1;

    // value
    ctx.fillStyle = "#111";
    ctx.font = `${11*devicePixelRatio}px sans-serif`;
    ctx.fillText(`${Math.round(v)}%`, x, y-6*devicePixelRatio);

    // label
    ctx.globalAlpha = 0.7;
    ctx.font = `${10*devicePixelRatio}px sans-serif`;
    ctx.fillText(labels[i], x, padT+areaH+18*devicePixelRatio);
    ctx.globalAlpha = 1;
  }
}

function drawLineMulti(canvas, series){
  const ctx = canvas.getContext("2d");
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = canvas.getAttribute("height") * devicePixelRatio;
  ctx.clearRect(0,0,W,H);

  const padL = 46*devicePixelRatio, padR = 12*devicePixelRatio, padT = 12*devicePixelRatio, padB = 30*devicePixelRatio;

  // collect x labels
  const labels = series[0]?.labels || [];
  const n = labels.length;
  const areaW = W - padL - padR;
  const areaH = H - padT - padB;

  // y range fixed 0-100
  const yTo = (v)=> padT + areaH - (Math.max(0,Math.min(100,v))/100)*areaH;

  // grid
  ctx.globalAlpha = 0.12;
  ctx.strokeStyle = "#111";
  for(let t=0;t<=4;t++){
    const y = yTo(t*25);
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+areaW,y); ctx.stroke();
  }
  ctx.globalAlpha = 1;

  // axes labels
  ctx.fillStyle="#111";
  ctx.globalAlpha=0.6;
  ctx.font = `${10*devicePixelRatio}px sans-serif`;
  for(let t=0;t<=4;t++){
    const v=t*25;
    ctx.fillText(String(v), 10*devicePixelRatio, yTo(v)+4*devicePixelRatio);
  }
  ctx.globalAlpha=1;

  // x labels
  ctx.globalAlpha=0.6;
  for(let i=0;i<n;i++){
    const x = padL + (areaW/(Math.max(1,n-1)))*i;
    ctx.fillText(labels[i], x-6*devicePixelRatio, padT+areaH+18*devicePixelRatio);
  }
  ctx.globalAlpha=1;

  // lines (auto color by hue)
  series.forEach((s, idx)=>{
    const hue = (idx*80) % 360;
    ctx.strokeStyle = `hsl(${hue} 80% 35%)`;
    ctx.lineWidth = 2*devicePixelRatio;
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const x = padL + (areaW/(Math.max(1,n-1)))*i;
      const y = yTo(s.values[i] ?? 0);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // legend
    ctx.fillStyle = `hsl(${hue} 80% 35%)`;
    ctx.font = `${11*devicePixelRatio}px sans-serif`;
    ctx.fillText(s.name, padL + idx*140*devicePixelRatio, padT - 2*devicePixelRatio);
  });
}

function pct(n,d){ return d? (n/d*100) : 0; }

async function refreshAnalytics(){
  if(!currentUser) return;

  const challenges = await loadChallenges(250);
  const habitsSnap = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(400)));
  const habits = [];
  habitsSnap.forEach(s=> habits.push({ id:s.id, ...s.data() }));
  const habitById = new Map(habits.map(h=>[h.id,h]));

  const active = challenges.filter(x=>x.status==="active");
  const done = challenges.filter(x=>x.status==="cleared" || x.status==="finished");
  const retired = challenges.filter(x=>x.status==="retired");

  anaHint.textContent = `æŒ‘æˆ¦ä¸­ ${active.length} / å®Œäº† ${done.length} / ãƒªã‚¿ã‚¤ã‚¢ ${retired.length}`;

  // ä¸Šï¼š3ã‚«ãƒ¼ãƒ‰ï¼ˆæœ€è¿‘3ä»¶ã ã‘ï¼‰
  function statusCard(title, items, kind){
    const box = document.createElement("div");
    box.className="review";
    box.style.margin="0";
    const short = items.slice(0,3);
    box.innerHTML = `
      <div class="reviewTop">
        <div class="reviewName">${escapeHtml(title)}</div>
        <div class="reviewMeta">${kind}</div>
      </div>
      <div class="reviewText" style="margin-top:10px">${short.map(ch=>{
        const t = ch.habitTitle || "â€”";
        const td = Number(ch.targetDays||3);
        return `â€¢ ${escapeHtml(t)}  <span style="font-family:var(--mono);opacity:.7">(${td}æ—¥)</span>`;
      }).join("\n") || "â€”"}</div>
      <div style="display:flex; justify-content:flex-end; margin-top:8px">
        <button class="btnMini" data-more="1" style="font-size:11px; opacity:.8">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    `;
    box.querySelector("[data-more]").addEventListener("click", ()=>{
      alert(items.map(ch=>`${ch.habitTitle||"â€”"}ï¼ˆ${ch.status} / ${Number(ch.targetDays||3)}æ—¥ï¼‰`).join("\n") || "â€”");
    });
    return box;
  }

  anaStatusGrid.innerHTML="";
  anaStatusGrid.appendChild(statusCard("è‚²æˆä¸­", active, "ACTIVE"));
  anaStatusGrid.appendChild(statusCard("è‚²æˆå®Œäº†", done, "DONE"));
  anaStatusGrid.appendChild(statusCard("ãƒªã‚¿ã‚¤ã‚¢", retired, "RETIRED"));

  // é›†è¨ˆï¼šã‚«ãƒ†ã‚´ãƒª/ä½œæˆè€…/ã‚¿ã‚° ãã‚Œãã‚ŒæˆåŠŸç‡ï¼ˆè‡ªåˆ†ã®æŒ‘æˆ¦çµæœãƒ™ãƒ¼ã‚¹ï¼‰
  const catMap = new Map();
  const creatorMap = new Map();
  const tagMap = new Map();

  for(const ch of challenges){
    const h = habitById.get(ch.habitId);
    const cat = (h?.category || "ãã®ä»–").trim() || "ãã®ä»–";
    const creator = (h?.creatorName || "ä½œæˆè€…").trim() || "ä½œæˆè€…";
    const tags = (h?.tags || []).map(x=>String(x||"").trim()).filter(Boolean);

    const isSuccess = (ch.status==="cleared");
    const isEnd = (ch.status==="cleared" || ch.status==="finished" || ch.status==="retired");
    if(!isEnd) continue;

    const c = catMap.get(cat) || { end:0, ok:0 };
    c.end++; if(isSuccess) c.ok++;
    catMap.set(cat,c);

    const cr = creatorMap.get(creator) || { end:0, ok:0 };
    cr.end++; if(isSuccess) cr.ok++;
    creatorMap.set(creator,cr);

    for(const t of tags){
      const tg = tagMap.get(t) || { end:0, ok:0 };
      tg.end++; if(isSuccess) tg.ok++;
      tagMap.set(t,tg);
    }
  }

  // æ£’ï¼šã‚«ãƒ†ã‚´ãƒªä¸Šä½
  const catArr = [...catMap.entries()]
    .map(([k,v])=>({k, r: pct(v.ok,v.end), end:v.end}))
    .sort((a,b)=> (b.end-a.end) || (b.r-a.r))
    .slice(0,6);
  drawBarChart(anaBar, catArr.map(x=>x.k), catArr.map(x=>Math.round(x.r)));

  // æŠ˜ã‚Œç·šï¼šã‚«ãƒ†ã‚´ãƒª/ä½œæˆè€…/ã‚¿ã‚° ä¸Šä½ã‚’åŒæ™‚æ¯”è¼ƒ
  const topCats = catArr.slice(0,3).map(x=>x.k);

  const topCreators = [...creatorMap.entries()]
    .map(([k,v])=>({k, r:pct(v.ok,v.end), end:v.end}))
    .sort((a,b)=> (b.r-a.r) || (b.end-a.end))
    .slice(0,2).map(x=>x.k);

  const topTags = [...tagMap.entries()]
    .map(([k,v])=>({k, r:pct(v.ok,v.end), end:v.end}))
    .sort((a,b)=> (b.end-a.end) || (b.r-a.r))
    .slice(0,2).map(x=>x.k);

  // xè»¸ã¯ã€ŒæˆåŠŸç‡ã®æ¯”è¼ƒé …ç›®ã€
  const labels = ["A","B","C","D","E","F"];
  const s1 = {
    name:"ã‚«ãƒ†ã‚´ãƒª",
    labels,
    values: topCats.concat(["â€”","â€”","â€”"]).slice(0,6).map(k=>{
      if(k==="â€”") return 0;
      const v = catMap.get(k); return Math.round(pct(v.ok,v.end));
    })
  };
  const s2 = {
    name:"ä½œæˆè€…",
    labels,
    values: topCreators.concat(["â€”","â€”","â€”","â€”"]).slice(0,6).map(k=>{
      if(k==="â€”") return 0;
      const v = creatorMap.get(k); return Math.round(pct(v.ok,v.end));
    })
  };
  const s3 = {
    name:"æ‚©ã¿ã‚¿ã‚°",
    labels,
    values: topTags.concat(["â€”","â€”","â€”","â€”"]).slice(0,6).map(k=>{
      if(k==="â€”") return 0;
      const v = tagMap.get(k); return Math.round(pct(v.ok,v.end));
    })
  };
  drawLineMulti(anaLines, [s1,s2,s3]);

  // ä¸‹ï¼šç™ºè¦‹ã‚«ãƒ¼ãƒ‰3ã¤ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°/ç¶šã‘ã‚„ã™ã„/å¤±æ•—ã—ã‚„ã™ã„ï¼‰
  const bestCreators = [...creatorMap.entries()]
    .map(([k,v])=>({k, r:pct(v.ok,v.end), end:v.end}))
    .filter(x=>x.end>=2)
    .sort((a,b)=> b.r-a.r)
    .slice(0,5);

  const worstCats = [...catMap.entries()]
    .map(([k,v])=>({k, r:pct(v.ok,v.end), end:v.end}))
    .filter(x=>x.end>=2)
    .sort((a,b)=> a.r-b.r)
    .slice(0,5);

  const keepers = challenges
    .filter(x=>x.status==="active")
    .sort((a,b)=> Number(b.day||1)-Number(a.day||1))
    .slice(0,5);

  function insightCard(title, lines){
    const box = document.createElement("div");
    box.className="review";
    box.style.margin="0";
    box.innerHTML = `
      <div class="reviewTop">
        <div class="reviewName">${escapeHtml(title)}</div>
        <div class="reviewMeta">ç™ºè¦‹</div>
      </div>
      <div class="reviewText" style="margin-top:10px">${escapeHtml(lines.join("\n") || "â€”")}</div>
    `;
    return box;
  }

  anaInsights.innerHTML="";
  anaInsights.appendChild(insightCard("æˆåŠŸç‡ãŒé«˜ã‚ã®ä½œæˆè€…TOP", bestCreators.map(x=>`â€¢ ${x.k}ï¼š${Math.round(x.r)}%ï¼ˆn=${x.end}ï¼‰`)));
  anaInsights.appendChild(insightCard("æ¯”è¼ƒçš„ã«ç¶šã‘ã¦ã„ã‚‹ãŠæ°—ã«å…¥ã‚Šè‚²æˆTOP", keepers.map(x=>`â€¢ ${x.habitTitle||"â€”"}ï¼š${Number(x.day||1)}æ—¥ç›® / ${Number(x.targetDays||3)}æ—¥`)));
  anaInsights.appendChild(insightCard("å¤±æ•—ã—ã‚„ã™ã„ã‚«ãƒ†ã‚´ãƒªï¼ˆè¦æ³¨æ„ï¼‰", worstCats.map(x=>`â€¢ ${x.k}ï¼š${Math.round(x.r)}%ï¼ˆn=${x.end}ï¼‰`)));
}






    // ===== Quick Deck storage =====
const DECK_KEY = "growme_quick_slots_v1";
// è¡¨ç¤ºã¯ [å·¦, ä¸­, å³] ã ãŒã€åŸ‹ã‚ã‚‹é †ç•ªã¯ã€ŒçœŸã‚“ä¸­ â†’ å³ â†’ å·¦ã€
const DISPLAY_SLOTS = ["L","M","R"];
const FILL_ORDER = ["M","R","L"];

function loadDeckSlots(){
  try{
    const raw = JSON.parse(localStorage.getItem(DECK_KEY) || "{}");
    return {
      L: typeof raw.L === "string" ? raw.L : "",
      M: typeof raw.M === "string" ? raw.M : "",
      R: typeof raw.R === "string" ? raw.R : "",
    };
  }catch{
    return { L:"", M:"", R:"" };
  }
}
function saveDeckSlots(slots){
  localStorage.setItem(DECK_KEY, JSON.stringify({
    L: slots.L || "",
    M: slots.M || "",
    R: slots.R || "",
  }));
}

// actives ã¨ localStorage ã‚’çªãåˆã‚ã›ã¦æ•´åˆã‚’å–ã‚‹
function reconcileDeckSlotsWithActives(actives){
  const activeIds = new Set((actives||[]).map(x=>x.habitId));

  let slots = loadDeckSlots();

  // ã™ã§ã«å…¥ã£ã¦ã‚‹ãŒã€activeã§ãªããªã£ãŸã‚‰ç©ºã«ã™ã‚‹ï¼ˆãƒªã‚¿ã‚¤ã‚¢/çµ‚äº†ï¼‰
  for(const k of DISPLAY_SLOTS){
    if(slots[k] && !activeIds.has(slots[k])) slots[k] = "";
  }

  // ã¾ã å…¥ã£ã¦ãªã„ active ã‚’ã€ç©ºãã« fill order ã§å…¥ã‚Œã‚‹
  const already = new Set(DISPLAY_SLOTS.map(k=>slots[k]).filter(Boolean));
  const candidates = (actives||[]).map(x=>x.habitId).filter(id=>!already.has(id));

  let idx = 0;
  for(const k of FILL_ORDER){
    if(!slots[k] && idx < candidates.length){
      slots[k] = candidates[idx++];
    }
  }

  saveDeckSlots(slots);
  return slots;
}

function starsText(avg){
  const v = Math.max(0, Math.min(5, Math.round(Number(avg||0))));
  return "â˜…".repeat(v) + "â˜†".repeat(5 - v);
}

function getChallengeByHabitId(habitId){
  return (__activeChallengesCache||[]).find(x=>x.habitId === habitId) || null;
}

// â€œã‚­ãƒ£ãƒ©ç”»åƒâ€ã¯ä»Šã¯çµµæ–‡å­—ã§ä»£ç”¨ï¼ˆã‚ãªãŸã®è‚²æˆæ®µéšã¨é€£å‹•ï¼‰
function deckCreatureEmoji(habitId){
  const ch = getChallengeByHabitId(habitId);
  if(!ch) return mascotEmojiFromHabitId(habitId);
  const pct = growthPctDynamic(ch);
  const info = growthStageInfo(pct);
  return (pct>=100) ? "ğŸ‘‘" : (pct<15 ? mascotEmojiFromHabitId(habitId) : info.emoji);
}

function setDeckFocus(on){
  quickDeck.classList.toggle("is-focus", !!on);
}

// Homeã ã‘è¡¨ç¤ºã—ãŸã„ã®ã§ showOnly() ã‹ã‚‰å‘¼ã¶
function updateDeckVisibility(){
  const isHome = (viewHome.style.display !== "none");
  quickDeck.classList.toggle("show", isHome);
}

// ãƒ‡ãƒƒã‚­å†æç”»
function renderQuickDeck(){
  if(!quickDeckInner) return;

  // activeï¼ˆæŒ‘æˆ¦ä¸­ï¼‰ã‚’åŸºæº–ã« slots ã‚’ç¢ºå®š
  const slots = reconcileDeckSlotsWithActives(__activeChallengesCache);

  quickDeckInner.innerHTML = "";

  for(const slotKey of DISPLAY_SLOTS){
    const habitId = slots[slotKey];
    const h = habitId ? __habitsMapForDeck.get(habitId) : null;

    const card = document.createElement("div");
    card.className = "qCard" + (habitId ? " hasItem" : "");

    // ----- ä¸­èº« -----
    if(!habitId){
      // ç©ºï¼ˆï¼‹ï¼‰
      card.innerHTML = `
        <button class="qPlusBtn" data-act="plus" data-slot="${slotKey}" aria-label="è¿½åŠ ">
          <div class="qPlus">ï¼‹</div>
        </button>
      `;
    }else{
      const title = (h?.title || getChallengeByHabitId(habitId)?.habitTitle || "â€”").trim();
      const action = (h?.action || "").trim();
      const avgRating = Number(h?.avgRating || 0);

      card.innerHTML = `
        <div class="qMain">
          <div class="qTitle">${escapeHtml(title)}</div>
          <div class="qAction">${escapeHtml(action)}</div>
        </div>

        <div class="qStars">${escapeHtml(starsText(avgRating))}</div>
        <div class="qChar">${escapeHtml(deckCreatureEmoji(habitId))}</div>

        <!-- ä¸­å¤®ã‚‰ã¸ã‚“ã ã‘å½“ãŸã‚Šåˆ¤å®šï¼ˆèª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ã®ãŸã‚å°ã•ã‚ï¼‰ -->
        <button class="qFocusZone" data-act="focus" data-slot="${slotKey}" aria-label="æ“ä½œ"></button>

        <button class="qCloseBtn" data-act="close" data-slot="${slotKey}" aria-label="ãƒªã‚¿ã‚¤ã‚¢">âœ•</button>
      `;
    }

    quickDeckInner.appendChild(card);

    // ----- ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰æœ¬ä½“ã¯ pointer-events:none ãªã®ã§ã€ãƒœã‚¿ãƒ³ã ã‘åå¿œï¼‰ -----
    const plusBtn = card.querySelector('[data-act="plus"]');
    if(plusBtn){
      // hover/clickã§3æšã¨ã‚‚æ¿ƒãï¼ˆï¼‹ãŒæŠ¼ã›ã‚‹ï¼‰
      plusBtn.addEventListener("mouseenter", ()=> setDeckFocus(true));
      plusBtn.addEventListener("mouseleave", ()=>{
        if(!__deckFocusedByTouch) setDeckFocus(false);
      });
      plusBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        __deckFocusedByTouch = true; // ã‚¹ãƒãƒ›æƒ³å®šï¼šä¸€åº¦æŠ¼ã—ãŸã‚‰ä»–ã‚¿ãƒƒãƒ—ã¾ã§æ¿ƒã„
        setDeckFocus(true);
        // ã“ã“ã¯ â€œè¿½åŠ æ“ä½œâ€ ã®å…¥å£ã€‚ä»Šã¯èª¤å‹•ä½œé˜²æ­¢ã§ä½•ã‚‚ã—ãªã„ï¼ˆå¿…è¦ãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ã«ç¹‹ãï¼‰
        // ä¾‹ï¼šalert("ä¸€è¦§ã‹ã‚‰ã€Œå‚åŠ ã€ã‚’æŠ¼ã™ã¨ã“ã“ã«å…¥ã‚Šã¾ã™");
      });
    }

    const focusZone = card.querySelector('[data-act="focus"]');
    if(focusZone){
      // PCï¼šhoverä¸­ã«Ã—ãŒå‡ºã‚‹ï¼ˆCSSã§åˆ¶å¾¡ï¼‰ + æ¿ƒã•UP
      focusZone.addEventListener("mouseenter", ()=> setDeckFocus(true));
      focusZone.addEventListener("mouseleave", ()=>{
        if(!__deckFocusedByTouch) setDeckFocus(false);
      });

      // ã‚¹ãƒãƒ›ï¼šã‚¿ãƒƒãƒ—ã§ â€œé¸æŠçŠ¶æ…‹â€ ã‚’ç¶­æŒ â†’ Ã— ã‚’å‡ºã™
      focusZone.addEventListener("click", (e)=>{
        e.stopPropagation();
        __deckFocusedByTouch = true;
        setDeckFocus(true);

        // picked ã‚’ä»˜ã‘æ›¿ãˆ
        [...quickDeckInner.children].forEach(el=> el.classList.remove("is-picked"));
        card.classList.add("is-picked");
        __pickedSlotKey = slotKey;
      });
    }

    const closeBtn = card.querySelector('[data-act="close"]');
    if(closeBtn){
      closeBtn.addEventListener("click", async (e)=>{
        e.stopPropagation();

        // localStorageä¸Šã¯å³ç©ºã«ã™ã‚‹ï¼ˆFirestoreå¤±æ•—ã—ã¦ã‚‚UIã¯æˆ»ã‚‹ï¼‰
        let slotsNow = loadDeckSlots();
        const hid = slotsNow[slotKey];
        slotsNow[slotKey] = "";
        saveDeckSlots(slotsNow);

        // ã‚‚ã—æŒ‘æˆ¦ä¸­ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œã¦ã„ã‚Œã°ã€æ—¢å­˜ã®ãƒªã‚¿ã‚¤ã‚¢å‡¦ç†ã‚‚å‘¼ã¶ï¼ˆâ€»æ–°æ©Ÿèƒ½ã¨ã—ã¦Firestoreã¯æ›¸ã‹ãªã„ãŒã€æ—¢å­˜æ©Ÿèƒ½ã®é€€é¿ï¼‰
        try{
          const ch = getChallengeByHabitId(hid);
          if(ch && typeof applyReport === "function"){
            // confirmã¯è¦ä»¶ã«æ›¸ã„ã¦ãªã„ã®ã§çœç•¥ï¼ˆå¿…è¦ãªã‚‰æˆ»ã™ï¼‰
            await applyReport(ch, { type:"retire" });
          }else{
            renderQuickDeck(); // Firestoreç„¡ã—ã§ã‚‚UIå¾©å¸°
          }
        }catch{
          renderQuickDeck();
        }

        // é¸æŠè§£é™¤
        card.classList.remove("is-picked");
        __pickedSlotKey = "";
      });
    }
  }
}

// â€œå¤–ã‚’æŠ¼ã—ãŸã‚‰æˆ»ã‚‹â€ï¼ˆã‚¹ãƒãƒ›æƒ³å®šï¼‰
document.addEventListener("click", (e)=>{
  if(!quickDeck.classList.contains("show")) return;
  if(e.target.closest("#quickDeck")) return;

  __deckFocusedByTouch = false;
  setDeckFocus(false);
  __pickedSlotKey = "";
  if(quickDeckInner){
    [...quickDeckInner.children].forEach(el=> el.classList.remove("is-picked"));
  }
});
    
  </script>
</body>
</html>
