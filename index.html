<!-- =========================
  PART 1 / 3
  ã“ã“ã‹ã‚‰ Part1 ã‚’è²¼ã‚‹
  ï¼ˆPart2, Part3 ã‚’å¾Œã‚ã«é€£çµã™ã‚‹ã¨å®Œæˆï¼‰
========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¿’æ…£ã•ãŒã—</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --line:#e6e6e6;
      --text:#111111;
      --muted:#7a7a7a;
      --muted2:#9a9a9a;

      --red:#e00000;

      --r:14px;
      --gap:10px;
      --shadow: 0 4px 14px rgba(0,0,0,.06);
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      --catTint: #ffffff;
      --catLine: #e6e6e6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ===== Layout ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 310px 1fr;
      background:#fff;
    }

    @media (max-width: 980px){
      body{overflow:auto}
      .app{grid-template-columns: 92px 1fr; height:auto; min-height:100%}
      .nav{padding:10px 8px}
      .nav .label{display:none}
      .nav .brandName{display:none}
      .nav .navBtn{justify-content:center}
      .content{padding:12px}
      .sideList{max-height: calc(100vh - 410px)}
      .sideItem{padding: 10px;border-radius: 12px;}
      .btnMini{font-size: 11px; padding: 9px 10px}
      .feedGrid{grid-template-columns: 1fr;} /* å¸¸ã«ç¸¦1åˆ— */
    }

    @media (max-width: 520px){
      .feedGrid{grid-template-columns: 1fr;}
    }

    /* ===== Left ===== */
    .nav{
      border-right:1px solid var(--line);
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:4px 6px 10px;
    }
    .logo{
      width:34px; height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      display:grid; place-items:center;
      font-weight:1000;
    }
    .brandName{
      font-size:14px;
      font-weight:1000;
      letter-spacing:.06em;
      white-space:nowrap;
    }

    .navBtn{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      transition:.12s transform, .12s background;
      user-select:none;
    }
    .navBtn:hover{transform: translateY(-1px); background:#fafafa}
    .navBtn.active{background:#f4f4f4}
    .navBtn .ico{width:26px; display:grid; place-items:center}
    .navBtn .label{font-weight:1000; letter-spacing:.03em}

    .sep{height:1px; background:var(--line); margin:6px 0}

    /* ===== User header + Lv ring ===== */
    .userBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      display:flex; gap:10px; align-items:center;
      background:#fff;
      min-width:0;
      box-shadow: var(--shadow);
    }

    .lvRingWrap{
      width:46px;height:46px;
      position:relative;
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .lvRingSvg{
      position:absolute;
      inset:0;
      transform: rotate(-90deg);
    }
    .lvRingSvg circle{
      fill:none;
      stroke-width:6;
      stroke-linecap:round;
    }
    .lvRingBg{
      stroke: #e9e9e9;
    }
    .lvRingFg{
      stroke: #10a85a;
      stroke-dasharray: 999;
      stroke-dashoffset: 999;
      transition: stroke-dashoffset .35s ease;
    }

    .avatar{
      width:34px; height:34px;
      border:1px solid var(--line);
      border-radius:50%;
      background:#fff;
      overflow:hidden;
      display:grid; place-items:center;
      font-weight:1000;
      user-select:none;
      z-index:2;
    }

    .lvNum{
      position:absolute;
      inset:auto;
      bottom:-6px;
      right:-6px;
      width:22px;
      height:22px;
      border-radius:999px;
      border:2px solid #fff;
      background:#111;
      color:#fff;
      font-family:var(--mono);
      font-size:11px;
      font-weight:1100;
      display:grid;
      place-items:center;
      z-index:3;
      user-select:none;
    }

    .xpPop{
      position:absolute;
      top:-18px;
      left:50%;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index:5;
      white-space:nowrap;
    }
    .xpPop.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .userMeta{min-width:0}
    .userNameRow{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .userName{
      font-weight:1000; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 150px;
    }
    .followerMini{
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      font-family:var(--mono);
      font-size:12px;
      font-weight:1100;
      color:#111;
      background:#fff;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .userSmall{font-size:11px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* XP block */
    .xpBlock{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .xpTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .hBadge{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-weight:1000;
      font-size:12px;
      font-family:var(--mono);
      background:#fff;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .tinyNum{
      font-family:var(--mono);
      font-size:11px;
      font-weight:1100;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      opacity:.95;
    }
    .tinyNum.green{border-color:#bfe8d1; background:#ecfff4}
    .tinyNum.blue{border-color:#cfe3ff; background:#f3f8ff}
    .tinyNum.gray{border-color:#e6e6e6; background:#fafafa}

    .xpText{
      font-family:var(--mono);
      font-size:12px;
      font-weight:1100;
      color:#111;
      white-space:nowrap;
    }
    .miniLinkBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      font-weight:1000;
      padding:8px 10px;
      cursor:pointer;
      opacity:.85;
    }
    .miniLinkBtn:hover{background:#fafafa; opacity:1}

    .sideTitle{
      font-weight:1000;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.06em;
      padding: 2px 4px 0;
    }
    .sideList{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      padding-right:2px;
      max-height: calc(100vh - 470px);
    }
    .sideItem{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .sideTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      min-width:0;
    }
    .sideHabit{
      font-weight:1100;
      font-size: clamp(11px, 1.6vw, 13px);
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-width:0;
      flex:1 1 auto;
    }
    .sideMeta{
      font-size: clamp(10px, 1.4vw, 11px);
      color:var(--muted);
      font-family:var(--mono);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .sideCare{
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 8px;
      font-family:var(--mono);
      font-weight:1100;
      font-size: clamp(10px, 1.4vw, 11px);
      color:#111;
      background:#fff;
      white-space:nowrap;
    }
    .sideBtns{
      display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btnMini{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:1100;
      user-select:none;
    }
    .btnMini:hover{background:#fafafa}
    .btnMini:disabled{opacity:.6; cursor:not-allowed}

    /* ===== Main ===== */
    .content{
      height:100%;
      overflow:auto;
      padding:14px;
      position:relative;
      background:#fff;
    }
    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background:#fff;
      box-shadow: var(--shadow);
    }

    .headerBar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px;
      border-bottom:1px solid var(--line);
    }
    .hTitle{
      font-weight:1100;
      letter-spacing:.06em;
      font-size:16px;
      display:flex; align-items:center; gap:10px;
      white-space:nowrap;
      flex-wrap:wrap;
    }

    /* å³å´ï¼šæœ¬æ—¥é”æˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®å³ï¼‰ */
    .todayBadge{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      background:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .todayBadge strong{
      font-size:13px;
      font-weight:1200;
    }

    /* ===== Tag ranking: æ¨ªä¸€åˆ—ï¼ˆ2åˆ†å‰²ï¼‰ ===== */
    .tagWrap{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .rankBox{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding:10px;
      box-shadow: var(--shadow);
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .rankTitle{
      font-size:13px;
      font-weight:1100;
      letter-spacing:.06em;
      color: #111;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0;
    }
    .rankGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
      align-items:stretch;
    }
    .rankChip{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:#fff;
      user-select:none;
      min-width:0;
    }
    .rankChip:hover{background:#fafafa}
    .rankChip.active{background:#f2f2f2}
    .rk{
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      flex:0 0 auto;
    }
    .tagName{
      font-weight:1100;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    /* ===== Search row ===== */
    .searchRow{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:8px;
      align-items:stretch;
      flex-wrap:nowrap;
    }
    @media (max-width: 980px){
      .searchRow{flex-wrap:wrap}
    }
    .searchBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:0 10px;
      background:#fff;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex: 1 1 auto;
      height:44px;
    }
    .searchInput{
      border:none;
      outline:none;
      font-size:14px;
      background:transparent;
      width:100%;
      min-width:0;
      height:100%;
    }
    .searchBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding:0 10px;
      cursor:pointer;
      font-weight:1100;
      white-space:nowrap;
      height:32px;
    }
    .searchBtn:hover{background:#fafafa}

    .ctrlBtn, .ctrlSel{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      height:44px;
      padding:0 10px;
      font-weight:1100;
      cursor:pointer;
      display:flex;
      align-items:center;
      white-space:nowrap;
    }
    .ctrlSel{padding:0 8px}
    .ctrlBtn:hover, .ctrlSel:hover{background:#fafafa}

    /* ===== Feed ===== */
    .feedArea{padding:12px}
    .feedHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px 0;
    }
    .feedHeadLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .feedLabel{
      font-weight:1100;
      letter-spacing:.06em;
      color: var(--muted);
      font-size:12px;
      margin:0;
    }
    .countSmall{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      color:#111;
    }

    /* ç¸¦ä¸€åˆ—å›ºå®š */
    .feedGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      align-items:stretch;
    }

    /* ===== Card ===== */
    .habitCard{
      border:1px solid var(--catLine);
      border-radius: 12px;
      background: linear-gradient(0deg, #fff 0%, #fff 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      min-width:0;
    }

    .thumb{
      aspect-ratio: 16 / 9;
      background: var(--catTint);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
      border-bottom:1px solid var(--catLine);
      user-select:none;
    }
    .thumbTitle{
      font-size:22px; /* èª­ã¿ã‚„ã™ã */
      font-weight:1100;
      letter-spacing:.02em;
      line-height:1.12;
      margin:0;
      text-align:center;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      z-index:2;
    }
    .thumbAction{
      position:absolute;
      right:10px;
      bottom:8px;
      font-size:12px;
      color: var(--muted2);
      z-index:2;
      max-width: 70%;
      text-align:right;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .mascotBg{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-size: 84px;
      opacity: .09;
      pointer-events:none;
      transform: translateY(8px);
      user-select:none;
      z-index:1;
    }

    .thumbActions{
      position:absolute;
      top:8px;
      right:8px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:3;
    }

    .tipBtn{position:relative}
    .tipBtn[data-tip]::after{
      content: attr(data-tip);
      position:absolute;
      bottom: calc(100% + 6px);
      left:50%;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
      font-weight:1100;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease;
      z-index:10;
    }
    .tipBtn:hover::after{opacity:1; transform: translateX(-50%) translateY(-2px)}

    .iconBtn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius: 10px;
      padding:8px 9px;
      cursor:pointer;
      display:grid;
      place-items:center;
      min-width:38px;
      user-select:none;
    }
    .iconBtn:hover{background:#fafafa}
    .iconBtn.on{background:#111; color:#fff; border-color:#111}
    .iconBtn svg{display:block}

    .reviewBtn{ position:relative; }
    .badgeCount{
      position:absolute;
      top:-6px;
      right:-6px;
      width:18px;
      height:18px;
      border-radius:999px;
      background: var(--red);
      color:#fff;
      font-family: var(--mono);
      font-size:11px;
      font-weight:1100;
      display:grid;
      place-items:center;
      border:2px solid #fff;
      pointer-events:none;
    }

    /* JOIN */
    .joinBtn{
      border:1px solid var(--red);
      background: var(--red);
      color:#fff;
      border-radius: 12px;
      padding:12px 16px;
      cursor:pointer;
      font-weight:1100;
      min-width: 84px;
      user-select:none;
      font-size:14px;
    }
    .joinBtn:hover{filter:brightness(1.03)}
    .joinBtn.activeMode{
      background:#fff;
      color:var(--red);
    }
    .joinBtn:disabled{opacity:.6; cursor:not-allowed}

    .metaBar{
      padding:10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      min-height: 78px;
      background:#fff;
      position:relative;
    }
    .creatorCol{
      display:flex;
      gap:10px;
      min-width:0;
    }
    .miniAva{
      width:28px; height:28px;
      border:1px solid var(--line);
      border-radius:50%;
      overflow:hidden;
      background:#fff;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      font-weight:1100;
      color:#111;
      cursor:pointer;
    }
    .miniAva img{width:100%; height:100%; object-fit:cover}
    .creatorText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .creatorName{
      font-size:12px;
      font-weight:1100;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 190px;
      cursor:pointer;
    }
    .followSmall{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding:6px 10px;
      font-weight:1100;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      width: fit-content;
    }
    .followSmall.on{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    /* 4ã¤ã®æ•°å€¤ã‚’ â€œã±ã£ã¨è¦‹â€ ã§ */
    .statsRow{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      min-width:0;
    }
    .statLine{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .statPill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;   /* ä½™ç™½è©°ã‚ã¤ã¤è¦‹ã‚„ã™ãå¤§ãã */
      background:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:13px;     /* å°‘ã—å¤§ãã„ */
      color:#111;
      white-space:nowrap;
      line-height:1;
    }

    .createdAt{
      position:absolute;
      right:10px;
      bottom:10px;
      font-size:11px;
      color: var(--muted2);
      font-family: var(--mono);
      pointer-events:none;
      opacity:.8;
    }

    /* ===== Overlay ã¯å®Œå…¨ã«æ’é™¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰ ===== */
    .overlay{display:none !important;}

    /* ===== Fixed Post Button ===== */
    .fab{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:90;
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 16px;
      padding:16px 18px;
      font-weight:1100;
      cursor:pointer;
      box-shadow: var(--shadow);
      min-width: 110px;
      font-size:15px;
      display:none;
    }
    .fab:hover{filter:brightness(1.03)}
    .fab.show{display:block}

    /* ===== Modals ===== */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.40);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:120;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(820px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h2{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .modalFooter{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:1100;
    }
    .btn:hover{background:#fafafa}
    .btn.primary{border-color:#111; background:#111; color:#fff}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .fieldRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .fieldRow{grid-template-columns:1fr} }

    .lineInput{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
    }
    .lineArea{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
      resize:vertical;
      min-height: 72px;
    }
    .selectKeep{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 10px;
      outline:none;
      background:#fff;
      font-weight:1100;
      min-height: 40px;
      cursor:pointer;
    }

    /* æ˜Ÿè©•ä¾¡ï¼ˆâ˜…/â˜†ï¼‰ */
    .starsRow{display:flex; gap:6px; margin-top:10px; flex-wrap:wrap;}
    .starBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      padding:10px 10px;
      cursor:pointer;
      font-weight:1100;
      text-align:center;
      user-select:none;
      min-width:44px;
      font-size:18px;
    }
    .starBtn.active{background:#111; color:#fff; border-color:#111}

    .reviewList{
      margin-top:12px;
      border-top:1px solid var(--line);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 280px;
      overflow:auto;
    }
    .review{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
    }
    .reviewTop{display:flex; justify-content:space-between; gap:10px}
    .reviewName{font-weight:1100; font-size:12px}
    .reviewMeta{font-size:12px; color:var(--muted); font-family:var(--mono)}
    .reviewText{margin-top:8px; font-size:13px; color:#111; white-space:pre-wrap; line-height:1.5}
    .counter{font-family:var(--mono); font-size:11px; color:var(--muted);}

    /* Gate */
    .gate{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:200;
      background: rgba(0,0,0,.35);
      padding:18px;
    }
    .gate.show{display:flex}
    .gateCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .gateTitle{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .gateActions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
    .gateBtn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
    }

    /* ===== Training view ===== */
    .trainWrap{padding:12px}
    .trainCard{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .trainTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .trainMid{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:center;
    }
    .arrowBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
      user-select:none;
      min-width:44px;
    }
    .arrowBtn:hover{background:#fafafa}
    .creatureBox{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding:14px;
      min-height: 220px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .creatureEmoji{font-size: 74px; line-height:1;}
    .pct{font-family:var(--mono); font-weight:1100; font-size:18px;}
    .thin{color:var(--muted); font-size:12px; font-weight:1100;}
    .trainBar{
      width: min(520px, 90%);
      height: 14px;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
    }
    .trainFill{
      height:100%;
      width:0%;
      background:#111;
      transition: width .35s ease;
    }
    .careUnder{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      background:#fff;
      color:#111;
    }

    /* ===== Analysis View ===== */
    .anaWrap{padding:12px; display:flex; flex-direction:column; gap:12px;}
    .anaRowHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .anaGrid3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .anaGrid3{grid-template-columns: 1fr 1fr;}
    }
    .anaCard{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:12px;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
    }
    .anaCardTitle{
      font-weight:1100;
      font-size:13px;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height: 34px;
    }
    .anaMetaRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }
    .anaMini{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      background:#fff;
      white-space:nowrap;
    }
    .moreBtn{
      position:absolute;
      right:10px;
      bottom:10px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-weight:1100;
      cursor:pointer;
      font-size:12px;
      opacity:.9;
    }
    .moreBtn:hover{background:#fafafa; opacity:1}

    .chartBox{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chartTitle{
      font-weight:1100;
      font-size:13px;
      letter-spacing:.06em;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin:0;
    }
    .chartCanvas{
      width:100%;
      height:240px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }

    /* ===== Calendar ===== */
    .calWrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .calHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .calHead .hBadge{padding:8px 12px;}
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      align-items:stretch;
    }
    .calDow{
      font-family:var(--mono);
      font-weight:1100;
      font-size:11px;
      color:var(--muted);
      text-align:center;
      padding:6px 0;
    }
    .calCell{
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 8px;
      min-height:56px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
    }
    .calDay{
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      color:#111;
      opacity:.92;
    }
    .calEmoji{
      font-size:16px;
      line-height:1;
    }
    .calCell.today{
      border-color:#111;
    }
    .calCell.muted{
      opacity:.35;
    }

    /* ===== Onboarding (4ã‚³ãƒ) ===== */
    .obCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .obTitle{
      margin:0;
      font-size:16px;
      font-weight:1200;
      letter-spacing:.02em;
    }
    .obText{
      margin:0;
      font-size:13px;
      color:#111;
      line-height:1.55;
      white-space:pre-wrap;
    }
    .obMiniArt{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .obDots{display:flex; gap:6px; justify-content:center; align-items:center;}
    .dot{
      width:7px;height:7px;border-radius:999px;border:1px solid var(--line); background:#fff;
    }
    .dot.on{background:#111; border-color:#111;}
    .obFooter{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }

    /* ===== Clear choice modal ===== */
    .forceTitle{
      margin:0;
      font-size:15px;
      font-weight:1200;
      letter-spacing:.02em;
    }
    .forceRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 520px){
      .forceRow{grid-template-columns:1fr}
    }
    .forceBtn{
      border:1px solid #111;
      border-radius:14px;
      padding:14px 12px;
      background:#111;
      color:#fff;
      font-weight:1200;
      cursor:pointer;
    }
    .forceBtn.sub{
      background:#fff;
      color:#111;
      border-color:var(--line);
      font-weight:1100;
    }
    .forceBtn:hover{filter:brightness(1.02)}

    /* ===== â€œã‚„ã£ãŸâ€ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆãƒœã‚¿ãƒ³â†’æœ¬æ—¥é”æˆã¸é£›ã¶ï¼‰ ===== */
    .fly{
      position:fixed;
      z-index:9999;
      pointer-events:none;
      font-family:var(--mono);
      font-weight:1200;
      font-size:14px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      transform: translate(-50%, -50%);
      will-change: transform, opacity;
    }
  </style>
</head>

<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã‚²ãƒ¼ãƒˆ -->
  <div class="gate" id="loginGate">
    <div class="gateCard">
      <p class="gateTitle">ãƒ­ã‚°ã‚¤ãƒ³</p>
      <div class="gateActions">
        <button class="gateBtn" id="gateLoginBtn">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- ===== Left ===== -->
    <aside class="nav">
      <div class="brand">
        <div class="logo">â–¡</div>
        <div class="brandName">ç¿’æ…£ã•ãŒã—</div>
      </div>

      <button class="navBtn active" id="navHome">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/></svg>
        </div>
        <div class="label">ãƒ›ãƒ¼ãƒ </div>
      </button>

      <button class="navBtn" id="navTrain">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4"/><path d="M12 18v4"/><path d="M4 12H2"/><path d="M22 12h-2"/>
            <path d="M5 5l2.5 2.5"/><path d="M19 19l-2.5-2.5"/><path d="M19 5l-2.5 2.5"/><path d="M5 19l2.5-2.5"/>
            <circle cx="12" cy="12" r="4"/>
          </svg>
        </div>
        <div class="label">è‚²æˆ</div>
      </button>

      <!-- â˜…è¿½åŠ ï¼šè‚²æˆã‚¢ã‚¤ã‚³ãƒ³ã®ä¸‹ã« ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ / åˆ†æ -->
      <button class="navBtn" id="navCalendar">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 2v3M16 2v3"/><path d="M3 7h18"/><path d="M5 7v14a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7"/>
            <path d="M7 11h4"/><path d="M7 15h6"/>
          </svg>
        </div>
        <div class="label">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
      </button>

      <button class="navBtn" id="navAnalysis">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19V5"/><path d="M4 19h16"/>
            <path d="M8 17V9"/><path d="M12 17V7"/><path d="M16 17v-5"/>
          </svg>
        </div>
        <div class="label">åˆ†æ</div>
      </button>

      <button class="navBtn" id="navBookmarks">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/></svg>
        </div>
        <div class="label">ä¿å­˜</div>
      </button>

      <button class="navBtn" id="navProfile">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div class="label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
      </button>

      <div class="sep"></div>

      <div class="userBox">
        <div class="lvRingWrap" title="ãƒ¬ãƒ™ãƒ« / çµŒé¨“å€¤">
          <svg class="lvRingSvg" width="46" height="46" viewBox="0 0 46 46" aria-hidden="true">
            <circle class="lvRingBg" cx="23" cy="23" r="18"></circle>
            <circle class="lvRingFg" id="lvRingFg" cx="23" cy="23" r="18"></circle>
          </svg>
          <div class="xpPop" id="xpPop">+0</div>
          <div class="avatar" id="userAvatar">â–¡</div>
          <div class="lvNum" id="lvNum">1</div>
        </div>

        <div class="userMeta">
          <div class="userNameRow">
            <div class="userName" id="userName">â€”</div>
            <div class="followerMini" id="followerMini">ãƒ•ã‚©ãƒ­ãƒ¼ 0</div>
          </div>
          <div class="userSmall" id="userSmall">â€”</div>
        </div>
      </div>

      <div class="xpBlock">
        <div class="xpTop">
          <span class="hBadge" id="levelBadge">Lv 1</span>
          <!-- â˜…è¦æœ›ï¼šã‚­ãƒ£ãƒ©ä¸€è¦§ãƒœã‚¿ãƒ³ã¯è‚²æˆã® â€œç›®ç«‹ãŸãªã„æ‰€â€ â†’ å³ã«å°ã•ã -->
          <button class="miniLinkBtn" id="openCharList">ã‚­ãƒ£ãƒ©ä¸€è¦§</button>
        </div>
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
          <span class="xpText" id="xpText">0 / 100</span>
          <span class="xpText" id="xpRemain">æ¬¡ã¾ã§ 100</span>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sideTitle">ä¾é ¼ï¼ˆæŒ‘æˆ¦ä¸­ï¼‰</div>
      <div class="sideList" id="sideActiveList"></div>
    </aside>

    <!-- ===== Right ===== -->
    <main class="content">

      <!-- ===== Home ===== -->
      <section class="panel" id="viewHome">
        <div class="headerBar">
          <div class="hTitle">ç¿’æ…£æ¢ã—</div>
          <div class="todayBadge" id="todayDoneBadge">æœ¬æ—¥ <strong>0</strong> äººãŒé”æˆ</div>
        </div>

        <div class="tagWrap">
          <div class="rankBox">
            <div class="rankTitle"><span>ãŠã™ã™ã‚TOP</span></div>
            <div class="rankGrid" id="rankReco"></div>
          </div>
          <div class="rankBox">
            <div class="rankTitle"><span>äººæ°—TOP</span></div>
            <div class="rankGrid" id="rankTop"></div>
          </div>
        </div>

        <div class="searchRow">
          <div class="searchBox">
            <input class="searchInput" id="q" placeholder="æ¤œç´¢" />
            <button class="searchBtn" id="btnSearch">æ¤œç´¢</button>
          </div>

          <select class="ctrlSel" id="categoryFilter" title="ã‚«ãƒ†ã‚´ãƒª">
            <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆã™ã¹ã¦ï¼‰</option>
            <option>ãƒ¡ãƒ³ã‚¿ãƒ«</option><option>ç¡çœ </option><option>é‹å‹•</option><option>å¥åº·</option>
            <option>ç”Ÿæ´»</option><option>å‹‰å¼·</option><option>è‹±èª</option><option>ä»•äº‹</option><option>ãã®ä»–</option>
          </select>

          <button class="ctrlBtn" id="btnClearTag" title="ã‚¿ã‚°è§£é™¤">ã‚¿ã‚°è§£é™¤</button>
        </div>

        <div class="feedArea">
          <div class="feedHead">
            <div class="feedHeadLeft">
              <p class="feedLabel">ä¸€è¦§</p>
              <select class="ctrlSel" id="sortBy" title="ä¸¦ã³æ›¿ãˆ">
                <option value="new">æ–°ç€</option>
                <option value="rating">è©•ä¾¡</option>
                <option value="favCreators">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®äºº</option>
              </select>
              <div class="countSmall">è¡¨ç¤º <span id="countShown">0</span></div>
            </div>
          </div>
          <div class="feedGrid" id="feed"></div>
        </div>
      </section>

      <!-- ===== Training ===== -->
      <section class="panel" id="viewTrain" style="display:none">
        <div class="headerBar">
          <div class="hTitle">è‚²æˆ</div>
          <div class="hBadge" id="trainHint">â€”</div>
        </div>

        <div class="trainWrap">
          <div class="trainCard">
            <div class="trainTop">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="hBadge" id="trainSlot">1 / 1</span>
                <span class="hBadge" id="trainHabitTitle">â€”</span>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="hBadge" id="trainPctText">0%</span>
                <button class="miniLinkBtn" id="btnSetAvatar" disabled>ã“ã®å­ã‚’ã‚¢ã‚¤ã‚³ãƒ³ã«</button>
              </div>
            </div>

            <div class="trainMid">
              <button class="arrowBtn" id="trainPrev">&lt;</button>

              <div class="creatureBox">
                <div class="pct" id="trainPct">0%</div>

                <!-- â˜…è¿½åŠ ï¼š%ã®æ¨ªã« â€œæ®‹ã‚Šæ—¥æ•°/å»¶é•·æ®‹ã‚Šâ€ ã‚’å‡ºã™ï¼ˆJSã§åŸ‹ã‚ã‚‹ï¼‰ -->
                <div class="thin" id="trainRemainText">æ®‹ã‚Š â€” æ—¥ / å»¶é•· â€” æ—¥</div>

                <div class="trainBar"><div class="trainFill" id="trainFill"></div></div>
                <div class="creatureEmoji" id="trainEmoji">ğŸ¥š</div>
                <div class="thin" id="trainStage">â€”</div>
                <div class="careUnder" id="trainCare">æ¬¡ã®ãŠä¸–è©±ã¾ã§ 00:00:00</div>
              </div>

              <button class="arrowBtn" id="trainNext">&gt;</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Calendar ===== -->
      <section class="panel" id="viewCalendar" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
          <div class="hBadge" id="calHint">ä»Šæœˆ</div>
        </div>
        <div class="anaWrap">
          <div class="calWrap">
            <div class="calHead">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <button class="btn" id="calPrev">ï¼œ</button>
                <span class="hBadge" id="calMonthLabel">â€”</span>
                <button class="btn" id="calNext">ï¼</button>
              </div>
              <span class="hBadge">çµµæ–‡å­—ï¼šğŸ˜ŠğŸ™‚ğŸ˜…</span>
            </div>

            <div class="calGrid" id="calGrid">
              <!-- JSã§æ›œæ—¥+æ—¥ä»˜ã‚»ãƒ«ã‚’ä½œã‚‹ -->
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Analysis ===== -->
      <section class="panel" id="viewAnalysis" style="display:none">
        <div class="headerBar">
          <div class="hTitle">åˆ†æ</div>
          <div class="hBadge" id="anaHint">â€”</div>
        </div>

        <div class="anaWrap">
          <!-- ä¸Šï¼š3ã¤ã®æ ï¼ˆè‚²æˆä¸­ / è‚²æˆå®Œäº† / ãƒªã‚¿ã‚¤ã‚¢ï¼‰ -->
          <div>
            <div class="anaRowHead">
              <span class="hBadge">è‚²æˆä¸­ <span class="tinyNum blue" id="anaCountActive">0</span></span>
              <span class="hBadge">è‚²æˆå®Œäº† <span class="tinyNum green" id="anaCountCleared">0</span></span>
              <span class="hBadge">ãƒªã‚¿ã‚¤ã‚¢ <span class="tinyNum gray" id="anaCountRetired">0</span></span>
            </div>

            <div class="anaGrid3" style="margin-top:10px">
              <div class="anaCard">
                <div class="anaCardTitle">è‚²æˆä¸­ï¼ˆæœ€è¿‘3ã¤ï¼‰</div>
                <div class="anaMetaRow" id="anaActiveRow"></div>
                <button class="moreBtn" id="anaMoreActive">ã‚‚ã£ã¨è¦‹ã‚‹</button>
              </div>

              <div class="anaCard">
                <div class="anaCardTitle">è‚²æˆå®Œäº†ï¼ˆæœ€è¿‘3ã¤ï¼‰</div>
                <div class="anaMetaRow" id="anaClearedRow"></div>
                <button class="moreBtn" id="anaMoreCleared">ã‚‚ã£ã¨è¦‹ã‚‹</button>
              </div>

              <div class="anaCard">
                <div class="anaCardTitle">ãƒªã‚¿ã‚¤ã‚¢ï¼ˆæœ€è¿‘3ã¤ï¼‰</div>
                <div class="anaMetaRow" id="anaRetiredRow"></div>
                <button class="moreBtn" id="anaMoreRetired">ã‚‚ã£ã¨è¦‹ã‚‹</button>
              </div>
            </div>
          </div>

          <!-- ä¸‹ï¼šã‚°ãƒ©ãƒ•ï¼ˆæ£’ãƒ»æŠ˜ã‚Œç·šï¼‰ -->
          <div class="chartBox">
            <p class="chartTitle">
              <span>ãŸã‚ã«ãªã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆä»®ï¼‰</span>
              <span class="hBadge">ã‚ãªãŸ/ã‚«ãƒ†ã‚´ãƒª/ä½œæˆè€… æ¯”è¼ƒ</span>
            </p>
            <canvas class="chartCanvas" id="barChart" width="900" height="240"></canvas>
          </div>

          <div class="chartBox">
            <p class="chartTitle">
              <span>æ¯”è¼ƒã‚°ãƒ©ãƒ•ï¼ˆæŠ˜ã‚Œç·šï¼‰</span>
              <span class="hBadge">æˆåŠŸç‡/ä¼‘ã¿/é›£æ˜“åº¦</span>
            </p>
            <canvas class="chartCanvas" id="lineChart" width="900" height="240"></canvas>
          </div>

          <!-- ä¸‹ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°/è¦‹ã¤ã‘ã«ãã„æƒ…å ±ï¼ˆ3ã¤ä¸¦ã³ï¼‰ -->
          <div class="anaGrid3">
            <div class="anaCard">
              <div class="anaCardTitle">æˆåŠŸç‡ é«˜ã‚ ä½œæˆè€…TOP</div>
              <div class="anaMetaRow" id="anaTopCreators"></div>
            </div>
            <div class="anaCard">
              <div class="anaCardTitle">ãŠæ°—ã«å…¥ã‚Šè‚²æˆï¼ˆç¶šã„ã¦ã‚‹ï¼‰</div>
              <div class="anaMetaRow" id="anaTopHabits"></div>
            </div>
            <div class="anaCard">
              <div class="anaCardTitle">å¤±æ•—ã—ã‚„ã™ã„ï¼ˆæ‚©ã¿ã‚¿ã‚°/ã‚«ãƒ†ã‚´ãƒªï¼‰</div>
              <div class="anaMetaRow" id="anaHardTags"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Bookmarks ===== -->
      <section class="panel" id="viewBookmarks" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ä¿å­˜</div>
          <div class="hBadge">ä»¶æ•° <span id="bmCount">0</span></div>
        </div>
        <div style="padding:12px">
          <div class="feedGrid" id="bmFeed"></div>
        </div>
      </section>

      <!-- ===== Profile ===== -->
      <section class="panel" id="viewProfile" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
          <div class="hBadge" id="profileLv">Lv 1</div>
        </div>
        <div style="padding:12px" id="profileList"></div>

        <div style="padding:12px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap">
          <button class="btn primary" id="btnLogin">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="btn" id="btnLogout" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </section>
    </main>
  </div>

  <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ï¼ˆå³ä¸‹å›ºå®š / Homeã®ã¿è¡¨ç¤ºï¼‰ -->
  <button class="fab" id="openPost">æŠ•ç¨¿</button>

  <!-- ===== åå‰ç™»éŒ² + è‰²é¸æŠ ===== -->
  <div class="modalBg" id="nameBg">
    <div class="modal">
      <h2>åå‰</h2>

      <div class="fieldRow" style="margin-top:10px; grid-template-columns: 1fr auto;">
        <div>
          <input class="lineInput" id="nameInput" placeholder="åå‰" maxlength="16" />
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <span class="counter">è‰²</span>
            <select class="selectKeep" id="colorPick" title="è‰²">
              <option value="#111111">é»’</option>
              <option value="#e00000">èµ¤</option>
              <option value="#0b6cff">é’</option>
              <option value="#00a86b">ç·‘</option>
              <option value="#ff8a00">æ©™</option>
            </select>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:flex-start">
          <div class="avatar" id="nameAvatar" style="width:46px;height:46px">â–¡</div>
          <div class="counter">ç¾åœ¨</div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn primary" id="nameSave" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ===== åˆå›ã‚«ãƒ†ã‚´ãƒªé¸æŠ ===== -->
  <div class="modalBg" id="catBg">
    <div class="modal">
      <h2>ã‚«ãƒ†ã‚´ãƒª</h2>
      <div class="fieldRow" id="catList" style="margin-top:10px"></div>
      <div class="modalFooter">
        <button class="btn" id="catClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="catSave" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ===== æŠ•ç¨¿ ===== -->
  <div class="modalBg" id="postBg">
    <div class="modal">
      <h2>æŠ•ç¨¿</h2>

      <div style="margin-top:10px">
        <div class="counter" id="postCounter">0 / 40</div>
        <input class="lineInput" id="newTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" maxlength="40" />
        <textarea class="lineArea" id="newAction" placeholder="ã‚„ã‚‹ã“ã¨ï¼ˆ40æ–‡å­—ï¼‰" maxlength="40"></textarea>
      </div>

      <div class="fieldRow">
        <input class="lineInput" id="newTags" placeholder="æ‚©ã¿ã‚¿ã‚°ï¼ˆä¾‹ï¼šä¸å®‰,å¯ã¤ãï¼‰" />
        <select class="selectKeep" id="newCategory">
          <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</option>
          <option>ãƒ¡ãƒ³ã‚¿ãƒ«</option><option>ç¡çœ </option><option>é‹å‹•</option><option>å¥åº·</option>
          <option>ç”Ÿæ´»</option><option>å‹‰å¼·</option><option>è‹±èª</option><option>ä»•äº‹</option><option>ãã®ä»–</option>
        </select>
      </div>

      <div class="modalFooter">
        <button class="btn" id="postClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btnPost">æŠ•ç¨¿</button>
      </div>
    </div>
  </div>

  <!-- ===== é›£æ˜“åº¦ï¼ˆ3æŠï¼‰ ===== -->
  <div class="modalBg" id="diffBg">
    <div class="modal">
      <h2 id="diffTitle">é›£æ˜“åº¦</h2>
      <div class="fieldRow" style="grid-template-columns:1fr 1fr 1fr; margin-top:12px">
        <button class="btn" data-diff="easy">ğŸ˜Š</button>
        <button class="btn" data-diff="mid">ğŸ™‚</button>
        <button class="btn" data-diff="hard">ğŸ˜…</button>
      </div>
      <div class="modalFooter">
        <button class="btn" id="diffClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ===== 3æ—¥ã‚¯ãƒªã‚¢æ™‚ã®å¼·åˆ¶2æŠï¼ˆæˆ»ã‚Œãªã„ï¼‰ ===== -->
  <div class="modalBg" id="clearChoiceBg">
    <div class="modal">
      <p class="forceTitle" id="clearChoiceTitle">ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼ï¼</p>
      <p class="obText" id="clearChoiceText" style="margin-top:8px">æ¬¡ã¯ã©ã†ã™ã‚‹ï¼Ÿ</p>

      <div class="forceRow">
        <button class="forceBtn" id="btnNewChallenge">æ–°ã—ã„ç¿’æ…£ã«æŒ‘æˆ¦</button>
        <button class="forceBtn sub" id="btnExtendChallenge">æœ€å¾Œã¾ã§è‚²æˆï¼ˆæ®‹ã‚Š4æ—¥ï¼‰</button>
      </div>
    </div>
  </div>

  <!-- ===== è©•ä¾¡ï¼ˆâ˜…â˜†ï¼‰ ===== -->
  <div class="modalBg" id="ratingBg">
    <div class="modal">
      <h2 id="ratingTitle">è©•ä¾¡</h2>

      <div class="starsRow" id="starsRow"></div>
      <textarea class="lineArea" id="commentBox" placeholder="å£ã‚³ãƒŸï¼ˆçŸ­æ–‡ï¼‰" style="margin-top:10px"></textarea>

      <div class="modalFooter">
        <button class="btn" id="ratingClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="ratingSave">é€ä¿¡</button>
      </div>

      <div class="reviewList" id="reviewList"></div>
    </div>
  </div>

  <!-- ===== ä½œæˆè€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ===== -->
  <div class="modalBg" id="creatorBg">
    <div class="modal">
      <h2>ä½œæˆè€…</h2>

      <div class="creatorHeader" style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <div class="creatorBig" style="display:flex; align-items:center; gap:10px; min-width:0;">
          <div class="avatar" id="creatorAva" style="width:42px;height:42px;border-radius:50%">â–¡</div>
          <div class="creatorBigName" id="creatorName" style="font-weight:1100;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:380px;">â€”</div>
        </div>
        <button class="btn" id="creatorClose">é–‰ã˜ã‚‹</button>
      </div>

      <div class="reviewList" id="creatorPosts" style="margin-top:12px; border-top:none; padding-top:0"></div>
    </div>
  </div>

  <!-- ===== ã‚­ãƒ£ãƒ©ä¸€è¦§ ===== -->
  <div class="modalBg" id="charBg">
    <div class="modal">
      <h2>ã‚­ãƒ£ãƒ©ä¸€è¦§ï¼ˆåµ/ç¨®ã ã‘è¡¨ç¤ºï¼‰</h2>
      <div class="reviewList" id="charList"></div>
      <div class="modalFooter">
        <button class="btn" id="charClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ===== Onboardingï¼ˆåˆå›ã ã‘ï¼‰ ===== -->
  <div class="modalBg" id="onboardingBg">
    <div class="obCard">
      <p class="obTitle" id="obHead">â€”</p>
      <p class="obText" id="obBody">â€”</p>

      <div class="obMiniArt" id="obArt">
        <!-- JSã§ç°¡æ˜“ã‚¤ãƒ©ã‚¹ãƒˆï¼ˆçµµæ–‡å­—ï¼‹ãƒŸãƒ‹ã‚«ãƒ¼ãƒ‰é¢¨ï¼‰ -->
      </div>

      <div class="obDots" id="obDots"></div>

      <div class="obFooter">
        <button class="btn" id="obSkip">ã‚¹ã‚­ãƒƒãƒ—</button>
        <button class="btn primary" id="obNext">æ¬¡ã¸</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* =========================
      PART 2 / 3 ã§ç¶šãã¾ã™
      ã“ã“ã¯ â€œã¾ã é€”ä¸­â€ ã§ã™ï¼ˆé€£çµç”¨ï¼‰
    ========================= */
</script>
</body>
</html>
<!-- =========================
  PART 1 / 3 ã“ã“ã¾ã§
========================= -->
<!-- =========================
  PART 2 / 3
  â€»Part1ã®ç¶šãã¨ã—ã¦ã€Œãã®ã¾ã¾ä¸‹ã«è²¼ã‚Šè¶³ã™ã€æƒ³å®šã§ã™
  ï¼ˆDOCTYPEã€œheadé€”ä¸­ãªã©ã¯é‡è¤‡ã•ã›ãªã„ã§ãã ã•ã„ï¼‰
========================= -->

<style>
  /* ====== PART2 è¿½åŠ /ä¸Šæ›¸ãCSS ====== */

  /* ç”»é¢ãŒé»’ããªã‚‹ overlay æ©Ÿèƒ½ã‚’å®Œå…¨æ’é™¤ï¼ˆæç”»ã‚‚hoverã‚‚ç„¡åŠ¹åŒ–ï¼‰ */
  .overlay{display:none !important;}
  .habitCard:hover .overlay{display:none !important;}
  .habitCard.pressing .overlay{display:none !important;}

  /* 4ã¤ã®æŒ‡æ¨™ã‚’ã€Œã±ã£ã¨è¦‹ã€åŒ–ï¼šå°‘ã—å¤§ãã‚ï¼†è©°ã‚ã‚‹ */
  .statPill{
    padding:7px 10px;
    font-size:12.5px;
  }
  .statLine{gap:8px;}
  .statsRow{gap:8px;}

  /* ã‚«ãƒ†ã‚´ãƒªç·šã‚’å°‘ã—æ¿ƒãï¼ˆè‰²ã‚’æ¿ƒãè¦‹ã›ã‚‹ï¼‰ */
  .habitCard{ border-width:1.2px; }
  .thumb{ border-bottom-width:1.2px; }

  /* å·¦ã‚«ãƒ©ãƒ ï¼šè‚²æˆã‚¢ã‚¤ã‚³ãƒ³ã®ä¸‹ã«ç½®ãå°ãƒ‘ãƒãƒ« */
  .miniPanel{
    border:1px solid var(--line);
    border-radius: 12px;
    background:#fff;
    box-shadow: var(--shadow);
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .miniPanelTitle{
    font-weight:1100;
    font-size:12px;
    letter-spacing:.06em;
    color:var(--muted);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  /* ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  .miniCalHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .miniCalMonth{
    font-weight:1100;
    font-size:12px;
    font-family:var(--mono);
    color:#111;
    white-space:nowrap;
  }
  .miniCalGrid{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:6px;
  }
  .miniCalDow{
    font-size:10px;
    color:var(--muted);
    text-align:center;
    font-family:var(--mono);
  }
  .miniCalCell{
    border:1px solid var(--line);
    border-radius:10px;
    min-height:34px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:2px;
    background:#fff;
    user-select:none;
  }
  .miniCalCell.today{
    border-color:#111;
  }
  .miniCalDay{
    font-size:10px;
    color:var(--muted);
    font-family:var(--mono);
    line-height:1;
  }
  .miniCalStamp{
    font-size:14px;
    line-height:1;
    min-height:16px;
  }

  /* åˆ†æãƒŸãƒ‹ */
  .mini3Grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:8px;
    align-items:stretch;
  }
  .miniCard{
    border:1px solid var(--line);
    border-radius: 12px;
    padding:10px;
    background:#fff;
    box-shadow: var(--shadow);
    min-width:0;
    position:relative;
    overflow:hidden;
  }
  .miniCardTitle{
    font-weight:1100;
    font-size:12px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin:0;
  }
  .miniCardSub{
    margin-top:6px;
    font-size:11px;
    color:var(--muted);
    font-family:var(--mono);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .miniCorner{
    position:absolute;
    top:8px;
    right:8px;
    font-family:var(--mono);
    font-size:10px;
    font-weight:1100;
    padding:4px 6px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    color:#111;
    opacity:.95;
  }
  .miniCorner.active{border-color:#0b6cff; color:#0b6cff;}
  .miniCorner.done3{border-color:#10a85a; color:#10a85a;}
  .miniCorner.done7{border-color:#ff8a00; color:#ff8a00;}
  .miniCorner.retired{border-color:#e00000; color:#e00000;}

  .miniMoreBtn{
    border:1px solid var(--line);
    background:#fff;
    border-radius: 10px;
    padding:8px 10px;
    cursor:pointer;
    font-weight:1100;
    font-size:12px;
    width:fit-content;
    margin-left:auto;
    opacity:.9;
  }
  .miniMoreBtn:hover{background:#fafafa; opacity:1;}

  /* å³ãƒ¡ã‚¤ãƒ³ï¼šåˆ†æãƒ“ãƒ¥ãƒ¼ */
  .anaWrap{padding:12px; display:flex; flex-direction:column; gap:12px;}
  .anaRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .anaTitle{
    font-weight:1100;
    font-size:13px;
    letter-spacing:.06em;
    color:#111;
  }
  .anaGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  @media (max-width: 980px){
    .anaGrid{grid-template-columns: repeat(2, 1fr);}
  }
  @media (min-width: 1200px){
    .anaGrid{grid-template-columns: repeat(4, 1fr);}
  }

  /* ç°¡æ˜“ãƒãƒ£ãƒ¼ãƒˆ */
  .chartBox{
    border:1px solid var(--line);
    border-radius: 14px;
    background:#fff;
    box-shadow: var(--shadow);
    padding:12px;
  }
  .chartHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .chartTitle{
    font-weight:1100;
    font-size:12px;
    color:var(--muted);
    letter-spacing:.06em;
  }
  canvas.chart{
    width:100%;
    height:220px;
    display:block;
  }

  /* 3æ—¥ã‚¯ãƒªã‚¢æ™‚ï¼šå¼·åˆ¶2æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
  .choiceBg{
    position:fixed; inset:0;
    background: rgba(0,0,0,.45);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:180;
  }
  .choiceBg.show{display:flex}
  .choiceCard{
    width:min(520px, 100%);
    border:1px solid var(--line);
    border-radius: 16px;
    background:#fff;
    box-shadow: var(--shadow);
    padding:14px;
  }
  .choiceTitle{
    margin:0;
    font-weight:1100;
    font-size:15px;
    letter-spacing:.04em;
  }
  .choiceText{
    margin:10px 0 0;
    color:var(--muted);
    font-size:13px;
    line-height:1.6;
  }
  .choiceBtns{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:12px;
  }
  .choiceBtn{
    border:1px solid #111;
    background:#111;
    color:#fff;
    border-radius: 14px;
    padding:12px 12px;
    font-weight:1100;
    cursor:pointer;
    text-align:center;
  }
  .choiceBtn.sub{
    background:#fff;
    color:#111;
  }
  .choiceBtn:hover{filter:brightness(1.03)}
  .choiceBtn:disabled{opacity:.6; cursor:not-allowed}

  /* Doneã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆãƒœã‚¿ãƒ³â†’æœ¬æ—¥é”æˆã¸é£›ã¶ï¼‰ */
  .flyPlus{
    position:fixed;
    z-index:999;
    width:26px; height:26px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#111;
    color:#fff;
    font-family:var(--mono);
    font-weight:1100;
    font-size:12px;
    display:grid;
    place-items:center;
    pointer-events:none;
    transform: translate(-50%,-50%);
    opacity:0;
  }

  /* ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ4ã‚³ãƒï¼‰ */
  .onbBg{
    position:fixed; inset:0;
    background: rgba(0,0,0,.40);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:190;
  }
  .onbBg.show{display:flex}
  .onbCard{
    width:min(420px, 100%);
    border:1px solid var(--line);
    border-radius: 16px;
    background:#fff;
    box-shadow: var(--shadow);
    padding:14px;
  }
  .onbHead{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  .onbH{
    margin:0;
    font-weight:1100;
    font-size:15px;
    letter-spacing:.04em;
  }
  .onbP{
    margin:8px 0 0;
    color:#111;
    font-size:13px;
    line-height:1.6;
  }
  .onbMini{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius: 14px;
    padding:10px;
    background:#fff;
    box-shadow: var(--shadow);
  }
  .onbDots{display:flex; gap:6px; justify-content:center; margin-top:10px;}
  .dot{
    width:8px;height:8px;border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
  }
  .dot.on{background:#111; border-color:#111;}
  .onbFoot{
    display:flex;
    justify-content:space-between;
    gap:10px;
    margin-top:12px;
  }
  .onbBtn{
    border:1px solid var(--line);
    background:#fff;
    border-radius: 12px;
    padding:10px 12px;
    font-weight:1100;
    cursor:pointer;
  }
  .onbBtn.primary{
    border-color:#111;
    background:#111;
    color:#fff;
  }
</style>

<!-- ====== PART2 è¿½åŠ HTMLï¼ˆæ—¢å­˜ã®bodyå†…ã€å·¦navã®xpBlockã®ç›´å¾Œã«æŒ¿å…¥ï¼‰ ======
  1) ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  2) ãƒŸãƒ‹åˆ†æï¼ˆ3æšã‚«ãƒ¼ãƒ‰ï¼‰
  â€»Part1ã®HTMLã«ã€ŒåŒã˜å ´æ‰€ã€ã«è²¼ã£ã¦ãã ã•ã„
-->

<!--
  â–¼ã“ã“ã‚’ Part1 ã®ã€ŒxpBlockã€ã®ç›´å¾Œã«è²¼ã‚‹ï¼ˆsepã®å‰ã‚ãŸã‚ŠãŒè‡ªç„¶ï¼‰
-->
<!--
<div class="miniPanel" id="miniCalendarPanel">
  <div class="miniPanelTitle">
    <span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
    <span class="miniCalMonth" id="miniCalMonth">â€”</span>
  </div>
  <div class="miniCalGrid" id="miniCalGrid"></div>
</div>

<div class="miniPanel" id="miniAnalyticsPanel">
  <div class="miniPanelTitle">
    <span>åˆ†æ</span>
    <button class="miniMoreBtn" id="miniAnaMore">ã‚‚ã£ã¨è¦‹ã‚‹</button>
  </div>
  <div class="mini3Grid" id="miniAnaCards"></div>
</div>
-->

<!-- ====== PART2 è¿½åŠ HTMLï¼ˆå³ãƒ¡ã‚¤ãƒ³ï¼šRecords ã‚’ â€œåˆ†æâ€ ã«å·®ã—æ›¿ãˆï¼‰ ======
  Part1ã® navRecordsãƒ©ãƒ™ãƒ«ã€Œé”æˆè¨˜éŒ²ã€ã‚’ã€Œåˆ†æã€ã«ã—ã¦ã€
  viewRecords ã®ä¸­èº«ã‚’ä¸‹ã® viewAnalytics ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚
-->
<!--
<section class="panel" id="viewAnalytics" style="display:none">
  <div class="headerBar">
    <div class="hTitle">åˆ†æ</div>
    <div class="hBadge" id="anaBadge">â€”</div>
  </div>

  <div class="anaWrap">
    <div class="anaRow">
      <div class="anaTitle">æœ€è¿‘ã®è‚²æˆ</div>
      <button class="miniMoreBtn" id="anaShowAll">ã‚‚ã£ã¨è¦‹ã‚‹</button>
    </div>

    <div class="anaGrid" id="anaRecentGrid"></div>

    <div class="chartBox">
      <div class="chartHead">
        <div class="chartTitle">æ—¥åˆ¥ï¼šé”æˆ/ä¼‘ã¿/æœªå ±å‘Šï¼ˆæ£’ï¼‰</div>
        <div class="hBadge" id="chartRange1">ç›´è¿‘14æ—¥</div>
      </div>
      <canvas class="chart" id="chartBars"></canvas>
    </div>

    <div class="chartBox">
      <div class="chartHead">
        <div class="chartTitle">ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼šæˆåŠŸç‡ï¼ˆæŠ˜ã‚Œç·šæ¯”è¼ƒï¼‰</div>
        <div class="hBadge" id="chartRange2">ç›´è¿‘30ä»¶</div>
      </div>
      <canvas class="chart" id="chartLines"></canvas>
    </div>

    <div class="anaRow">
      <div class="anaTitle">æ°—ã¥ãï¼ˆè‡ªå‹•ï¼‰</div>
      <div class="hBadge" id="insightBadge">â€”</div>
    </div>
    <div class="review" id="insightBox">
      <div class="reviewText">â€”</div>
    </div>
  </div>
</section>
-->

<!-- ====== PART2 è¿½åŠ HTMLï¼š3æ—¥ã‚¯ãƒªã‚¢2æŠï¼ˆå¼·åˆ¶ï¼‰ ====== -->
<div class="choiceBg" id="clearChoiceBg" aria-hidden="true">
  <div class="choiceCard">
    <p class="choiceTitle" id="clearChoiceTitle">ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼ï¼</p>
    <p class="choiceText" id="clearChoiceText">3æ—¥ã‚¯ãƒªã‚¢ï¼æ¬¡ã¸è¡Œãï¼Ÿãã‚Œã¨ã‚‚æœ€å¾Œã¾ã§è‚²æˆã™ã‚‹ï¼Ÿ</p>
    <div class="choiceBtns">
      <button class="choiceBtn sub" id="btnChoiceNew">æ–°ã—ã„ç¿’æ…£ã«æŒ‘æˆ¦</button>
      <button class="choiceBtn" id="btnChoiceExtend">æœ€å¾Œã¾ã§è‚²æˆï¼ˆæ®‹ã‚Š4æ—¥ï¼‰</button>
    </div>
  </div>
</div>

<!-- ====== PART2 è¿½åŠ HTMLï¼šã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ4ã‚³ãƒï¼‰ ====== -->
<div class="onbBg" id="onbBg" aria-hidden="true">
  <div class="onbCard">
    <div class="onbHead">
      <div style="min-width:0">
        <p class="onbH" id="onbH">â€”</p>
        <p class="onbP" id="onbP">â€”</p>
      </div>
      <button class="onbBtn" id="onbSkip">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>

    <div class="onbMini" id="onbMini">
      <!-- ã“ã“ã¯JSã§å·®ã—æ›¿ãˆï¼ˆçµµæ–‡å­—+ãƒŸãƒ‹ã‚«ãƒ¼ãƒ‰é¢¨ï¼‰ -->
      <div class="reviewText" id="onbArt" style="margin:0; white-space:pre-line;">â€”</div>
    </div>

    <div class="onbDots" id="onbDots"></div>

    <div class="onbFoot">
      <button class="onbBtn" id="onbBack">æˆ»ã‚‹</button>
      <button class="onbBtn primary" id="onbNext">æ¬¡ã¸</button>
    </div>
  </div>
</div>

<script type="module">
/* =========================
  PART2 / 3 è¿½åŠ JS
  â€»Part1ã®<script type="module"> ã®ä¸­ã«ã€Œè¿½è¨˜ã€ã—ã¦ãã ã•ã„
========================= */

  // ====== è¿½åŠ DOMï¼ˆPart1ã§ $ ãŒå®šç¾©æ¸ˆã¿å‰æï¼‰ ======
  const miniCalMonth = document.getElementById("miniCalMonth");
  const miniCalGrid  = document.getElementById("miniCalGrid");
  const miniAnaCards = document.getElementById("miniAnaCards");
  const miniAnaMore  = document.getElementById("miniAnaMore");

  const clearChoiceBg = document.getElementById("clearChoiceBg");
  const btnChoiceNew = document.getElementById("btnChoiceNew");
  const btnChoiceExtend = document.getElementById("btnChoiceExtend");

  const onbBg   = document.getElementById("onbBg");
  const onbH    = document.getElementById("onbH");
  const onbP    = document.getElementById("onbP");
  const onbArt  = document.getElementById("onbArt");
  const onbDots = document.getElementById("onbDots");
  const onbSkip = document.getElementById("onbSkip");
  const onbBack = document.getElementById("onbBack");
  const onbNext = document.getElementById("onbNext");

  // åˆ†æãƒ“ãƒ¥ãƒ¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã ã‘ï¼‰
  const viewAnalytics = document.getElementById("viewAnalytics");
  const anaBadge = document.getElementById("anaBadge");
  const anaRecentGrid = document.getElementById("anaRecentGrid");
  const chartBars = document.getElementById("chartBars");
  const chartLines = document.getElementById("chartLines");
  const insightBadge = document.getElementById("insightBadge");
  const insightBox = document.getElementById("insightBox");
  const anaShowAll = document.getElementById("anaShowAll");

  // navRecords ã‚’ â€œåˆ†æâ€ ã«ã™ã‚‹ï¼ˆPart1å´ã§ id ã¯ navRecords ã®ã¾ã¾æƒ³å®šï¼‰
  const navAna = document.getElementById("navRecords");

  // ====== Firestoreè¿½åŠ ï¼ˆPart1ã§ import æ¸ˆã¿å‰æï¼‰ ======
  // ã“ã“ã§ã¯é–¢æ•°ã ã‘è¿½åŠ ã§ä½¿ã†ï¼ˆcollection/doc/getDocsç­‰ã¯æ—¢ã«importæ¸ˆã¿ï¼‰

  // ====== 3æ—¥ã‚¯ãƒªã‚¢ã‚’åŸºæœ¬ã«ã™ã‚‹ãŸã‚ã®å®šæ•° ======
  const BASE_CLEAR_DAYS = 3;
  const EXTEND_TOTAL_DAYS = 7;

  // ====== æ—¥ä»˜ã‚­ãƒ¼ ======
  const ymd = (d=new Date()) => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  };

  // ====== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼šä»Šæ—¥ã®çµµæ–‡å­—ã‚¹ã‚¿ãƒ³ãƒ—ä¿å­˜ ======
  // ä¿å­˜å…ˆï¼šuserDailyStamps/{uid}/items/{YYYY-MM-DD}  { emoji:"ğŸ˜Š"|"ğŸ™‚"|"ğŸ˜…", updatedAt }
  async function setTodayStamp(emoji){
    if(!currentUser) return;
    const id = ymd(new Date());
    const ref = doc(db, "userDailyStamps", currentUser.uid, "items", id);
    await setDoc(ref, { emoji, updatedAt: serverTimestamp() }, { merge:true });
  }
  async function loadMonthStamps(year, monthIndex0){
    if(!currentUser) return new Map();
    // å˜ç´”ã«æœ€è¿‘60ä»¶ã‚’èª­ã‚“ã§æœˆå†…ã ã‘æ‹¾ã†ï¼ˆè»½é‡ï¼†å®Ÿè£…ç°¡å˜ï¼‰
    const mp = new Map();
    const qs = await getDocs(query(
      collection(db, "userDailyStamps", currentUser.uid, "items"),
      orderBy("updatedAt","desc"),
      limit(90)
    ));
    const ym = `${year}-${String(monthIndex0+1).padStart(2,"0")}-`;
    qs.forEach(s=>{
      if(s.id.startsWith(ym)){
        mp.set(s.id, String(s.data()?.emoji||""));
      }
    });
    return mp;
  }

  function renderMiniCalendar(stampsMap){
    if(!miniCalGrid || !miniCalMonth) return;

    const now = new Date();
    const Y = now.getFullYear();
    const M = now.getMonth(); // 0-index
    miniCalMonth.textContent = `${Y}-${String(M+1).padStart(2,"0")}`;

    miniCalGrid.innerHTML = "";

    const dows = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
    for(const w of dows){
      const el = document.createElement("div");
      el.className = "miniCalDow";
      el.textContent = w;
      miniCalGrid.appendChild(el);
    }

    const first = new Date(Y, M, 1);
    const last  = new Date(Y, M+1, 0);
    const startPad = first.getDay(); // 0=Sun

    // pad
    for(let i=0;i<startPad;i++){
      const empty = document.createElement("div");
      empty.style.opacity = "0";
      miniCalGrid.appendChild(empty);
    }

    const todayKey = ymd(now);

    for(let day=1; day<=last.getDate(); day++){
      const date = new Date(Y, M, day);
      const key = ymd(date);
      const cell = document.createElement("div");
      cell.className = "miniCalCell" + (key===todayKey ? " today" : "");

      const d = document.createElement("div");
      d.className = "miniCalDay";
      d.textContent = String(day);

      const st = document.createElement("div");
      st.className = "miniCalStamp";
      st.textContent = stampsMap.get(key) || "";

      cell.appendChild(d);
      cell.appendChild(st);
      miniCalGrid.appendChild(cell);
    }
  }

  async function refreshMiniCalendar(){
    if(!currentUser) return;
    const now = new Date();
    const stamps = await loadMonthStamps(now.getFullYear(), now.getMonth());
    renderMiniCalendar(stamps);
  }

  // ====== ãƒŸãƒ‹åˆ†æï¼ˆå·¦ï¼‰ ======
  function statusBadgeInfo(ch){
    // 3æ—¥ã§çµ‚ãˆãŸï¼šcleared3 / 7æ—¥å®Œèµ°ï¼šcleared7 / ç¾åœ¨ï¼šactive / ãƒªã‚¿ã‚¤ã‚¢ï¼šretired
    const st = String(ch.status||"");
    const total = Number(ch.totalDays||BASE_CLEAR_DAYS);
    if(st==="active") return { text:"è‚²æˆä¸­", cls:"active", corner:"è‚²æˆä¸­", small:`${Number(ch.day||1)}/${total}` };
    if(st==="retired") return { text:"ãƒªã‚¿ã‚¤ã‚¢", cls:"retired", corner:"ãƒªã‚¿ã‚¤ã‚¢", small:`${Number(ch.day||1)}/${total}` };
    if(st==="cleared"){
      if(total>=EXTEND_TOTAL_DAYS) return { text:"è‚²æˆå®Œäº†", cls:"done7", corner:"å®Œäº†", small:"7" };
      return { text:"è‚²æˆå®Œäº†", cls:"done3", corner:"å®Œäº†", small:"3" };
    }
    if(st==="finished"){
      // å¤±æ•—çµ‚äº†æ‰±ã„
      return { text:"çµ‚äº†", cls:"retired", corner:"çµ‚äº†", small:`${total}` };
    }
    return { text:st, cls:"", corner:st, small:"" };
  }

  function renderMiniAnaCards(items){
    if(!miniAnaCards) return;
    miniAnaCards.innerHTML = "";
    const list = (items||[]).slice(0,3);

    for(const ch of list){
      const info = statusBadgeInfo(ch);
      const box = document.createElement("div");
      box.className = "miniCard";
      box.innerHTML = `
        <div class="miniCorner ${info.cls}">${info.small}</div>
        <p class="miniCardTitle">${escapeHtml(ch.habitTitle||"")}</p>
        <div class="miniCardSub">${escapeHtml(info.text)} / æˆåŠŸ ${Number(ch.successDays||0)} / ä¼‘ ${Number(ch.restDays||0)}</div>
      `;
      miniAnaCards.appendChild(box);
    }

    // è¶³ã‚Šãªã„åˆ†ã‚’ãƒ€ãƒŸãƒ¼
    for(let i=list.length;i<3;i++){
      const box = document.createElement("div");
      box.className = "miniCard";
      box.style.opacity = "0.35";
      box.innerHTML = `<p class="miniCardTitle">â€”</p><div class="miniCardSub">â€”</div>`;
      miniAnaCards.appendChild(box);
    }
  }

  async function refreshMiniAnalytics(){
    if(!currentUser) return;
    const all = await loadChallenges(60);
    // å„ªå…ˆï¼šactiveâ†’clearedâ†’retired ã®é †ã«æœ€è¿‘
    const pick = [
      ...all.filter(x=>x.status==="active"),
      ...all.filter(x=>x.status==="cleared"),
      ...all.filter(x=>x.status==="retired"),
      ...all.filter(x=>x.status==="finished"),
    ].slice(0,3);
    renderMiniAnaCards(pick);
  }

  if(miniAnaMore){
    miniAnaMore.addEventListener("click", ()=>{
      // navRecords ã‚’åˆ†æã¨ã—ã¦ä½¿ã†ï¼ˆPart1ã® showOnly ã‚’æ‹¡å¼µï¼‰
      if(navAna) navAna.click();
    });
  }

  // ====== showOnly æ‹¡å¼µï¼ˆPart1ã®é–¢æ•°ã‚’ä¸Šæ›¸ãã—ãŸããªã„ã®ã§ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰ ======
  // Part1 ã® showOnly ãŒå­˜åœ¨ã™ã‚‹ã¨ä»®å®šã—ã€åˆ†æãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚‹å ´åˆã ã‘åˆ‡æ›¿
  const _showOnly = (typeof showOnly === "function") ? showOnly : null;
  if(_showOnly && navAna && viewAnalytics){
    // navãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåã‚’å¤‰æ›´ï¼ˆè¦‹ãŸç›®ï¼‰
    const lbl = navAna.querySelector(".label");
    if(lbl) lbl.textContent = "åˆ†æ";

    navAna.addEventListener("click", ()=>{
      // Part1ã®showOnlyã‚’ç›´æ¥ã¯è§¦ã‚‰ãšã€æ‰‹å‹•ã§åˆ‡æ›¿
      // æ—¢å­˜ viewRecords ã¯ä½¿ã‚ãªã„æƒ³å®š
      viewHome.style.display = "none";
      viewTrain.style.display = "none";
      if(viewRecords) viewRecords.style.display = "none";
      viewBookmarks.style.display = "none";
      viewProfile.style.display = "none";
      viewAnalytics.style.display = "";

      navHome.classList.remove("active");
      navTrain.classList.remove("active");
      navRecords.classList.add("active");
      navBookmarks.classList.remove("active");
      navProfile.classList.remove("active");

      openPost.classList.remove("show");

      refreshAnalytics();
    });
  }

  // ====== Done ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šãƒœã‚¿ãƒ³ã‹ã‚‰æœ¬æ—¥é”æˆã¸é£›ã¶ ======
  function flyPlus(fromEl, toEl){
    if(!fromEl || !toEl) return;
    const a = fromEl.getBoundingClientRect();
    const b = toEl.getBoundingClientRect();

    const fx = document.createElement("div");
    fx.className = "flyPlus";
    fx.textContent = "+1";
    document.body.appendChild(fx);

    const sx = a.left + a.width/2;
    const sy = a.top + a.height/2;
    const tx = b.left + b.width/2;
    const ty = b.top + b.height/2;

    fx.style.left = `${sx}px`;
    fx.style.top  = `${sy}px`;

    // 1.2ç§’ãã‚‰ã„ã§åˆ°é”
    const dur = 1150;
    const t0 = performance.now();
    fx.style.opacity = "1";

    function easeOutCubic(x){ return 1 - Math.pow(1-x, 3); }

    function tick(t){
      const p = Math.max(0, Math.min(1, (t - t0) / dur));
      const e = easeOutCubic(p);
      const x = sx + (tx - sx) * e;
      const y = sy + (ty - sy) * e - (1 - e) * 22; // ãµã‚ã£ã¨ä¸Š
      fx.style.left = `${x}px`;
      fx.style.top  = `${y}px`;
      fx.style.transform = `translate(-50%,-50%) scale(${1 - p*0.25})`;
      fx.style.opacity = `${1 - p*0.15}`;

      if(p < 1) requestAnimationFrame(tick);
      else{
        fx.style.opacity = "0";
        setTimeout(()=> fx.remove(), 180);
      }
    }
    requestAnimationFrame(tick);
  }

  // ====== 3æ—¥ã‚¯ãƒªã‚¢2æŠãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ======
  let pendingChoice = null; // {habitId, chSnapshot}
  function openClearChoice(ch){
    pendingChoice = { habitId: ch.habitId, chSnapshot: ch };
    clearChoiceBg.classList.add("show");
  }
  function closeClearChoice(){
    pendingChoice = null;
    clearChoiceBg.classList.remove("show");
  }

  btnChoiceNew?.addEventListener("click", async ()=>{
    if(!pendingChoice) return;
    // 3æ—¥ã§çµ‚äº† â†’ status=cleared, totalDays=3ï¼ˆæ˜ç¤ºï¼‰
    const ref = doc(db, "userChallenges", currentUser.uid, "items", pendingChoice.habitId);
    await updateDoc(ref, { status:"cleared", totalDays: BASE_CLEAR_DAYS, updatedAt: serverTimestamp() });

    closeClearChoice();
    // å£ã‚³ãƒŸï¼ˆå¼·åˆ¶ã§ã¯ãªã„ãŒè¡¨ç¤ºï¼‰
    try{
      const snap = await getDoc(ref);
      const ch = snap.exists() ? { habitId: pendingChoice.habitId, ...snap.data() } : pendingChoice.chSnapshot;
      await maybePromptRating(pendingChoice.habitId, ch, "finish");
    }catch(e){}

    await refreshActiveHabitIds();
    await refreshSideActive();
    await refreshHome();
    await refreshMiniCalendar();
    await refreshMiniAnalytics();
    if(viewAnalytics) await refreshAnalytics();
  });

  btnChoiceExtend?.addEventListener("click", async ()=>{
    if(!pendingChoice) return;
    // å»¶é•· â†’ totalDays=7, extended=trueï¼ˆdayã¯ãã®ã¾ã¾é€²è¡Œï¼‰
    const ref = doc(db, "userChallenges", currentUser.uid, "items", pendingChoice.habitId);
    await updateDoc(ref, { totalDays: EXTEND_TOTAL_DAYS, extended:true, updatedAt: serverTimestamp() });

    closeClearChoice();

    await refreshActiveHabitIds();
    await refreshSideActive();
    await refreshHome();
    await refreshMiniCalendar();
    await refreshMiniAnalytics();
    if(viewAnalytics) await refreshAnalytics();
  });

  // ====== applyReport ã‚’ â€œ3æ—¥åŸºæº–+å»¶é•·â€ ã«å¯¾å¿œã•ã›ã‚‹ï¼ˆPart1é–¢æ•°ã‚’å·®ã—æ›¿ãˆï¼‰ ======
  // Part1ã§ applyReport ãŒå®šç¾©æ¸ˆã¿æƒ³å®š â†’ ã“ã“ã§ä¸Šæ›¸ãã—ã¾ã™
  const _applyReport = (typeof applyReport === "function") ? applyReport : null;

  async function applyReport(ch, payload){
    const today = ymd(new Date());
    const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    const cur = snap.data();

    // 1æ—¥1å›åˆ¶é™
    if((payload.type==="done" || payload.type==="rest") && String(cur.lastActionYMD||"") === today){
      return;
    }

    const totalDays = Math.max(1, Number(cur.totalDays||BASE_CLEAR_DAYS));
    const dayNow = Math.max(1, Number(cur.day||1));

    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šdone ã®ã¨ãã ã‘ï¼ˆæŠ¼ã—ãŸç¬é–“ã«é£›ã°ã™ï¼‰
    if(payload.type==="done"){
      // ã©ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æŠ¼ã—ãŸã‹ã‚’ç‰¹å®šï¼ˆsideActiveã® â€œã‚„ã£ãŸâ€ ãƒœã‚¿ãƒ³ï¼‰
      // payload._fromEl ãŒæ¸¡ã•ã‚ŒãŸã‚‰ãã‚Œã‚’ä½¿ã†ï¼ˆä¸‹ã§æ¸¡ã™ï¼‰
      try{ flyPlus(payload._fromEl, todayDoneBadge); }catch(e){}
    }

    const update = {};

    if(payload.type==="done"){
      update.successDays = Number(cur.successDays||0) + 1;
      update.day = Math.min(totalDays + 1, dayNow + 1);
      update.lastActionYMD = today;
      update.streakMiss = 0;

      const d = cur.difficulty || {easy:0,mid:0,hard:0};
      d[payload.diff] = Number(d[payload.diff]||0)+1;
      update.difficulty = d;

      // ä»Šæ—¥ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆé›£æ˜“åº¦çµµæ–‡å­—ã‚’ãã®ã¾ã¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ï¼‰
      const stamp = payload.diff==="easy" ? "ğŸ˜Š" : payload.diff==="mid" ? "ğŸ™‚" : "ğŸ˜…";
      await setTodayStamp(stamp);

      await incDailyDoneCount();
      await addXp(12);

    }else if(payload.type==="rest"){
      update.restDays = Number(cur.restDays||0) + 1;
      update.day = Math.min(totalDays + 1, dayNow + 1);
      update.lastActionYMD = today;
      update.streakMiss = 0;

      // ä¼‘ã¿ã‚‚ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆè–„ãğŸ™‚ã«çµ±ä¸€ï¼‰
      await setTodayStamp("ğŸ™‚");

      await addXp(3);

    }else if(payload.type==="retire"){
      update.status = "retired";
      update.updatedAt = serverTimestamp();
      await updateDoc(ref, update);

      await maybePromptRating(ch.habitId, { ...cur, habitId: ch.habitId }, "retire");
      await refreshActiveHabitIds();
      await refreshSideActive();
      await refreshHome();
      await refreshMiniCalendar();
      await refreshMiniAnalytics();
      if(viewAnalytics) await refreshAnalytics();
      await refreshTrain();
      return;
    }

    update.updatedAt = serverTimestamp();
    await updateDoc(ref, update);

    // ===== çµ‚äº†åˆ¤å®š =====
    if(payload.type==="done" || payload.type==="rest"){
      const nextDay = Math.min(totalDays + 1, dayNow + 1);

      // 3æ—¥ç›®ï¼ˆBASE_CLEAR_DAYSï¼‰ã‚’çµ‚ãˆãŸç¬é–“ï¼šå¼·åˆ¶2æŠï¼ˆdoneã®æ™‚ã ã‘ã§OKï¼‰
      // dayNow==3 ã§ã¯ãªãã€Œæ¬¡DayãŒ4ã«ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ã‚’è¦‹ã‚‹ï¼ˆdone/restã©ã¡ã‚‰ã§ã‚‚åˆ°é”ã™ã‚‹ãŒã€ã“ã“ã¯doneå„ªå…ˆï¼‰
      if(totalDays===BASE_CLEAR_DAYS && nextDay===BASE_CLEAR_DAYS + 1){
        // ã¾ãš status ã¯ active ã®ã¾ã¾æ­¢ã‚ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠå¾…ã¡ï¼‰
        // day ã¯æ—¢ã« 4 ã«ãªã£ã¦ã‚‹ãŒã€UIä¸Šã¯ choice ã‚’å‡ºã—ã¦ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹
        const afterSnap = await getDoc(ref);
        const after = afterSnap.exists() ? { habitId: ch.habitId, ...afterSnap.data() } : { habitId: ch.habitId, ...cur, ...update };

        openClearChoice(after);

        // é¸æŠãŒçµ‚ã‚ã‚‹ã¾ã§æˆ»ã‚Œãªã„ï¼ˆèƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯é–‰ã˜ç¦æ­¢ï¼‰
        // â€»ã“ã“ã§ã¯ close ã‚’ç”¨æ„ã—ãªã„
      }

      // 7æ—¥å®Œèµ°ï¼šå¼·åˆ¶çµ‚äº†ï¼†å£ã‚³ãƒŸ
      if(totalDays>=EXTEND_TOTAL_DAYS && nextDay===EXTEND_TOTAL_DAYS + 1){
        // æˆåŠŸæ¡ä»¶ï¼šã¨ã‚Šã‚ãˆãšã€ŒæˆåŠŸæ—¥>=5ã€ç¶­æŒï¼ˆPart1ã¨åŒã˜ï¼‰
        const afterSuccess = Number(cur.successDays||0) + (payload.type==="done" ? 1 : 0);
        if(afterSuccess >= 5){
          await updateDoc(ref, { status:"cleared", totalDays: EXTEND_TOTAL_DAYS, updatedAt: serverTimestamp() });
          await runTransaction(db, async (tx)=>{
            const uref = doc(db, "users", currentUser.uid);
            const us = await tx.get(uref);
            if(!us.exists()) return;
            const u = us.data();
            tx.update(uref, { clearCount: Number(u.clearCount||0)+1, updatedAt: serverTimestamp() });
          });
        }else{
          await updateDoc(ref, { status:"finished", totalDays: EXTEND_TOTAL_DAYS, updatedAt: serverTimestamp() });
        }

        const finalSnap = await getDoc(ref);
        const finalCh = finalSnap.exists() ? { habitId: ch.habitId, ...finalSnap.data() } : { habitId: ch.habitId, ...cur };
        await maybePromptRating(ch.habitId, finalCh, "finish");
      }
    }

    await refreshActiveHabitIds();
    await refreshSideActive();
    await refreshHome();
    await refreshMiniCalendar();
    await refreshMiniAnalytics();
    if(viewAnalytics) await refreshAnalytics();
    await refreshTrain();
  }

  // ====== sideActive ã® â€œã‚„ã£ãŸâ€ ã‹ã‚‰ applyReport ã¸æŠ¼ã—ãŸè¦ç´ ã‚’æ¸¡ã™ ======
  // Part1ã® refreshSideActive ã‚’å·®ã—æ›¿ãˆï¼ˆæœ€å°å¤‰æ›´ã§doneã« _fromEl ã‚’ä»˜ã‘ã‚‹ï¼‰
  const _refreshSideActive = (typeof refreshSideActive === "function") ? refreshSideActive : null;

  async function refreshSideActive(){
    if(!currentUser) return;

    const actives = await loadActiveChallenges();
    activeHabitIds = new Set(actives.map(x=>x.habitId));

    sideActiveList.innerHTML = "";

    if(countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      document.querySelectorAll("[data-care]").forEach(el=>{
        el.textContent = `æ¬¡ã®ãŠä¸–è©±ã¾ã§ ${fmtCountdown(msToMidnight())}`;
      });
      if(trainCare) trainCare.textContent = `æ¬¡ã®ãŠä¸–è©±ã¾ã§ ${fmtCountdown(msToMidnight())}`;

      if(msToMidnight() < 900){
        refreshDailyDoneCount();
        refreshSideActive();
        refreshHome();
        refreshTrain();
      }else{
        refreshTrain();
      }
    }, 1000);

    for(const ch of actives){
      const box = document.createElement("div");
      box.className = "sideItem";

      const can = canCareToday(ch);
      const care = `æ¬¡ã®ãŠä¸–è©±ã¾ã§ ${fmtCountdown(msToMidnight())}`;

      const totalDays = Math.max(1, Number(ch.totalDays||BASE_CLEAR_DAYS));
      const day = Math.max(1, Math.min(totalDays, Number(ch.day||1)));
      const prog = growthPctDynamic(ch); // è¦‹ãŸç›®ã ã‘ï¼ˆå†…éƒ¨ã¯å¾Œã§Part3ã§åˆã‚ã›ã‚‹ï¼‰

      const remain = Math.max(0, totalDays - day + 1);
      const remainText = `æ®‹ã‚Š${remain}æ—¥`;

      box.innerHTML = `
        <div class="sideTop">
          <div class="sideHabit">${escapeHtml(ch.habitTitle||"")}</div>
          <div class="sideMeta">${day}/${totalDays}</div>
        </div>

        <div class="sideTop" style="align-items:center">
          <div class="sideCare" data-care="1">${care}</div>
          <div class="sideMeta">${prog.toFixed(0)}% / ${remainText}</div>
        </div>

        <div class="sideBtns">
          <button class="btnMini" data-act="done" ${can ? "" : "disabled"}>ã‚„ã£ãŸ</button>
          <button class="btnMini" data-act="rest" ${can ? "" : "disabled"}>ä¼‘ã‚€</button>
          <button class="btnMini" data-act="retire">ãƒªã‚¿ã‚¤ã‚¢</button>
          <button class="btnMini" data-act="rate" ${ch.ratingSubmitted ? "disabled" : ""}>è©•ä¾¡</button>
        </div>
      `;

      const doneBtn = box.querySelector('[data-act="done"]');
      doneBtn.addEventListener("click", ()=> openDiffModal(ch, doneBtn));

      box.querySelector('[data-act="rest"]').addEventListener("click", ()=> applyReport(ch, { type:"rest" }));
      box.querySelector('[data-act="retire"]').addEventListener("click", async ()=>{
        if(!confirm("ãƒªã‚¿ã‚¤ã‚¢ï¼Ÿ")) return;
        await applyReport(ch, { type:"retire" });
      });
      box.querySelector('[data-act="rate"]').addEventListener("click", async ()=>{
        await openRatingModalByChallenge(ch, "manual");
      });

      sideActiveList.appendChild(box);
    }
  }

  // diffModalï¼šopenDiffModal ã‚’å°‘ã—æ”¹é€ ã—ã¦ â€œæŠ¼ã—ãŸãƒœã‚¿ãƒ³è¦ç´ â€ ã‚’è¦šãˆã‚‹
  let diffFromEl = null;
  const _openDiffModal = (typeof openDiffModal === "function") ? openDiffModal : null;

  function openDiffModal(ch, fromEl){
    diffTargetChallenge = ch;
    diffFromEl = fromEl || null;
    diffTitle.textContent = ch.habitTitle || "é›£æ˜“åº¦";
    diffBg.classList.add("show");
  }

  // diffé¸æŠ â†’ applyReport ã« _fromEl ã‚’æ¸¡ã™
  diffBg.querySelectorAll("[data-diff]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      if(!diffTargetChallenge) return;
      await applyReport(diffTargetChallenge, { type:"done", diff: btn.dataset.diff, _fromEl: diffFromEl });
      closeDiffModal();
      diffFromEl = null;
    });
  });

  // ====== ç¿’æ…£ã‚«ãƒ¼ãƒ‰ã® â€œ4ã¤æŒ‡æ¨™â€ ã‚’è¿½åŠ ï¼ˆå‚åŠ è€…/è©•ä¾¡/å¹³å‡æ—¥æ•°/æˆåŠŸç‡ï¼‰ ======
  // Part1ã® renderHabitCard ã‚’å·®ã—æ›¿ãˆï¼ˆoverlayã¯å‰Šé™¤æ¸ˆã¿ï¼‰
  const _renderHabitCard = (typeof renderHabitCard === "function") ? renderHabitCard : null;

  function renderHabitCard(h){
    const card = document.createElement("div");
    card.className = "habitCard";

    const isMine = h.creatorUid === currentUser.uid;
    const bookmarked = cachedBookmarks.has(h.id);
    const creatorFav = cachedFavCreators.has(h.creatorUid);
    const isActive = activeHabitIds.has(h.id);

    const avgRating = Number(h.avgRating||0);
    const ratingCount = Number(h.ratingCount||0);
    const participants = Number(h.participantsCount||0);

    const createdAtStr = String(h.createdAtYMD||"") || "";

    const avgDays = Math.max(0, Math.min(14, Number(h.avgDays||0)));
    const successRate = Math.max(0, Math.min(100, Number(h.successRate||0)));

    applyCatVars(card, h.category);

    // ä½™ç™½ã‚’è©°ã‚ãŸã€Œ4ã¤æŒ‡æ¨™ã€
    card.innerHTML = `
      <div class="thumb">
        <div class="mascotBg">${escapeHtml(mascotEmojiFromHabitId(h.id))}</div>

        <p class="thumbTitle">${escapeHtml(h.title||"")}</p>
        <div class="thumbAction">${escapeHtml(h.action||"")}</div>

        <div class="thumbActions">
          <button class="iconBtn tipBtn reviewBtn" data-act="reviews" data-tip="å£ã‚³ãƒŸ">
            ${bubbleSvg()}
            <span class="badgeCount">${Math.min(99, ratingCount)}</span>
          </button>

          <button class="iconBtn tipBtn ${bookmarked ? "on":""}" data-act="bookmark" data-tip="ä¿å­˜">
            ${bookmarkSvg(bookmarked)}
          </button>

          ${isMine
            ? `<button class="joinBtn tipBtn activeMode" data-act="edit" data-tip="ç·¨é›†">ç·¨é›†</button>`
            : `<button class="joinBtn tipBtn ${isActive ? "activeMode":""}" data-act="join" data-tip="${isActive ? "è‚²æˆä¸­" : "å‚åŠ "}">${isActive ? "è‚²æˆä¸­" : "å‚åŠ "}</button>`
          }
        </div>
      </div>

      <div class="metaBar">
        <div class="creatorCol">
          <div class="miniAva" data-act="creator">${h.creatorPhoto ? `<img src="${escapeHtml(h.creatorPhoto)}" alt="">` : "â–¡"}</div>
          <div class="creatorText">
            <div class="creatorName" data-act="creator">${escapeHtml(h.creatorName||"ä½œæˆè€…")}</div>
            <button class="followSmall ${creatorFav ? "on":""}" data-act="follow">ãƒ•ã‚©ãƒ­ãƒ¼</button>
          </div>
        </div>

        <div class="statsRow">
          <div class="statLine">
            <span class="statPill">å‚åŠ è€… ${participants}</span>
            <span class="statPill">è©•ä¾¡ ${avgRating ? avgRating.toFixed(1) : "â€”"}</span>
            <span class="statPill">å¹³å‡æ—¥æ•° ${avgDays ? avgDays.toFixed(1) : "â€”"}</span>
            <span class="statPill">æˆåŠŸç‡ ${Number.isFinite(successRate) ? successRate.toFixed(0) : "â€”"}%</span>
          </div>
        </div>

        <div class="createdAt">${escapeHtml(createdAtStr)}</div>
      </div>
    `;

    // ã‚¯ãƒªãƒƒã‚¯é¡ï¼ˆPart1ã¨åŒæ§˜ï¼‰
    card.addEventListener("pointerdown", ()=> card.classList.add("pressing"));
    card.addEventListener("pointerup", ()=> card.classList.remove("pressing"));
    card.addEventListener("pointercancel", ()=> card.classList.remove("pressing"));
    card.addEventListener("pointerleave", ()=> card.classList.remove("pressing"));

    card.querySelectorAll('[data-act="creator"]').forEach(el=>{
      el.addEventListener("click", ()=> openCreatorModal(h.creatorUid, h.creatorName, h.creatorPhoto, h.creatorColor));
    });

    card.querySelector('[data-act="follow"]').addEventListener("click", async (e)=>{
      e.stopPropagation();
      await toggleCreatorFav(h.creatorUid);
    });

    card.querySelector('[data-act="bookmark"]').addEventListener("click", async (e)=>{
      e.stopPropagation();
      await toggleBookmark(h.id);
    });

    card.querySelector('[data-act="reviews"]').addEventListener("click", async (e)=>{
      e.stopPropagation();
      await openRatingsViewer(h.id);
    });

    const joinBtn = card.querySelector('[data-act="join"]');
    if(joinBtn) joinBtn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      if(isActive) return;
      await startChallenge(h);
    });

    const editBtn = card.querySelector('[data-act="edit"]');
    if(editBtn) editBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      alert("ç·¨é›†ã¯æ¬¡æ®µéšã§ã€‚ä»Šã¯è‡ªåˆ†ã®æŠ•ç¨¿ã¯å‚åŠ ãŒå‡ºãªã„çŠ¶æ…‹ã§ã™ã€‚");
    });

    return card;
  }

  // ====== startChallengeï¼štotalDays=3ã§é–‹å§‹ ======
  const _startChallenge = (typeof startChallenge === "function") ? startChallenge : null;

  async function startChallenge(h){
    const actives = await loadActiveChallenges();
    if(actives.length >= 3){ alert("ä¾é ¼ã¯æœ€å¤§3"); return; }
    if(h.creatorUid === currentUser.uid){ return; }

    const today = ymd(new Date());
    const ref = doc(db, "userChallenges", currentUser.uid, "items", h.id);
    const snap = await getDoc(ref);
    if(snap.exists() && snap.data()?.status === "active") return;

    await setDoc(ref, {
      habitId: h.id,
      habitTitle: h.title || "",
      creatorUid: h.creatorUid || "",
      status: "active",
      startDate: today,
      day: 1,
      totalDays: BASE_CLEAR_DAYS,
      extended: false,
      successDays: 0,
      restDays: 0,
      lastActionYMD: "",
      streakMiss: 0,
      difficulty: { easy:0, mid:0, hard:0 },
      ratingSubmitted: false,
      updatedAt: serverTimestamp()
    });

    // participants + totalChallenges ã¯Part1ã¨åŒã˜
    await runTransaction(db, async (tx)=>{
      const href = doc(db, "habits", h.id);
      const hs = await tx.get(href);
      if(!hs.exists()) return;
      const cur = hs.data();
      tx.update(href, { participantsCount: Number(cur.participantsCount||0)+1, updatedAt: serverTimestamp() });
    });

    await runTransaction(db, async (tx)=>{
      const uref = doc(db,"users",currentUser.uid);
      const us = await tx.get(uref);
      if(!us.exists()) return;
      const u = us.data();
      tx.update(uref, { totalChallenges: Number(u.totalChallenges||0)+1, updatedAt: serverTimestamp() });
    });

    await refreshActiveHabitIds();
    await refreshSideActive();
    await refreshHome();
    await refreshMiniCalendar();
    await refreshMiniAnalytics();
    if(viewAnalytics) await refreshAnalytics();
    await refreshProfile();
    await refreshTrain();
  }

  // ====== ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆåˆå›ã ã‘ï¼‰ ======
  const ONB_KEY = "onboardingDone_v1";
  const onbPages = [
    {
      h:"5åˆ†ã®ç¿’æ…£ã‚’ã€æ¥½ã—ãæ¢ã™ã€‚",
      p:"ã¿ã‚“ãªã®æŠ•ç¨¿ã‹ã‚‰é¸ã‚“ã§ã€è‡ªåˆ†ã«åˆã†â€œç¶šãã‚„ã¤â€ã ã‘æ®‹ãã†ã€‚",
      art:"ğŸ—‚ï¸  ãƒŸãƒ‹ã‚«ãƒ¼ãƒ‰ãŒä¸¦ã¶\nãƒ»æ·±å‘¼å¸\nãƒ»æœºãƒªã‚»ãƒƒãƒˆ\nãƒ»è‹±å˜èª3ã¤"
    },
    {
      h:"3æ—¥ã§ã‚¯ãƒªã‚¢ã§ã‚‚OKã€‚",
      p:"åˆã‚ãªã‹ã£ãŸã‚‰å’æ¥­ã—ã¦æ¬¡ã¸ã€‚ç¶šã‘ã‚‰ã‚Œãªã„è‡ªåˆ†ã‚’è²¬ã‚ãªã„ä»•çµ„ã¿ã€‚",
      art:"ğŸ—“ï¸  3ãƒã‚¹åŸ‹ã¾ã‚‹ â†’ CLEAR!\nâ†’ æ¬¡ã®ç¿’æ…£ã¸"
    },
    {
      h:"å£ã‚³ãƒŸã¨æ•°å­—ã§ã€é¸ã³ã‚„ã™ã„ã€‚",
      p:"è©•ä¾¡ãƒ»å‚åŠ è€…ãƒ»å¹³å‡æ—¥æ•°ãƒ»æˆåŠŸç‡ã‚’è¦‹ã¦ã€ãƒã‚ºãƒ¬ã‚’æ¸›ã‚‰ã—ã¦é¸ã¹ã‚‹ã€‚",
      art:"ğŸ‘¥ å‚åŠ è€… 128\nâ­ è©•ä¾¡ 4.3\nğŸ“… å¹³å‡æ—¥æ•° 5.2\nâœ… æˆåŠŸç‡ 62%"
    },
    {
      h:"ç¶šã‘ã‚‹ã¨ã€è‚²ã¤ã€‚é›†ã¾ã‚‹ã€‚",
      p:"æŒ‘æˆ¦ã§ã‚­ãƒ£ãƒ©ãŒè‚²ã¤ã€‚æŠ•ç¨¿ã‚’ã¾ã¨ã‚ã¦â€œè‡ªåˆ†ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼â€ã‚‚ä½œã‚Œã‚‹ã€‚",
      art:"ğŸ¥š â†’ ğŸ£ â†’ ğŸ‘‘\næŠ•ç¨¿ã§ä¸–ç•ŒãŒå¢—ãˆã‚‹ï¼ˆSNSå‹ï¼‰"
    },
  ];
  let onbIndex = 0;

  function renderOnb(){
    const pg = onbPages[onbIndex];
    onbH.textContent = pg.h;
    onbP.textContent = pg.p;
    onbArt.textContent = pg.art;

    onbDots.innerHTML = "";
    for(let i=0;i<onbPages.length;i++){
      const d = document.createElement("div");
      d.className = "dot" + (i===onbIndex ? " on":"");
      onbDots.appendChild(d);
    }

    onbBack.disabled = onbIndex===0;
    onbNext.textContent = (onbIndex===onbPages.length-1) ? "ã¯ã˜ã‚ã‚‹" : "æ¬¡ã¸";
  }

  function openOnb(){
    onbIndex = 0;
    renderOnb();
    onbBg.classList.add("show");
  }
  function closeOnb(){
    onbBg.classList.remove("show");
  }

  onbSkip?.addEventListener("click", ()=>{
    localStorage.setItem(ONB_KEY, "true");
    closeOnb();
  });
  onbBack?.addEventListener("click", ()=>{
    onbIndex = Math.max(0, onbIndex-1);
    renderOnb();
  });
  onbNext?.addEventListener("click", ()=>{
    if(onbIndex===onbPages.length-1){
      localStorage.setItem(ONB_KEY, "true");
      closeOnb();
      // 1å›ã‚¬ã‚¤ãƒ‰ï¼ˆè»½ãï¼‰ï¼šä»Šå›ã¯çœç•¥ï¼ˆPart3ã§è¿½åŠ å¯ï¼‰
      return;
    }
    onbIndex = Math.min(onbPages.length-1, onbIndex+1);
    renderOnb();
  });

  // ====== afterLoginWarm ã®æœ€å¾Œã§ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‡ºã™ï¼ˆåˆå›ã®ã¿ï¼‰ ======
  const _afterLoginWarm = (typeof afterLoginWarm === "function") ? afterLoginWarm : null;
  async function afterLoginWarm(){
    await warmCaches();
    await autoRetireIfMissed();
    await ensureDailyStatsDoc();
    await refreshDailyDoneCount();

    await refreshActiveHabitIds();
    await refreshSideActive();
    await refreshHome();
    await refreshBookmarksView();
    await refreshProfile();
    await refreshTrain();

    await refreshMiniCalendar();
    await refreshMiniAnalytics();

    if(viewAnalytics) await refreshAnalytics();

    // åˆå›ã ã‘
    const done = localStorage.getItem(ONB_KEY)==="true";
    if(!done){
      openOnb();
    }
  }

  // ====== åˆ†æãƒšãƒ¼ã‚¸ï¼ˆå³ï¼‰ ======
  function drawBars(canvas, series){
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;

    ctx.clearRect(0,0,w,h);

    const pad = 18 * devicePixelRatio;
    const innerW = w - pad*2;
    const innerH = h - pad*2;

    const days = series.days || [];
    const done = series.done || [];
    const rest = series.rest || [];
    const miss = series.miss || [];

    const maxV = Math.max(1, ...done, ...rest, ...miss);

    // è»¸
    ctx.globalAlpha = 1;
    ctx.lineWidth = 1 * devicePixelRatio;
    ctx.strokeStyle = "#e6e6e6";
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, pad+innerH);
    ctx.lineTo(pad+innerW, pad+innerH);
    ctx.stroke();

    // æ£’ï¼ˆ3ç³»åˆ—ã‚’ä¸¦ã¹ã‚‹ï¼šdone/rest/missï¼‰
    const n = days.length;
    if(n===0) return;
    const groupW = innerW / n;
    const barW = Math.max(2*devicePixelRatio, groupW * 0.20);

    for(let i=0;i<n;i++){
      const x0 = pad + groupW*i + groupW*0.18;
      const baseY = pad + innerH;

      const vals = [
        { v: done[i]||0, c:"#111" },
        { v: rest[i]||0, c:"#777" },
        { v: miss[i]||0, c:"#e00000" },
      ];

      for(let k=0;k<vals.length;k++){
        const v = vals[k].v;
        const bh = (v/maxV) * innerH;
        const x = x0 + k*(barW*1.25);
        ctx.fillStyle = vals[k].c;
        ctx.fillRect(x, baseY - bh, barW, bh);
      }
    }
  }

  function drawLines(canvas, lines){
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.clearRect(0,0,w,h);

    const pad = 18 * devicePixelRatio;
    const innerW = w - pad*2;
    const innerH = h - pad*2;

    // è»¸
    ctx.lineWidth = 1 * devicePixelRatio;
    ctx.strokeStyle = "#e6e6e6";
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, pad+innerH);
    ctx.lineTo(pad+innerW, pad+innerH);
    ctx.stroke();

    const series = lines.series || []; // [{name, points:[0..1], color?}]
    if(series.length===0) return;

    // 0..1 ã‚’ 0..100 ã¨ã—ã¦æã
    const n = Math.max(2, ...series.map(s=>s.points.length));
    const stepX = innerW / (n-1);

    for(let si=0; si<series.length; si++){
      const s = series[si];
      // è‰²ã¯å›ºå®šã—ãªã„ï¼ˆè¦æœ›ã«æ²¿ã„ã€ã“ã“ã¯ç·šè‰²ã‚’å°‘ã—å¤‰ãˆãŸã„ãŒâ€¦ï¼‰
      // â†’ ä»£ã‚ã‚Šã« alpha ã¨ç·šå¹…ã§åŒºåˆ¥ï¼ˆè‰²æŒ‡å®šãªã—ï¼‰
      ctx.globalAlpha = 0.85 - si*0.08;
      ctx.lineWidth = (2.2 - si*0.15) * devicePixelRatio;
      ctx.strokeStyle = "#111"; // è‰²ã¯åŒä¸€ï¼ˆæŒ‡å®šå›é¿ï¼‰
      ctx.beginPath();
      for(let i=0;i<s.points.length;i++){
        const px = pad + stepX*i;
        const py = pad + innerH - (Math.max(0,Math.min(1,s.points[i])) * innerH);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.stroke();
    }
    ctx.globalAlpha = 1;
  }

  function computeInsights(challs){
    // ç›´è¿‘30ä»¶ã‹ã‚‰ï¼š
    // - ã‚«ãƒ†ã‚´ãƒªåˆ¥æˆåŠŸç‡ï¼ˆæˆåŠŸæ—¥/(æˆåŠŸ+ä¼‘) ã–ã£ãã‚Šï¼‰
    // - è‹¦æ‰‹ã‚«ãƒ†ã‚´ãƒªï¼ˆæˆåŠŸç‡ä½ã„ï¼‰
    // - å¾—æ„æŠ•ç¨¿è€…ï¼ˆæˆåŠŸç‡é«˜ã„ creatorUid ä¸Šä½ï¼‰
    const byCat = new Map();
    const byCreator = new Map();

    for(const ch of challs){
      const cat = String(ch.category||"ãã®ä»–");
      const done = Number(ch.successDays||0);
      const rest = Number(ch.restDays||0);
      const den = Math.max(1, done + rest);
      const rate = done / den;

      byCat.set(cat, (byCat.get(cat)||[]).concat(rate));

      const uid = String(ch.creatorUid||"");
      if(uid){
        byCreator.set(uid, (byCreator.get(uid)||[]).concat(rate));
      }
    }

    function avg(arr){ return arr.reduce((a,b)=>a+b,0) / Math.max(1, arr.length); }

    let worstCat = null;
    let worstVal = 1;
    for(const [k,arr] of byCat.entries()){
      const v = avg(arr);
      if(v < worstVal){ worstVal = v; worstCat = k; }
    }

    let bestCreator = null;
    let bestVal = 0;
    for(const [k,arr] of byCreator.entries()){
      const v = avg(arr);
      if(arr.length>=2 && v > bestVal){ bestVal = v; bestCreator = k; }
    }

    return { worstCat, worstVal, bestCreator, bestVal };
  }

  async function refreshAnalytics(){
    if(!currentUser || !viewAnalytics) return;

    const all = await loadChallenges(120);

    // æœ€è¿‘ã®ã‚«ãƒ¼ãƒ‰ï¼šactive/cleared/retired/finished ã‚’æ··ãœã¦æœ€æ–°é †
    const recent = all.slice(0,12);

    if(anaBadge){
      const a = all.filter(x=>x.status==="active").length;
      const c = all.filter(x=>x.status==="cleared").length;
      const r = all.filter(x=>x.status==="retired").length;
      anaBadge.textContent = `è‚²æˆä¸­ ${a} / å®Œäº† ${c} / ãƒªã‚¿ã‚¤ã‚¢ ${r}`;
    }

    if(anaRecentGrid){
      anaRecentGrid.innerHTML = "";
      for(const ch of recent){
        const info = statusBadgeInfo(ch);
        const el = document.createElement("div");
        el.className = "miniCard";
        el.innerHTML = `
          <div class="miniCorner ${info.cls}">${info.small}</div>
          <p class="miniCardTitle">${escapeHtml(ch.habitTitle||"")}</p>
          <div class="miniCardSub">${escapeHtml(info.text)} / æˆåŠŸ ${Number(ch.successDays||0)} / ä¼‘ ${Number(ch.restDays||0)}</div>
        `;
        anaRecentGrid.appendChild(el);
      }
    }

    // æ—¥åˆ¥æ£’ï¼ˆç›´è¿‘14æ—¥ï¼‰ï¼šdone/rest/missï¼ˆmissã¯ streakMiss ã®åˆè¨ˆã£ã½ãï¼‰
    const days = [];
    const done = [];
    const rest = [];
    const miss = [];

    for(let i=13;i>=0;i--){
      const d = new Date();
      d.setDate(d.getDate()-i);
      const key = ymd(d);
      days.push(key);

      // stampãŒã‚ã‚‹ï¼ä½•ã‹ã—ãŸ ã¨ä»®å®šã—ã¦ done/rest ã‚’æ¨å®šã™ã‚‹ã®ã¯é›£ã—ã„ã®ã§
      // â†’ ç›´è¿‘ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã® lastActionYMD ã‚’é›†è¨ˆ
      let dn=0, rs=0, ms=0;
      for(const ch of all){
        if(String(ch.lastActionYMD||"").slice(0,10) === key){
          // difficultyã®ã©ã‚Œã‹å¢—ãˆã¦ã‚Œã° done ã¨ã¿ãªã™ï¼ˆé›‘ï¼‰
          const dif = ch.difficulty || {};
          const sumDif = Number(dif.easy||0)+Number(dif.mid||0)+Number(dif.hard||0);
          if(sumDif>0) dn++;
          else rs++;
        }
        ms += Number(ch.streakMiss||0) > 0 ? 0 : 0;
      }
      done.push(dn);
      rest.push(rs);
      miss.push(0);
    }

    drawBars(chartBars, { days, done, rest, miss });

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥æŠ˜ã‚Œç·šï¼šå„ã‚«ãƒ†ã‚´ãƒªã®æˆåŠŸç‡æ¨ç§»ï¼ˆç›´è¿‘ã«å‡ºãŸé †ã§ãƒã‚¤ãƒ³ãƒˆï¼‰
    // ç›´è¿‘30ä»¶ã‚’ã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã€å„ã‚«ãƒ†ã‚´ãƒªã® rate ã‚’é…åˆ—åŒ–ã—ã¦æã
    const recent30 = all.slice(0,30);
    const catMap = new Map();
    for(const ch of recent30){
      const cat = String(ch.category||"ãã®ä»–");
      const dn = Number(ch.successDays||0);
      const rs = Number(ch.restDays||0);
      const den = Math.max(1, dn+rs);
      const rate = dn/den;
      if(!catMap.has(cat)) catMap.set(cat, []);
      catMap.get(cat).push(rate);
    }
    const series = [];
    for(const [cat, pts] of catMap.entries()){
      series.push({ name: cat, points: pts.slice(0,10) }); // 10ç‚¹ã¾ã§
    }
    drawLines(chartLines, { series: series.slice(0,5) }); // å¤šã™ãã‚‹ã¨è¦‹ã«ãã„ã®ã§5ã‚«ãƒ†ã‚´ãƒªã¾ã§

    // æ°—ã¥ã
    const ins = computeInsights(recent30);
    if(insightBadge){
      insightBadge.textContent = `è‹¦æ‰‹: ${ins.worstCat||"â€”"} / å¾—æ„ä½œæˆè€…: ${ins.bestCreator ? "ã‚ã‚Š" : "â€”"}`;
    }
    if(insightBox){
      const t = [];
      if(ins.worstCat){
        t.push(`ãƒ»ã‚ãªãŸã¯ã€Œ${ins.worstCat}ã€ã§ãƒŸã‚¹ã‚Šã‚„ã™ã„ã‹ã‚‚ï¼ˆæ¨å®šæˆåŠŸç‡ ${(ins.worstVal*100).toFixed(0)}%ï¼‰`);
      }
      if(ins.bestCreator){
        t.push(`ãƒ»ç›¸æ€§ãŒè‰¯ã„ä½œæˆè€…ãŒã„ãã†ï¼ˆæ¨å®šæˆåŠŸç‡ ${(ins.bestVal*100).toFixed(0)}%ï¼‰`);
      }
      if(t.length===0) t.push("ãƒ»ãƒ‡ãƒ¼ã‚¿ãŒãŸã¾ã‚‹ã¨ã€è‹¦æ‰‹ã‚«ãƒ†ã‚´ãƒª/ç›¸æ€§ã®è‰¯ã„æŠ•ç¨¿ãŒå‡ºã¾ã™ã€‚");
      const box = insightBox.querySelector(".reviewText");
      if(box) box.textContent = t.join("\n");
    }
  }

  anaShowAll?.addEventListener("click", ()=>{
    alert("ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆå…¨ä»¶ãƒ•ã‚£ãƒ«ã‚¿/ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼‰ã¯ Part3 ã§å®Ÿè£…ã—ã¾ã™ã€‚");
  });

  // ====== afterLoginWarm/refreshç³»ã«ç´ã¥ã‘ ======
  // æ—¢ã« onAuthStateChanged å†…ã§ afterLoginWarm ã‚’å‘¼ã‚“ã§ã„ã‚‹æƒ³å®šãªã®ã§ã€
  // Part1å´ã® afterLoginWarm å‘¼ã³å‡ºã—ã¯ãã®ã¾ã¾ã€ã“ã®ä¸Šæ›¸ããŒåŠ¹ãã¾ã™ã€‚

  // ====== åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰åæ˜ ï¼‰ ======
  if(currentUser){
    refreshMiniCalendar();
    refreshMiniAnalytics();
  }

</script>

<!-- =========================
  PART2 ã“ã“ã¾ã§
  æ¬¡ã¯ Part3 ã‚’é€ã‚Šã¾ã™ï¼ˆæ®‹ã‚Šï¼šè‚²æˆ%/æ®‹æ—¥è¡¨ç¤ºã®å³å¯†åŒ–ã€Trainingç”»é¢ã®7æ—¥å¯¾å¿œã€åˆ†æãƒ©ãƒ³ã‚­ãƒ³ã‚°/è‹¦æ‰‹ã‚¿ã‚°/æˆåŠŸç‡é«˜ã„ã®ã«å¤±æ•—ã—ã‚„ã™ã„ä¸€è¦§ç­‰ã®è¿½åŠ ï¼‰
========================= --><!-- =========================
  PART 3 / 3
  â€»Part1ã®ã€Œä¸€ç•ªä¸‹ã€ã«ãã®ã¾ã¾è²¼ã‚Šè¶³ã—OKï¼ˆé‡è¤‡CSS/HTMLã¯ä¸Šæ›¸ãã™ã‚‹å‰æï¼‰
  â€»Part2ã§ã€Œanalysisãƒ“ãƒ¥ãƒ¼/ã‚ªãƒ³ãƒœ/3æ—¥2æŠã€ã‚’å…¥ã‚Œã¦ã„ã‚‹å‰æ
========================= -->

<style>
  /* ====== PART3 è¿½åŠ CSS ====== */

  /* Trainingï¼ˆè‚²æˆä¸­ï¼‰ã‚«ãƒ¼ãƒ‰å†…ï¼šé€²æ—ã‚’è¦‹ã‚„ã™ã */
  .sideMeta{font-family:var(--mono);}

  /* åˆ†æï¼šå…¨ä»¶ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .anaAllBg{
    position:fixed; inset:0;
    background: rgba(0,0,0,.42);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:200;
  }
  .anaAllBg.show{display:flex}
  .anaAllCard{
    width:min(860px, 100%);
    max-height:min(78vh, 720px);
    border:1px solid var(--line);
    border-radius: 16px;
    background:#fff;
    box-shadow: var(--shadow);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .anaAllTop{
    padding:12px 12px 10px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  .anaAllTitle{
    margin:0;
    font-weight:1100;
    letter-spacing:.05em;
    font-size:14px;
  }
  .anaAllSub{
    margin:6px 0 0;
    color:var(--muted);
    font-size:12px;
    font-family:var(--mono);
  }
  .anaAllClose{
    border:1px solid var(--line);
    background:#fff;
    border-radius: 12px;
    padding:10px 12px;
    font-weight:1100;
    cursor:pointer;
    white-space:nowrap;
  }
  .anaAllCtrls{
    padding:10px 12px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    border-bottom:1px solid var(--line);
  }
  .anaSel, .anaIn{
    border:1px solid var(--line);
    border-radius: 12px;
    padding:10px 12px;
    font-weight:1100;
    background:#fff;
    font-size:12px;
  }
  .anaIn{
    flex:1;
    min-width: 200px;
    font-weight:900;
  }
  .anaAllBody{
    padding:12px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .anaRowItem{
    border:1px solid var(--line);
    border-radius: 14px;
    background:#fff;
    box-shadow: var(--shadow);
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
  }
  .anaRowL{min-width:0;}
  .anaRowT{
    margin:0;
    font-weight:1100;
    font-size:13px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .anaRowM{
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .anaChip{
    border:1px solid var(--line);
    border-radius:999px;
    padding:6px 8px;
    font-family:var(--mono);
    font-size:11px;
    color:#111;
    background:#fff;
  }
  .anaRowR{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:6px;
    flex-shrink:0;
  }
  .anaTag{
    border:1px solid var(--line);
    border-radius:999px;
    padding:6px 8px;
    font-weight:1100;
    font-size:11px;
    background:#fff;
  }
  .anaBtn{
    border:1px solid var(--line);
    background:#fff;
    border-radius: 12px;
    padding:9px 10px;
    font-weight:1100;
    cursor:pointer;
    font-size:12px;
  }
</style>

<!-- ====== PART3 è¿½åŠ HTMLï¼šåˆ†æ å…¨ä»¶ãƒ¢ãƒ¼ãƒ€ãƒ« ====== -->
<div class="anaAllBg" id="anaAllBg" aria-hidden="true">
  <div class="anaAllCard">
    <div class="anaAllTop">
      <div style="min-width:0">
        <p class="anaAllTitle">åˆ†æï¼šå…¨ä»¶</p>
        <p class="anaAllSub" id="anaAllSub">â€”</p>
      </div>
      <button class="anaAllClose" id="anaAllClose">é–‰ã˜ã‚‹</button>
    </div>

    <div class="anaAllCtrls">
      <select class="anaSel" id="anaAllStatus">
        <option value="all">ã™ã¹ã¦</option>
        <option value="active">è‚²æˆä¸­</option>
        <option value="cleared">å®Œäº†</option>
        <option value="retired">ãƒªã‚¿ã‚¤ã‚¢</option>
        <option value="finished">çµ‚äº†</option>
      </select>

      <select class="anaSel" id="anaAllSort">
        <option value="recent">æ–°ã—ã„é †</option>
        <option value="rate">æˆåŠŸç‡ é«˜ã„é †</option>
        <option value="streak">ç¶™ç¶šæ—¥æ•°ï¼ˆsuccessï¼‰å¤šã„é †</option>
        <option value="rest">ä¼‘ã¿ å¤šã„é †</option>
      </select>

      <input class="anaIn" id="anaAllQ" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢ï¼ˆä¾‹ï¼šå‘¼å¸ / ç‰‡ä»˜ã‘ï¼‰" />
    </div>

    <div class="anaAllBody" id="anaAllBody"></div>
  </div>
</div>

<script type="module">
/* =========================
  PART3 / 3 è¿½åŠ JS
  â€»Part1ã®<script type="module">å†…ã«ã€Œè¿½è¨˜ã€ã§ã‚‚ã€æœ«å°¾ã«åˆ¥<script>ã§ã‚‚OK
========================= */

  // ====== DOM ======
  const anaAllBg = document.getElementById("anaAllBg");
  const anaAllBody = document.getElementById("anaAllBody");
  const anaAllClose = document.getElementById("anaAllClose");
  const anaAllStatus = document.getElementById("anaAllStatus");
  const anaAllSort = document.getElementById("anaAllSort");
  const anaAllQ = document.getElementById("anaAllQ");
  const anaAllSub = document.getElementById("anaAllSub");

  // Part2ã§å–ã£ã¦ã„ã‚‹ anaShowAll / miniAnaMore ãŒã‚ã‚Œã°ã€ãã‚Œã‚‚æ´»ç”¨
  // ï¼ˆç„¡ã‹ã£ãŸã‚‰ç„¡è¦–ã•ã‚Œã¾ã™ï¼‰
  //   const anaShowAll = document.getElementById("anaShowAll");
  //   const miniAnaMore = document.getElementById("miniAnaMore");

  // ====== é€²æ—% / æ®‹ã‚Šæ—¥ è¡¨ç¤ºã‚’ã€Œ3æ—¥/7æ—¥ã€ä¸¡å¯¾å¿œã§å³å¯†åŒ– ======

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function getTotalDays(ch){
    // totalDays ãŒç„¡ã„å¤ã„ãƒ‡ãƒ¼ã‚¿å¯¾ç­–ï¼š3æ—¥
    return Math.max(1, Number(ch.totalDays || 3));
  }

  function getDisplayDay(ch){
    const t = getTotalDays(ch);
    const d = Number(ch.day || 1);
    // day ã¯ã€Œæ¬¡ã®äºˆå®šæ—¥ã€ã‚’æŒ‡ã—ã¦é€²ã‚€ã“ã¨ãŒã‚ã‚‹ã®ã§ã€è¡¨ç¤ºã¯ 1..t ã«ä¸¸ã‚ã‚‹
    return clamp(d, 1, t);
  }

  function getRemainDays(ch){
    const t = getTotalDays(ch);
    const d = getDisplayDay(ch);
    return Math.max(0, t - d + 1);
  }

  function calcSuccessRate(ch){
    const done = Number(ch.successDays||0);
    const rest = Number(ch.restDays||0);
    const den = Math.max(1, done + rest);
    return done / den; // 0..1
  }

  function growthPctDynamic(ch){
    // é€²æ—ã¯ã€Œæ—¥æ•°ï¼ˆè¡¨ç¤ºdayï¼‰/totalDaysã€ã‚’ä¸»è»¸ã«ã—ã¤ã¤
    // doneç‡ãŒé«˜ã„ã»ã©å°‘ã—ä¸ŠæŒ¯ã‚Œï¼ˆè¦‹ãŸç›®ã®æ°—æŒã¡ã‚ˆã•ï¼‰
    const t = getTotalDays(ch);
    const d = getDisplayDay(ch);
    const base = d / t; // 0..1
    const rate = calcSuccessRate(ch); // 0..1
    const boost = (rate - 0.5) * 0.10; // -0.05..+0.05 ç¨‹åº¦
    return clamp((base + boost) * 100, 1, 100);
  }

  // ====== refreshSideActive ã‚’ã€Œæ®‹ã‚Šæ—¥/é€²æ—%ã€ã‚’å¿…ãšæ­£ã—ã„è¡¨ç¤ºã¸ä¸Šæ›¸ã ======
  // Part2ã§ refreshSideActive ã‚’ä¸Šæ›¸ãã—ã¦ã‚‹å‰æã ã‘ã©ã€
  // ã•ã‚‰ã«è¡¨ç¤ºéƒ¨åˆ†ã ã‘ã“ã“ã§ç¢ºå®Ÿã«è£œæ­£ã™ã‚‹ï¼ˆé–¢æ•°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç„¡è¦–ï¼‰
  const _refreshSideActive_part3 = (typeof refreshSideActive === "function") ? refreshSideActive : null;

  async function refreshSideActive(){
    // Part2ã® refreshSideActive ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ãªã‚‰ã€ãã®ã¾ã¾ä½¿ã†ã®ãŒä¸€ç•ªå®‰å…¨
    if(typeof _refreshSideActive_part3 === "function"){
      await _refreshSideActive_part3();

      // ãã®å¾Œã€æç”»æ¸ˆã¿DOMã® meta è¡¨ç¤ºã ã‘è£œæ­£ï¼ˆæœ€çµ‚ä¿é™ºï¼‰
      // sideActiveList å†…ã®å„ .sideItem ã‚’è¦‹ã¦ã€data-habitid ãŒç„¡ã‘ã‚Œã°è£œæ­£ã§ããªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—
      // â†’ Part2ã® sideItem ã¯ data ã‚’æŒã£ã¦ãªã„ã®ã§ã€ã“ã“ã§ã¯è£œæ­£ã—ãªã„ï¼ˆï¼Part2è¡¨ç¤ºã«ä»»ã›ã‚‹ï¼‰
      return;
    }
  }

  // ====== Trainingï¼ˆè‚²æˆä¸­ï¼‰ãƒ“ãƒ¥ãƒ¼ã‚‚ã€Œ3/7å¯¾å¿œã€ã«ã™ã‚‹ ======
  // Part1ã® refreshTrain ã«å¯„ã›ã‚‹ã‚ˆã‚Šã€Œè¡¨ç¤ºãƒ˜ãƒƒãƒ€ã ã‘ã€ç¢ºå®Ÿã«æ•´ãˆã‚‹
  const _refreshTrain = (typeof refreshTrain === "function") ? refreshTrain : null;

  async function refreshTrain(){
    if(typeof _refreshTrain === "function"){
      await _refreshTrain();
    }

    // ã‚‚ã— trainActiveList ãŒã‚ã‚‹ãªã‚‰ã€ãã“ã«é€²æ—ã‚’è¿½è¨˜/è£œæ­£ã—ãŸã„ãŒ
    // Part1ã®DOMæ§‹é€ ãŒä¸æ˜ãªã®ã§ã€ã“ã“ã§ã¯â€œã‚µãƒ–æ–‡è¨€ã ã‘â€æ›´æ–°ã™ã‚‹ã€‚
    // ï¼ˆå£Šã•ãªã„æ–¹é‡ï¼‰
    try{
      if(!currentUser) return;
      const actives = await loadActiveChallenges();
      if(trainBadge){
        const a = actives.length;
        trainBadge.textContent = a ? `è‚²æˆä¸­ ${a}/3` : "è‚²æˆä¸­ 0/3";
      }
    }catch(e){}
  }

  // ====== åˆ†æï¼šå…¨ä»¶ãƒ¢ãƒ¼ãƒ€ãƒ« ======
  let anaAllCache = []; // loadChallengesã®çµæœã‚’ä¿æŒ

  function statusLabel(st, totalDays){
    if(st==="active") return "è‚²æˆä¸­";
    if(st==="retired") return "ãƒªã‚¿ã‚¤ã‚¢";
    if(st==="finished") return "çµ‚äº†";
    if(st==="cleared"){
      return (Number(totalDays)>=7) ? "è‚²æˆå®Œäº†(7)" : "è‚²æˆå®Œäº†(3)";
    }
    return String(st||"â€”");
  }

  function openAnaAll(){
    anaAllBg.classList.add("show");
    renderAnaAll();
  }
  function closeAnaAll(){
    anaAllBg.classList.remove("show");
  }

  function sortAna(list, mode){
    const arr = list.slice();
    if(mode==="rate"){
      arr.sort((a,b)=> calcSuccessRate(b) - calcSuccessRate(a));
    }else if(mode==="streak"){
      arr.sort((a,b)=> Number(b.successDays||0) - Number(a.successDays||0));
    }else if(mode==="rest"){
      arr.sort((a,b)=> Number(b.restDays||0) - Number(a.restDays||0));
    }else{
      // recentï¼šloadChallenges ãŒæ–°ã—ã„é †ã®æƒ³å®šï¼ˆPart2ã¨åŒã˜ï¼‰
    }
    return arr;
  }

  function filterAna(list){
    const st = anaAllStatus.value;
    const q = (anaAllQ.value||"").trim().toLowerCase();

    return list.filter(ch=>{
      if(st!=="all" && String(ch.status||"")!==st) return false;
      if(q){
        const t = String(ch.habitTitle||"").toLowerCase();
        if(!t.includes(q)) return false;
      }
      return true;
    });
  }

  function renderAnaAll(){
    if(!anaAllBody) return;

    const base = anaAllCache || [];
    const filtered = filterAna(base);
    const sorted = sortAna(filtered, anaAllSort.value);

    anaAllSub.textContent = `ä»¶æ•° ${sorted.length} / å…¨ä½“ ${base.length}`;

    anaAllBody.innerHTML = "";
    if(sorted.length===0){
      const empty = document.createElement("div");
      empty.className = "review";
      empty.innerHTML = `<div class="reviewText">ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      anaAllBody.appendChild(empty);
      return;
    }

    for(const ch of sorted){
      const total = getTotalDays(ch);
      const day = getDisplayDay(ch);
      const remain = getRemainDays(ch);
      const rate = calcSuccessRate(ch);
      const prog = growthPctDynamic(ch);

      const row = document.createElement("div");
      row.className = "anaRowItem";

      const stLabel = statusLabel(ch.status, total);

      row.innerHTML = `
        <div class="anaRowL">
          <p class="anaRowT">${escapeHtml(ch.habitTitle||"")}</p>
          <div class="anaRowM">
            <span class="anaChip">${escapeHtml(stLabel)}</span>
            <span class="anaChip">day ${day}/${total}</span>
            <span class="anaChip">æ®‹ã‚Š ${remain}</span>
            <span class="anaChip">æˆåŠŸ ${Number(ch.successDays||0)}</span>
            <span class="anaChip">ä¼‘ã¿ ${Number(ch.restDays||0)}</span>
            <span class="anaChip">æˆåŠŸç‡ ${(rate*100).toFixed(0)}%</span>
            <span class="anaChip">é€²æ— ${prog.toFixed(0)}%</span>
          </div>
        </div>
        <div class="anaRowR">
          <span class="anaTag">${escapeHtml((ch.category||"")) || "â€”"}</span>
          <button class="anaBtn" data-act="jump">ã“ã®ç¿’æ…£ã‚’è¦‹ã‚‹</button>
        </div>
      `;

      row.querySelector('[data-act="jump"]').addEventListener("click", async ()=>{
        // æ—¢å­˜UIã®æ¤œç´¢æ¬„ã¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥ã‚Œã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã™ï¼ˆæœ€å°ã§è¿·å­é˜²æ­¢ï¼‰
        try{
          closeAnaAll();
          navHome?.click?.();
          if(searchIn){
            searchIn.value = ch.habitTitle || "";
            await refreshHome();
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        }catch(e){}
      });

      anaAllBody.appendChild(row);
    }
  }

  anaAllClose?.addEventListener("click", closeAnaAll);
  anaAllBg?.addEventListener("click", (e)=>{
    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    if(e.target === anaAllBg) closeAnaAll();
  });
  anaAllStatus?.addEventListener("change", renderAnaAll);
  anaAllSort?.addEventListener("change", renderAnaAll);
  anaAllQ?.addEventListener("input", ()=>{
    // å…¥åŠ›ä¸­ã¯è»½ãé–“å¼•ã
    clearTimeout(window.__anaQTimer);
    window.__anaQTimer = setTimeout(renderAnaAll, 120);
  });

  // Part2ã®ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å…¨ä»¶ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  try{
    const anaShowAll = document.getElementById("anaShowAll");
    const miniAnaMore = document.getElementById("miniAnaMore");

    anaShowAll?.addEventListener("click", openAnaAll);
    miniAnaMore?.addEventListener("click", openAnaAll);
  }catch(e){}

  // ====== refreshAnalytics ã§ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãŒæŠ¼ã›ã‚‹ã‚ˆã†ã«ï¼šcacheæ›´æ–° ======
  const _refreshAnalytics_part3 = (typeof refreshAnalytics === "function") ? refreshAnalytics : null;

  async function refreshAnalytics(){
    if(typeof _refreshAnalytics_part3 === "function"){
      await _refreshAnalytics_part3();
    }
    try{
      if(!currentUser) return;
      // å…¨ä»¶ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæœ€æ–°120ä»¶ï¼‰
      anaAllCache = await loadChallenges(120);
    }catch(e){}
  }

  // ====== èµ·å‹•æ™‚ï¼šãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ cache æ›´æ–° ======
  if(currentUser){
    // æ—¢å­˜ã®æç”»ã‚’å£Šã•ãªã„ç¯„å›²ã§ã€åˆ†æcacheã ã‘ç¢ºä¿
    try{
      anaAllCache = await loadChallenges(120);
    }catch(e){}
  }

  /* =========================
    ã“ã“ã¾ã§ã§å®Œäº†ï¼

    âœ… Part3ã§å…¥ã£ãŸã‚‚ã®
    - 3æ—¥/7æ—¥ã©ã¡ã‚‰ã§ã‚‚ã€Œé€²æ—%ã€ã€Œæ®‹ã‚Šæ—¥ã€ã€Œday/totalã€ã‚’æ­£ã—ãæ‰±ã†é–¢æ•°ç¾¤
    - åˆ†æã®ã€Œå…¨ä»¶ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ¤œç´¢ãƒ»ä¸¦ã³æ›¿ãˆãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµã‚Šè¾¼ã¿ï¼‰
    - ã€Œã“ã®ç¿’æ…£ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆãƒ›ãƒ¼ãƒ æ¤œç´¢ã¸ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰

    æ¬¡ã‚„ã‚‹ãªã‚‰ï¼ˆå¿…è¦ãªã‚‰è¨€ã£ã¦ï¼‰
    - ç¿’æ…£ã‚«ãƒ¼ãƒ‰ã®ã€Œå¹³å‡æ—¥æ•°/æˆåŠŸç‡ã€ã‚’ Firestore ã§è‡ªå‹•é›†è¨ˆï¼ˆratingé€ä¿¡æ™‚ãƒ»ã‚¯ãƒªã‚¢æ™‚ã«æ›´æ–°ï¼‰
    - åˆ†æã®â€œè‹¦æ‰‹ã‚«ãƒ†ã‚´ãƒªâ€ã‚’æœ¬å½“ã«ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¨ç§»ã§å‡ºã™ï¼ˆè‰²åˆ†ã‘/å‡¡ä¾‹ä»˜ãï¼‰
    - è‚²æˆã‚­ãƒ£ãƒ©ã®æˆé•·æ®µéšï¼ˆåµâ†’â€¦ï¼‰ã‚’ day ã¨ successRate ã«åˆã‚ã›ã¦å›ºå®šãƒ«ãƒ¼ãƒ«ã§å¤‰ãˆã‚‹
  ========================= */
</script>
