<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÁøíÊÖ£„Åï„Åå„Åó</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --line:#e6e6e6;
      --text:#111111;
      --muted:#7a7a7a;
      --muted2:#9a9a9a;

      --red:#e00000;
      --xpGreen:#00a86b;

      --r:14px;
      --gap:10px;
      --shadow: 0 4px 14px rgba(0,0,0,.06);
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      --catTint: #ffffff;
      --catLine: #e6e6e6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ===== Layout ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 310px 1fr;
      background:#fff;
    }

    @media (max-width: 980px){
      body{overflow:auto}
      .app{grid-template-columns: 92px 1fr; height:auto; min-height:100%}
      .nav{padding:10px 8px}
      .nav .label{display:none}
      .nav .brandName{display:none}
      .nav .navBtn{justify-content:center}
      .content{padding:12px}

      /* ‰æùÈ†ºÔºàÊåëÊà¶‰∏≠Ôºâ: Áã≠„ÅÑÊôÇ„ÅØÊäò„ÇäËøî„Åï„ÅöÁ∏ÆÂ∞è */
      .sideList{max-height: calc(100vh - 350px)}
      .sideItem{padding: 10px;border-radius: 12px;}
      .sideHabit{
        font-size: clamp(10px, 2.9vw, 13px);
        -webkit-line-clamp:1;
      }
      .sideMeta{font-size: clamp(10px, 2.6vw, 11px)}
      .btnMini{font-size: clamp(10px, 2.6vw, 11px); padding: 9px 10px}
    }

    /* ===== Left ===== */
    .nav{
      border-right:1px solid var(--line);
      padding:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:4px 6px 10px;
    }
    .logo{
      width:34px; height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      display:grid; place-items:center;
      font-weight:1000;
    }
    .brandName{
      font-size:14px;
      font-weight:1000;
      letter-spacing:.06em;
      white-space:nowrap;
    }

    .navBtn{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      transition:.12s transform, .12s background;
      user-select:none;
    }
    .navBtn:hover{transform: translateY(-1px); background:#fafafa}
    .navBtn.active{background:#f4f4f4}
    .navBtn .ico{width:26px; display:grid; place-items:center}
    .navBtn .label{font-weight:1000; letter-spacing:.03em}

    .sep{height:1px; background:var(--line); margin:6px 0}

    .userBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      display:flex; gap:10px; align-items:center;
      background:#fff;
      min-width:0;
      box-shadow: var(--shadow);
    }

    /* ===== Lv ring (avatar area) ===== */
    .lvRingWrap{
      width:44px; height:44px;
      position:relative;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .lvRingSvg{position:absolute; inset:0}
    .lvInner{
      width:32px; height:32px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      display:grid; place-items:center;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      color:#111;
      position:relative;
      z-index:2;
    }
    .xpPop{
      position:absolute;
      top:-10px;
      left:50%;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      font-family:var(--mono);
      font-weight:1100;
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      z-index:4;
      transition: opacity .2s ease, transform .2s ease;
      white-space:nowrap;
    }
    .xpPop.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    .userMeta{min-width:0}
    .userNameRow{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .userName{
      font-weight:1000; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 150px;
    }
    .followerMini{
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      font-family:var(--mono);
      font-size:11px;
      font-weight:1000;
      color:#111;
      background:#fff;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .userSmall{font-size:11px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* Small char list button near user card (ÁõÆÁ´ã„Åü„Å™„ÅÑ) */
    .charMiniRow{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      margin-top:8px;
    }
    .miniLinkBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      font-weight:1000;
      padding:7px 9px;
      cursor:pointer;
      font-size:11px;
      opacity:.85;
    }
    .miniLinkBtn:hover{background:#fafafa; opacity:1}

    .sideTitle{
      font-weight:1000;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.06em;
      padding: 2px 4px 0;
    }
    .sideList{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      padding-right:2px;
      max-height: calc(100vh - 365px);
    }
    .sideItem{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .sideTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      min-width:0;
    }
    .sideHabit{
      font-weight:1000;
      font-size:13px;
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-width:0;
    }
    .sideMeta{
      font-size:11px; color:var(--muted);
      font-family:var(--mono);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .sideCare{
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 8px;
      font-family:var(--mono);
      font-weight:1000;
      font-size:11px;
      color:#111;
      background:#fff;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .sideBtns{
      display:flex; gap:6px; flex-wrap:nowrap; justify-content:flex-end;
      overflow:hidden;
    }
    .btnMini{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:1000;
      user-select:none;
      white-space:nowrap;
    }
    .btnMini:hover{background:#fafafa}
    .btnMini:disabled{opacity:.6; cursor:not-allowed}

    /* ===== Main ===== */
    .content{
      height:100%;
      overflow:auto;
      padding:14px;
      position:relative;
      background:#fff;
    }
    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background:#fff;
      box-shadow: var(--shadow);
    }

    .headerBar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px;
      border-bottom:1px solid var(--line);
    }
    .hTitle{
      font-weight:1000;
      letter-spacing:.06em;
      font-size:18px; /* „Çø„Ç§„Éà„É´Â∞ë„ÅóÂ§ß„Åç„Åè */
      display:flex; align-items:center; gap:10px;
      white-space:nowrap;
      flex-wrap:wrap;
    }
    .hBadge{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      font-weight:1000;
      font-size:12px;
      font-family:var(--mono);
      background:#fff;
      white-space:nowrap;
    }

    /* ===== Tag ranking: ÂøÖ„ÅöÊ®™‰∏ÄÂàóÔºà2ÂàÜÂâ≤Âõ∫ÂÆöÔºâ ===== */
    .tagWrap{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .rankBox{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding:10px;
      box-shadow: var(--shadow);
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .rankTitle{
      font-size:13px;
      font-weight:1000;
      letter-spacing:.06em;
      color: #111;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0;
    }
    .rankGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
      align-items:stretch;
    }
    .rankChip{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:#fff;
      user-select:none;
      min-width:0;
    }
    .rankChip:hover{background:#fafafa}
    .rankChip.active{background:#f2f2f2}
    .rk{
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      flex:0 0 auto;
    }
    .tagName{
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    /* ===== Search row: Ê§úÁ¥¢„ÅØ‰∏ÄË¶ß„ÅÆ1„Å§‰∏ä ===== */
    .searchRow{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:8px;
      align-items:stretch;
      flex-wrap:nowrap;
    }
    @media (max-width: 980px){
      .searchRow{flex-wrap:wrap}
    }
    .searchBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:0 10px;
      background:#fff;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex: 1 1 auto;
      height:44px;
    }
    .searchInput{
      border:none;
      outline:none;
      font-size:14px;
      background:transparent;
      width:100%;
      min-width:0;
      height:100%;
    }
    .searchBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding:0 10px;
      cursor:pointer;
      font-weight:1000;
      white-space:nowrap;
      height:32px;
    }
    .searchBtn:hover{background:#fafafa}

    .ctrlBtn, .ctrlSel{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      height:44px;
      padding:0 10px;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      white-space:nowrap;
    }
    .ctrlSel{padding:0 8px}
    .ctrlBtn:hover, .ctrlSel:hover{background:#fafafa}

    /* ===== Feed ===== */
    .feedArea{padding:12px}
    .feedHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px 0;
    }
    .feedHeadLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .feedLabel{
      font-weight:1000;
      letter-spacing:.06em;
      color: var(--muted);
      font-size:12px;
      margin:0;
    }
    .countSmall{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-family:var(--mono);
      font-weight:1000;
      font-size:12px;
      color:#111;
    }

    /* ‰∏¶„Å≥ÊñπÔºöÁ∏¶‰∏ÄÂàóÂõ∫ÂÆö */
    .feedGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      align-items:stretch;
    }

    /* ===== Card ===== */
    .habitCard{
      border:1px solid var(--catLine);
      border-radius: 12px;
      background: linear-gradient(0deg, #fff 0%, #fff 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      min-width:0;
    }

    .thumb{
      aspect-ratio: 16 / 9;
      background: var(--catTint);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
      border-bottom:1px solid var(--catLine);
      user-select:none;
    }
    .thumbTitle{
      font-size:22px; /* Â∞ë„ÅóÂ§ß„Åç„Åè */
      font-weight:1100;
      letter-spacing:.02em;
      line-height:1.12;
      margin:0;
      text-align:center;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
      z-index:2;
    }
    .thumbAction{
      position:absolute;
      right:10px;
      bottom:8px;
      font-size:12px;
      color: var(--muted2);
      z-index:2;
      max-width: 70%;
      text-align:right;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    /* faint mascot behind */
    .mascotBg{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-size: 84px;
      opacity: .09;
      pointer-events:none;
      transform: translateY(8px);
      user-select:none;
      z-index:1;
    }

    .thumbActions{
      position:absolute;
      top:8px;
      right:8px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:3;
    }

    /* tooltip */
    .tipBtn{position:relative}
    .tipBtn[data-tip]::after{
      content: attr(data-tip);
      position:absolute;
      bottom: calc(100% + 6px);
      left:50%;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
      font-weight:1000;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease;
      z-index:10;
    }
    .tipBtn:hover::after{opacity:1; transform: translateX(-50%) translateY(-2px)}

    .iconBtn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius: 10px;
      padding:8px 9px;
      cursor:pointer;
      display:grid;
      place-items:center;
      min-width:38px;
      user-select:none;
    }
    .iconBtn:hover{background:#fafafa}
    .iconBtn.on{background:#111; color:#fff; border-color:#111}
    .iconBtn svg{display:block}

    .reviewBtn{position:relative;}
    .badgeCount{
      position:absolute;
      top:-6px;
      right:-6px;
      width:18px;
      height:18px;
      border-radius:999px;
      background: var(--red);
      color:#fff;
      font-family: var(--mono);
      font-size:11px;
      font-weight:1100;
      display:grid;
      place-items:center;
      border:2px solid #fff;
      pointer-events:none;
    }

    /* JOIN button: Â∞ë„ÅóÂ§ß„Åç„ÇÅ + ÂèÇÂä†=Ëµ§ / ËÇ≤Êàê‰∏≠=ÁôΩ */
    .joinBtn{
      border:1px solid var(--red);
      background: var(--red);
      color:#fff;
      border-radius: 12px;
      padding:12px 16px;
      cursor:pointer;
      font-weight:1000;
      min-width: 92px;
      user-select:none;
      font-size:14px;
    }
    .joinBtn:hover{filter:brightness(1.03)}
    .joinBtn.activeMode{
      background:#fff;
      color:var(--red);
    }
    .joinBtn:disabled{opacity:.6; cursor:not-allowed}

    /* Meta bar */
    .metaBar{
      padding:10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      min-height: 74px;
      background:#fff;
      position:relative;
    }
    .creatorCol{
      display:flex;
      gap:10px;
      min-width:0;
      align-items:flex-start;
    }
    .miniAva{
      width:28px; height:28px;
      border:1px solid var(--line);
      border-radius:50%;
      overflow:hidden;
      background:#fff;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      font-weight:1000;
      color:#111;
      cursor:pointer;
    }
    .miniAva img{width:100%; height:100%; object-fit:cover}

    .creatorText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    /* ÂêçÂâç„ÅÆ„Åô„ÅêÊ®™„Å´„Éï„Ç©„É≠„Éº„Éú„Çø„É≥ÔºàÂ∞è„Åï„ÇÅ„ÄÅÂêçÂâç„Åè„Çâ„ÅÑÔºâ */
    .creatorNameRow{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .creatorName{
      font-size:12px;
      font-weight:1100;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
      cursor:pointer;
      min-width:0;
    }
    .followMini{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding:5px 8px;
      font-weight:1100;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      flex:0 0 auto;
      font-family: var(--mono);
    }
    .followMini.on{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .statsRow{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      min-width:0;
    }
    .statLine{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .statPill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-family:var(--mono);
      font-weight:1000;
      font-size:12px;
      color:#111;
      white-space:nowrap;
    }

    /* createdAt right-bottom subtle */
    .createdAt{
      position:absolute;
      right:10px;
      bottom:8px;
      font-size:11px;
      color: rgba(0,0,0,.35);
      font-family: var(--mono);
      pointer-events:none;
    }

    /* Overlay */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.65);
      color:#fff;
      display:none;
      padding:12px;
      z-index: 20;
    }
    .habitCard:hover .overlay{display:block}
    .habitCard.pressing .overlay{display:block}
    .overlayInner{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:10px;
    }
    .ovTitle{
      font-weight:1100;
      letter-spacing:.06em;
      font-size:12px;
      opacity:.92;
    }
    .bar{
      border:1px solid rgba(255,255,255,.25);
      border-radius:999px;
      overflow:hidden;
      height:14px;
      background: rgba(255,255,255,.10);
    }
    .barFill{
      height:100%;
      width:0%;
      background:#fff;
      transition: width .15s ease;
    }
    .ovRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-family: var(--mono);
      font-weight:1100;
      font-size:12px;
    }

    /* ===== Fixed Post Button (Âè≥‰∏ãÂõ∫ÂÆö„ÉªHome„ÅÆ„ÅøË°®Á§∫) ===== */
    .fab{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:90;
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 16px;
      padding:16px 18px; /* Â∞ë„ÅóÂ§ß„Åç„Åè */
      font-weight:1100;
      cursor:pointer;
      box-shadow: var(--shadow);
      min-width: 104px;
      font-size:15px;
      display:none;
    }
    .fab:hover{filter:brightness(1.03)}
    .fab.show{display:block}

    /* ===== Modals ===== */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.40);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:120;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(820px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h2{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .modalFooter{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:1000;
    }
    .btn:hover{background:#fafafa}
    .btn.primary{border-color:#111; background:#111; color:#fff}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .fieldRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .fieldRow{grid-template-columns:1fr} }

    .lineInput{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
    }
    .lineArea{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
      resize:vertical;
      min-height: 72px;
    }
    .selectKeep{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 10px;
      outline:none;
      background:#fff;
      font-weight:1000;
      min-height: 40px;
      cursor:pointer;
    }

    .starsRow{display:flex; gap:6px; margin-top:10px; flex-wrap:wrap;}
    .starBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      padding:10px 10px;
      cursor:pointer;
      font-weight:1100;
      text-align:center;
      user-select:none;
      min-width:44px;
      font-size:16px;
    }
    .starBtn.active{background:#111; color:#fff; border-color:#111}

    .reviewList{
      margin-top:12px;
      border-top:1px solid var(--line);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 280px;
      overflow:auto;
    }
    .review{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
    }
    .reviewTop{display:flex; justify-content:space-between; gap:10px}
    .reviewName{font-weight:1000; font-size:12px}
    .reviewMeta{font-size:12px; color:var(--muted); font-family:var(--mono)}
    .reviewText{margin-top:8px; font-size:13px; color:#111; white-space:pre-wrap; line-height:1.5}
    .counter{font-family:var(--mono); font-size:11px; color:var(--muted);}

    /* Gate */
    .gate{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:200;
      background: rgba(0,0,0,.35);
      padding:18px;
    }
    .gate.show{display:flex}
    .gateCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .gateTitle{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .gateActions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
    .gateBtn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
    }

    /* ===== Training view ===== */
    .trainWrap{padding:12px}
    .trainCard{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .trainTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .trainMid{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:center;
    }
    .arrowBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
      user-select:none;
      min-width:44px;
    }
    .arrowBtn:hover{background:#fafafa}
    .creatureBox{
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding:14px;
      min-height: 220px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      position:relative;
      overflow:hidden;
    }
    .creatureEmoji{font-size: 78px; line-height:1;}
    .pct{font-family:var(--mono); font-weight:1100; font-size:18px;}
    .thin{color:var(--muted); font-size:12px; font-weight:1000;}
    .trainBar{
      width: min(520px, 90%);
      height: 14px;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
    }
    .trainFill{
      height:100%;
      width:0%;
      background:#111;
      transition: width .35s ease;
    }
    .careUnder{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-family:var(--mono);
      font-weight:1100;
      font-size:12px;
      background:#fff;
      color:#111;
    }

    /* Creator modal */
    .creatorHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .creatorBig{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .bigAva{
      width:42px;height:42px;border:1px solid var(--line);border-radius:50%;
      display:grid;place-items:center;font-weight:1000;
      overflow:hidden;background:#fff;
    }
    .bigAva img{width:100%;height:100%;object-fit:cover}
    .creatorBigName{
      font-weight:1100;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 380px;
    }
  </style>
</head>

<body>
  <!-- „É≠„Ç∞„Ç§„É≥ÂøÖÈ†à„Ç≤„Éº„Éà -->
  <div class="gate" id="loginGate">
    <div class="gateCard">
      <p class="gateTitle">„É≠„Ç∞„Ç§„É≥</p>
      <div class="gateActions">
        <button class="gateBtn" id="gateLoginBtn">Google„É≠„Ç∞„Ç§„É≥</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- ===== Left ===== -->
    <aside class="nav">
      <div class="brand">
        <div class="logo">‚ñ°</div>
        <div class="brandName">ÁøíÊÖ£„Åï„Åå„Åó</div>
      </div>

      <button class="navBtn active" id="navHome">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/></svg>
        </div>
        <div class="label">„Éõ„Éº„É†</div>
      </button>

      <button class="navBtn" id="navTrain">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4"/><path d="M12 18v4"/><path d="M4 12H2"/><path d="M22 12h-2"/>
            <path d="M5 5l2.5 2.5"/><path d="M19 19l-2.5-2.5"/><path d="M19 5l-2.5 2.5"/><path d="M5 19l2.5-2.5"/>
            <circle cx="12" cy="12" r="4"/>
          </svg>
        </div>
        <div class="label">ËÇ≤Êàê</div>
      </button>

      <button class="navBtn" id="navRecords">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v3M16 2v3"/><path d="M3 7h18"/><path d="M5 7v14a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7"/><path d="M8 11h3"/><path d="M8 15h6"/></svg>
        </div>
        <div class="label">ÈÅîÊàêË®òÈå≤</div>
      </button>

      <button class="navBtn" id="navBookmarks">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/></svg>
        </div>
        <div class="label">‰øùÂ≠ò</div>
      </button>

      <button class="navBtn" id="navProfile">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div class="label">„Éó„É≠„Éï„Ç£„Éº„É´</div>
      </button>

      <div class="sep"></div>

      <div class="userBox">
        <!-- Lv ring + xp pop -->
        <div class="lvRingWrap" id="lvRingWrap" title="ÂèÇÂä†„É¨„Éô„É´">
          <svg class="lvRingSvg" width="44" height="44" viewBox="0 0 44 44" aria-hidden="true">
            <circle cx="22" cy="22" r="18" fill="none" stroke="#e6e6e6" stroke-width="4"></circle>
            <circle id="xpRing" cx="22" cy="22" r="18" fill="none" stroke="var(--xpGreen)" stroke-width="4"
              stroke-linecap="round" transform="rotate(-90 22 22)"></circle>
          </svg>
          <div class="lvInner" id="lvInner">1</div>
          <div class="xpPop" id="xpPop">+0</div>
        </div>

        <div class="userMeta">
          <div class="userNameRow">
            <div class="userName" id="userName">‚Äî</div>
            <div class="followerMini" id="followerMini">„Éï„Ç©„É≠„Éº 0</div>
          </div>
          <div class="userSmall" id="userSmall">‚Äî</div>

          <div class="charMiniRow">
            <button class="miniLinkBtn" id="openCharList">„Ç≠„É£„É©‰∏ÄË¶ß</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sideTitle">‰æùÈ†ºÔºàÊåëÊà¶‰∏≠Ôºâ</div>
      <div class="sideList" id="sideActiveList"></div>
    </aside>

    <!-- ===== Right ===== -->
    <main class="content">

      <!-- ===== Home ===== -->
      <section class="panel" id="viewHome">
        <div class="headerBar">
          <div class="hTitle">ÁøíÊÖ£Êé¢„Åó</div>
          <!-- Êú¨Êó•ÈÅîÊàê + Ëá™ÂàÜ„ÅÆ„É¨„Éô„É´ + ÊÆã„ÇäXPÔºà„Çø„Ç§„Éà„É´Âè≥Ôºâ -->
          <div class="hBadge" id="headerStatus">Êú¨Êó• 0 ‰∫∫„ÅåÈÅîÊàê / Lv 1 / ÊÆã„Çä 100XP</div>
        </div>

        <!-- TOP tags -->
        <div class="tagWrap">
          <div class="rankBox">
            <div class="rankTitle"><span>„Åä„Åô„Åô„ÇÅTOP</span></div>
            <div class="rankGrid" id="rankReco"></div>
          </div>
          <div class="rankBox">
            <div class="rankTitle"><span>‰∫∫Ê∞óTOP</span></div>
            <div class="rankGrid" id="rankTop"></div>
          </div>
        </div>

        <!-- Search + category + tag reset -->
        <div class="searchRow">
          <div class="searchBox">
            <input class="searchInput" id="q" placeholder="Ê§úÁ¥¢" />
            <button class="searchBtn" id="btnSearch">Ê§úÁ¥¢</button>
          </div>

          <select class="ctrlSel" id="categoryFilter" title="„Ç´„ÉÜ„Ç¥„É™">
            <option value="">„Ç´„ÉÜ„Ç¥„É™Ôºà„Åô„Åπ„Å¶Ôºâ</option>
            <option>„É°„É≥„Çø„É´</option><option>Áù°Áú†</option><option>ÈÅãÂãï</option><option>ÂÅ•Â∫∑</option>
            <option>ÁîüÊ¥ª</option><option>ÂãâÂº∑</option><option>Ëã±Ë™û</option><option>‰ªï‰∫ã</option><option>„Åù„ÅÆ‰ªñ</option>
          </select>

          <button class="ctrlBtn" id="btnClearTag" title="„Çø„Ç∞Ëß£Èô§">„Çø„Ç∞Ëß£Èô§</button>
        </div>

        <!-- list -->
        <div class="feedArea">
          <div class="feedHead">
            <div class="feedHeadLeft">
              <p class="feedLabel">‰∏ÄË¶ß</p>

              <!-- ‰∏¶„Å≥Êõø„ÅàÔºö‰∏ÄË¶ß„ÅÆÊ®™ -->
              <select class="ctrlSel" id="sortBy" title="‰∏¶„Å≥Êõø„Åà">
                <option value="new">Êñ∞ÁùÄ</option>
                <option value="rating">Ë©ï‰æ°</option>
                <option value="favCreators">„Éï„Ç©„É≠„Éº‰∏≠„ÅÆ‰∫∫</option>
              </select>

              <div class="countSmall">Ë°®Á§∫ <span id="countShown">0</span></div>
            </div>
          </div>

          <div class="feedGrid" id="feed"></div>
        </div>
      </section>

      <!-- ===== Training ===== -->
      <section class="panel" id="viewTrain" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ËÇ≤Êàê</div>
          <div class="hBadge" id="trainHint">‚Äî</div>
        </div>

        <div class="trainWrap">
          <div class="trainCard">
            <div class="trainTop">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="hBadge" id="trainSlot">1 / 1</span>
                <span class="hBadge" id="trainHabitTitle">‚Äî</span>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="hBadge" id="trainPctText">0%</span>
                <button class="miniLinkBtn" id="btnSetAvatar" disabled>„Åì„ÅÆÂ≠ê„Çí„Ç¢„Ç§„Ç≥„É≥„Å´</button>
              </div>
            </div>

            <div class="trainMid">
              <button class="arrowBtn" id="trainPrev">&lt;</button>

              <div class="creatureBox">
                <!-- ‰∏≠Â§Æ„ÅÆ‰∏ä„Åã„ÇâÂ∞ë„Åó‰∏ã„Å´%Ôºà=„Åì„ÅìÔºâ -->
                <div class="pct" id="trainPct">0%</div>
                <div class="trainBar"><div class="trainFill" id="trainFill"></div></div>
                <!-- %„ÅÆ‰∏ã„Å´„Ç≠„É£„É© -->
                <div class="creatureEmoji" id="trainEmoji">ü•ö</div>
                <div class="thin" id="trainStage">‚Äî</div>
                <div class="careUnder" id="trainCare">Ê¨°„ÅÆ„Åä‰∏ñË©±„Åæ„Åß 00:00:00</div>
              </div>

              <button class="arrowBtn" id="trainNext">&gt;</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Records ===== -->
      <section class="panel" id="viewRecords" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ÈÅîÊàêË®òÈå≤</div>
          <div class="hBadge">‚Äî</div>
        </div>
        <div style="padding:12px" id="recordList"></div>
      </section>

      <!-- ===== Bookmarks ===== -->
      <section class="panel" id="viewBookmarks" style="display:none">
        <div class="headerBar">
          <div class="hTitle">‰øùÂ≠ò</div>
          <div class="hBadge">‰ª∂Êï∞ <span id="bmCount">0</span></div>
        </div>
        <div style="padding:12px">
          <div class="feedGrid" id="bmFeed"></div>
        </div>
      </section>

      <!-- ===== Profile ===== -->
      <section class="panel" id="viewProfile" style="display:none">
        <div class="headerBar">
          <div class="hTitle">„Éó„É≠„Éï„Ç£„Éº„É´</div>
          <div class="hBadge" id="profileLv">Lv 1</div>
        </div>
        <div style="padding:12px" id="profileList"></div>

        <!-- Google„É≠„Ç∞„Ç§„É≥/„É≠„Ç∞„Ç¢„Ç¶„Éà„ÅØ„Åì„Åì„Å†„Åë -->
        <div style="padding:12px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap">
          <button class="btn primary" id="btnLogin">Google„É≠„Ç∞„Ç§„É≥</button>
          <button class="btn" id="btnLogout" disabled>„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
      </section>
    </main>
  </div>

  <!-- ÊäïÁ®ø„Éú„Çø„É≥ÔºàÂè≥‰∏ãÂõ∫ÂÆö / Home„ÅÆ„ÅøË°®Á§∫Ôºâ -->
  <button class="fab" id="openPost">ÊäïÁ®ø</button>

  <!-- ===== ÂêçÂâçÁôªÈå≤ + Ëâ≤ÈÅ∏ÊäûÔºàÂè≥„Å´ÁèæÂú®„Ç¢„Ç§„Ç≥„É≥Ôºâ ===== -->
  <div class="modalBg" id="nameBg">
    <div class="modal">
      <h2>ÂêçÂâç</h2>

      <div class="fieldRow" style="margin-top:10px; grid-template-columns: 1fr auto;">
        <div>
          <input class="lineInput" id="nameInput" placeholder="ÂêçÂâç" maxlength="16" />
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <span class="counter">Ëâ≤</span>
            <select class="selectKeep" id="colorPick" title="Ëâ≤">
              <option value="#111111">Èªí</option>
              <option value="#e00000">Ëµ§</option>
              <option value="#0b6cff">Èùí</option>
              <option value="#00a86b">Á∑ë</option>
              <option value="#ff8a00">Ê©ô</option>
            </select>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:flex-start">
          <div id="nameAvatar" style="width:46px;height:46px;border-radius:999px;border:1px solid var(--line);display:grid;place-items:center;font-weight:1000;background:#fff;color:#111">‚ñ°</div>
          <div class="counter">ÁèæÂú®</div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn primary" id="nameSave" disabled>‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- ===== ÂàùÂõû„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû ===== -->
  <div class="modalBg" id="catBg">
    <div class="modal">
      <h2>„Ç´„ÉÜ„Ç¥„É™</h2>
      <div class="fieldRow" id="catList" style="margin-top:10px"></div>
      <div class="modalFooter">
        <button class="btn" id="catClose">Èñâ„Åò„Çã</button>
        <button class="btn primary" id="catSave" disabled>‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- ===== ÊäïÁ®ø ===== -->
  <div class="modalBg" id="postBg">
    <div class="modal">
      <h2>ÊäïÁ®ø</h2>

      <div style="margin-top:10px">
        <div class="counter" id="postCounter">0 / 40</div>
        <input class="lineInput" id="newTitle" placeholder="„Çø„Ç§„Éà„É´" maxlength="40" />
        <textarea class="lineArea" id="newAction" placeholder="„ÇÑ„Çã„Åì„Å®Ôºà40ÊñáÂ≠óÔºâ" maxlength="40"></textarea>
      </div>

      <div class="fieldRow">
        <input class="lineInput" id="newTags" placeholder="ÊÇ©„Åø„Çø„Ç∞Ôºà‰æãÔºö‰∏çÂÆâ,ÂØù„Å§„ÅçÔºâ" />
        <select class="selectKeep" id="newCategory">
          <option value="">„Ç´„ÉÜ„Ç¥„É™Ôºà‰ªªÊÑèÔºâ</option>
          <option>„É°„É≥„Çø„É´</option><option>Áù°Áú†</option><option>ÈÅãÂãï</option><option>ÂÅ•Â∫∑</option>
          <option>ÁîüÊ¥ª</option><option>ÂãâÂº∑</option><option>Ëã±Ë™û</option><option>‰ªï‰∫ã</option><option>„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>

      <div class="modalFooter">
        <button class="btn" id="postClose">Èñâ„Åò„Çã</button>
        <button class="btn primary" id="btnPost">ÊäïÁ®ø</button>
      </div>
    </div>
  </div>

  <!-- ===== Èõ£ÊòìÂ∫¶Ôºà3ÊäûÔºâ ===== -->
  <div class="modalBg" id="diffBg">
    <div class="modal">
      <h2 id="diffTitle">Èõ£ÊòìÂ∫¶</h2>
      <div class="fieldRow" style="grid-template-columns:1fr 1fr 1fr; margin-top:12px">
        <button class="btn" data-diff="easy">üòä</button>
        <button class="btn" data-diff="mid">üôÇ</button>
        <button class="btn" data-diff="hard">üòÖ</button>
      </div>
      <div class="modalFooter">
        <button class="btn" id="diffClose">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- ===== Ë©ï‰æ°Ôºà‚òÖ‚òÜÔºâ ===== -->
  <div class="modalBg" id="ratingBg">
    <div class="modal">
      <h2 id="ratingTitle">Ë©ï‰æ°</h2>

      <div class="starsRow" id="starsRow"></div>
      <textarea class="lineArea" id="commentBox" placeholder="Âè£„Ç≥„ÉüÔºàÁü≠ÊñáÔºâ" style="margin-top:10px"></textarea>

      <div class="modalFooter">
        <button class="btn" id="ratingClose">Èñâ„Åò„Çã</button>
        <button class="btn primary" id="ratingSave">ÈÄÅ‰ø°</button>
      </div>

      <div class="reviewList" id="reviewList"></div>
    </div>
  </div>

  <!-- ===== ‰ΩúÊàêËÄÖ„Éó„É≠„Éï„Ç£„Éº„É´ ===== -->
  <div class="modalBg" id="creatorBg">
    <div class="modal">
      <h2>‰ΩúÊàêËÄÖ</h2>

      <div class="creatorHeader">
        <div class="creatorBig">
          <div class="bigAva" id="creatorAva">‚ñ°</div>
          <div class="creatorBigName" id="creatorName">‚Äî</div>
        </div>
        <button class="btn" id="creatorClose">Èñâ„Åò„Çã</button>
      </div>

      <div class="reviewList" id="creatorPosts" style="margin-top:12px; border-top:none; padding-top:0"></div>
    </div>
  </div>

  <!-- ===== „Ç≠„É£„É©‰∏ÄË¶ß ===== -->
  <div class="modalBg" id="charBg">
    <div class="modal">
      <h2>„Ç≠„É£„É©‰∏ÄË¶ßÔºàÂçµ/Á®Æ„Å†„ÅëË°®Á§∫Ôºâ</h2>
      <div class="reviewList" id="charList"></div>
      <div class="modalFooter">
        <button class="btn" id="charClose">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    import {
      getFirestore,
      collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      getDocs, query, orderBy, limit, serverTimestamp,
      runTransaction, increment
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvdaEW4o2y8rljlafXQJbGE-nuGQn9Q88",
      authDomain: "zuzutomo-d8fa0.firebaseapp.com",
      projectId: "zuzutomo-d8fa0",
      storageBucket: "zuzutomo-d8fa0.firebasestorage.app",
      messagingSenderId: "637121353766",
      appId: "1:637121353766:web:dbfb13f85bfaf521616ee7",
      measurementId: "G-C6K64YE13X"
    };

    const app = initializeApp(firebaseConfig);
    try{ getAnalytics(app); }catch{}
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

    const nowLocal = () => new Date();
    const fmtYMD = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return \`\${y}-\${m}-\${day}\`;
    };
    const parseYMD = (s) => {
      const raw = String(s||"").slice(0,10);
      if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(raw)) return null;
      const [y,m,d] = raw.split("-").map(Number);
      return new Date(y, m-1, d);
    };
    const daysBetween = (a, b) => {
      const A = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
      const B = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
      return Math.round((B - A) / 86400000);
    };
    const msToMidnight = () => {
      const n = nowLocal();
      const next = new Date(n.getFullYear(), n.getMonth(), n.getDate()+1, 0,0,0,0);
      return Math.max(0, next.getTime() - n.getTime());
    };
    const fmtCountdown = (ms) => {
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,"0");
      const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return \`\${hh}:\${mm}:\${ss}\`;
    };

    // ===== Category color (ËñÑ„ÇÅ) =====
    const CAT_COLORS = {
      "„É°„É≥„Çø„É´": { tint:"#fbfbff", line:"#dfe3ff" },
      "Áù°Áú†":     { tint:"#fbfffb", line:"#d9f0dc" },
      "ÈÅãÂãï":     { tint:"#fffafb", line:"#ffd7e4" },
      "ÂÅ•Â∫∑":     { tint:"#fbffff", line:"#d6f2f2" },
      "ÁîüÊ¥ª":     { tint:"#fffffb", line:"#f0f0d6" },
      "ÂãâÂº∑":     { tint:"#fbfcff", line:"#e1e6ff" },
      "Ëã±Ë™û":     { tint:"#fbffff", line:"#d7f1ff" },
      "‰ªï‰∫ã":     { tint:"#fcfcfc", line:"#e6e6e6" },
      "„Åù„ÅÆ‰ªñ":   { tint:"#ffffff", line:"#e6e6e6" }
    };
    function applyCatVars(el, cat){
      const c = CAT_COLORS[String(cat||"")] || { tint:"#ffffff", line:"#e6e6e6" };
      el.style.setProperty("--catTint", c.tint);
      el.style.setProperty("--catLine", c.line);
    }

    // ===== Hourly mascot (ÊäïÁ®øÂæå„ÇÇ1ÊôÇÈñì„Åä„Åç„Å´Â§â„Çè„Çã) =====
    function hourKey(){
      const d = nowLocal();
      return \`\${d.getFullYear()}-\${d.getMonth()+1}-\${d.getDate()}-\${d.getHours()}\`;
    }
    function hash32(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0);
    }
    function mascotEmojiFromHabitId(habitId){
      const k = habitId + ":" + hourKey();
      const v = hash32(k) % 6;
      return ["ü•ö","ü•ö‚ú®","ü•ö‚ùñ","üå∞","üå∞‚ú®","üå∞‚ùñ"][v];
    }

    // ===== Elements =====
    const navHome = $("navHome");
    const navTrain = $("navTrain");
    const navRecords = $("navRecords");
    const navBookmarks = $("navBookmarks");
    const navProfile = $("navProfile");

    const viewHome = $("viewHome");
    const viewTrain = $("viewTrain");
    const viewRecords = $("viewRecords");
    const viewBookmarks = $("viewBookmarks");
    const viewProfile = $("viewProfile");

    const headerStatus = $("headerStatus");

    const loginGate = $("loginGate");
    const gateLoginBtn = $("gateLoginBtn");

    const userName = $("userName");
    const userSmall = $("userSmall");
    const followerMini = $("followerMini");

    // Lv ring
    const lvInner = $("lvInner");
    const xpRing = $("xpRing");
    const xpPop = $("xpPop");

    const openCharList = $("openCharList");
    const sideActiveList = $("sideActiveList");

    // Home
    const feed = $("feed");
    const qInput = $("q");
    const btnSearch = $("btnSearch");
    const categoryFilter = $("categoryFilter");
    const sortBy = $("sortBy");
    const btnClearTag = $("btnClearTag");
    const rankReco = $("rankReco");
    const rankTop = $("rankTop");
    const countShown = $("countShown");

    // FAB
    const openPost = $("openPost");

    // Post modal
    const postBg = $("postBg");
    const postClose = $("postClose");
    const btnPost = $("btnPost");
    const newTitle = $("newTitle");
    const newAction = $("newAction");
    const newTags = $("newTags");
    const newCategory = $("newCategory");
    const postCounter = $("postCounter");

    // Name modal
    const nameBg = $("nameBg");
    const nameInput = $("nameInput");
    const nameSave = $("nameSave");
    const colorPick = $("colorPick");
    const nameAvatar = $("nameAvatar");

    // Category modal
    const catBg = $("catBg");
    const catList = $("catList");
    const catClose = $("catClose");
    const catSave = $("catSave");

    // Difficulty
    const diffBg = $("diffBg");
    const diffTitle = $("diffTitle");
    const diffClose = $("diffClose");

    // Records/bookmarks/profile
    const recordList = $("recordList");
    const bmFeed = $("bmFeed");
    const bmCount = $("bmCount");
    const profileList = $("profileList");
    const profileLv = $("profileLv");

    // Profile auth buttons
    const btnLogin = $("btnLogin");
    const btnLogout = $("btnLogout");

    // Rating
    const ratingBg = $("ratingBg");
    const ratingTitle = $("ratingTitle");
    const starsRow = $("starsRow");
    const commentBox = $("commentBox");
    const ratingClose = $("ratingClose");
    const ratingSave = $("ratingSave");
    const reviewList = $("reviewList");

    // Creator modal
    const creatorBg = $("creatorBg");
    const creatorClose = $("creatorClose");
    const creatorAva = $("creatorAva");
    const creatorName = $("creatorName");
    const creatorPosts = $("creatorPosts");

    // Char list
    const charBg = $("charBg");
    const charList = $("charList");
    const charClose = $("charClose");

    // Training
    const trainHint = $("trainHint");
    const trainSlot = $("trainSlot");
    const trainHabitTitle = $("trainHabitTitle");
    const trainPctText = $("trainPctText");
    const trainPct = $("trainPct");
    const trainFill = $("trainFill");
    const trainEmoji = $("trainEmoji");
    const trainStage = $("trainStage");
    const trainPrev = $("trainPrev");
    const trainNext = $("trainNext");
    const btnSetAvatar = $("btnSetAvatar");
    const trainCare = $("trainCare");

    // ===== State =====
    const CATS = ["„É°„É≥„Çø„É´","Áù°Áú†","ÈÅãÂãï","ÂÅ•Â∫∑","ÁîüÊ¥ª","ÂãâÂº∑","Ëã±Ë™û","‰ªï‰∫ã","„Åù„ÅÆ‰ªñ"];

    let currentUser = null;
    let myProfile = null;

    let selectedTag = "";
    let cachedFavCreators = new Set();
    let cachedBookmarks = new Set();

    let activeHabitIds = new Set();

    let diffTargetChallenge = null;

    let ratingTargetHabit = null;
    let ratingStars = 0;

    let trainChallenges = [];
    let trainIndex = 0;

    // ===== Character system (‰∏ÄË¶ß„ÅßÂçµ/Á®Æ„Å†„Åë) =====
    const CHAR_TIERS = [
      { minLv: 1, name: "Âçµ", emoji: "ü•ö", type:"egg" },
      { minLv: 3, name: "ÂÖâ„ÇãÂçµ", emoji: "ü•ö‚ú®", type:"egg" },
      { minLv: 5, name: "‰∏çÊÄùË≠∞„Å™Âçµ", emoji: "ü•ö‚ùñ", type:"egg" },
      { minLv: 1, name: "Á®Æ", emoji: "üå∞", type:"seed" },
      { minLv: 3, name: "ÂÖâ„ÇãÁ®Æ", emoji: "üå∞‚ú®", type:"seed" },
      { minLv: 5, name: "‰∏çÊÄùË≠∞„Å™Á®Æ", emoji: "üå∞‚ùñ", type:"seed" },
    ];

    // ËÇ≤Êàê„ÅÆ‰ªÆ7ÊÆµÈöéÔºàÁîªÂÉè„Å™„Åó„Å™„ÅÆ„ÅßÁµµÊñáÂ≠ó„ÅßÔºâ
    const TRAIN_VISUAL_STAGES = [
      { max: 0,   label:"Áú†„Çä",   emoji:"ü•ö" },
      { max: 15,  label:"ÁõÆË¶ö„ÇÅ", emoji:"ü•öüí§" },
      { max: 30,  label:"„Çà„Å°„Çà„Å°", emoji:"üê£" },
      { max: 45,  label:"ËÇ≤„Å°",   emoji:"üê•" },
      { max: 60,  label:"Ê∫ñÂÇô",   emoji:"üê§‚ú®" },
      { max: 75,  label:"ÈÄ≤ÂåñÂâç", emoji:"ü¶ú‚ú®" },
      { max: 100, label:"ÂÆåÊàê",   emoji:"üëë" },
    ];

    // ===== XP / Level =====
    function needXpForLevel(lv){ return 100 + Math.max(0, lv-1)*40; }
    function computeLevelFromXp(totalXp){
      let lv = 1;
      let xp = Math.max(0, Number(totalXp||0));
      while(true){
        const need = needXpForLevel(lv);
        if(xp >= need){ xp -= need; lv++; continue; }
        return { lv, cur: xp, need };
      }
    }

    // ring geometry
    const RING_R = 18;
    const RING_CIRC = 2 * Math.PI * RING_R;

    function showXpPop(add){
      xpPop.textContent = \`+\${add}\`;
      xpPop.classList.add("show");
      setTimeout(()=> xpPop.classList.remove("show"), 2000);
    }

    function setXpUI(){
      const total = Number(myProfile?.xpTotal||0);
      const { lv, cur, need } = computeLevelFromXp(total);
      myProfile.level = lv;
      myProfile.xpCur = cur;
      myProfile.xpNeed = need;

      // ring
      lvInner.textContent = String(lv);
      xpRing.style.strokeDasharray = String(RING_CIRC);
      const pct = need ? Math.max(0, Math.min(1, cur/need)) : 0;
      const offset = RING_CIRC * (1 - pct);
      xpRing.style.strokeDashoffset = String(offset);

      // header + profile
      profileLv.textContent = \`Lv \${lv}\`;
      applyHeaderStatus();
    }

    function applyHeaderStatus(){
      const done = Number(window.__todayDoneCount||0);
      const lv = Number(myProfile?.level||1);
      const remain = Math.max(0, Number(myProfile?.xpNeed||100) - Number(myProfile?.xpCur||0));
      headerStatus.textContent = \`Êú¨Êó• \${done} ‰∫∫„ÅåÈÅîÊàê / Lv \${lv} / ÊÆã„Çä \${remain}XP\`;
    }

    async function addXp(amount){
      const add = Math.max(0, Math.floor(amount||0));
      if(!add) return;
      showXpPop(add);

      await runTransaction(db, async (tx)=>{
        const uref = doc(db, "users", currentUser.uid);
        const us = await tx.get(uref);
        if(!us.exists()) return;
        const u = us.data();
        tx.update(uref, { xpTotal: Number(u.xpTotal||0) + add, updatedAt: serverTimestamp() });
      });
      const snap = await getDoc(doc(db,"users",currentUser.uid));
      myProfile = snap.data();
      setXpUI();
      applyUserHeader();
    }

    // ===== Helpers =====
    function setAvatarColor(el, color){
      el.style.background = String(color||"#111111");
      el.style.color = "#fff";
      el.textContent = "‚ñ°";
    }

    function showOnly(section){
      viewHome.style.display = section==="home" ? "" : "none";
      viewTrain.style.display = section==="train" ? "" : "none";
      viewRecords.style.display = section==="records" ? "" : "none";
      viewBookmarks.style.display = section==="bookmarks" ? "" : "none";
      viewProfile.style.display = section==="profile" ? "" : "none";

      navHome.classList.toggle("active", section==="home");
      navTrain.classList.toggle("active", section==="train");
      navRecords.classList.toggle("active", section==="records");
      navBookmarks.classList.toggle("active", section==="bookmarks");
      navProfile.classList.toggle("active", section==="profile");

      openPost.classList.toggle("show", section==="home");

      if(section==="records") refreshRecords();
      if(section==="bookmarks") refreshBookmarksView();
      if(section==="profile") refreshProfile();
      if(section==="train") refreshTrain();
    }

    // ===== Auth =====
    async function login(){
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }
    async function logout(){
      await signOut(auth);
    }
    gateLoginBtn.addEventListener("click", async ()=>{ try{ await login(); }catch{ alert("„É≠„Ç∞„Ç§„É≥Â§±Êïó"); } });
    btnLogin.addEventListener("click", async ()=>{ try{ await login(); }catch{ alert("„É≠„Ç∞„Ç§„É≥Â§±Êïó"); } });
    btnLogout.addEventListener("click", async ()=>{ try{ await logout(); }catch{ alert("„É≠„Ç∞„Ç¢„Ç¶„ÉàÂ§±Êïó"); } });

    // ===== Name modal =====
    function openNameModal(){
      nameInput.value = "";
      nameSave.disabled = true;
      const c = myProfile?.avatarColor || "#111111";
      colorPick.value = c;
      setAvatarColor(nameAvatar, c);
      nameBg.classList.add("show");
    }
    function closeNameModal(){ nameBg.classList.remove("show"); }
    nameInput.addEventListener("input", ()=>{ nameSave.disabled = nameInput.value.trim().length<1; });
    colorPick.addEventListener("change", ()=> setAvatarColor(nameAvatar, colorPick.value));

    nameSave.addEventListener("click", async ()=>{
      const nm = nameInput.value.trim().slice(0,16);
      if(!nm) return;
      const color = colorPick.value || "#111111";

      await updateDoc(doc(db,"users",currentUser.uid), { name: nm, avatarColor: color, updatedAt: serverTimestamp() });
      myProfile.name = nm;
      myProfile.avatarColor = color;

      closeNameModal();

      if(!(myProfile?.preferredCategory||"")) openCategoryModal();
      await afterLoginWarm();
    });

    // ===== Category modal =====
    let catSelected = "";
    function openCategoryModal(){
      catSelected = "";
      catSave.disabled = true;
      catList.innerHTML = "";
      for(const c of CATS){
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = c;
        applyCatButton(b, c, false);
        b.addEventListener("click", ()=>{
          catSelected = c;
          [...catList.querySelectorAll(".btn")].forEach(x=>{
            x.classList.remove("primary");
            x.style.borderColor = "var(--line)";
            x.style.background = "#fff";
          });
          b.classList.add("primary");
          applyCatButton(b, c, true);
          catSave.disabled = false;
        });
        catList.appendChild(b);
      }
      catBg.classList.add("show");
    }
    function applyCatButton(btn, cat, selected){
      const c = CAT_COLORS[String(cat)] || { tint:"#fff", line:"#e6e6e6" };
      btn.style.borderColor = c.line;
      btn.style.background = selected ? c.line : "#fff";
    }
    function closeCategoryModal(){ catBg.classList.remove("show"); }
    catClose.addEventListener("click", closeCategoryModal);
    catSave.addEventListener("click", async ()=>{
      if(!catSelected) return;
      await updateDoc(doc(db,"users",currentUser.uid), { preferredCategory: catSelected, updatedAt: serverTimestamp() });
      myProfile.preferredCategory = catSelected;
      closeCategoryModal();

      categoryFilter.value = catSelected;
      await refreshHome();
    });

    // ===== Post modal =====
    function openPostModal(){
      newTitle.value = "";
      newTags.value = "";
      newCategory.value = "";
      newAction.value = "";
      updatePostCounter();
      postBg.classList.add("show");
    }
    function closePostModal(){ postBg.classList.remove("show"); }
    openPost.addEventListener("click", ()=> openPostModal());
    postClose.addEventListener("click", closePostModal);
    postBg.addEventListener("click", (e)=>{ if(e.target===postBg) closePostModal(); });

    function updatePostCounter(){ postCounter.textContent = \`\${newAction.value.length} / 40\`; }
    newAction.addEventListener("input", updatePostCounter);

    btnPost.addEventListener("click", async ()=>{
      const title = newTitle.value.trim();
      const action = newAction.value.trim();
      const tags = newTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(newCategory.value||"").trim();

      if(title.length<2){ alert("„Çø„Ç§„Éà„É´Áü≠„ÅÑ"); return; }
      if(action.length<2){ alert("„ÇÑ„Çã„Åì„Å®Áü≠„ÅÑ"); return; }
      if(action.length>40){ alert("40ÊñáÂ≠ó‰ª•ÂÜÖ"); return; }

      try{
        const created = nowLocal();
        await addDoc(collection(db, "habits"), {
          title, action, tags, category,
          creatorUid: currentUser.uid,
          creatorName: myProfile?.name || (currentUser.displayName || "‰ΩúÊàêËÄÖ"),
          creatorPhoto: currentUser.photoURL || "",
          creatorColor: myProfile?.avatarColor || "#111111",

          createdAt: serverTimestamp(),
          createdAtYMD: fmtYMD(created),
          updatedAt: serverTimestamp(),

          avgRating: 0,
          ratingCount: 0,
          participantsCount: 0,
          avgDays: 0,
          successRate: 0,

          baseHabitId: "",
          version: 1
        });

        // ÊäïÁ®øXP
        await addXp(8);

        closePostModal();
        await refreshHome();
        await refreshProfile();
      }catch{
        alert("ÊäïÁ®øÂ§±Êïó");
      }
    });

    // ===== Profile doc =====
    async function ensureProfile(){
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const initial = {
          name: "",
          photoURL: currentUser.photoURL || "",
          avatarColor: "#111111",
          preferredCategory: "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          clearCount: 0,
          totalChallenges: 0,
          ratingRank: 1,
          xpTotal: 0,
          followerCount: 0
        };
        await setDoc(ref, initial);
        myProfile = initial;
      }else{
        myProfile = snap.data();
      }
      setXpUI();
      applyUserHeader();
    }

    function applyUserHeader(){
      const nm = (myProfile?.name || "").trim();
      userName.textContent = nm || "‚Äî";
      userSmall.textContent = currentUser.email || "‚Äî";
      followerMini.textContent = \`„Éï„Ç©„É≠„Éº \${Number(myProfile?.followerCount||0)}\`;
    }

    async function warmCaches(){
      cachedFavCreators = new Set();
      cachedBookmarks = new Set();

      {
        const qs = await getDocs(query(
          collection(db, "userCreatorFavs", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(300)
        ));
        qs.forEach(s=> cachedFavCreators.add(s.id));
      }
      {
        const qs = await getDocs(query(
          collection(db, "userBookmarks", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(500)
        ));
        qs.forEach(s=> cachedBookmarks.add(s.id));
      }
    }

    // ===== Daily done count =====
    function dailyDocId(){ return fmtYMD(nowLocal()); }
    async function ensureDailyStatsDoc(){
      const ref = doc(db, "dailyStats", dailyDocId());
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { doneCount: 0, date: dailyDocId(), updatedAt: serverTimestamp() });
      }
    }
    async function refreshDailyDoneCount(){
      try{
        const ref = doc(db, "dailyStats", dailyDocId());
        const snap = await getDoc(ref);
        const done = snap.exists() ? Number(snap.data().doneCount||0) : 0;
        window.__todayDoneCount = done;
        applyHeaderStatus();
      }catch{
        window.__todayDoneCount = 0;
        applyHeaderStatus();
      }
    }
    async function incDailyDoneCount(){
      await runTransaction(db, async (tx)=>{
        const ref = doc(db, "dailyStats", dailyDocId());
        const snap = await tx.get(ref);
        if(!snap.exists()){
          tx.set(ref, { doneCount: 1, date: dailyDocId(), updatedAt: serverTimestamp() });
        }else{
          tx.update(ref, { doneCount: increment(1), updatedAt: serverTimestamp() });
        }
      });
      await refreshDailyDoneCount();
    }

    async function afterLoginWarm(){
      await warmCaches();
      await autoRetireIfMissed();
      await ensureDailyStatsDoc();
      await refreshDailyDoneCount();

      await refreshActiveHabitIds();
      await refreshSideActive();
      await refreshHome();
      await refreshRecords();
      await refreshBookmarksView();
      await refreshProfile();
      await refreshTrain();
    }

    // ===== Active set for cards =====
    async function refreshActiveHabitIds(){
      activeHabitIds = new Set();
      const actives = await loadActiveChallenges();
      for(const ch of actives) activeHabitIds.add(ch.habitId);
    }

    // ===== Auth state =====
    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;

      if(!currentUser){
        loginGate.classList.add("show");
        btnLogout.disabled = true;

        userName.textContent = "‚Äî";
        userSmall.textContent = "‚Äî";
        followerMini.textContent = "„Éï„Ç©„É≠„Éº 0";
        lvInner.textContent = "1";
        xpRing.style.strokeDasharray = String(RING_CIRC);
        xpRing.style.strokeDashoffset = String(RING_CIRC);

        sideActiveList.innerHTML = "";
        feed.innerHTML = "";
        recordList.innerHTML = "";
        bmFeed.innerHTML = "";
        bmCount.textContent = "0";
        profileList.innerHTML = "";

        cachedFavCreators = new Set();
        cachedBookmarks = new Set();
        activeHabitIds = new Set();

        window.__todayDoneCount = 0;
        headerStatus.textContent = "Êú¨Êó• 0 ‰∫∫„ÅåÈÅîÊàê / Lv 1 / ÊÆã„Çä 100XP";

        showOnly("home");
        return;
      }

      loginGate.classList.remove("show");
      btnLogout.disabled = false;

      await ensureProfile();

      const nm = (myProfile?.name || "").trim();
      if(!nm){
        openNameModal();
        return;
      }
      if(!(myProfile?.preferredCategory||"")){
        openCategoryModal();
      }else{
        categoryFilter.value = myProfile.preferredCategory;
      }

      await afterLoginWarm();
    });

    // ===== Navigation =====
    navHome.addEventListener("click", ()=> showOnly("home"));
    navTrain.addEventListener("click", ()=> showOnly("train"));
    navRecords.addEventListener("click", ()=> showOnly("records"));
    navBookmarks.addEventListener("click", ()=> showOnly("bookmarks"));
    navProfile.addEventListener("click", ()=> showOnly("profile"));

    // ===== Search/filters =====
    btnSearch.addEventListener("click", refreshHome);
    qInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshHome(); });
    categoryFilter.addEventListener("change", refreshHome);
    sortBy.addEventListener("change", refreshHome);
    btnClearTag.addEventListener("click", async ()=>{
      selectedTag = "";
      highlightRankChips();
      await refreshHome();
    });

    // ===== Home =====
    async function refreshHome(){
      if(!currentUser) return;

      await refreshActiveHabitIds();

      const keyword = qInput.value.trim().toLowerCase();
      const cat = categoryFilter.value.trim();
      const sort = sortBy.value;

      let habits = [];
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(300)));
      qs.forEach(s=> habits.push({ id:s.id, ...s.data() }));

      // tag ranking
      const tagCounts = new Map();
      for(const h of habits){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          tagCounts.set(k, (tagCounts.get(k)||0)+1);
        });
      }
      const top3 = [...tagCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);

      // recoÔºöËá™ÂàÜ„ÅÆ„Ç´„ÉÜ„Ç¥„É™ÂÑ™ÂÖà
      const pref = (myProfile?.preferredCategory||"").trim();
      const pool = pref ? habits.filter(h => String(h.category||"").trim() === pref) : habits;
      const recoCounts = new Map();
      for(const h of pool){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          recoCounts.set(k, (recoCounts.get(k)||0)+1);
        });
      }
      const reco3 = [...recoCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);

      renderRank(rankReco, reco3);
      renderRank(rankTop, top3);
      highlightRankChips();

      // filter
      let filtered = habits.filter(h=>{
        const hCat = String(h.category||"").trim();
        if(cat && hCat !== cat) return false;
        if(selectedTag && !(h.tags||[]).includes(selectedTag)) return false;
        if(keyword){
          const blob = [h.title, h.action, (h.tags||[]).join(" "), h.category, h.creatorName].join(" ").toLowerCase();
          if(!blob.includes(keyword)) return false;
        }
        if(sort==="favCreators"){
          return cachedFavCreators.has(h.creatorUid);
        }
        return true;
      });

      // sort
      filtered.sort((a,b)=>{
        const ca = a.createdAt?.seconds ? a.createdAt.seconds : 0;
        const cb = b.createdAt?.seconds ? b.createdAt.seconds : 0;

        const ra = Number(a.avgRating||0);
        const rb = Number(b.avgRating||0);

        if(sort==="rating") return (rb-ra) || (cb-ca);
        return (cb-ca);
      });

      countShown.textContent = String(filtered.length);

      feed.innerHTML = "";
      for(const h of filtered){
        feed.appendChild(renderHabitCard(h));
      }
    }

    function renderRank(container, tags){
      container.innerHTML = "";
      const list = (tags||[]).slice(0,3);
      for(let i=0;i<list.length;i++){
        const t = list[i];
        const chip = document.createElement("div");
        chip.className = "rankChip";
        chip.dataset.tag = t;
        chip.innerHTML = \`<span class="rk">\${i+1}‰Ωç</span><span class="tagName">#\${escapeHtml(t)}</span>\`;
        chip.addEventListener("click", async ()=>{
          selectedTag = t;
          highlightRankChips();
          await refreshHome();
        });
        container.appendChild(chip);
      }
      for(let i=list.length;i<3;i++){
        const dummy = document.createElement("div");
        dummy.className = "rankChip";
        dummy.style.opacity = "0.25";
        dummy.style.pointerEvents = "none";
        dummy.innerHTML = \`<span class="rk">\${i+1}‰Ωç</span><span class="tagName">‚Äî</span>\`;
        container.appendChild(dummy);
      }
    }
    function highlightRankChips(){
      document.querySelectorAll(".rankChip").forEach(el=>{
        el.classList.toggle("active", (el.dataset.tag||"") === selectedTag);
      });
    }

    function bookmarkSvg(filled){
      if(filled){
        return \`
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/>
          </svg>\`;
      }
      return \`
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/>
        </svg>\`;
    }

    function bubbleSvg(){
      return \`
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/>
        </svg>\`;
    }

    function renderHabitCard(h){
      const card = document.createElement("div");
      card.className = "habitCard";

      const isMine = h.creatorUid === currentUser.uid;
      const bookmarked = cachedBookmarks.has(h.id);
      const creatorFav = cachedFavCreators.has(h.creatorUid);
      const isActive = activeHabitIds.has(h.id);

      const avgRating = Number(h.avgRating||0);
      const ratingCount = Number(h.ratingCount||0);
      const participants = Number(h.participantsCount||0);

      const createdAtStr = String(h.createdAtYMD||"") || "";

      const avgDays = Math.max(0, Math.min(14, Number(h.avgDays||0)));
      const successRate = Math.max(0, Math.min(100, Number(h.successRate||0)));
      const daysPct = Math.max(0, Math.min(100, (avgDays/14)*100));

      applyCatVars(card, h.category);

      card.innerHTML = \`
        <div class="thumb">
          <div class="mascotBg">\${escapeHtml(mascotEmojiFromHabitId(h.id))}</div>

          <p class="thumbTitle">\${escapeHtml(h.title||"")}</p>
          <div class="thumbAction">\${escapeHtml(h.action||"")}</div>

          <div class="thumbActions">
            <button class="iconBtn tipBtn reviewBtn" data-act="reviews" data-tip="Âè£„Ç≥„Éü">
              \${bubbleSvg()}
              <span class="badgeCount">\${Math.min(99, ratingCount)}</span>
            </button>

            <button class="iconBtn tipBtn \${bookmarked ? "on":""}" data-act="bookmark" data-tip="‰øùÂ≠ò">
              \${bookmarkSvg(bookmarked)}
            </button>

            \${isMine
              ? \`<button class="joinBtn tipBtn activeMode" data-act="edit" data-tip="Á∑®ÈõÜ">Á∑®ÈõÜ</button>\`
              : \`<button class="joinBtn tipBtn \${isActive ? "activeMode":""}" data-act="join" data-tip="\${isActive ? "ËÇ≤Êàê‰∏≠" : "ÂèÇÂä†"}">\${isActive ? "ËÇ≤Êàê‰∏≠" : "ÂèÇÂä†"}</button>\`
            }
          </div>

          <div class="overlay">
            <div class="overlayInner">
              <div class="ovTitle">Á∂ôÁ∂ö</div>
              <div class="ovRow"><span>Âπ≥ÂùáÊó•Êï∞</span><span>\${avgDays ? avgDays.toFixed(1) : "‚Äî"}Êó•</span></div>
              <div class="bar"><div class="barFill" style="width:\${daysPct}%"></div></div>

              <div class="ovTitle" style="margin-top:6px">ÊàêÂäü</div>
              <div class="ovRow"><span>ÊàêÂäüÁéá</span><span>\${Number.isFinite(successRate) ? successRate.toFixed(0) : "‚Äî"}%</span></div>
              <div class="bar"><div class="barFill" style="width:\${successRate}%"></div></div>
            </div>
          </div>
        </div>

        <div class="metaBar">
          <div class="creatorCol">
            <div class="miniAva" data-act="creator">\${h.creatorPhoto ? \`<img src="\${escapeHtml(h.creatorPhoto)}" alt="">\` : "‚ñ°"}</div>

            <div class="creatorText">
              <div class="creatorNameRow">
                <div class="creatorName" data-act="creator">\${escapeHtml(h.creatorName||"‰ΩúÊàêËÄÖ")}</div>
                <button class="followMini \${creatorFav ? "on":""}" data-act="follow">„Éï„Ç©„É≠„Éº</button>
              </div>
            </div>
          </div>

          <div class="statsRow">
            <div class="statLine">
              <span class="statPill">ÂèÇÂä†ËÄÖ \${participants}</span>
              <span class="statPill">Ë©ï‰æ° \${avgRating ? avgRating.toFixed(1) : "‚Äî"}</span>
            </div>
          </div>

          <div class="createdAt">\${escapeHtml(createdAtStr)}</div>
        </div>
      \`;

      // press to show overlay on touch
      card.addEventListener("pointerdown", ()=> card.classList.add("pressing"));
      card.addEventListener("pointerup", ()=> card.classList.remove("pressing"));
      card.addEventListener("pointercancel", ()=> card.classList.remove("pressing"));
      card.addEventListener("pointerleave", ()=> card.classList.remove("pressing"));

      // creator modal (icon click => profile + posts only)
      card.querySelectorAll('[data-act="creator"]').forEach(el=>{
        el.addEventListener("click", ()=> openCreatorModal(h.creatorUid, h.creatorName, h.creatorPhoto, h.creatorColor));
      });

      // follow
      card.querySelector('[data-act="follow"]').addEventListener("click", async (e)=>{
        e.stopPropagation();
        await toggleCreatorFav(h.creatorUid);
      });

      // bookmark
      card.querySelector('[data-act="bookmark"]').addEventListener("click", async (e)=>{
        e.stopPropagation();
        await toggleBookmark(h.id);
      });

      // reviews viewer
      card.querySelector('[data-act="reviews"]').addEventListener("click", async (e)=>{
        e.stopPropagation();
        await openRatingsViewer(h.id);
      });

      // join/edit
      const joinBtn = card.querySelector('[data-act="join"]');
      if(joinBtn) joinBtn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        if(isActive) return;
        await startChallenge(h);
      });
      const editBtn = card.querySelector('[data-act="edit"]');
      if(editBtn) editBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        alert("Á∑®ÈõÜ„ÅØÊ¨°ÊÆµÈöé„Åß„ÄÇ‰ªä„ÅØËá™ÂàÜ„ÅÆÊäïÁ®ø„ÅØÂèÇÂä†„ÅåÂá∫„Å™„ÅÑÁä∂ÊÖã„Åß„Åô„ÄÇ");
      });

      return card;
    }

    // ===== toggles =====
    async function toggleCreatorFav(creatorUid){
      if(!creatorUid) return;
      const ref = doc(db, "userCreatorFavs", currentUser.uid, "items", creatorUid);
      if(cachedFavCreators.has(creatorUid)){
        await deleteDoc(ref);
        cachedFavCreators.delete(creatorUid);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedFavCreators.add(creatorUid);
      }
      await refreshHome();
      await refreshProfile();
    }

    async function toggleBookmark(habitId){
      if(!habitId) return;
      const ref = doc(db, "userBookmarks", currentUser.uid, "items", habitId);
      if(cachedBookmarks.has(habitId)){
        await deleteDoc(ref);
        cachedBookmarks.delete(habitId);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedBookmarks.add(habitId);
      }
      await refreshHome();
      await refreshBookmarksView();
      await refreshProfile();
    }

    // ===== Challenges =====
    async function loadChallenges(limitN=200){
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(limitN)
      ));
      const arr = [];
      qs.forEach(s=> arr.push({ id:s.id, ...s.data() }));
      return arr;
    }
    async function loadActiveChallenges(){
      const all = await loadChallenges(200);
      return all.filter(x => x.status === "active").slice(0, 50);
    }

    // 1Êó•1ÂõûÔºà„Åä‰∏ñË©±Ôºâ
    function canCareToday(ch){
      const today = fmtYMD(nowLocal());
      const last = String(ch.lastActionYMD||"").slice(0,10);
      return last !== today;
    }

    // ===== Growth % =====
    function growthPctDynamic(ch){
      const day = Number(ch.day||1);
      const base = Math.max(0, Math.min(7, day-1)) / 7 * 100;

      const today = fmtYMD(nowLocal());
      const cared = String(ch.lastActionYMD||"").slice(0,10) === today;

      const totalMs = 86400000;
      const remain = msToMidnight();
      const elapsed = Math.max(0, Math.min(totalMs, totalMs - remain));
      const frac = elapsed / totalMs;

      const add = cared ? (frac * (100/7)) : 0;
      return Math.max(0, Math.min(100, base + add));
    }

    async function startChallenge(h){
      const actives = await loadActiveChallenges();
      if(actives.length >= 3){ alert("‰æùÈ†º„ÅØÊúÄÂ§ß3"); return; }
      if(h.creatorUid === currentUser.uid){ return; }

      const today = fmtYMD(nowLocal());
      const ref = doc(db, "userChallenges", currentUser.uid, "items", h.id);
      const snap = await getDoc(ref);
      if(snap.exists() && snap.data()?.status === "active") return;

      await setDoc(ref, {
        habitId: h.id,
        habitTitle: h.title || "",
        creatorUid: h.creatorUid || "",
        status: "active",
        startDate: today,
        day: 1,
        successDays: 0,
        restDays: 0,
        lastActionYMD: "",
        streakMiss: 0,
        difficulty: { easy:0, mid:0, hard:0 },
        ratingSubmitted: false,
        updatedAt: serverTimestamp()
      });

      await runTransaction(db, async (tx)=>{
        const href = doc(db, "habits", h.id);
        const hs = await tx.get(href);
        if(!hs.exists()) return;
        const cur = hs.data();
        tx.update(href, { participantsCount: Number(cur.participantsCount||0)+1, updatedAt: serverTimestamp() });
      });

      await runTransaction(db, async (tx)=>{
        const uref = doc(db,"users",currentUser.uid);
        const us = await tx.get(uref);
        if(!us.exists()) return;
        const u = us.data();
        tx.update(uref, { totalChallenges: Number(u.totalChallenges||0)+1, updatedAt: serverTimestamp() });
      });

      // ÂèÇÂä†„Åß„ÇÇÂ∞ë„Åó„É¨„Éô„É´„Åå‰∏ä„Åå„Çã
      await addXp(4);

      await refreshActiveHabitIds();
      await refreshSideActive();
      await refreshRecords();
      await refreshHome();
      await refreshProfile();
      await refreshTrain();
    }

    // ===== Side active list =====
    let countdownTimer = null;
    async function refreshSideActive(){
      if(!currentUser) return;

      const actives = await loadActiveChallenges();
      activeHabitIds = new Set(actives.map(x=>x.habitId));

      sideActiveList.innerHTML = "";

      if(countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(()=>{
        document.querySelectorAll("[data-care]").forEach(el=>{
          el.textContent = \`Ê¨°„ÅÆ„Åä‰∏ñË©±„Åæ„Åß \${fmtCountdown(msToMidnight())}\`;
        });
        if(trainCare) trainCare.textContent = \`Ê¨°„ÅÆ„Åä‰∏ñË©±„Åæ„Åß \${fmtCountdown(msToMidnight())}\`;

        if(msToMidnight() < 900){
          refreshDailyDoneCount();
          refreshSideActive();
          refreshHome();
          refreshTrain();
        }else{
          refreshTrain();
        }
      }, 1000);

      for(const ch of actives){
        const box = document.createElement("div");
        box.className = "sideItem";

        const can = canCareToday(ch);
        const care = \`Ê¨°„ÅÆ„Åä‰∏ñË©±„Åæ„Åß \${fmtCountdown(msToMidnight())}\`;

        const day = Math.max(1, Math.min(7, Number(ch.day||1)));
        const prog = growthPctDynamic(ch);

        box.innerHTML = \`
          <div class="sideTop">
            <div class="sideHabit">\${escapeHtml(ch.habitTitle||"")}</div>
            <div class="sideMeta">\${day}/7</div>
          </div>

          <div class="sideTop" style="align-items:center">
            <div class="sideCare" data-care="1">\${care}</div>
            <div class="sideMeta">\${prog.toFixed(0)}%</div>
          </div>

          <div class="sideBtns">
            <button class="btnMini" data-act="done" \${can ? "" : "disabled"}>„ÇÑ„Å£„Åü</button>
            <button class="btnMini" data-act="rest" \${can ? "" : "disabled"}>‰ºë„ÇÄ</button>
            <button class="btnMini" data-act="retire">„É™„Çø„Ç§„Ç¢</button>
            <button class="btnMini" data-act="rate" \${ch.ratingSubmitted ? "disabled" : ""}>Ë©ï‰æ°</button>
          </div>
        \`;

        box.querySelector('[data-act="done"]').addEventListener("click", ()=> openDiffModal(ch));
        box.querySelector('[data-act="rest"]').addEventListener("click", ()=> applyReport(ch, { type:"rest" }));
        box.querySelector('[data-act="retire"]').addEventListener("click", async ()=>{
          if(!confirm("„É™„Çø„Ç§„Ç¢Ôºü")) return;
          await applyReport(ch, { type:"retire" });
        });
        box.querySelector('[data-act="rate"]').addEventListener("click", async ()=>{
          await openRatingModalByChallenge(ch, "manual");
        });

        sideActiveList.appendChild(box);
      }
    }

    function openDiffModal(ch){
      diffTargetChallenge = ch;
      diffTitle.textContent = ch.habitTitle || "Èõ£ÊòìÂ∫¶";
      diffBg.classList.add("show");
    }
    function closeDiffModal(){
      diffTargetChallenge = null;
      diffBg.classList.remove("show");
    }
    diffClose.addEventListener("click", closeDiffModal);
    diffBg.addEventListener("click", (e)=>{ if(e.target===diffBg) closeDiffModal(); });
    diffBg.querySelectorAll("[data-diff]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!diffTargetChallenge) return;
        await applyReport(diffTargetChallenge, { type:"done", diff: btn.dataset.diff });
        closeDiffModal();
      });
    });

    // ===== Apply report =====
    async function applyReport(ch, payload){
      const today = fmtYMD(nowLocal());
      const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const cur = snap.data();

      if((payload.type==="done" || payload.type==="rest") && String(cur.lastActionYMD||"") === today){
        return;
      }

      const update = {};

      if(payload.type==="done"){
        update.successDays = Number(cur.successDays||0)+1;
        update.day = Math.min(8, Number(cur.day||1)+1);
        update.lastActionYMD = today;
        update.streakMiss = 0;

        const d = cur.difficulty || {easy:0,mid:0,hard:0};
        d[payload.diff] = Number(d[payload.diff]||0)+1;
        update.difficulty = d;

        await incDailyDoneCount();

        // „ÇÑ„Å£„ÅüÔºöÂü∫Êú¨XP + Èõ£ÊòìÂ∫¶„ÅßÂ∞ë„ÅóÂ∑Æ
        const diffXp = payload.diff==="hard" ? 18 : payload.diff==="mid" ? 14 : 12;
        await addXp(diffXp);

      }else if(payload.type==="rest"){
        update.restDays = Number(cur.restDays||0)+1;
        update.day = Math.min(8, Number(cur.day||1)+1);
        update.lastActionYMD = today;
        update.streakMiss = 0;

        await addXp(3);

      }else if(payload.type==="retire"){
        update.status = "retired";
        update.updatedAt = serverTimestamp();
        await updateDoc(ref, update);

        await maybePromptRating(ch.habitId, { ...cur, habitId: ch.habitId }, "retire");
        await refreshActiveHabitIds();
        await refreshSideActive();
        await refreshRecords();
        await refreshHome();
        await refreshProfile();
        await refreshTrain();
        return;
      }

      update.updatedAt = serverTimestamp();
      await updateDoc(ref, update);

      // 7Êó•ÁµÇ‰∫ÜÔºàday„Åå8„Å´„Å™„Å£„Åü„ÇâÁµÇ‰∫ÜÂà§ÂÆöÔºâ
      if(payload.type==="done" || payload.type==="rest"){
        const afterDay = Math.min(8, Number(cur.day||1)+1);
        if(afterDay === 8){
          const afterSuccess = Number(cur.successDays||0) + (payload.type==="done" ? 1 : 0);
          if(afterSuccess >= 5){
            await updateDoc(ref, { status:"cleared", updatedAt: serverTimestamp() });

            // ÊàêÂäüÔºà„ÇØ„É™„Ç¢Ôºâ„ÅØÁâπ„Å´„É¨„Éô„É´UPÔºà„Éú„Éº„Éä„ÇπXPÔºâ
            await addXp(30);

            await runTransaction(db, async (tx)=>{
              const uref = doc(db, "users", currentUser.uid);
              const us = await tx.get(uref);
              if(!us.exists()) return;
              const u = us.data();
              tx.update(uref, { clearCount: Number(u.clearCount||0)+1, updatedAt: serverTimestamp() });
            });
          }else{
            await updateDoc(ref, { status:"finished", updatedAt: serverTimestamp() });
          }

          const finalSnap = await getDoc(ref);
          const finalCh = finalSnap.exists() ? finalSnap.data() : cur;
          await maybePromptRating(ch.habitId, { ...finalCh, habitId: ch.habitId }, "finish");
        }
      }

      await refreshActiveHabitIds();
      await refreshSideActive();
      await refreshRecords();
      await refreshHome();
      await refreshProfile();
      await refreshTrain();
    }

    // ===== Auto retire (3Êó•Êú™Â†±Âëä) =====
    async function autoRetireIfMissed(){
      const today = nowLocal();
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(200)
      ));
      const updates = [];
      qs.forEach(s=>{
        const ch = s.data();
        if(ch.status !== "active") return;

        const startD = parseYMD(ch.startDate);
        const lastD = parseYMD(ch.lastActionYMD);

        let miss = 0;
        if(lastD){
          const gap = daysBetween(lastD, today);
          miss = Math.max(0, gap - 1);
        }else if(startD){
          const gap = daysBetween(startD, today);
          miss = Math.max(0, gap - 1);
        }

        const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
        if(miss >= 3){
          updates.push(updateDoc(ref, {
            status:"retired",
            streakMiss: miss,
            updatedAt: serverTimestamp()
          }));
        }else{
          updates.push(updateDoc(ref, { streakMiss: miss, updatedAt: serverTimestamp() }));
        }
      });
      await Promise.allSettled(updates);
    }

    // ===== Records =====
    async function refreshRecords(){
      if(!currentUser) return;
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(150)
      ));
      const items = [];
      qs.forEach(s=> items.push(s.data()));

      recordList.innerHTML = "";
      for(const ch of items){
        const row = document.createElement("div");
        row.className = "review";
        const day = Math.max(1, Math.min(7, Number(ch.day||1)));
        row.innerHTML = \`
          <div class="reviewTop">
            <div class="reviewName">\${escapeHtml(ch.habitTitle||"")}</div>
            <div class="reviewMeta">\${escapeHtml(String(ch.status||""))}</div>
          </div>
          <div class="reviewText">\${day}/7 / ÊàêÂäü \${Number(ch.successDays||0)} / ‰ºë \${Number(ch.restDays||0)} / Êú™Â†±Âëä \${Number(ch.streakMiss||0)} / ËÇ≤Êàê \${growthPctDynamic(ch).toFixed(0)}%</div>
        \`;
        recordList.appendChild(row);
      }
    }

    // ===== Bookmarks =====
    async function refreshBookmarksView(){
      if(!currentUser) return;
      bmCount.textContent = String(cachedBookmarks.size);
      bmFeed.innerHTML = "";
      if(cachedBookmarks.size === 0) return;

      await refreshActiveHabitIds();

      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(300)));
      const habits = [];
      qs.forEach(s=> habits.push({ id:s.id, ...s.data() }));
      const filtered = habits.filter(h => cachedBookmarks.has(h.id));
      bmCount.textContent = String(filtered.length);
      for(const h of filtered){
        bmFeed.appendChild(renderHabitCard(h));
      }
    }

    // ===== Profile =====
    async function refreshProfile(){
      if(!currentUser) return;

      const actives = await loadActiveChallenges();
      const myPosts = await countMyPosts();

      const total = Number(myProfile?.xpTotal||0);
      const { lv, cur, need } = computeLevelFromXp(total);
      profileLv.textContent = \`Lv \${lv}\`;

      profileList.innerHTML = \`
        <div class="review">
          <div class="reviewTop">
            <div class="reviewName">\${escapeHtml(myProfile?.name||"‚Äî")}</div>
            <div class="reviewMeta" style="font-weight:1100">Lv \${lv} / ÊÆã„Çä \${Math.max(0, need-cur)}XP</div>
          </div>
          <div class="reviewText">
            XP \${cur} / \${need}\\n
            „ÇØ„É™„Ç¢ \${Number(myProfile?.clearCount||0)} / ÊåëÊà¶‰∏≠ \${actives.length} / Á∑èÊåëÊà¶ \${Number(myProfile?.totalChallenges||0)}\\n
            „Éï„Ç©„É≠„Éº \${cachedFavCreators.size} / ‰øùÂ≠ò \${cachedBookmarks.size} / ÊäïÁ®ø \${myPosts}\\n
            „Éï„Ç©„É≠„ÉØ„Éº \${Number(myProfile?.followerCount||0)}
          </div>
        </div>

        <div class="review">
          <div class="reviewTop">
            <div class="reviewName">Ëâ≤</div>
            <div class="reviewMeta">‚Äî</div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px">
            <select class="selectKeep" id="profileColor">
              <option value="#111111">Èªí</option>
              <option value="#e00000">Ëµ§</option>
              <option value="#0b6cff">Èùí</option>
              <option value="#00a86b">Á∑ë</option>
              <option value="#ff8a00">Ê©ô</option>
            </select>
            <button class="btn primary" id="saveProfileColor">‰øùÂ≠ò</button>
          </div>
        </div>
      \`;

      const profileColor = document.getElementById("profileColor");
      const saveProfileColor = document.getElementById("saveProfileColor");
      if(profileColor && saveProfileColor){
        profileColor.value = myProfile?.avatarColor || "#111111";
        saveProfileColor.addEventListener("click", async ()=>{
          const c = profileColor.value || "#111111";
          await updateDoc(doc(db,"users",currentUser.uid), { avatarColor: c, updatedAt: serverTimestamp() });
          const snap = await getDoc(doc(db,"users",currentUser.uid));
          myProfile = snap.data();
          setXpUI();
          applyUserHeader();
          await refreshHome();
        });
      }
    }

    async function countMyPosts(){
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(450)));
      let c = 0;
      qs.forEach(s=>{
        const h = s.data();
        if(h.creatorUid === currentUser.uid) c++;
      });
      return c;
    }

    // ===== Rating rules =====
    async function canRate(habitId, ch){
      const didAny = (Number(ch.successDays||0) + Number(ch.restDays||0)) > 0;
      const finishedLike = ["cleared","finished","retired"].includes(String(ch.status||""));
      return didAny || finishedLike;
    }

    async function maybePromptRating(habitId, ch, reason){
      const ref = doc(db, "userChallenges", currentUser.uid, "items", habitId);
      const snap = await getDoc(ref);
      if(snap.exists() && snap.data()?.ratingSubmitted) return;

      if(!(await canRate(habitId, ch))) return;

      const rref = doc(db, "habits", habitId, "ratings", currentUser.uid);
      const rsnap = await getDoc(rref);
      if(rsnap.exists()) {
        await updateDoc(ref, { ratingSubmitted: true, updatedAt: serverTimestamp() });
        return;
      }

      await openRatingModalByChallenge(ch, reason);
    }

    function openRatingModal(){
      ratingStars = 0;
      commentBox.value = "";
      renderStars();
      ratingBg.classList.add("show");
    }
    function closeRatingModal(){
      ratingBg.classList.remove("show");
      ratingTargetHabit = null;
    }
    ratingClose.addEventListener("click", closeRatingModal);
    ratingBg.addEventListener("click", (e)=>{ if(e.target===ratingBg) closeRatingModal(); });

    function renderStars(){
      starsRow.innerHTML = "";
      for(let i=1;i<=5;i++){
        const b = document.createElement("div");
        b.className = "starBtn";
        b.textContent = i<=ratingStars ? "‚òÖ" : "‚òÜ";
        b.classList.toggle("active", i<=ratingStars);
        b.addEventListener("click", ()=>{
          ratingStars = i;
          renderStars();
        });
        starsRow.appendChild(b);
      }
    }

    async function openRatingModalByChallenge(ch, reason){
      const ok = await canRate(ch.habitId, ch);
      if(!ok){ alert("ÂèÇÂä†ËÄÖ„ÅÆ„Åø"); return; }

      ratingTargetHabit = ch.habitId;

      ratingTitle.textContent = reason==="retire" ? \`Ë©ï‰æ°Ôºà„É™„Çø„Ç§„Ç¢Ôºâ\` :
                                reason==="finish" ? \`Ë©ï‰æ°Ôºà7Êó•ÁµÇ‰∫ÜÔºâ\` :
                                \`Ë©ï‰æ°\`;

      openRatingModal();
      await loadRatingsList(ch.habitId);

      ratingSave.onclick = async ()=>{
        if(ratingStars < 1){ alert("Êòü„ÇíÈÅ∏„Å∂"); return; }

        await setDoc(doc(db, "habits", ch.habitId, "ratings", currentUser.uid), {
          uid: currentUser.uid,
          displayName: myProfile?.name || currentUser.displayName || "„É¶„Éº„Ç∂„Éº",
          photoURL: currentUser.photoURL || "",
          stars: ratingStars,
          comment: (commentBox.value || "").trim().slice(0, 300),
          updatedAt: serverTimestamp()
        }, { merge:true });

        await updateDoc(doc(db, "userChallenges", currentUser.uid, "items", ch.habitId), {
          ratingSubmitted: true,
          updatedAt: serverTimestamp()
        });

        await recomputeRatingAgg(ch.habitId);

        closeRatingModal();
        await refreshHome();
        await refreshProfile();
      };
    }

    async function loadRatingsList(habitId){
      reviewList.innerHTML = "";
      const qs = await getDocs(query(
        collection(db, "habits", habitId, "ratings"),
        orderBy("updatedAt","desc"),
        limit(40)
      ));
      const arr = [];
      qs.forEach(s=> arr.push(s.data()));
      for(const r of arr){
        const box = document.createElement("div");
        box.className = "review";
        const stars = "‚òÖ".repeat(Math.max(0, Math.min(5, Number(r.stars||0)))) + "‚òÜ".repeat(Math.max(0, 5-Number(r.stars||0)));
        box.innerHTML = \`
          <div class="reviewTop">
            <div class="reviewName">\${escapeHtml(r.displayName||"„É¶„Éº„Ç∂„Éº")}</div>
            <div class="reviewMeta">\${stars}</div>
          </div>
          <div class="reviewText">\${escapeHtml(r.comment||"")}</div>
        \`;
        reviewList.appendChild(box);
      }
    }

    async function recomputeRatingAgg(habitId){
      const rs = await getDocs(query(collection(db, "habits", habitId, "ratings"), limit(500)));
      let sum = 0;
      let cnt = 0;
      rs.forEach(s=>{
        const r = s.data();
        const stars = Number(r.stars||0);
        if(stars>=1 && stars<=5){
          sum += stars;
          cnt += 1;
        }
      });
      const avg = cnt ? (sum/cnt) : 0;

      await updateDoc(doc(db, "habits", habitId), {
        avgRating: Number.isFinite(avg) ? avg : 0,
        ratingCount: cnt,
        updatedAt: serverTimestamp()
      });
    }

    // reviews viewer (Èñ≤Ë¶ß„ÅÆ„Åø)
    async function openRatingsViewer(habitId){
      ratingTitle.textContent = "Âè£„Ç≥„Éü";
      ratingStars = 0;
      commentBox.value = "";
      renderStars();
      ratingSave.onclick = null;
      ratingBg.classList.add("show");
      await loadRatingsList(habitId);
    }

    // ===== Creator modal =====
    function openCreatorModal(uid, name, photo, color){
      creatorName.textContent = name || "‚Äî";
      creatorAva.innerHTML = "";
      if(photo){
        const img = document.createElement("img");
        img.src = photo;
        creatorAva.appendChild(img);
      }else{
        creatorAva.textContent = "‚ñ°";
        creatorAva.style.background = color || "#111111";
        creatorAva.style.color = "#fff";
      }
      creatorPosts.innerHTML = "";
      creatorBg.classList.add("show");
      loadCreatorPosts(uid);
    }
    function closeCreatorModal(){ creatorBg.classList.remove("show"); }
    creatorClose.addEventListener("click", closeCreatorModal);
    creatorBg.addEventListener("click", (e)=>{ if(e.target===creatorBg) closeCreatorModal(); });

    async function loadCreatorPosts(uid){
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(300)));
      const arr = [];
      qs.forEach(s=>{
        const h = s.data();
        if(h.creatorUid === uid) arr.push({ id:s.id, ...h });
      });

      if(arr.length===0){
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = \`<div class="reviewText">ÊäïÁ®ø„Å™„Åó</div>\`;
        creatorPosts.appendChild(box);
        return;
      }

      for(const h of arr){
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = \`
          <div class="reviewTop">
            <div class="reviewName">\${escapeHtml(h.title||"")}</div>
            <div class="reviewMeta">\${escapeHtml(String(h.createdAtYMD||""))}</div>
          </div>
          <div class="reviewText">\${escapeHtml(h.action||"")}</div>
        \`;
        creatorPosts.appendChild(box);
      }
    }

    // ===== Char list modal =====
    function openCharModal(){
      const lv = Number(myProfile?.level||1);
      charList.innerHTML = "";

      const maxLv = Math.max(10, lv+2);
      for(let L=1; L<=maxLv; L++){
        const eggs = CHAR_TIERS.filter(x=>x.type==="egg" && x.minLv<=L);
        const seeds = CHAR_TIERS.filter(x=>x.type==="seed" && x.minLv<=L);
        const eggShow = eggs.length ? eggs[eggs.length-1] : null;
        const seedShow = seeds.length ? seeds[seeds.length-1] : null;

        const row = document.createElement("div");
        row.className = "review";
        row.innerHTML = \`
          <div class="reviewTop">
            <div class="reviewName">Lv \${L}</div>
            <div class="reviewMeta">\${L===lv ? "ÁèæÂú®" : ""}</div>
          </div>
          <div class="reviewText">
            ÂçµÔºö\${eggShow ? \`\${eggShow.emoji} \${eggShow.name}\` : "‚Äî"}\\n
            Á®ÆÔºö\${seedShow ? \`\${seedShow.emoji} \${seedShow.name}\` : "‚Äî"}\\n
            Ê¨°„ÅÆLvÔºö\${L+1}
          </div>
        \`;
        charList.appendChild(row);
      }

      charBg.classList.add("show");
    }
    function closeCharModal(){ charBg.classList.remove("show"); }
    openCharList.addEventListener("click", openCharModal);
    charClose.addEventListener("click", closeCharModal);
    charBg.addEventListener("click", (e)=>{ if(e.target===charBg) closeCharModal(); });

    // ===== Training view =====
    function stageFromPct(pct){
      const p = Math.max(0, Math.min(100, Math.floor(pct||0)));
      for(const s of TRAIN_VISUAL_STAGES){
        if(p <= s.max) return s;
      }
      return TRAIN_VISUAL_STAGES[TRAIN_VISUAL_STAGES.length-1];
    }

    async function refreshTrain(){
      if(!currentUser) return;
      trainChallenges = await loadActiveChallenges();
      if(trainChallenges.length===0){
        trainHint.textContent = "ÊåëÊà¶‰∏≠„Å™„Åó";
        trainSlot.textContent = "‚Äî";
        trainHabitTitle.textContent = "‚Äî";
        trainPctText.textContent = "0%";
        trainPct.textContent = "0%";
        trainFill.style.width = "0%";
        trainEmoji.textContent = "ü•ö";
        trainStage.textContent = "‚Äî";
        trainCare.textContent = \`Ê¨°„ÅÆ„Åä‰∏ñË©±„Åæ„Åß \${fmtCountdown(msToMidnight())}\`;
        btnSetAvatar.disabled = true;
        return;
      }

      trainHint.textContent = \`ÊåëÊà¶‰∏≠ \${trainChallenges.length} / 3\`;
      trainIndex = Math.max(0, Math.min(trainIndex, trainChallenges.length-1));
      renderTrainCurrent();
    }

    function renderTrainCurrent(){
      const ch = trainChallenges[trainIndex];
      const slot = \`\${trainIndex+1} / \${trainChallenges.length}\`;

      const pct = growthPctDynamic(ch);
      const stage = stageFromPct(pct);

      const day = Math.max(1, Math.min(7, Number(ch.day||1)));
      trainSlot.textContent = slot;
      trainHabitTitle.textContent = \`\${ch.habitTitle || "‚Äî"}Ôºà\${day}/7Ôºâ\`;
      trainPctText.textContent = \`\${pct.toFixed(0)}%\`;
      trainPct.textContent = \`\${pct.toFixed(0)}%\`;
      trainFill.style.width = \`\${pct}%\`;
      trainStage.textContent = stage.label;
      trainEmoji.textContent = stage.emoji;
      trainCare.textContent = \`Ê¨°„ÅÆ„Åä‰∏ñË©±„Åæ„Åß \${fmtCountdown(msToMidnight())}\`;

      const canSet = (String(ch.status||"")==="cleared") || (pct>=100);
      btnSetAvatar.disabled = !canSet;

      btnSetAvatar.onclick = async ()=>{
        if(!canSet) return;
        await updateDoc(doc(db,"users",currentUser.uid), {
          avatarSetFrom:"creature",
          avatarCreature: String(trainEmoji.textContent||""),
          updatedAt: serverTimestamp()
        });
        alert("‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºàÂ∞ÜÊù•„Åì„ÅÆÂ≠ê„ÅÆÁîªÂÉè„Çí„Ç¢„Ç§„Ç≥„É≥„Å´„Åß„Åç„Åæ„ÅôÔºâ");
      };
    }

    trainPrev.addEventListener("click", ()=>{
      if(trainChallenges.length===0) return;
      trainIndex = (trainIndex - 1 + trainChallenges.length) % trainChallenges.length;
      renderTrainCurrent();
    });
    trainNext.addEventListener("click", ()=>{
      if(trainChallenges.length===0) return;
      trainIndex = (trainIndex + 1) % trainChallenges.length;
      renderTrainCurrent();
    });

    // ===== Init + timers =====
    setInterval(()=>{
      if(!currentUser) return;
      refreshDailyDoneCount();
      // 1ÊôÇÈñì„Åä„Åç„Å´Âçµ„ÅåÂ§â„Çè„Çã„ÅÆ„Åß„ÄÅËªΩ„ÅèÊõ¥Êñ∞
      refreshHome();
    }, 60000);

    showOnly("home");
    updatePostCounter();
    openPost.classList.add("show");

  </script>
</body>
</html>
