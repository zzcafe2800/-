<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¿’æ…£ã•ãŒã—</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --line:#e6e6e6;
      --text:#111111;
      --muted:#6a6a6a;
      --muted2:#8a8a8a;
      --on:#111111;
      --off:#ffffff;

      --r:14px;
      --gap:10px;
      --shadow: 0 4px 14px rgba(0,0,0,.06);
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ===== Layout ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 280px 1fr;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .app{grid-template-columns: 86px 1fr; height:auto; min-height:100%}
      .nav{padding:10px 8px}
      .nav .label{display:none}
      .nav .brandName{display:none}
      .nav .navBtn{justify-content:center}
      .content{padding:12px}
      .feedGrid{grid-template-columns: 1fr;} /* ã‚¹ãƒãƒ›1åˆ— */
      .bottomBar{grid-template-columns: 1fr;}
      .bottomBar .miniRow{justify-content:flex-start; flex-wrap:wrap}
      .bottomBar .miniSelect{min-width: 140px}
    }

    .nav{
      border-right:1px solid var(--line);
      padding:14px;
      background: #fff;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:4px 6px 10px;
    }
    .logo{
      width:34px; height:34px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      display:grid; place-items:center;
    }
    .brandName{
      font-size:14px;
      font-weight:900;
      letter-spacing:.06em;
      white-space:nowrap;
    }

    .navBtn{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      transition:.12s transform, .12s background;
      user-select:none;
    }
    .navBtn:hover{transform: translateY(-1px); background:#fafafa}
    .navBtn.active{background:#f4f4f4}
    .navBtn .ico{width:26px; display:grid; place-items:center}
    .navBtn .label{font-weight:900; letter-spacing:.03em}

    .sep{
      height:1px; background:var(--line);
      margin: 6px 0;
    }

    .userBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      display:flex; gap:10px; align-items:center;
      background:#fff;
      min-width:0;
    }
    .avatar{
      width:32px; height:32px;
      border:1px solid var(--line);
      border-radius:50%;
      background:#fff;
      overflow:hidden;
      flex:0 0 auto;
      display:grid; place-items:center;
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .userMeta{min-width:0}
    .userName{font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .userSmall{font-size:11px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* å·¦ï¼šä¾é ¼ä¸€è¦§ */
    .sideTitle{
      font-weight:900;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.06em;
      padding: 2px 4px 0;
    }
    .sideList{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      padding-right:2px;
      max-height: calc(100vh - 280px);
    }
    .sideItem{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sideTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      min-width:0;
    }
    .sideHabit{
      font-weight:900;
      font-size:13px;
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .sideMeta{
      font-size:11px; color:var(--muted);
      font-family:var(--mono);
      white-space:nowrap;
    }
    .sideBtns{
      display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;
    }

    /* ===== Main ===== */
    .content{
      height:100%;
      overflow:auto;
      padding:14px;
      position:relative;
      background:#fff;
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background:#fff;
      box-shadow: var(--shadow);
    }

    .headerBar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px;
      border-bottom:1px solid var(--line);
    }
    .hTitle{
      font-weight:1000;
      letter-spacing:.06em;
      font-size:14px;
      display:flex; align-items:center; gap:10px;
      white-space:nowrap;
    }
    .hBadge{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      font-size:12px;
      font-family:var(--mono);
      background:#fff;
    }

    .listHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .listHeaderLeft{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .labelPill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      color: var(--muted);
      background:#fff;
    }

    /* ===== Tag ranking blocks ===== */
    .tagWrap{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .tagWrap{grid-template-columns:1fr;}
    }
    .rankBox{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding:10px;
      box-shadow: var(--shadow);
    }
    .rankTitle{
      font-size:12px;
      font-weight:1000;
      letter-spacing:.06em;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .rankGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
    }
    .rankChip{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:8px 8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:#fff;
      user-select:none;
      min-width:0;
    }
    .rankChip:hover{background:#fafafa}
    .rankChip.active{background:#f2f2f2}
    .rk{
      font-family:var(--mono);
      font-size:11px;
      color: var(--muted);
      flex:0 0 auto;
    }
    .tagName{
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    /* ===== Feed ===== */
    .feedArea{
      padding:12px;
    }
    .feedLabel{
      font-weight:1000;
      letter-spacing:.06em;
      color: var(--muted);
      font-size:12px;
      margin: 0 0 10px 0;
    }

    /* å¿…ãšç¸¦2åˆ— */
    .feedGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:stretch;
    }

    .habitCard{
      border:1px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding:10px;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:8px;
      min-height: 180px;
    }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .creatorRow{
      display:flex; align-items:center; gap:8px;
      min-width:0;
    }
    .miniAva{
      width:22px; height:22px;
      border:1px solid var(--line);
      border-radius:50%;
      overflow:hidden;
      background:#fff;
      flex:0 0 auto;
    }
    .miniAva img{width:100%; height:100%; object-fit:cover}
    .creatorName{
      font-size:12px;
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 160px;
    }

    .topActions{
      display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .iconBtn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius: 10px;
      padding:8px 9px;
      cursor:pointer;
      display:grid;
      place-items:center;
      min-width:36px;
      user-select:none;
      position:relative;
    }
    .iconBtn:hover{background:#fafafa}
    .iconBtn.on{background:#111; color:#fff; border-color:#111}

    .iconBtn[data-tip]::after{
      content: attr(data-tip);
      position:absolute;
      bottom: calc(100% + 6px);
      left:50%;
      transform: translateX(-50%);
      background:#111;
      color:#fff;
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
      font-weight:900;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease;
    }
    .iconBtn:hover::after{opacity:1; transform: translateX(-50%) translateY(-2px)}

    .titleBlock{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height: 0;
    }
    .habitTitle{
      font-size:20px;
      font-weight:1100;
      letter-spacing:.02em;
      line-height:1.15;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp:3; /* â˜…ã‚«ãƒ¼ãƒ‰ã®7-8å‰²ã¯ã‚¿ã‚¤ãƒˆãƒ« */
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .habitAction{
      font-size:12px;
      color: var(--muted2);
      line-height:1.35;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .cardBottom{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .metaLeft{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .catTagRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      font-weight:900;
    }
    .chipMini{
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 8px;
      background:#fff;
      cursor:pointer;
    }
    .chipMini:hover{background:#fafafa}

    .statsRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      font-size:12px;
      font-weight:1000;
      color:#111;
    }
    .statPill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-family:var(--mono);
    }

    /* ===== Bottom bars ===== */
    .bottomWrap{
      position:sticky;
      bottom:0;
      z-index:20;
      background:#fff;
      border-top:1px solid var(--line);
      padding:10px;
    }
    .bottomBar{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .searchGroup{
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding:8px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .searchInput{
      border:none;
      outline:none;
      font-size:14px;
      padding:8px 10px;
      background:transparent;
      color:#111;
      width:100%;
    }
    .miniRow{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .miniSelect, .miniBtn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      min-height: 36px;
    }
    .miniSelect{outline:none}
    .miniBtn:hover, .miniSelect:hover{background:#fafafa}

    .postBtn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
      min-height: 44px;
      white-space:nowrap;
    }
    .postBtn:hover{filter:brightness(1.03)}

    /* ===== Modals ===== */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.40);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:60;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(760px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h2{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .modalFooter{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      border-radius: 10px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:1000;
    }
    .btn:hover{background:#fafafa}
    .btn.primary{border-color:#111; background:#111; color:#fff}
    .btn.danger{border-color:#111; background:#fff; color:#111}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .fieldRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .fieldRow{grid-template-columns:1fr} }

    /* æ ã¯æ¥µåŠ›æ¸›ã‚‰ã™ï¼ˆä¸‹ç·šã®ã¿ï¼‰ */
    .lineInput{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
    }
    .lineArea{
      border:none;
      border-bottom:1px solid var(--line);
      border-radius:0;
      padding:10px 2px;
      outline:none;
      font-size:14px;
      width:100%;
      background:transparent;
      color:#111;
      resize:vertical;
      min-height: 72px;
    }
    .selectKeep{
      border:1px solid var(--line);
      border-radius: 10px;
      padding:10px 10px;
      outline:none;
      background:#fff;
      font-weight:900;
      min-height: 40px;
    }

    .starsRow{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .starBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      padding:10px 8px;
      cursor:pointer;
      font-weight:1000;
      text-align:center;
      user-select:none;
    }
    .starBtn.active{background:#111; color:#fff; border-color:#111}
    .toggleBtn{
      border:1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      padding:10px 10px;
      cursor:pointer;
      font-weight:1000;
      user-select:none;
    }
    .toggleBtn.active{background:#111; color:#fff; border-color:#111}
    .reviewList{
      margin-top:12px;
      border-top:1px solid var(--line);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 260px;
      overflow:auto;
    }
    .review{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
    }
    .reviewTop{display:flex; justify-content:space-between; gap:10px}
    .reviewName{font-weight:1000; font-size:12px}
    .reviewMeta{font-size:12px; color:var(--muted); font-family:var(--mono)}
    .reviewText{margin-top:8px; font-size:13px; color:#111; white-space:pre-wrap; line-height:1.5}
    .counter{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
    }

    /* Gate */
    .gate{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:100;
      background: rgba(0,0,0,.35);
      padding:18px;
    }
    .gate.show{display:flex}
    .gateCard{
      width:min(520px, 100%);
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .gateTitle{
      margin:0;
      font-size:14px;
      font-weight:1100;
      letter-spacing:.06em;
    }
    .gateActions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
    .gateBtn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
    }

    /* Profile login/logout (å³ä¸‹å›ºå®š) */
    .profileAuthDock{
      position:sticky;
      bottom: 10px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding: 12px;
      border-top:1px solid var(--line);
      background:#fff;
    }

    /* å°ã•ã„ +1 æ¼”å‡º */
    .plusOne{
      position:fixed;
      right:18px;
      top: 18px;
      z-index:120;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:none;
      font-weight:1100;
      font-family:var(--mono);
    }
    @keyframes floatUp{
      0%{transform: translateY(8px); opacity:0}
      15%{opacity:1}
      100%{transform: translateY(-14px); opacity:0}
    }
  </style>
</head>

<body>
  <div class="plusOne" id="plusOne">+1</div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã‚²ãƒ¼ãƒˆ -->
  <div class="gate" id="loginGate">
    <div class="gateCard">
      <p class="gateTitle">ãƒ­ã‚°ã‚¤ãƒ³</p>
      <div class="gateActions">
        <button class="gateBtn" id="gateLoginBtn">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- ===== Left ===== -->
    <aside class="nav">
      <div class="brand">
        <div class="logo">â–¡</div>
        <div class="brandName">ç¿’æ…£ã•ãŒã—</div>
      </div>

      <button class="navBtn active" id="navHome">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/></svg>
        </div>
        <div class="label">ãƒ›ãƒ¼ãƒ </div>
      </button>

      <button class="navBtn" id="navRecords">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v3M16 2v3"/><path d="M3 7h18"/><path d="M5 7v14a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7"/><path d="M8 11h3"/><path d="M8 15h6"/></svg>
        </div>
        <div class="label">é”æˆè¨˜éŒ²</div>
      </button>

      <button class="navBtn" id="navBookmarks">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3h12a1 1 0 0 1 1 1v18l-7-4-7 4V4a1 1 0 0 1 1-1z"/></svg>
        </div>
        <div class="label">ä¿å­˜</div>
      </button>

      <button class="navBtn" id="navProfile">
        <div class="ico">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div class="label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
      </button>

      <div class="sep"></div>

      <div class="userBox">
        <div class="avatar" id="userAvatar">â–¡</div>
        <div class="userMeta">
          <div class="userName" id="userName">â€”</div>
          <div class="userSmall" id="userSmall">â€”</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sideTitle">ä¾é ¼ï¼ˆæŒ‘æˆ¦ä¸­ï¼‰</div>
      <div class="sideList" id="sideActiveList"></div>
    </aside>

    <!-- ===== Right ===== -->
    <main class="content">
      <!-- ===== Home ===== -->
      <section class="panel" id="viewHome">
        <div class="headerBar">
          <div class="hTitle">
            ç¿’æ…£æ¢ã—
            <span class="hBadge" id="todayDoneBadge">æœ¬æ—¥ 0 äººãŒé”æˆ</span>
          </div>
          <div class="hBadge">è¡¨ç¤º <span id="countShown">0</span></div>
        </div>

        <!-- tags -->
        <div class="tagWrap">
          <div class="rankBox">
            <div class="rankTitle"><span>ãŠã™ã™ã‚TOP</span><span class="counter" id="recoHint">â€”</span></div>
            <div class="rankGrid" id="rankReco"></div>
          </div>
          <div class="rankBox">
            <div class="rankTitle"><span>äººæ°—TOP</span><span class="counter" id="topHint">â€”</span></div>
            <div class="rankGrid" id="rankTop"></div>
          </div>
        </div>

        <!-- list -->
        <div class="feedArea">
          <p class="feedLabel">ä¸€è¦§</p>
          <div class="feedGrid" id="feed"></div>
        </div>

        <!-- bottom search (å¸¸ã«ä¸€ç•ªä¸‹) -->
        <div class="bottomWrap">
          <div class="bottomBar">
            <div class="searchGroup">
              <input class="searchInput" id="q" placeholder="æ¤œç´¢ï¼ˆã“ã“ã«ã‚«ãƒ†ã‚´ãƒªãƒ»ä¸¦ã³æ›¿ãˆãƒ»ã‚¿ã‚°è§£é™¤ãŒå…¥ã‚Šã¾ã™ï¼‰" />
              <div class="miniRow">
                <select class="miniSelect" id="categoryFilter" title="ã‚«ãƒ†ã‚´ãƒª">
                  <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆã™ã¹ã¦ï¼‰</option>
                  <option>ãƒ¡ãƒ³ã‚¿ãƒ«</option><option>ç¡çœ </option><option>é‹å‹•</option><option>å¥åº·</option>
                  <option>ç”Ÿæ´»</option><option>å‹‰å¼·</option><option>è‹±èª</option><option>ä»•äº‹</option><option>ãã®ä»–</option>
                </select>

                <select class="miniSelect" id="sortBy" title="ä¸¦ã³æ›¿ãˆ">
                  <option value="new">æ–°ç€</option>
                  <option value="rating">è©•ä¾¡</option>
                  <option value="success">æˆåŠŸç‡</option>
                  <option value="days">ç¶™ç¶š</option>
                  <option value="favCreators">ãŠæ°—ã«å…¥ã‚Šä¸­ã®äºº</option>
                </select>

                <button class="miniBtn" id="btnClearTag" title="ã‚¿ã‚°è§£é™¤">ã‚¿ã‚°è§£é™¤</button>
              </div>
            </div>

            <button class="postBtn" id="openPost">æŠ•ç¨¿</button>
          </div>
        </div>
      </section>

      <!-- ===== Records ===== -->
      <section class="panel" id="viewRecords" style="display:none">
        <div class="headerBar">
          <div class="hTitle">é”æˆè¨˜éŒ²</div>
          <div class="hBadge">â€”</div>
        </div>
        <div style="padding:12px" id="recordList"></div>
      </section>

      <!-- ===== Bookmarks ===== -->
      <section class="panel" id="viewBookmarks" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ä¿å­˜</div>
          <div class="hBadge">ä»¶æ•° <span id="bmCount">0</span></div>
        </div>
        <div style="padding:12px">
          <div class="feedGrid" id="bmFeed"></div>
        </div>
      </section>

      <!-- ===== Profile ===== -->
      <section class="panel" id="viewProfile" style="display:none">
        <div class="headerBar">
          <div class="hTitle">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
          <div class="hBadge">â€”</div>
        </div>
        <div style="padding:12px" id="profileList"></div>

        <!-- Googleãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã¯ã“ã“ã ã‘ï¼ˆå³ä¸‹ï¼‰ -->
        <div class="profileAuthDock">
          <button class="btn primary" id="btnLogin">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="btn" id="btnLogout" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== åå‰ç™»éŒ² ===== -->
  <div class="modalBg" id="nameBg">
    <div class="modal">
      <h2>åå‰</h2>
      <input class="lineInput" id="nameInput" placeholder="åå‰" maxlength="16" />
      <div class="modalFooter">
        <button class="btn primary" id="nameSave" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ===== åˆå›ã‚«ãƒ†ã‚´ãƒªé¸æŠ ===== -->
  <div class="modalBg" id="catBg">
    <div class="modal">
      <h2>ã‚«ãƒ†ã‚´ãƒª</h2>
      <div class="fieldRow" id="catList" style="margin-top:10px"></div>
      <div class="modalFooter">
        <button class="btn" id="catClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="catSave" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ===== æŠ•ç¨¿ ===== -->
  <div class="modalBg" id="postBg">
    <div class="modal">
      <h2>æŠ•ç¨¿</h2>

      <div style="margin-top:10px">
        <div class="counter" id="postCounter">0 / 40</div>
        <input class="lineInput" id="newTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" maxlength="40" />
        <textarea class="lineArea" id="newAction" placeholder="ã‚„ã‚‹ã“ã¨ï¼ˆ40æ–‡å­—ï¼‰" maxlength="40"></textarea>
      </div>

      <div class="fieldRow">
        <input class="lineInput" id="newTags" placeholder="ã‚¿ã‚°ï¼ˆä¾‹ï¼šä¸å®‰,å¯ã¤ãï¼‰" />
        <select class="selectKeep" id="newCategory">
          <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</option>
          <option>ãƒ¡ãƒ³ã‚¿ãƒ«</option><option>ç¡çœ </option><option>é‹å‹•</option><option>å¥åº·</option>
          <option>ç”Ÿæ´»</option><option>å‹‰å¼·</option><option>è‹±èª</option><option>ä»•äº‹</option><option>ãã®ä»–</option>
        </select>
      </div>

      <div class="modalFooter">
        <button class="btn" id="postClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btnPost">æŠ•ç¨¿</button>
      </div>
    </div>
  </div>

  <!-- ===== é›£æ˜“åº¦ï¼ˆ3æŠï¼‰ ===== -->
  <div class="modalBg" id="diffBg">
    <div class="modal">
      <h2 id="diffTitle">é›£æ˜“åº¦</h2>
      <div class="fieldRow" style="grid-template-columns:1fr 1fr 1fr; margin-top:12px">
        <button class="btn" data-diff="easy">ğŸ˜Š</button>
        <button class="btn" data-diff="mid">ğŸ™‚</button>
        <button class="btn" data-diff="hard">ğŸ˜…</button>
      </div>
      <div class="modalFooter">
        <button class="btn" id="diffClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ===== è©•ä¾¡ï¼ˆå®Ÿéš›ã«å‚åŠ ã—ãŸäººã ã‘ / ãƒªã‚¿ã‚¤ã‚¢ or 7æ—¥å¾Œï¼‰ ===== -->
  <div class="modalBg" id="ratingBg">
    <div class="modal">
      <h2 id="ratingTitle">è©•ä¾¡</h2>

      <div class="starsRow" id="starsRow"></div>

      <div style="display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap">
        <button class="toggleBtn" id="likeToggle">ãƒ•ã‚©ãƒ­ãƒ¼</button>
        <span class="labelPill">R<span id="myRank">1</span></span>
      </div>

      <textarea class="lineArea" id="commentBox" placeholder="å£ã‚³ãƒŸï¼ˆçŸ­æ–‡ï¼‰" style="margin-top:10px"></textarea>

      <div class="modalFooter">
        <button class="btn" id="ratingClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="ratingSave">é€ä¿¡</button>
      </div>

      <div class="reviewList" id="reviewList"></div>
    </div>
  </div>

  <!-- ===== ç·¨é›†ï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã ã‘ï¼‰ ===== -->
  <div class="modalBg" id="editBg">
    <div class="modal">
      <h2 id="editTitle">ç·¨é›†</h2>

      <div style="margin-top:10px">
        <div class="counter" id="editCounter">0 / 40</div>
        <input class="lineInput" id="editNewTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" maxlength="40" />
        <textarea class="lineArea" id="editNewAction" placeholder="ã‚„ã‚‹ã“ã¨ï¼ˆ40æ–‡å­—ï¼‰" maxlength="40"></textarea>
      </div>

      <div class="fieldRow">
        <input class="lineInput" id="editNewTags" placeholder="ã‚¿ã‚°ï¼ˆä¾‹ï¼šä¸å®‰,å¯ã¤ãï¼‰" />
        <select class="selectKeep" id="editNewCategory">
          <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</option>
          <option>ãƒ¡ãƒ³ã‚¿ãƒ«</option><option>ç¡çœ </option><option>é‹å‹•</option><option>å¥åº·</option>
          <option>ç”Ÿæ´»</option><option>å‹‰å¼·</option><option>è‹±èª</option><option>ä»•äº‹</option><option>ãã®ä»–</option>
        </select>
      </div>

      <div class="modalFooter">
        <button class="btn" id="editClose">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btnSaveEdit">ä¿å­˜</button>
        <button class="btn" id="btnDerive">æ´¾ç”Ÿ</button>
      </div>

      <div class="reviewList" id="versionsList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    import {
      getFirestore,
      collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      getDocs, query, orderBy, limit, serverTimestamp,
      runTransaction, increment
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvdaEW4o2y8rljlafXQJbGE-nuGQn9Q88",
      authDomain: "zuzutomo-d8fa0.firebaseapp.com",
      projectId: "zuzutomo-d8fa0",
      storageBucket: "zuzutomo-d8fa0.firebasestorage.app",
      messagingSenderId: "637121353766",
      appId: "1:637121353766:web:dbfb13f85bfaf521616ee7",
      measurementId: "G-C6K64YE13X"
    };

    const app = initializeApp(firebaseConfig);
    try{ getAnalytics(app); }catch{}
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

    const nowLocal = () => new Date();
    const fmtYMD = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };
    const parseYMD = (s) => {
      const raw = String(s||"").slice(0,10);
      if(!/^\d{4}-\d{2}-\d{2}$/.test(raw)) return null;
      const [y,m,d] = raw.split("-").map(Number);
      return new Date(y, m-1, d);
    };
    const daysBetween = (a, b) => {
      const A = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
      const B = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
      return Math.round((B - A) / 86400000);
    };
    const msToMidnight = () => {
      const n = nowLocal();
      const next = new Date(n.getFullYear(), n.getMonth(), n.getDate()+1, 0,0,0,0);
      return Math.max(0, next.getTime() - n.getTime());
    };
    const fmtCountdown = (ms) => {
      const s = Math.floor(ms/1000);
      const hh = String(Math.floor(s/3600)).padStart(2,"0");
      const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    };

    // ===== Elements =====
    const navHome = $("navHome");
    const navRecords = $("navRecords");
    const navBookmarks = $("navBookmarks");
    const navProfile = $("navProfile");

    const viewHome = $("viewHome");
    const viewRecords = $("viewRecords");
    const viewBookmarks = $("viewBookmarks");
    const viewProfile = $("viewProfile");

    const loginGate = $("loginGate");
    const gateLoginBtn = $("gateLoginBtn");

    const userName = $("userName");
    const userSmall = $("userSmall");
    const userAvatar = $("userAvatar");

    const sideActiveList = $("sideActiveList");

    // Home
    const todayDoneBadge = $("todayDoneBadge");
    const countShown = $("countShown");
    const feed = $("feed");
    const qInput = $("q");
    const categoryFilter = $("categoryFilter");
    const sortBy = $("sortBy");
    const btnClearTag = $("btnClearTag");
    const rankReco = $("rankReco");
    const rankTop = $("rankTop");
    const recoHint = $("recoHint");
    const topHint = $("topHint");

    // Bottom
    const openPost = $("openPost");

    // Post modal
    const postBg = $("postBg");
    const postClose = $("postClose");
    const btnPost = $("btnPost");
    const newTitle = $("newTitle");
    const newAction = $("newAction");
    const newTags = $("newTags");
    const newCategory = $("newCategory");
    const postCounter = $("postCounter");

    // Name modal
    const nameBg = $("nameBg");
    const nameInput = $("nameInput");
    const nameSave = $("nameSave");

    // Category modal
    const catBg = $("catBg");
    const catList = $("catList");
    const catClose = $("catClose");
    const catSave = $("catSave");

    // Difficulty
    const diffBg = $("diffBg");
    const diffTitle = $("diffTitle");
    const diffClose = $("diffClose");

    // Records/bookmarks/profile
    const recordList = $("recordList");
    const bmFeed = $("bmFeed");
    const bmCount = $("bmCount");
    const profileList = $("profileList");

    // Profile auth buttons
    const btnLogin = $("btnLogin");
    const btnLogout = $("btnLogout");

    // Rating
    const ratingBg = $("ratingBg");
    const ratingTitle = $("ratingTitle");
    const starsRow = $("starsRow");
    const likeToggle = $("likeToggle");
    const myRankEl = $("myRank");
    const commentBox = $("commentBox");
    const ratingClose = $("ratingClose");
    const ratingSave = $("ratingSave");
    const reviewList = $("reviewList");

    // Edit
    const editBg = $("editBg");
    const editTitle = $("editTitle");
    const editNewTitle = $("editNewTitle");
    const editNewAction = $("editNewAction");
    const editNewTags = $("editNewTags");
    const editNewCategory = $("editNewCategory");
    const editClose = $("editClose");
    const btnSaveEdit = $("btnSaveEdit");
    const btnDerive = $("btnDerive");
    const versionsList = $("versionsList");
    const editCounter = $("editCounter");

    const plusOne = $("plusOne");

    // ===== State =====
    const CATS = ["ãƒ¡ãƒ³ã‚¿ãƒ«","ç¡çœ ","é‹å‹•","å¥åº·","ç”Ÿæ´»","å‹‰å¼·","è‹±èª","ä»•äº‹","ãã®ä»–"];

    let currentUser = null;
    let myProfile = null;

    let selectedTag = "";
    let cachedFavCreators = new Set();
    let cachedBookmarks = new Set();

    let diffTargetChallenge = null;

    let ratingTargetHabit = null;
    let ratingStars = 0;
    let ratingFollow = false; // ã“ã“ã§ã¯ã€Œåˆ¶ä½œè€…ãƒ•ã‚©ãƒ­ãƒ¼ã€ã‚’è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã«çµ±åˆï¼ˆè¦æœ›ï¼‰
    let ratingReason = ""; // "retire" | "finish" | "manual"
    let ratingAllowManual = false;

    let editTargetHabit = null;

    // ===== Helpers =====
    function showPlusOne(){
      plusOne.style.display = "block";
      plusOne.style.animation = "none";
      void plusOne.offsetWidth;
      plusOne.style.animation = "floatUp .9s ease-out forwards";
      setTimeout(()=> plusOne.style.display = "none", 950);
    }
    function showOnly(section){
      viewHome.style.display = section==="home" ? "" : "none";
      viewRecords.style.display = section==="records" ? "" : "none";
      viewBookmarks.style.display = section==="bookmarks" ? "" : "none";
      viewProfile.style.display = section==="profile" ? "" : "none";

      navHome.classList.toggle("active", section==="home");
      navRecords.classList.toggle("active", section==="records");
      navBookmarks.classList.toggle("active", section==="bookmarks");
      navProfile.classList.toggle("active", section==="profile");

      if(section==="records") refreshRecords();
      if(section==="bookmarks") refreshBookmarksView();
      if(section==="profile") refreshProfile();
    }

    // ===== Auth =====
    async function login(){
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }
    async function logout(){
      await signOut(auth);
    }
    gateLoginBtn.addEventListener("click", async ()=>{ try{ await login(); }catch{ alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); } });
    btnLogin.addEventListener("click", async ()=>{ try{ await login(); }catch{ alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); } });
    btnLogout.addEventListener("click", async ()=>{ try{ await logout(); }catch{ alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—"); } });

    // ===== Name modal =====
    function openNameModal(){
      nameInput.value = "";
      nameSave.disabled = true;
      nameBg.classList.add("show");
    }
    function closeNameModal(){ nameBg.classList.remove("show"); }
    nameInput.addEventListener("input", ()=>{ nameSave.disabled = nameInput.value.trim().length<1; });
    nameSave.addEventListener("click", async ()=>{
      const nm = nameInput.value.trim().slice(0,16);
      if(!nm) return;
      await updateDoc(doc(db,"users",currentUser.uid), { name: nm, updatedAt: serverTimestamp() });
      myProfile.name = nm;
      userName.textContent = nm;
      closeNameModal();

      // æ¬¡ã‚«ãƒ†ã‚´ãƒª
      if(!(myProfile?.preferredCategory||"")) openCategoryModal();
      await afterLoginWarm();
    });

    // ===== Category modal =====
    let catSelected = "";
    function openCategoryModal(){
      catSelected = "";
      catSave.disabled = true;
      catList.innerHTML = "";
      for(const c of CATS){
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = c;
        b.addEventListener("click", ()=>{
          catSelected = c;
          [...catList.querySelectorAll(".btn")].forEach(x=>x.classList.remove("primary"));
          b.classList.add("primary");
          catSave.disabled = false;
        });
        catList.appendChild(b);
      }
      catBg.classList.add("show");
    }
    function closeCategoryModal(){ catBg.classList.remove("show"); }
    catClose.addEventListener("click", closeCategoryModal);
    catSave.addEventListener("click", async ()=>{
      if(!catSelected) return;
      await updateDoc(doc(db,"users",currentUser.uid), { preferredCategory: catSelected, updatedAt: serverTimestamp() });
      myProfile.preferredCategory = catSelected;
      closeCategoryModal();

      // â˜…ã€Œå…¨ã¦ã®è¨­å®šã§å¤‰æ›´ã—ãŸã‚‰ãã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã ã‘è¡¨ç¤ºã€
      categoryFilter.value = catSelected;
      await refreshHome();
    });

    // ===== Post modal =====
    function openPostModal(){
      newTitle.value = "";
      newTags.value = "";
      newCategory.value = "";
      newAction.value = "";
      updatePostCounter();
      postBg.classList.add("show");
    }
    function closePostModal(){ postBg.classList.remove("show"); }
    openPost.addEventListener("click", ()=> openPostModal());
    postClose.addEventListener("click", closePostModal);
    postBg.addEventListener("click", (e)=>{ if(e.target===postBg) closePostModal(); });

    function updatePostCounter(){ postCounter.textContent = `${newAction.value.length} / 40`; }
    newAction.addEventListener("input", updatePostCounter);

    btnPost.addEventListener("click", async ()=>{
      const title = newTitle.value.trim();
      const action = newAction.value.trim();
      const tags = newTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(newCategory.value||"").trim();

      if(title.length<2){ alert("ã‚¿ã‚¤ãƒˆãƒ«çŸ­ã„"); return; }
      if(action.length<2){ alert("ã‚„ã‚‹ã“ã¨çŸ­ã„"); return; }
      if(action.length>40){ alert("40æ–‡å­—ä»¥å†…"); return; }

      try{
        await addDoc(collection(db, "habits"), {
          title, action, tags, category,
          creatorUid: currentUser.uid,
          creatorName: myProfile?.name || (currentUser.displayName || "ä½œæˆè€…"),
          creatorPhoto: currentUser.photoURL || "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),

          avgRating: 0,
          ratingCount: 0,
          participantsCount: 0,
          avgDays: 0,
          successRate: 0,

          // ver
          baseHabitId: "",
          version: 1,
        });
        closePostModal();
        await refreshHome();
        await refreshProfile();
      }catch{
        alert("æŠ•ç¨¿å¤±æ•—");
      }
    });

    // ===== Profile doc =====
    async function ensureProfile(){
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const initial = {
          name: "",
          photoURL: currentUser.photoURL || "",
          preferredCategory: "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          clearCount: 0,
          totalChallenges: 0,
          ratingRank: 1
        };
        await setDoc(ref, initial);
        myProfile = initial;
      }else{
        myProfile = snap.data();
      }
      myRankEl.textContent = String(myProfile?.ratingRank || 1);
    }

    async function warmCaches(){
      cachedFavCreators = new Set();
      cachedBookmarks = new Set();

      // creator favs
      {
        const qs = await getDocs(query(
          collection(db, "userCreatorFavs", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(300)
        ));
        qs.forEach(s=> cachedFavCreators.add(s.id));
      }
      // bookmarks
      {
        const qs = await getDocs(query(
          collection(db, "userBookmarks", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(500)
        ));
        qs.forEach(s=> cachedBookmarks.add(s.id));
      }
    }

    async function afterLoginWarm(){
      await warmCaches();
      await autoRetireIfMissed();
      await ensureDailyStatsDoc();
      await refreshDailyDoneCount();
      await refreshSideActive();
      await refreshHome();
      await refreshRecords();
      await refreshBookmarksView();
      await refreshProfile();
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;

      if(!currentUser){
        loginGate.classList.add("show");
        btnLogout.disabled = true;

        userName.textContent = "â€”";
        userSmall.textContent = "â€”";
        userAvatar.textContent = "â–¡";
        userAvatar.innerHTML = "â–¡";

        sideActiveList.innerHTML = "";
        feed.innerHTML = "";
        recordList.innerHTML = "";
        bmFeed.innerHTML = "";
        bmCount.textContent = "0";
        profileList.innerHTML = "";

        cachedFavCreators = new Set();
        cachedBookmarks = new Set();

        showOnly("home");
        return;
      }

      loginGate.classList.remove("show");
      btnLogout.disabled = false;

      userSmall.textContent = currentUser.email || "â€”";
      userAvatar.innerHTML = "";
      if(currentUser.photoURL){
        const img = document.createElement("img");
        img.src = currentUser.photoURL;
        img.alt = "avatar";
        userAvatar.appendChild(img);
      }else{
        userAvatar.textContent = "â–¡";
      }

      await ensureProfile();

      const nm = (myProfile?.name || "").trim();
      userName.textContent = nm || "â€”";
      if(!nm){
        openNameModal();
        return;
      }

      if(!(myProfile?.preferredCategory||"")){
        openCategoryModal();
      }else{
        // åˆæœŸï¼šã‚«ãƒ†ã‚´ãƒªã¯è‡ªåˆ†ã®ã‚«ãƒ†ã‚´ãƒªã«è‡ªå‹•ã‚»ãƒƒãƒˆï¼ˆè¦æœ›ï¼‰
        categoryFilter.value = myProfile.preferredCategory;
      }

      await afterLoginWarm();
    });

    // ===== Navigation =====
    navHome.addEventListener("click", ()=> showOnly("home"));
    navRecords.addEventListener("click", ()=> showOnly("records"));
    navBookmarks.addEventListener("click", ()=> showOnly("bookmarks"));
    navProfile.addEventListener("click", ()=> showOnly("profile"));

    // ===== Search/filters =====
    qInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshHome(); });
    categoryFilter.addEventListener("change", async ()=>{
      // å¤‰æ›´ã—ãŸã‚‰ãã®ã‚«ãƒ†ã‚´ãƒªã ã‘è¡¨ç¤º
      await refreshHome();
    });
    sortBy.addEventListener("change", refreshHome);
    btnClearTag.addEventListener("click", async ()=>{
      selectedTag = "";
      highlightRankChips();
      await refreshHome();
    });

    // ===== Daily stats (æœ¬æ—¥é”æˆäººæ•°) =====
    function dailyDocId(){
      return fmtYMD(nowLocal());
    }
    async function ensureDailyStatsDoc(){
      const ref = doc(db, "dailyStats", dailyDocId());
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { doneCount: 0, date: dailyDocId(), updatedAt: serverTimestamp() });
      }
    }
    async function refreshDailyDoneCount(){
      try{
        const ref = doc(db, "dailyStats", dailyDocId());
        const snap = await getDoc(ref);
        const done = snap.exists() ? Number(snap.data().doneCount||0) : 0;
        todayDoneBadge.textContent = `æœ¬æ—¥ ${done} äººãŒé”æˆ`;
      }catch{
        todayDoneBadge.textContent = `æœ¬æ—¥ 0 äººãŒé”æˆ`;
      }
    }
    async function incDailyDoneCount(){
      await runTransaction(db, async (tx)=>{
        const ref = doc(db, "dailyStats", dailyDocId());
        const snap = await tx.get(ref);
        if(!snap.exists()){
          tx.set(ref, { doneCount: 1, date: dailyDocId(), updatedAt: serverTimestamp() });
        }else{
          tx.update(ref, { doneCount: increment(1), updatedAt: serverTimestamp() });
        }
      });
      showPlusOne();
      await refreshDailyDoneCount();
    }

    // ===== Home =====
    async function refreshHome(){
      if(!currentUser) return;

      const keyword = qInput.value.trim().toLowerCase();
      const cat = categoryFilter.value.trim();
      const sort = sortBy.value;

      let habits = [];
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(240)));
      qs.forEach(s=> habits.push({ id:s.id, ...s.data() }));

      // tag ranking
      const tagCounts = new Map();
      for(const h of habits){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          tagCounts.set(k, (tagCounts.get(k)||0)+1);
        });
      }

      const top3 = [...tagCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);

      // recoï¼šè‡ªåˆ†ã®ã‚«ãƒ†ã‚´ãƒªå„ªå…ˆï¼ˆãªã‘ã‚Œã°å…¨ä½“ï¼‰
      const pref = (myProfile?.preferredCategory||"").trim();
      const pool = pref ? habits.filter(h => String(h.category||"").trim() === pref) : habits;
      const recoCounts = new Map();
      for(const h of pool){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          recoCounts.set(k, (recoCounts.get(k)||0)+1);
        });
      }
      const reco3 = [...recoCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);

      recoHint.textContent = pref ? `ã‚«ãƒ†ã‚´ãƒª=${pref}` : "â€”";
      topHint.textContent = "â€”";

      renderRank(rankReco, reco3);
      renderRank(rankTop, top3);
      highlightRankChips();

      // filter
      let filtered = habits.filter(h=>{
        const hCat = String(h.category||"").trim();
        if(cat && hCat !== cat) return false;
        if(selectedTag && !(h.tags||[]).includes(selectedTag)) return false;
        if(keyword){
          const blob = [h.title, h.action, (h.tags||[]).join(" "), h.category, h.creatorName].join(" ").toLowerCase();
          if(!blob.includes(keyword)) return false;
        }
        if(sort==="favCreators"){
          return cachedFavCreators.has(h.creatorUid);
        }
        return true;
      });

      // sort
      filtered.sort((a,b)=>{
        const ca = a.createdAt?.seconds ? a.createdAt.seconds : 0;
        const cb = b.createdAt?.seconds ? b.createdAt.seconds : 0;
        const ra = Number(a.avgRating||0);
        const rb = Number(b.avgRating||0);
        const sa = Number(a.successRate||0);
        const sb = Number(b.successRate||0);
        const da = Number(a.avgDays||0);
        const dbb = Number(b.avgDays||0);

        if(sort==="rating") return (rb-ra) || (cb-ca);
        if(sort==="success") return (sb-sa) || (cb-ca);
        if(sort==="days") return (dbb-da) || (cb-ca);
        return (cb-ca);
      });

      countShown.textContent = String(filtered.length);

      feed.innerHTML = "";
      for(const h of filtered){
        feed.appendChild(renderHabitCard(h));
      }
    }

    function renderRank(container, tags){
      container.innerHTML = "";
      const list = (tags||[]).slice(0,3);
      for(let i=0;i<list.length;i++){
        const t = list[i];
        const chip = document.createElement("div");
        chip.className = "rankChip";
        chip.dataset.tag = t;
        chip.innerHTML = `<span class="rk">${i+1}ä½</span><span class="tagName">#${escapeHtml(t)}</span>`;
        chip.addEventListener("click", async ()=>{
          selectedTag = t;
          highlightRankChips();
          await refreshHome();
        });
        container.appendChild(chip);
      }
      // 3å€‹æœªæº€ã§ã‚‚å¹…ã‚’åŸ‹ã‚ãŸã„ â†’ ç©ºãƒ€ãƒŸãƒ¼
      for(let i=list.length;i<3;i++){
        const dummy = document.createElement("div");
        dummy.className = "rankChip";
        dummy.style.opacity = "0.25";
        dummy.style.pointerEvents = "none";
        dummy.innerHTML = `<span class="rk">${i+1}ä½</span><span class="tagName">â€”</span>`;
        container.appendChild(dummy);
      }
    }
    function highlightRankChips(){
      document.querySelectorAll(".rankChip").forEach(el=>{
        el.classList.toggle("active", (el.dataset.tag||"") === selectedTag);
      });
    }

    function renderHabitCard(h){
      const card = document.createElement("div");
      card.className = "habitCard";

      const isMine = h.creatorUid === currentUser.uid;
      const bookmarked = cachedBookmarks.has(h.id);
      const creatorFav = cachedFavCreators.has(h.creatorUid);

      const cat = String(h.category||"").trim();
      const tags = (h.tags||[]).slice(0,2);

      const avgRating = Number(h.avgRating||0);
      const avgDays = Number(h.avgDays||0);
      const successRate = Number(h.successRate||0);
      const participants = Number(h.participantsCount||0);

      card.innerHTML = `
        <div class="cardTop">
          <div class="creatorRow">
            <div class="miniAva">${h.creatorPhoto ? `<img src="${escapeHtml(h.creatorPhoto)}" alt="">` : ""}</div>
            <div class="creatorName">${escapeHtml(h.creatorName||"ä½œæˆè€…")}</div>
          </div>

          <div class="topActions">
            <button class="iconBtn ${creatorFav ? "on":""}" data-act="follow" data-tip="ãƒ•ã‚©ãƒ­ãƒ¼">F</button>
            <button class="iconBtn ${bookmarked ? "on":""}" data-act="bookmark" data-tip="ä¿å­˜">B</button>

            ${
              isMine
              ? `<button class="iconBtn" data-act="edit" data-tip="ç·¨é›†">E</button>`
              : `<button class="iconBtn" data-act="join" data-tip="å‚åŠ ">å‚åŠ </button>`
            }
          </div>
        </div>

        <div class="titleBlock">
          <p class="habitTitle">${escapeHtml(h.title||"")}</p>
          <p class="habitAction">${escapeHtml(h.action||"")}</p>
        </div>

        <div class="cardBottom">
          <div class="metaLeft">
            <div class="catTagRow">
              ${cat ? `<span class="chipMini" data-cat="${escapeHtml(cat)}">C:${escapeHtml(cat)}</span>` : ""}
              ${tags.map(t=>`<span class="chipMini" data-tag="${escapeHtml(t)}">T:#${escapeHtml(t)}</span>`).join("")}
            </div>
            <div class="statsRow">
              <span class="statPill">å‚åŠ è€… ${participants}</span>
              <span class="statPill">è©•ä¾¡ ${avgRating ? avgRating.toFixed(1) : "â€”"}</span>
              <span class="statPill">ç¶™ç¶š ${avgDays ? avgDays.toFixed(1) : "â€”"}æ—¥</span>
              <span class="statPill">æˆåŠŸ ${successRate ? successRate.toFixed(0) : "â€”"}%</span>
            </div>
          </div>
        </div>
      `;

      card.querySelector('[data-act="bookmark"]').addEventListener("click", ()=> toggleBookmark(h.id));
      card.querySelector('[data-act="follow"]').addEventListener("click", ()=> toggleCreatorFav(h.creatorUid));

      const joinBtn = card.querySelector('[data-act="join"]');
      if(joinBtn) joinBtn.addEventListener("click", ()=> startChallenge(h));

      const editBtn = card.querySelector('[data-act="edit"]');
      if(editBtn) editBtn.addEventListener("click", ()=> openEditModal(h));

      card.querySelectorAll("[data-tag]").forEach(el=>{
        el.addEventListener("click", async (e)=>{
          selectedTag = el.dataset.tag || "";
          highlightRankChips();
          await refreshHome();
          e.stopPropagation();
        });
      });
      card.querySelectorAll("[data-cat]").forEach(el=>{
        el.addEventListener("click", async (e)=>{
          categoryFilter.value = el.dataset.cat || "";
          await refreshHome();
          e.stopPropagation();
        });
      });

      return card;
    }

    // ===== Phase3 toggles =====
    async function toggleCreatorFav(creatorUid){
      if(!creatorUid) return;
      const ref = doc(db, "userCreatorFavs", currentUser.uid, "items", creatorUid);
      if(cachedFavCreators.has(creatorUid)){
        await deleteDoc(ref);
        cachedFavCreators.delete(creatorUid);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedFavCreators.add(creatorUid);
      }
      await refreshHome();
      await refreshProfile();
    }

    async function toggleBookmark(habitId){
      if(!habitId) return;
      const ref = doc(db, "userBookmarks", currentUser.uid, "items", habitId);
      if(cachedBookmarks.has(habitId)){
        await deleteDoc(ref);
        cachedBookmarks.delete(habitId);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedBookmarks.add(habitId);
      }
      await refreshHome();
      await refreshBookmarksView();
      await refreshProfile();
    }

    // ===== Challenges (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦) =====
    async function loadChallenges(limitN=200){
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(limitN)
      ));
      const arr = [];
      qs.forEach(s=> arr.push({ id:s.id, ...s.data() }));
      return arr;
    }
    async function loadActiveChallenges(){
      const all = await loadChallenges(200);
      return all.filter(x => x.status === "active").slice(0, 50);
    }

    // 1æ—¥1å›åˆ¶é™ï¼ˆåŒæ—¥äºŒåº¦æŠ¼ã—é˜²æ­¢ï¼‰
    function canActToday(ch){
      const today = fmtYMD(nowLocal());
      const last = String(ch.lastActionYMD||"").slice(0,10);
      return last !== today;
    }

    async function startChallenge(h){
      const actives = await loadActiveChallenges();
      if(actives.length >= 3){ alert("ä¾é ¼ã¯æœ€å¤§3"); return; }
      if(h.creatorUid === currentUser.uid){ return; }

      const today = fmtYMD(nowLocal());
      const ref = doc(db, "userChallenges", currentUser.uid, "items", h.id);
      const snap = await getDoc(ref);
      if(snap.exists() && snap.data()?.status === "active") return;

      await setDoc(ref, {
        habitId: h.id,
        habitTitle: h.title || "",
        creatorUid: h.creatorUid || "",
        status: "active",
        startDate: today,
        day: 1,
        successDays: 0,
        restDays: 0,
        lastActionYMD: "",
        streakMiss: 0,
        difficulty: { easy:0, mid:0, hard:0 },
        ratingSubmitted: false, // â˜…é€ä¿¡ã—ãŸã‚‰æ¶ˆã™
        updatedAt: serverTimestamp()
      });

      // participants +1
      await runTransaction(db, async (tx)=>{
        const href = doc(db, "habits", h.id);
        const hs = await tx.get(href);
        if(!hs.exists()) return;
        const cur = hs.data();
        tx.update(href, { participantsCount: Number(cur.participantsCount||0)+1, updatedAt: serverTimestamp() });
      });

      // user totalChallenges +1
      await runTransaction(db, async (tx)=>{
        const uref = doc(db,"users",currentUser.uid);
        const us = await tx.get(uref);
        if(!us.exists()) return;
        const u = us.data();
        tx.update(uref, { totalChallenges: Number(u.totalChallenges||0)+1, updatedAt: serverTimestamp() });
      });

      await refreshSideActive();
      await refreshRecords();
      await refreshHome();
      await refreshProfile();
    }

    // ===== Side active list (å·¦ã«å…¨è¡¨ç¤º + ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ + ã„ã¤ã§ã‚‚è©•ä¾¡æ ) =====
    let countdownTimer = null;
    async function refreshSideActive(){
      if(!currentUser) return;

      const actives = await loadActiveChallenges();
      sideActiveList.innerHTML = "";

      // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ï¼ˆè¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã ã‘ï¼‰
      if(countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(()=>{
        document.querySelectorAll("[data-next]").forEach(el=>{
          const ms = msToMidnight();
          el.textContent = `æ¬¡ã¾ã§ ${fmtCountdown(ms)}`;
        });
        // 0æ™‚è¶…ãˆãŸã‚‰æ›´æ–°
        if(msToMidnight() < 900){
          // ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆ
          refreshSideActive();
          refreshDailyDoneCount();
        }
      }, 1000);

      for(const ch of actives){
        const box = document.createElement("div");
        box.className = "sideItem";

        const can = canActToday(ch);
        const next = `æ¬¡ã¾ã§ ${fmtCountdown(msToMidnight())}`;

        const allowRate = await canRate(ch.habitId, ch); // å®Ÿéš›ã«å‚åŠ ã—ãŸäººã ã‘

        box.innerHTML = `
          <div class="sideTop">
            <div class="sideHabit">${escapeHtml(ch.habitTitle||"")}</div>
            <div class="sideMeta">D${Number(ch.day||1)}</div>
          </div>
          <div class="sideTop" style="align-items:center">
            <div class="sideMeta" data-next="1">${next}</div>
            <div class="sideMeta">æˆåŠŸ ${Number(ch.successDays||0)} / ä¼‘ ${Number(ch.restDays||0)}</div>
          </div>
          <div class="sideBtns">
            <button class="btn" data-act="done" ${can ? "" : "disabled"}>ã‚„ã£ãŸ</button>
            <button class="btn" data-act="rest" ${can ? "" : "disabled"}>ä¼‘ã‚€</button>
            <button class="btn" data-act="retire">ãƒªã‚¿ã‚¤ã‚¢</button>
            <button class="btn" data-act="rate" ${(!allowRate || ch.ratingSubmitted) ? "disabled" : ""}>è©•ä¾¡</button>
          </div>
        `;

        box.querySelector('[data-act="done"]').addEventListener("click", ()=> openDiffModal(ch));
        box.querySelector('[data-act="rest"]').addEventListener("click", ()=> applyReport(ch, { type:"rest" }));
        box.querySelector('[data-act="retire"]').addEventListener("click", async ()=>{
          if(!confirm("ãƒªã‚¿ã‚¤ã‚¢ï¼Ÿ")) return;
          await applyReport(ch, { type:"retire" });
        });
        box.querySelector('[data-act="rate"]').addEventListener("click", async ()=>{
          await openRatingModalByChallenge(ch, "manual");
        });

        sideActiveList.appendChild(box);
      }
    }

    function openDiffModal(ch){
      diffTargetChallenge = ch;
      diffTitle.textContent = ch.habitTitle || "é›£æ˜“åº¦";
      diffBg.classList.add("show");
    }
    function closeDiffModal(){
      diffTargetChallenge = null;
      diffBg.classList.remove("show");
    }
    diffClose.addEventListener("click", closeDiffModal);
    diffBg.addEventListener("click", (e)=>{ if(e.target===diffBg) closeDiffModal(); });
    diffBg.querySelectorAll("[data-diff]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!diffTargetChallenge) return;
        await applyReport(diffTargetChallenge, { type:"done", diff: btn.dataset.diff });
        closeDiffModal();
      });
    });

    // ===== Apply report =====
    async function applyReport(ch, payload){
      const today = fmtYMD(nowLocal());
      const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;
      const cur = snap.data();

      // åŒæ—¥å¤šé‡ã‚’æ­¢ã‚ã‚‹ï¼ˆdone/restï¼‰
      if((payload.type==="done" || payload.type==="rest") && String(cur.lastActionYMD||"") === today){
        return;
      }

      const update = {};
      if(payload.type==="done"){
        update.successDays = Number(cur.successDays||0)+1;
        update.day = Number(cur.day||1)+1;
        update.lastActionYMD = today;
        update.streakMiss = 0;
        const d = cur.difficulty || {easy:0,mid:0,hard:0};
        d[payload.diff] = Number(d[payload.diff]||0)+1;
        update.difficulty = d;

        // æœ¬æ—¥é”æˆ +1ï¼ˆãƒªã‚¢ãƒ«ã‚«ã‚¦ãƒ³ãƒˆï¼‰
        await incDailyDoneCount();

      }else if(payload.type==="rest"){
        update.restDays = Number(cur.restDays||0)+1;
        update.day = Number(cur.day||1)+1;
        update.lastActionYMD = today;
        update.streakMiss = 0;

      }else if(payload.type==="retire"){
        update.status = "retired";
        update.updatedAt = serverTimestamp();
        await updateDoc(ref, update);

        // ãƒªã‚¿ã‚¤ã‚¢æ™‚ï¼šè©•ä¾¡ï¼ˆæœªé€ä¿¡ãªã‚‰ï¼‰
        await maybePromptRating(cur.habitId || ch.habitId, { ...cur, habitId: ch.habitId }, "retire");
        await refreshSideActive();
        await refreshRecords();
        await refreshHome();
        await refreshProfile();
        return;
      }

      update.updatedAt = serverTimestamp();
      await updateDoc(ref, update);

      // 7æ—¥å¾Œãƒã‚§ãƒƒã‚¯ï¼ˆ7æ—¥ç›®ã®è¡Œå‹•ã‚’ã—ãŸç›´å¾Œï¼šdayãŒ8ã«ãªã‚‹ã®ã§ã€ç›´å‰ãŒ7ã ã£ãŸã‹ã§åˆ¤å®šï¼‰
      if(payload.type==="done"){
        const beforeDay = Number(cur.day||1);
        const afterDay = beforeDay + 1;
        const afterSuccess = Number(cur.successDays||0)+1;

        if(beforeDay >= 7){
          // ã™ã§ã«7è¶…ãˆã¯ä½•ã‚‚ã—ãªã„
        }else if(afterDay === 8){
          // 7æ—¥ç›®ã‚’ã‚„ã£ãŸç›´å¾Œ
          // 7æ—¥ã®ã†ã¡5æ—¥é”æˆã§ã‚¯ãƒªã‚¢ï¼ˆæˆåŠŸãƒ™ãƒ¼ã‚¹ï¼‰
          if(afterSuccess >= 5){
            await updateDoc(ref, { status:"cleared", updatedAt: serverTimestamp() });
            await runTransaction(db, async (tx)=>{
              const uref = doc(db, "users", currentUser.uid);
              const us = await tx.get(uref);
              if(!us.exists()) return;
              const u = us.data();
              tx.update(uref, { clearCount: Number(u.clearCount||0)+1, updatedAt: serverTimestamp() });
            });
          }else{
            await updateDoc(ref, { status:"finished", updatedAt: serverTimestamp() });
          }

          // çµ‚äº†æ™‚ï¼šè©•ä¾¡ï¼ˆæœªé€ä¿¡ãªã‚‰ï¼‰
          const finalSnap = await getDoc(ref);
          const finalCh = finalSnap.exists() ? finalSnap.data() : cur;
          await maybePromptRating(ch.habitId, { ...finalCh, habitId: ch.habitId }, "finish");
        }
      }

      await refreshSideActive();
      await refreshRecords();
      await refreshHome();
      await refreshProfile();
    }

    // ===== Auto retire (3æ—¥æœªå ±å‘Š) =====
    async function autoRetireIfMissed(){
      const today = nowLocal();
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(200)
      ));
      const updates = [];
      qs.forEach(s=>{
        const ch = s.data();
        if(ch.status !== "active") return;

        const startD = parseYMD(ch.startDate);
        const lastD = parseYMD(ch.lastActionYMD);

        let miss = 0;
        if(lastD){
          const gap = daysBetween(lastD, today);
          miss = Math.max(0, gap - 1);
        }else if(startD){
          const gap = daysBetween(startD, today);
          miss = Math.max(0, gap - 1);
        }

        const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
        if(miss >= 3){
          updates.push(updateDoc(ref, {
            status:"retired",
            streakMiss: miss,
            updatedAt: serverTimestamp()
          }));
        }else{
          updates.push(updateDoc(ref, { streakMiss: miss, updatedAt: serverTimestamp() }));
        }
      });
      await Promise.allSettled(updates);
    }

    // ===== Records =====
    async function refreshRecords(){
      if(!currentUser) return;
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(150)
      ));
      const items = [];
      qs.forEach(s=> items.push(s.data()));

      recordList.innerHTML = "";
      for(const ch of items){
        const row = document.createElement("div");
        row.className = "review";
        row.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(ch.habitTitle||"")}</div>
            <div class="reviewMeta">${escapeHtml(String(ch.status||""))}</div>
          </div>
          <div class="reviewText">D${Number(ch.day||1)} / æˆåŠŸ ${Number(ch.successDays||0)} / ä¼‘ ${Number(ch.restDays||0)} / æœªå ±å‘Š ${Number(ch.streakMiss||0)}</div>
        `;
        recordList.appendChild(row);
      }
    }

    // ===== Bookmarks =====
    async function refreshBookmarksView(){
      if(!currentUser) return;
      bmCount.textContent = String(cachedBookmarks.size);
      bmFeed.innerHTML = "";
      if(cachedBookmarks.size === 0) return;

      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(260)));
      const habits = [];
      qs.forEach(s=> habits.push({ id:s.id, ...s.data() }));
      const filtered = habits.filter(h => cachedBookmarks.has(h.id));
      bmCount.textContent = String(filtered.length);
      for(const h of filtered){
        bmFeed.appendChild(renderHabitCard(h));
      }
    }

    // ===== Profile =====
    async function refreshProfile(){
      if(!currentUser) return;

      const actives = await loadActiveChallenges();
      const myPosts = await countMyPosts();

      profileList.innerHTML = `
        <div class="review">
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(myProfile?.name||"â€”")}</div>
            <div class="reviewMeta">R${Number(myProfile?.ratingRank||1)}</div>
          </div>
          <div class="reviewText">
            ã‚¯ãƒªã‚¢ ${Number(myProfile?.clearCount||0)} / æŒ‘æˆ¦ä¸­ ${actives.length} / ç·æŒ‘æˆ¦ ${Number(myProfile?.totalChallenges||0)}\n
            ãƒ•ã‚©ãƒ­ãƒ¼ ${cachedFavCreators.size} / ä¿å­˜ ${cachedBookmarks.size} / æŠ•ç¨¿ ${myPosts}
          </div>
        </div>
      `;
    }
    async function countMyPosts(){
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(450)));
      let c = 0;
      qs.forEach(s=>{
        const h = s.data();
        if(h.creatorUid === currentUser.uid) c++;
      });
      return c;
    }

    // ===== Rating rules (è¦æœ›) =====
    // - ãƒªã‚¿ã‚¤ã‚¢ or 7æ—¥å¾Œ(çµ‚äº†)ã§è‡ªå‹•è¡¨ç¤ºï¼ˆæœªé€ä¿¡ã®å ´åˆï¼‰
    // - å®Ÿéš›ã«å‚åŠ ã—ãŸäººã ã‘ï¼ˆsuccessDays + restDays > 0 ã‹ã€æœªå ±å‘Šã§7æ—¥çµŒéã§ã‚‚OKï¼‰
    // - å·¦ã®ã€Œè©•ä¾¡ã€ãƒœã‚¿ãƒ³ã§ã„ã¤ã§ã‚‚é–‹ã‘ã‚‹ï¼ˆãŸã ã—å‚åŠ å®Ÿç¸¾ãŒå¿…è¦ï¼‰
    // - é€ä¿¡ã—ãŸã‚‰ãã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ã€Œè©•ä¾¡ã€ãƒœã‚¿ãƒ³ã¯æ¶ˆãˆã‚‹ï¼ˆratingSubmitted=trueï¼‰
    async function canRate(habitId, ch){
      const didAny = (Number(ch.successDays||0) + Number(ch.restDays||0)) > 0;
      // å…¨ã‚µãƒœã‚Šã§ã‚‚ã€Œ7æ—¥ãŒçµ‚ã‚ã£ã¦ã‚‹ã€ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å‡ºã™ã€ã®è¦æœ› â†’ statusãŒfinished/cleared/retired ãªã‚‰OK
      const finishedLike = ["cleared","finished","retired"].includes(String(ch.status||""));
      return didAny || finishedLike;
    }

    async function maybePromptRating(habitId, ch, reason){
      // ã™ã§ã«é€ä¿¡æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
      const ref = doc(db, "userChallenges", currentUser.uid, "items", habitId);
      const snap = await getDoc(ref);
      if(snap.exists() && snap.data()?.ratingSubmitted) return;

      // å‚åŠ æ¡ä»¶
      if(!(await canRate(habitId, ch))) return;

      // ã‚‚ã—æ—¢ã«habits/{id}/ratings ã«è‡ªåˆ†ã®docãŒã‚ã‚‹ãªã‚‰å‡ºã•ãªã„ï¼ˆè¦æœ›ï¼‰
      const rref = doc(db, "habits", habitId, "ratings", currentUser.uid);
      const rsnap = await getDoc(rref);
      if(rsnap.exists()) {
        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸å´ã‚‚é€ä¿¡æ¸ˆã¿ã«ã—ã¦ãƒœã‚¿ãƒ³æ¶ˆã™
        await updateDoc(ref, { ratingSubmitted: true, updatedAt: serverTimestamp() });
        return;
      }

      await openRatingModalByChallenge(ch, reason);
    }

    // ===== Rating modal =====
    function openRatingModal(){
      ratingStars = 0;
      ratingFollow = false;
      commentBox.value = "";
      renderStars();

      likeToggle.classList.remove("active");
      likeToggle.textContent = "ãƒ•ã‚©ãƒ­ãƒ¼";
      likeToggle.onclick = ()=>{
        ratingFollow = !ratingFollow;
        likeToggle.classList.toggle("active", ratingFollow);
      };

      ratingBg.classList.add("show");
    }
    function closeRatingModal(){
      ratingBg.classList.remove("show");
      ratingTargetHabit = null;
      ratingReason = "";
      ratingAllowManual = false;
    }
    ratingClose.addEventListener("click", closeRatingModal);
    ratingBg.addEventListener("click", (e)=>{ if(e.target===ratingBg) closeRatingModal(); });

    function renderStars(){
      starsRow.innerHTML = "";
      for(let i=1;i<=5;i++){
        const b = document.createElement("div");
        b.className = "starBtn" + (i===ratingStars ? " active" : "");
        b.textContent = String(i);
        b.addEventListener("click", ()=>{
          ratingStars = i;
          renderStars();
        });
        starsRow.appendChild(b);
      }
    }

    async function openRatingModalByChallenge(ch, reason){
      ratingReason = reason;
      ratingAllowManual = (reason === "manual");
      ratingTargetHabit = ch.habitId;

      ratingTitle.textContent = reason==="retire" ? `è©•ä¾¡ï¼ˆãƒªã‚¿ã‚¤ã‚¢ï¼‰` :
                                reason==="finish" ? `è©•ä¾¡ï¼ˆ7æ—¥çµ‚äº†ï¼‰` :
                                `è©•ä¾¡`;

      myRankEl.textContent = String(myProfile?.ratingRank || 1);

      openRatingModal();
      await loadRatingsList(ch.habitId);

      ratingSave.onclick = async ()=>{
        if(ratingStars < 1){ alert("æ˜Ÿã‚’é¸ã¶"); return; }

        const habitId = ch.habitId;
        const rank = Number(myProfile?.ratingRank || 1);
        const weight = rank === 3 ? 3 : rank === 2 ? 2 : 1;

        // rating doc
        await setDoc(doc(db, "habits", habitId, "ratings", currentUser.uid), {
          uid: currentUser.uid,
          displayName: myProfile?.name || currentUser.displayName || "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
          photoURL: currentUser.photoURL || "",
          stars: ratingStars,
          followed: ratingFollow, // ãƒ•ã‚©ãƒ­ãƒ¼ã®æ„æ€ã‚‚ã“ã“ã«å…¥ã‚Œã¦ãŠãï¼ˆè¦æœ›ï¼‰
          comment: (commentBox.value || "").trim().slice(0, 300),
          rank,
          weight,
          updatedAt: serverTimestamp()
        }, { merge:true });

        // é€ä¿¡ã—ãŸã‚‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸å´ãƒ•ãƒ©ã‚°ï¼ˆè¡¨ç¤ºæ¶ˆãˆã‚‹ï¼‰
        await updateDoc(doc(db, "userChallenges", currentUser.uid, "items", habitId), {
          ratingSubmitted: true,
          updatedAt: serverTimestamp()
        });

        // ãƒ•ã‚©ãƒ­ãƒ¼åæ˜ 
        if(ratingFollow && ch.creatorUid){
          const cref = doc(db, "userCreatorFavs", currentUser.uid, "items", ch.creatorUid);
          await setDoc(cref, { createdAt: serverTimestamp() }, { merge:true });
          cachedFavCreators.add(ch.creatorUid);
        }

        // é›†è¨ˆï¼ˆæœ¬ç•ªã¯Functionsæ¨å¥¨ / ã“ã“ã¯ç°¡æ˜“ï¼‰
        await recomputeRatingAgg(habitId);

        closeRatingModal();
        await refreshSideActive();
        await refreshHome();
        await refreshProfile();
      };
    }

    async function loadRatingsList(habitId){
      reviewList.innerHTML = "";
      const qs = await getDocs(query(
        collection(db, "habits", habitId, "ratings"),
        orderBy("updatedAt","desc"),
        limit(40)
      ));
      const arr = [];
      qs.forEach(s=> arr.push(s.data()));
      for(const r of arr){
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(r.displayName||"ãƒ¦ãƒ¼ã‚¶ãƒ¼")}</div>
            <div class="reviewMeta">â˜…${Number(r.stars||0)} R${Number(r.rank||1)}</div>
          </div>
          <div class="reviewText">${escapeHtml(r.comment||"")}</div>
        `;
        reviewList.appendChild(box);
      }
    }

    async function recomputeRatingAgg(habitId){
      // ç°¡æ˜“ï¼šã‚µãƒ–ã‚³ãƒ¬ã‚’èª­ã‚“ã§é‡ã¿å¹³å‡ â†’ habitsã¸åæ˜ 
      const rs = await getDocs(query(collection(db, "habits", habitId, "ratings"), limit(500)));
      let wSum = 0;
      let swSum = 0;
      let count = 0;
      rs.forEach(s=>{
        const r = s.data();
        const stars = Number(r.stars||0);
        const w = Number(r.weight||1);
        if(stars>=1 && stars<=5){
          wSum += w;
          swSum += stars*w;
          count += 1;
        }
      });
      const avg = wSum ? (swSum/wSum) : 0;

      await updateDoc(doc(db, "habits", habitId), {
        avgRating: Number.isFinite(avg) ? avg : 0,
        ratingCount: count,
        updatedAt: serverTimestamp()
      });
    }

    // ===== Edit (è‡ªåˆ†ã ã‘) verå±¥æ­´3ä»¶ =====
    function openEditModal(h){
      editTargetHabit = h;
      editTitle.textContent = `ç·¨é›†`;
      editNewTitle.value = h.title || "";
      editNewAction.value = h.action || "";
      editNewTags.value = (h.tags||[]).join(",");
      editNewCategory.value = h.category || "";
      updateEditCounter();
      versionsList.innerHTML = "";
      editBg.classList.add("show");
      loadVersions(h.id);
    }
    function closeEditModal(){
      editBg.classList.remove("show");
      editTargetHabit = null;
    }
    editClose.addEventListener("click", closeEditModal);
    editBg.addEventListener("click", (e)=>{ if(e.target===editBg) closeEditModal(); });
    function updateEditCounter(){ editCounter.textContent = `${editNewAction.value.length} / 40`; }
    editNewAction.addEventListener("input", updateEditCounter);

    async function loadVersions(habitId){
      versionsList.innerHTML = "";
      const qs = await getDocs(query(
        collection(db, "habits", habitId, "versions"),
        orderBy("createdAt","desc"),
        limit(3)
      ));
      qs.forEach(s=>{
        const v = s.data();
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">ver${Number(v.version||1)}</div>
            <div class="reviewMeta"></div>
          </div>
          <div class="reviewText">${escapeHtml(v.title||"")}\n${escapeHtml(v.action||"")}</div>
        `;
        versionsList.appendChild(box);
      });
    }

    btnSaveEdit.addEventListener("click", async ()=>{
      if(!editTargetHabit) return;

      const title = editNewTitle.value.trim();
      const action = editNewAction.value.trim();
      const tags = editNewTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(editNewCategory.value||"").trim();

      if(title.length<2 || action.length<2){ alert("çŸ­ã„"); return; }
      if(action.length>40){ alert("40æ–‡å­—ä»¥å†…"); return; }

      const habitId = editTargetHabit.id;

      await runTransaction(db, async (tx)=>{
        const href = doc(db, "habits", habitId);
        const hs = await tx.get(href);
        if(!hs.exists()) return;
        const cur = hs.data();

        // versionsã«æ—§ä¿å­˜
        const vref = doc(collection(db, "habits", habitId, "versions"));
        tx.set(vref, {
          version: Number(cur.version||1),
          title: cur.title||"",
          action: cur.action||"",
          tags: cur.tags||[],
          category: cur.category||"",
          createdAt: serverTimestamp()
        });

        const nextVer = Math.min(3, Number(cur.version||1)+1);
        tx.update(href, { title, action, tags, category, version: nextVer, updatedAt: serverTimestamp() });
      });

      // å¤ã„ã®æ¶ˆã™ï¼ˆãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆï¼‰
      try{
        const qs = await getDocs(query(collection(db,"habits",habitId,"versions"), orderBy("createdAt","desc"), limit(10)));
        const all = [];
        qs.forEach(s=> all.push(s.ref));
        const del = all.slice(3);
        await Promise.allSettled(del.map(r=>deleteDoc(r)));
      }catch{}

      await loadVersions(habitId);
      await refreshHome();
    });

    btnDerive.addEventListener("click", async ()=>{
      if(!editTargetHabit) return;
      const title = editNewTitle.value.trim();
      const action = editNewAction.value.trim();
      const tags = editNewTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(editNewCategory.value||"").trim();

      if(title.length<2 || action.length<2){ alert("çŸ­ã„"); return; }
      if(action.length>40){ alert("40æ–‡å­—ä»¥å†…"); return; }

      await addDoc(collection(db,"habits"), {
        title, action, tags, category,
        creatorUid: currentUser.uid,
        creatorName: myProfile?.name || (currentUser.displayName || "ä½œæˆè€…"),
        creatorPhoto: currentUser.photoURL || "",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        avgRating: 0,
        ratingCount: 0,
        participantsCount: 0,
        avgDays: 0,
        successRate: 0,
        baseHabitId: editTargetHabit.id,
        version: 1
      });

      closeEditModal();
      await refreshHome();
      await refreshProfile();
    });

    // ===== Startup UI =====
    showOnly("home");

    // åˆå›ï¼šæŠ•ç¨¿æ–‡å­—æ•°è¡¨ç¤º
    updatePostCounter();

    // ===== Background refreshers =====
    // ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«é–‹å§‹ï¼‰
    setInterval(()=>{
      if(!currentUser) return;
      refreshDailyDoneCount();
    }, 30000);

  </script>
</body>
</html>
