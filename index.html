<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÁøíÊÖ£„Åï„Åå„ÅóÔΩú„Å§„Å•„ÅèÔºàWebÁâàÔºâ</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg1:#071a2b;
      --bg2:#0b2b45;
      --text:#eaf6ff;
      --muted:#b7d4e8;
      --line:#24465f;
      --accent:#57c7ff;
      --accent2:#7cffa6;
      --danger:#ff4d5e;
      --warn:#ffc94d;

      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      overflow:hidden;
      background: radial-gradient(1200px 700px at 10% 0%, #103e63 0%, transparent 55%),
                  radial-gradient(900px 600px at 95% 30%, #083a5a 0%, transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
    }

    .bg-fish{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.35;
      mix-blend-mode:screen;
    }
    .fish{
      position:absolute;
      width:240px; height:90px;
      background: radial-gradient(closest-side, rgba(120,220,255,.5), transparent 70%),
                  radial-gradient(closest-side, rgba(90,255,180,.35), transparent 72%);
      border-radius: 999px;
      transform: translateX(-30vw);
      animation: swim 16s linear infinite;
      filter: blur(10px);
    }
    .fish::before{
      content:"";
      position:absolute;
      right:-18px; top:26px;
      width:40px; height:40px;
      background: radial-gradient(circle at 30% 50%, rgba(120,220,255,.5), transparent 70%);
      border-radius: 8px 999px 999px 8px;
      transform: rotate(20deg);
      filter: blur(6px);
    }
    .fish.f2{ top:18%; animation-duration: 22s; opacity:.25; transform: translateX(-40vw) scale(1.1);}
    .fish.f3{ top:62%; animation-duration: 19s; opacity:.2; transform: translateX(-45vw) scale(.95);}
    .fish.f1{ top:38%; animation-duration: 17s; opacity:.22; transform: translateX(-35vw) scale(1.2);}
    @keyframes swim{
      0%{ left:-35vw; transform: translateY(0) scale(1) }
      30%{ transform: translateY(-10px) scale(1.02)}
      60%{ transform: translateY(8px) scale(.99)}
      100%{ left:120vw; transform: translateY(0) scale(1) }
    }

    .app{
      position:relative;
      height:100%;
      display:grid;
      grid-template-columns: 280px 1fr;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .app{grid-template-columns: 88px 1fr; height:auto; min-height:100%}
      .nav .label{display:none}
      .nav{padding:10px 8px}
      .nav .navBtn{justify-content:center}
      .content{padding:14px}
      .tagGrid{grid-template-columns: 1fr;}
      .topbar{grid-template-columns: 1fr; }
      .select{width:100%}
    }

    .nav{
      padding:18px 16px;
      border-right:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(10,35,55,.7), rgba(10,30,48,.35));
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px 16px;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, #7fe3ff, #1a6f9b 55%, #07314d);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
    }
    .brand h1{
      font-size:16px; margin:0; line-height:1.1;
      letter-spacing:.06em;
    }

    .navSection{margin-top:10px}
    .navBtn{
      width:100%;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      margin:10px 0;
      transition: .15s transform, .15s background, .15s border-color;
    }
    .navBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .navBtn.active{
      border-color: rgba(87,199,255,.45);
      background: linear-gradient(180deg, rgba(87,199,255,.14), rgba(255,255,255,.04));
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
    }
    .navBtn .ico{font-size:20px; width:26px; text-align:center}
    .navBtn .label{font-weight:700; letter-spacing:.04em}

    .navFooter{
      position:sticky; bottom:16px;
      margin-top:18px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .userCard{
      display:flex; align-items:center; gap:10px;
      padding:10px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .avatar{
      width:34px; height:34px; border-radius:50%;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      flex: 0 0 auto;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .userMeta{min-width:0}
    .userName{font-size:13px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .userSmall{font-size:11px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .authRow{display:flex; gap:10px; margin-top:10px}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.03em;
      transition:.15s transform, .15s background, .15s border-color;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.08)}
    .btn.primary{
      border-color: rgba(87,199,255,.55);
      background: linear-gradient(180deg, rgba(87,199,255,.18), rgba(255,255,255,.06));
    }
    .btn.danger{
      border-color: rgba(255,77,94,.55);
      background: linear-gradient(180deg, rgba(255,77,94,.16), rgba(255,255,255,.04));
    }
    .btn.small{padding:8px 10px; font-size:12px; border-radius:10px}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .content{
      padding:18px 18px 12px;
      overflow:auto;
      height:100%;
    }

    .panel{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:12px;
      padding:14px;
      align-items:center;
    }
    .searchBox{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .searchBox input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .select{
      min-width: 170px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color:var(--text);
      padding:10px 12px;
      font-weight:700;
      outline:none;
    }

    .tagArea{ padding: 0 14px 14px; }
    .tagGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .tagBlock{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      min-height:66px;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid rgba(87,199,255,.25);
      background: rgba(87,199,255,.10);
      color: var(--text);
      padding:7px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      transition:.12s transform, .12s background;
      user-select:none;
    }
    .chip:hover{transform: translateY(-1px); background: rgba(87,199,255,.14)}
    .chip.active{
      border-color: rgba(124,255,166,.55);
      background: rgba(124,255,166,.14);
    }

    .feedHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 10px 14px 0;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      font-size:12px;
      color: rgba(255,255,255,.85);
      font-weight:800;
    }

    .feed{
      padding: 12px 14px 14px;
      display:flex; flex-direction:column; gap:12px;
    }
    .habitCard{
      position:relative;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.16), rgba(255,255,255,.03));
      overflow:hidden;
    }
    .habitTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .miniUser{
      display:flex; align-items:center; gap:8px; min-width:0;
      opacity:.95;
    }
    .miniUser .miniAva{
      width:24px; height:24px; border-radius:50%;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .miniUser .miniAva img{width:100%; height:100%; object-fit:cover}
    .miniUser .miniName{
      font-size:12px; font-weight:800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 210px;
    }
    .badgeRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .badge{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.85);
      font-weight:800;
      cursor:pointer;
    }
    .badge.cat{border-color: rgba(255,201,77,.28); background: rgba(255,201,77,.12)}
    .badge.tag{border-color: rgba(87,199,255,.28); background: rgba(87,199,255,.10)}
    .habitTitle{
      font-size:16px;
      font-weight:900;
      letter-spacing:.03em;
      margin:2px 0 6px;
    }
    .habitDesc{
      color: rgba(234,246,255,.92);
      font-size:13px;
      line-height:1.55;
      margin:0 0 10px;
      white-space:pre-wrap;
    }
    .habitBottom{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .stats{
      display:flex; gap:10px; flex-wrap:wrap;
      color: rgba(234,246,255,.9);
      font-size:12px;
      font-weight:800;
    }
    .stat{
      display:flex; align-items:center; gap:7px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btnTry{
      border:none;
      background: linear-gradient(180deg, rgba(255,77,94,.95), rgba(255,77,94,.62));
      color:#fff;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(255,77,94,.18);
    }
    .btnTry:hover{filter:brightness(1.03)}
    .btnGhost{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
    }
    .btnGhost:hover{background: rgba(255,255,255,.06)}

    .toastWrap{
      position:sticky;
      top:10px;
      z-index:20;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 0 0 10px;
    }
    .toast{
      border-radius: 16px;
      border:1px solid rgba(124,255,166,.25);
      background: linear-gradient(180deg, rgba(124,255,166,.14), rgba(0,0,0,.12));
      padding:12px;
      box-shadow: var(--shadow);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      animation: pop .18s ease-out;
    }
    @keyframes pop{from{transform: translateY(-6px); opacity:.0} to{transform: translateY(0); opacity:1}}
    .toast .left{display:flex; flex-direction:column; gap:4px; min-width:0}
    .toast .kicker{font-size:12px; font-weight:900}
    .toast .main{font-size:14px; font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .toast .right{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .emojiBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      display:flex; align-items:center; gap:8px;
    }
    .emojiBtn:hover{background: rgba(255,255,255,.06)}
    .emojiBtn.primary{border-color: rgba(124,255,166,.45); background: rgba(124,255,166,.12)}
    .emojiBtn.danger{border-color: rgba(255,77,94,.45); background: rgba(255,77,94,.10)}
    .emojiBtn.warn{border-color: rgba(255,201,77,.45); background: rgba(255,201,77,.10)}

    .composer{
      position:sticky;
      bottom: 12px;
      z-index:10;
      margin-top: 14px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,25,38,.78);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
    }
    .composer .row{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .composer .row{grid-template-columns: 1fr}
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    .field input, .field textarea{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    .field textarea{min-height: 74px; resize: vertical}
    .composerFooter{
      display:flex; align-items:center; justify-content:flex-end; gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .counter{
      font-family:var(--mono);
      font-size:11px;
      color: rgba(255,255,255,.7);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.14);
      margin-right:auto;
    }

    .view{display:none}
    .view.active{display:block}

    .recordGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:14px;
    }
    .recordCard{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .recordCard .rTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .recordCard .rTitle{font-weight:950; font-size:14px; margin:0}
    .recordCard .rSub{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.6}
    .stamps{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .stamp{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
    }
    .stamp.easy{border-color: rgba(124,255,166,.35); background: rgba(124,255,166,.10)}
    .stamp.mid{border-color: rgba(87,199,255,.35); background: rgba(87,199,255,.10)}
    .stamp.hard{border-color: rgba(255,201,77,.40); background: rgba(255,201,77,.10)}
    .stamp.fail{border-color: rgba(255,77,94,.40); background: rgba(255,77,94,.10)}

    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(720px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,25,38,.92);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h2{margin:0; font-size:16px; letter-spacing:.06em}
    .catList{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .catBtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .catBtn:hover{background: rgba(255,255,255,.06)}
    .catBtn.active{border-color: rgba(87,199,255,.55); background: rgba(87,199,255,.12)}
    .modalFooter{display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap}

    .plusOne{
      position:fixed;
      right:22px;
      top: 92px;
      z-index:60;
      font-weight:1000;
      font-size:14px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(124,255,166,.35);
      background: rgba(124,255,166,.12);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      animation: floatUp .9s ease-out forwards;
    }
    @keyframes floatUp{
      0%{transform: translateY(8px); opacity:0}
      15%{opacity:1}
      100%{transform: translateY(-18px); opacity:0}
    }

    /* rating modal */
    .ratingModal{
      width:min(640px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,25,38,.94);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .ratingHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .ratingTitle{font-weight:950; font-size:14px; margin:0}
    .ratingSub{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.6}
    .starsRow{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0}
    .starBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1000;
      color:var(--text);
      display:flex; align-items:center; gap:8px;
    }
    .starBtn.active{border-color: rgba(255,201,77,.55); background: rgba(255,201,77,.14)}
    .row2{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .toggle{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      display:flex; align-items:center; gap:8px;
    }
    .toggle.active{border-color: rgba(255,77,94,.55); background: rgba(255,77,94,.14)}
    .commentBox{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
      margin-top:10px;
      min-height: 88px;
      resize: vertical;
    }
    .list{
      margin-top:12px;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:12px;
      display:flex; flex-direction:column; gap:10px;
      max-height: 260px;
      overflow:auto;
    }
    .review{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding:10px 12px;
    }
    .reviewTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .reviewName{font-weight:900; font-size:12px; opacity:.95}
    .reviewMeta{font-size:12px; opacity:.9}
    .reviewText{margin-top:8px; font-size:13px; line-height:1.55; opacity:.95; white-space:pre-wrap}
  </style>
</head>

<body>
  <div class="bg-fish" aria-hidden="true">
    <div class="fish f2"></div>
    <div class="fish f1"></div>
    <div class="fish f3"></div>
  </div>

  <div class="plusOne" id="plusOne">‚ú® +1</div>

  <div class="app">
    <aside class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>ÁøíÊÖ£„Åï„Åå„ÅóÔΩú„Å§„Å•„Åè</h1>
        </div>
      </div>

      <div class="navSection">
        <button class="navBtn active" id="navHome">
          <div class="ico">üè†</div>
          <div class="label">„Éõ„Éº„É†</div>
        </button>
        <button class="navBtn" id="navRecords">
          <div class="ico">üìÖ</div>
          <div class="label">ÈÅîÊàêË®òÈå≤</div>
        </button>
      </div>

      <div class="navFooter">
        <div class="userCard">
          <div class="avatar" id="userAvatar">üë§</div>
          <div class="userMeta">
            <div class="userName" id="userName">Êú™„É≠„Ç∞„Ç§„É≥</div>
            <div class="userSmall" id="userSmall">‚Äî</div>
          </div>
        </div>

        <div class="authRow">
          <button class="btn primary" id="btnLogin">Google„É≠„Ç∞„Ç§„É≥</button>
          <button class="btn danger" id="btnLogout" disabled>„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
      </div>
    </aside>

    <main class="content">
      <section class="view active" id="viewHome">
        <div class="toastWrap" id="toastWrap"></div>

        <div class="panel">
          <div class="topbar">
            <div class="searchBox">
              <span style="opacity:.85">üîé</span>
              <input id="q" placeholder="Ê§úÁ¥¢" />
            </div>

            <select class="select" id="categoryFilter">
              <option value="">„Ç´„ÉÜ„Ç¥„É™Ôºà„Åô„Åπ„Å¶Ôºâ</option>
              <option>ÂÅ•Â∫∑</option>
              <option>„É°„É≥„Çø„É´</option>
              <option>ÂãâÂº∑</option>
              <option>‰ªï‰∫ã</option>
              <option>ÁîüÊ¥ª</option>
              <option>Áù°Áú†</option>
              <option>ÈÅãÂãï</option>
              <option>Ëã±Ë™û</option>
              <option>„Åù„ÅÆ‰ªñ</option>
            </select>

            <select class="select" id="sortBy">
              <option value="new">üÜï Êñ∞ÁùÄ</option>
              <option value="rating">‚≠ê Ë©ï‰æ°</option>
              <option value="success">üéØ ÊàêÂäüÁéá</option>
              <option value="days">üìÖ Á∂ôÁ∂ö</option>
              <option value="favCreators">‚ù§Ô∏è „ÅäÊ∞ó„Å´ÂÖ•„Çä</option>
            </select>
          </div>

          <div class="tagArea">
            <div class="tagGrid">
              <div class="tagBlock"><div class="chips" id="chipsRecommend"></div></div>
              <div class="tagBlock"><div class="chips" id="chipsTop"></div></div>
            </div>
          </div>

          <div class="feedHeader">
            <div class="pill">‰ª∂Êï∞Ôºö<b id="countShown">0</b></div>
            <div class="pill">„Ç´„ÉÜ„Ç¥„É™Ôºö<b id="myCategory">Êú™Ë®≠ÂÆö</b> <button class="btn small" id="btnChangeMyCategory">Â§âÊõ¥</button></div>
          </div>

          <div class="feed" id="feed"></div>

          <div class="composer" id="composer">
            <div class="counter" id="counterAction">0 / 40</div>
            <div class="row">
              <div class="field">
                <input id="newTitle" placeholder="„Çø„Ç§„Éà„É´" maxlength="40" />
              </div>
              <div class="field">
                <input id="newTags" placeholder="„Çø„Ç∞Ôºà‰æãÔºö‰∏çÂÆâ,ÂØù„Å§„ÅçÔºâ" />
              </div>
              <div class="field">
                <input id="newCategory" placeholder="„Ç´„ÉÜ„Ç¥„É™Ôºà‰ªªÊÑèÔºâ" maxlength="20" />
              </div>
              <div class="field">
                <textarea id="newAction" placeholder="5ÂàÜ„Åß„ÇÑ„Çã„Åì„Å®Ôºà40ÊñáÂ≠óÔºâ" maxlength="40"></textarea>
              </div>
            </div>

            <div class="composerFooter">
              <button class="btn" id="btnSeed">„Çµ„É≥„Éó„É´ËøΩÂä†</button>
              <button class="btn primary" id="btnPost">ÊäïÁ®ø</button>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="viewRecords">
        <div class="panel">
          <div class="recordGrid" id="recordGrid"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- ÂàùÂõû„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <h2>„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû</h2>
      <div class="catList" id="catList"></div>
      <div class="modalFooter">
        <button class="btn" id="modalSkip">„ÅÇ„Å®„Åß</button>
        <button class="btn primary" id="modalSave" disabled>‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Ë©ï‰æ°„É¢„Éº„ÉÄ„É´ -->
  <div class="modalBg" id="ratingBg">
    <div class="ratingModal">
      <div class="ratingHead">
        <div>
          <p class="ratingTitle" id="ratingHabitTitle">Ë©ï‰æ°</p>
          <div class="ratingSub" id="ratingHabitMeta">‚Äî</div>
        </div>
        <button class="btn" id="ratingClose">Èñâ„Åò„Çã</button>
      </div>

      <div class="starsRow" id="starsRow"></div>

      <div class="row2">
        <button class="toggle" id="likeToggle">‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠</button>
        <div class="pill">„ÅÇ„Å™„Åü„ÅÆ„É©„É≥„ÇØÔºö<b id="myRank">1</b></div>
      </div>

      <textarea class="commentBox" id="commentBox" placeholder="Âè£„Ç≥„ÉüÔºàÁü≠ÊñáÔºâ"></textarea>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px; flex-wrap:wrap">
        <button class="btn danger" id="ratingDelete">ÂâäÈô§</button>
        <button class="btn primary" id="ratingSave">‰øùÂ≠ò</button>
      </div>

      <div class="list" id="reviewList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore,
      collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      getDocs, query, where, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvdaEW4o2y8rljlafXQJbGE-nuGQn9Q88",
      authDomain: "zuzutomo-d8fa0.firebaseapp.com",
      projectId: "zuzutomo-d8fa0",
      storageBucket: "zuzutomo-d8fa0.firebasestorage.app",
      messagingSenderId: "637121353766",
      appId: "1:637121353766:web:dbfb13f85bfaf521616ee7",
      measurementId: "G-C6K64YE13X"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){}

    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    const navHome = $("navHome");
    const navRecords = $("navRecords");
    const viewHome = $("viewHome");
    const viewRecords = $("viewRecords");

    const btnLogin = $("btnLogin");
    const btnLogout = $("btnLogout");

    const userName = $("userName");
    const userSmall = $("userSmall");
    const userAvatar = $("userAvatar");

    const qInput = $("q");
    const categoryFilter = $("categoryFilter");
    const sortBy = $("sortBy");

    const chipsRecommend = $("chipsRecommend");
    const chipsTop = $("chipsTop");

    const feed = $("feed");
    const countShown = $("countShown");
    const myCategory = $("myCategory");
    const btnChangeMyCategory = $("btnChangeMyCategory");

    const toastWrap = $("toastWrap");
    const plusOne = $("plusOne");

    const newTitle = $("newTitle");
    const newTags = $("newTags");
    const newCategory = $("newCategory");
    const newAction = $("newAction");
    const counterAction = $("counterAction");
    const btnPost = $("btnPost");
    const btnSeed = $("btnSeed");

    const recordGrid = $("recordGrid");

    const modalBg = $("modalBg");
    const catList = $("catList");
    const modalSkip = $("modalSkip");
    const modalSave = $("modalSave");

    // rating modal
    const ratingBg = $("ratingBg");
    const ratingClose = $("ratingClose");
    const ratingHabitTitle = $("ratingHabitTitle");
    const ratingHabitMeta = $("ratingHabitMeta");
    const starsRow = $("starsRow");
    const likeToggle = $("likeToggle");
    const myRankEl = $("myRank");
    const commentBox = $("commentBox");
    const ratingSave = $("ratingSave");
    const ratingDelete = $("ratingDelete");
    const reviewList = $("reviewList");

    let currentUser = null;
    let myProfile = null;

    let selectedTag = "";
    let selectedTopTags = [];
    let selectedRecoTags = [];
    let favCreatorsSet = new Set();

    const CATS = ["„É°„É≥„Çø„É´","Áù°Áú†","ÈÅãÂãï","ÂÅ•Â∫∑","ÁîüÊ¥ª","ÂãâÂº∑","Ëã±Ë™û","‰ªï‰∫ã","„Åù„ÅÆ‰ªñ"];
    let modalSelected = "";

    // rating state
    let ratingTargetHabit = null; // {id, ...}
    let ratingStars = 0;
    let ratingLiked = false;

    const nowLocal = () => new Date();
    const fmtDate = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };
    const parseYMD = (s) => {
      // "YYYY-MM-DD" „Å†„ÅëÊÉ≥ÂÆöÔºà"YYYY-MM-DDÔºà‰ºëÔºâ"„Å™„Å©„ÅØÂâçÂçä„Å†„ÅëÂèñ„ÇãÔºâ
      const raw = String(s||"").slice(0,10);
      if(!/^\d{4}-\d{2}-\d{2}$/.test(raw)) return null;
      const [y,m,d] = raw.split("-").map(Number);
      return new Date(y, m-1, d);
    };
    const daysBetween = (a, b) => {
      // a,b: DateÔºà„É≠„Éº„Ç´„É´Êó•‰ªòÔºâ
      const A = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
      const B = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
      return Math.round((B - A) / 86400000);
    };
    const escapeHtml = (s) => {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    };

    function showPlusOne(){
      plusOne.style.display = "block";
      plusOne.style.animation = "none";
      void plusOne.offsetWidth;
      plusOne.style.animation = "floatUp .9s ease-out forwards";
      setTimeout(()=> plusOne.style.display = "none", 950);
    }

    function setView(which){
      const isHome = which === "home";
      navHome.classList.toggle("active", isHome);
      navRecords.classList.toggle("active", !isHome);
      viewHome.classList.toggle("active", isHome);
      viewRecords.classList.toggle("active", !isHome);
      if(!isHome) refreshRecords();
    }
    navHome.addEventListener("click", ()=> setView("home"));
    navRecords.addEventListener("click", ()=> setView("records"));

    function openCategoryModal(){
      modalSelected = "";
      modalSave.disabled = true;
      catList.innerHTML = "";
      for(const c of CATS){
        const b = document.createElement("button");
        b.className = "catBtn";
        b.textContent = c;
        b.addEventListener("click", ()=>{
          modalSelected = c;
          [...catList.querySelectorAll(".catBtn")].forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          modalSave.disabled = false;
        });
        catList.appendChild(b);
      }
      modalBg.classList.add("show");
    }
    function closeCategoryModal(){ modalBg.classList.remove("show"); }

    modalSkip.addEventListener("click", closeCategoryModal);
    modalSave.addEventListener("click", async ()=>{
      if(!modalSelected) return;
      if(!currentUser){
        localStorage.setItem("myCategory", modalSelected);
        myCategory.textContent = modalSelected;
        closeCategoryModal();
        await refreshHome();
        return;
      }
      await ensureProfile();
      await updateDoc(doc(db,"users",currentUser.uid), {
        preferredCategory: modalSelected,
        updatedAt: serverTimestamp()
      });
      myProfile.preferredCategory = modalSelected;
      myCategory.textContent = modalSelected;
      closeCategoryModal();
      await refreshHome();
    });
    btnChangeMyCategory.addEventListener("click", openCategoryModal);

    btnLogin.addEventListener("click", async ()=>{
      const provider = new GoogleAuthProvider();
      try{ await signInWithPopup(auth, provider); }
      catch(e){ alert("„É≠„Ç∞„Ç§„É≥Â§±ÊïóÔºö\n"+(e?.message ?? e)); }
    });
    btnLogout.addEventListener("click", async ()=>{
      try{ await signOut(auth); }
      catch(e){ alert("„É≠„Ç∞„Ç¢„Ç¶„ÉàÂ§±ÊïóÔºö\n"+(e?.message ?? e)); }
    });

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      btnLogout.disabled = !currentUser;

      if(!currentUser){
        userName.textContent = "Êú™„É≠„Ç∞„Ç§„É≥";
        userSmall.textContent = "‚Äî";
        userAvatar.innerHTML = "üë§";
        myProfile = null;

        const lc = localStorage.getItem("myCategory") || "Êú™Ë®≠ÂÆö";
        myCategory.textContent = lc;

        try{
          const raw = localStorage.getItem("favCreators");
          favCreatorsSet = new Set(raw ? JSON.parse(raw) : []);
        }catch{ favCreatorsSet = new Set(); }

        await refreshHome();
        await refreshRecords();
        return;
      }

      userName.textContent = currentUser.displayName || "„É¶„Éº„Ç∂„Éº";
      userSmall.textContent = currentUser.email || "‚Äî";
      userAvatar.innerHTML = "";
      if(currentUser.photoURL){
        const img = document.createElement("img");
        img.src = currentUser.photoURL;
        img.alt = "avatar";
        userAvatar.appendChild(img);
      }else{
        userAvatar.textContent = "üë§";
      }

      await ensureProfile();

      favCreatorsSet = new Set(myProfile?.favCreators || []);
      localStorage.setItem("favCreators", JSON.stringify([...favCreatorsSet]));

      const pref = myProfile?.preferredCategory || "";
      myCategory.textContent = pref || "Êú™Ë®≠ÂÆö";
      if(!pref) openCategoryModal();

      // ‚òÖ 3Êó•ÈÄ£Á∂öÊú™Â†±Âëä Ëá™Âãï„É™„Çø„Ç§„Ç¢Âà§ÂÆöÔºà„É≠„Ç∞„Ç§„É≥ÊôÇ„Å´ÂÆüË°åÔºâ
      await autoRetireIfMissed();

      await refreshHome();
      await refreshRecords();
    });

    async function ensureProfile(){
      if(!currentUser) return;
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const initial = {
          displayName: currentUser.displayName || "„É¶„Éº„Ç∂„Éº",
          photoURL: currentUser.photoURL || "",
          preferredCategory: "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          favCreators: [],
          clearCount: 0,
          activeCount: 0,
          totalChallenges: 0,
          // ÂèÇÂä†ËÄÖ„É©„É≥„ÇØÔºà1-3Ôºâ
          ratingRank: 1
        };
        await setDoc(ref, initial);
        myProfile = initial;
      }else{
        myProfile = snap.data();
      }
      myRankEl.textContent = String(myProfile?.ratingRank || 1);
    }

    function updateCounter(){
      counterAction.textContent = `${newAction.value.length} / 40`;
    }
    newAction.addEventListener("input", updateCounter);
    updateCounter();

    // ====== ÊäïÁ®ø ======
    btnPost.addEventListener("click", async ()=>{
      const title = newTitle.value.trim();
      const tags = newTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = newCategory.value.trim();
      const action = newAction.value.trim();

      if(!title || !action){ alert("„Çø„Ç§„Éà„É´ / 5ÂàÜ„Åß„ÇÑ„Çã„Åì„Å® „ÅØÂøÖÈ†à"); return; }
      if(action.length > 40){ alert("40ÊñáÂ≠ó‰ª•ÂÜÖ"); return; }

      const data = {
        title, action, tags, category,
        creatorUid: currentUser?.uid || "guest",
        creatorName: currentUser?.displayName || "„Ç≤„Çπ„Éà",
        creatorPhoto: currentUser?.photoURL || "",
        createdAt: serverTimestamp(),
        avgRating: 0,
        ratingCount: 0,
        participantsCount: 0,
        avgDays: 0,
        successRate: 0
      };

      try{
        if(currentUser){
          await addDoc(collection(db, "habits"), data);
        }else{
          const local = JSON.parse(localStorage.getItem("localHabits") || "[]");
          local.unshift({ ...data, _localId: crypto.randomUUID(), createdAtLocal: Date.now() });
          localStorage.setItem("localHabits", JSON.stringify(local));
        }

        newTitle.value = "";
        newTags.value = "";
        newCategory.value = "";
        newAction.value = "";
        updateCounter();

        await refreshHome();
      }catch(e){
        alert("ÊäïÁ®øÂ§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    });

    btnSeed.addEventListener("click", async ()=>{
      const samples = [
        { title:"Â§ú5ÂàÜÊï£Ê≠©", action:"Â§ñ„Å´Âá∫„Å¶3ÂàÜÊ≠©„Åç„ÄÅÊúÄÂæå„Å´Ê∑±ÂëºÂê∏1Âõû", tags:["‰∏çÂÆâ","ÂØù„Å§„Åç"], category:"„É°„É≥„Çø„É´" },
        { title:"ÁõÆ„Çí‰ºë„ÇÅ„Çã 1ÂàÜ", action:"ÈÅ†„Åè„ÇíË¶ã„Å¶„ÄÅ„Åæ„Å∞„Åü„Åç10Âõû", tags:["ÈõÜ‰∏≠","Áñ≤„ÇåÁõÆ"], category:"ÁîüÊ¥ª" },
        { title:"Ëã±ÂçòË™û5„Å§", action:"ÂçòË™ûÂ∏≥„Åß5ÂçòË™û„Å†„ÅëË¶ã„Çã", tags:["Ëã±Ë™û","ÂãâÂº∑"], category:"Ëã±Ë™û" },
        { title:"ÂØù„ÇãÂâç„Å´Ê∞¥", action:"„Ç≥„ÉÉ„ÉóÂçäÂàÜ„ÅÆÊ∞¥„ÇíÈ£≤„ÇÄ", tags:["Áù°Áú†","‰ΩìË™ø"], category:"Áù°Áú†" },
      ];
      try{
        for(const s of samples){
          const data = {
            ...s,
            creatorUid: currentUser?.uid || "guest",
            creatorName: currentUser?.displayName || "„Ç≤„Çπ„Éà",
            creatorPhoto: currentUser?.photoURL || "",
            createdAt: serverTimestamp(),
            avgRating: 4.2,
            ratingCount: 12,
            participantsCount: 54,
            avgDays: 6.2,
            successRate: 32
          };
          if(currentUser) await addDoc(collection(db,"habits"), data);
          else{
            const local = JSON.parse(localStorage.getItem("localHabits") || "[]");
            local.unshift({ ...data, _localId: crypto.randomUUID(), createdAtLocal: Date.now() });
            localStorage.setItem("localHabits", JSON.stringify(local));
          }
        }
        await refreshHome();
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    });

    // ====== „Éï„Ç£„É´„Çø ======
    function setSelectedTag(tag){
      selectedTag = tag || "";
      [...document.querySelectorAll(".chip")].forEach(ch=>{
        ch.classList.toggle("active", ch.dataset.tag === selectedTag);
      });
      refreshHome();
    }
    qInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshHome(); });
    categoryFilter.addEventListener("change", refreshHome);
    sortBy.addEventListener("change", refreshHome);

    // ====== Home ======
    async function refreshHome(){
      const keyword = qInput.value.trim().toLowerCase();
      const cat = categoryFilter.value.trim();
      const sort = sortBy.value;

      const prefCat = (currentUser ? (myProfile?.preferredCategory || "") : (localStorage.getItem("myCategory") || "")) || "";
      myCategory.textContent = prefCat || "Êú™Ë®≠ÂÆö";

      let habits = [];

      try{
        const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(140)));
        qs.forEach(docSnap=>{
          habits.push({ id: docSnap.id, ...docSnap.data(), _source:"remote" });
        });
      }catch(e){}

      try{
        const local = JSON.parse(localStorage.getItem("localHabits") || "[]");
        habits = habits.concat(local.map(x=>({ ...x, id: x._localId, _source:"local" })));
      }catch{}

      // tags
      const tagCounts = new Map();
      for(const h of habits){
        (h.tags || []).forEach(t=>{
          const k = String(t || "").trim();
          if(!k) return;
          tagCounts.set(k, (tagCounts.get(k)||0)+1);
        });
      }
      selectedTopTags = [...tagCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
      renderChips(chipsTop, selectedTopTags);

      const recoPool = habits.filter(h=>{
        if(!prefCat) return true;
        return (h.category || "").trim() === prefCat;
      });
      const recoCounts = new Map();
      for(const h of recoPool){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          recoCounts.set(k, (recoCounts.get(k)||0)+1);
        });
      }
      selectedRecoTags = [...recoCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
      if(selectedRecoTags.length===0) selectedRecoTags = selectedTopTags;
      renderChips(chipsRecommend, selectedRecoTags);

      let filtered = habits.filter(h=>{
        if(cat && (h.category || "").trim() !== cat) return false;
        if(selectedTag && !(h.tags || []).includes(selectedTag)) return false;
        if(keyword){
          const blob = [h.title, h.action, (h.tags||[]).join(" "), h.category, h.creatorName].join(" ").toLowerCase();
          if(!blob.includes(keyword)) return false;
        }
        return true;
      });

      filtered.sort((a,b)=>{
        const ca = a.createdAt?.seconds ? a.createdAt.seconds : (a.createdAtLocal ? Math.floor(a.createdAtLocal/1000) : 0);
        const cb = b.createdAt?.seconds ? b.createdAt.seconds : (b.createdAtLocal ? Math.floor(b.createdAtLocal/1000) : 0);

        const ra = Number(a.avgRating||0);
        const rb = Number(b.avgRating||0);
        const sa = Number(a.successRate||0);
        const sb = Number(b.successRate||0);
        const da = Number(a.avgDays||0);
        const dbb = Number(b.avgDays||0);

        if(sort === "rating") return (rb - ra) || (cb - ca);
        if(sort === "success") return (sb - sa) || (cb - ca);
        if(sort === "days") return (dbb - da) || (cb - ca);
        if(sort === "favCreators"){
          const af = favCreatorsSet.has(a.creatorUid) ? 1 : 0;
          const bf = favCreatorsSet.has(b.creatorUid) ? 1 : 0;
          return (bf - af) || (cb - ca);
        }
        return (cb - ca);
      });

      countShown.textContent = String(filtered.length);

      feed.innerHTML = "";
      await refreshTodayToasts();
      for(const h of filtered){
        feed.appendChild(renderHabitCard(h));
      }
    }

    function renderChips(container, tags){
      container.innerHTML = "";
      for(const t of tags){
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.dataset.tag = t;
        chip.textContent = `#${t}`;
        chip.addEventListener("click", ()=> setSelectedTag(t));
        container.appendChild(chip);
      }
      [...container.querySelectorAll(".chip")].forEach(ch=>{
        ch.classList.toggle("active", ch.dataset.tag === selectedTag);
      });
    }

    function renderHabitCard(h){
      const card = document.createElement("div");
      card.className = "habitCard";

      const tags = (h.tags || []).slice(0,4);
      const cat = (h.category || "").trim();

      const avgRating = Number(h.avgRating||0);
      const avgDays = Number(h.avgDays||0);
      const successRate = Number(h.successRate||0);

      card.innerHTML = `
        <div class="habitTop">
          <div class="miniUser">
            <div class="miniAva">${h.creatorPhoto ? `<img src="${h.creatorPhoto}" alt=""/>` : ""}</div>
            <div class="miniName">${escapeHtml(h.creatorName || "‰ΩúÊàêËÄÖ")}</div>
          </div>
          <div class="badgeRow">
            ${cat ? `<span class="badge cat" data-cat="${escapeHtml(cat)}">${escapeHtml(cat)}</span>` : ""}
            ${tags.map(t=>`<span class="badge tag" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</span>`).join("")}
          </div>
        </div>

        <div class="habitTitle">${escapeHtml(h.title || "")}</div>
        <p class="habitDesc">${escapeHtml(h.action || "")}</p>

        <div class="habitBottom">
          <div class="stats">
            <div class="stat">‚≠ê ${avgRating ? avgRating.toFixed(1) : "‚Äî"}</div>
            <div class="stat">üìÖ ${avgDays ? avgDays.toFixed(1) : "‚Äî"}</div>
            <div class="stat">üéØ ${successRate ? successRate.toFixed(0) + "%" : "‚Äî"}</div>
          </div>

          <div class="actions">
            <button class="btnGhost" data-act="bookmark">üîñ</button>
            <button class="btnGhost" data-act="rate">‚≠ê</button>
            <button class="btnGhost" data-act="fav">‚ù§Ô∏è</button>
            <button class="btnTry" data-act="try">‚ñ∂ ÊåëÊà¶</button>
          </div>
        </div>
      `;

      card.querySelector('[data-act="try"]').addEventListener("click", ()=> startChallenge(h));
      card.querySelector('[data-act="bookmark"]').addEventListener("click", ()=> bookmarkHabit(h));
      card.querySelector('[data-act="fav"]').addEventListener("click", ()=> toggleFavCreator(h.creatorUid));
      card.querySelector('[data-act="rate"]').addEventListener("click", ()=> openRatingModal(h));

      card.querySelectorAll(".badge.tag").forEach(el=>{
        el.addEventListener("click", (e)=>{
          setSelectedTag(el.dataset.tag || el.textContent.trim());
          e.stopPropagation();
        });
      });
      card.querySelectorAll(".badge.cat").forEach(el=>{
        el.addEventListener("click", (e)=>{
          categoryFilter.value = el.dataset.cat || el.textContent.trim();
          refreshHome();
          e.stopPropagation();
        });
      });

      return card;
    }

    // ====== bookmarkÔºàÈùûÂÖ¨Èñã„ÅÆ„ÅøÔºâ ======
    async function bookmarkHabit(h){
      if(!currentUser){
        const key = "localBookmarks";
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        if(!arr.includes(h.id)){
          arr.push(h.id);
          localStorage.setItem(key, JSON.stringify(arr));
        }
        return;
      }
      try{
        const ref = doc(db, "userBookmarks", currentUser.uid, "items", h.id);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          await setDoc(ref, {
            habitId: h.id,
            title: h.title || "",
            createdAt: serverTimestamp(),
            visibility: "private",
            listName: "ÈùûÂÖ¨Èñã„É™„Çπ„Éà"
          });
        }
      }catch(e){
        alert("‰øùÂ≠òÂ§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    async function toggleFavCreator(creatorUid){
      if(!creatorUid) return;
      if(!currentUser){
        if(favCreatorsSet.has(creatorUid)) favCreatorsSet.delete(creatorUid);
        else favCreatorsSet.add(creatorUid);
        localStorage.setItem("favCreators", JSON.stringify([...favCreatorsSet]));
        await refreshHome();
        return;
      }
      try{
        await ensureProfile();
        if(favCreatorsSet.has(creatorUid)) favCreatorsSet.delete(creatorUid);
        else favCreatorsSet.add(creatorUid);

        await updateDoc(doc(db,"users",currentUser.uid), {
          favCreators: [...favCreatorsSet],
          updatedAt: serverTimestamp()
        });
        myProfile.favCreators = [...favCreatorsSet];
        localStorage.setItem("favCreators", JSON.stringify([...favCreatorsSet]));
        await refreshHome();
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    // ====== Challenge ======
    async function startChallenge(h){
      const maxActive = 3;
      const actives = await loadActiveChallenges();
      if(actives.length >= maxActive){
        alert("‰æùÈ†º„ÅØÊúÄÂ§ß3");
        return;
      }

      const start = fmtDate(nowLocal());

      if(!currentUser){
        const key = "localChallenges";
        const items = JSON.parse(localStorage.getItem(key) || "[]");
        const exists = items.find(x => x.habitId === h.id && x.status === "active");
        if(exists) return;
        items.unshift({
          id: crypto.randomUUID(),
          habitId: h.id,
          habitTitle: h.title || "",
          status:"active",
          startDate:start,
          day:1,
          lastReportedDate:"",
          streakMiss:0,
          successDays:0,
          restDays:0,
          difficulty:{easy:0,mid:0,hard:0},
          updatedAt: Date.now(),
          category: h.category || "",
          tags: h.tags || []
        });
        localStorage.setItem(key, JSON.stringify(items));
        await refreshTodayToasts();
        await refreshRecords();
        return;
      }

      try{
        const ref = doc(db, "userChallenges", currentUser.uid, "items", h.id);
        const snap = await getDoc(ref);
        if(snap.exists() && (snap.data()?.status === "active")) return;

        await setDoc(ref, {
          habitId: h.id,
          habitTitle: h.title || "",
          status:"active",
          startDate: start,
          day: 1,
          lastReportedDate: "",
          streakMiss: 0,
          successDays: 0,
          restDays: 0,
          difficulty: { easy:0, mid:0, hard:0 },
          category: h.category || "",
          tags: h.tags || [],
          updatedAt: serverTimestamp()
        });

        // participantsCount Â¢ó„ÇÑ„ÅôÔºàÁ∞°ÊòìÔºâ
        try{
          if(h._source === "remote"){
            const href = doc(db, "habits", h.id);
            const hs = await getDoc(href);
            if(hs.exists()){
              const cur = hs.data();
              const pc = Number(cur.participantsCount||0) + 1;
              await updateDoc(href, { participantsCount: pc });
            }
          }
        }catch{}

        await refreshTodayToasts();
        await refreshRecords();
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    async function loadActiveChallenges(){
      if(!currentUser){
        const items = JSON.parse(localStorage.getItem("localChallenges") || "[]");
        return items.filter(x => x.status === "active");
      }
      try{
        const qs = await getDocs(query(
          collection(db, "userChallenges", currentUser.uid, "items"),
          where("status","==","active"),
          orderBy("updatedAt","desc"),
          limit(10)
        ));
        const arr = [];
        qs.forEach(s=> arr.push(s.data()));
        return arr;
      }catch(e){
        return [];
      }
    }

    async function refreshTodayToasts(){
      toastWrap.innerHTML = "";
      const actives = await loadActiveChallenges();
      if(actives.length === 0) return;

      for(const ch of actives.slice(0,3)){
        const title = ch.habitTitle || "ÁøíÊÖ£";
        const day = Number(ch.day||1);
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.innerHTML = `
          <div class="left">
            <div class="kicker">üå±</div>
            <div class="main">${escapeHtml(title)}Ôºà${day}Êó•ÁõÆÔºâ</div>
          </div>
          <div class="right">
            <button class="emojiBtn primary" data-act="done">‚úÖ</button>
            <button class="emojiBtn warn" data-act="rest">üõå</button>
            <button class="emojiBtn danger" data-act="retire">üè≥Ô∏è</button>
          </div>
        `;
        toast.querySelector('[data-act="done"]').addEventListener("click", ()=> reportDone(ch, "done"));
        toast.querySelector('[data-act="rest"]').addEventListener("click", ()=> reportDone(ch, "rest"));
        toast.querySelector('[data-act="retire"]').addEventListener("click", ()=> reportDone(ch, "retire"));
        toastWrap.appendChild(toast);
      }
    }

    function incPlusOne(){ showPlusOne(); }

    async function reportDone(ch, mode){
      if(mode === "done"){
        const choice = prompt("üòäüôÇüòÖ");
        const d = (choice || "").trim();
        const map = { "üòä":"easy", "üôÇ":"mid", "üòÖ":"hard" };
        if(!map[d]) return;
        await applyReport(ch, { type:"done", diff: map[d] });
        return;
      }
      if(mode === "rest"){
        await applyReport(ch, { type:"rest" });
        return;
      }
      if(mode === "retire"){
        const ok = confirm("„É™„Çø„Ç§„Ç¢Ôºü");
        if(!ok) return;
        await applyReport(ch, { type:"retire" });
        return;
      }
    }

    async function applyReport(ch, payload){
      const today = fmtDate(nowLocal());

      if(!currentUser){
        const key = "localChallenges";
        const items = JSON.parse(localStorage.getItem(key) || "[]");
        const idx = items.findIndex(x => x.habitId === ch.habitId && x.status === "active");
        if(idx === -1) return;
        const cur = items[idx];

        if(payload.type === "done"){
          cur.successDays = Number(cur.successDays||0) + 1;
          cur.lastReportedDate = today;
          cur.streakMiss = 0;
          cur.day = Number(cur.day||1) + 1;
          cur.difficulty = cur.difficulty || {easy:0,mid:0,hard:0};
          cur.difficulty[payload.diff] = Number(cur.difficulty[payload.diff]||0) + 1;
          incPlusOne();
        }else if(payload.type === "rest"){
          cur.restDays = Number(cur.restDays||0) + 1;
          cur.lastReportedDate = today + "Ôºà‰ºëÔºâ";
          cur.streakMiss = 0;
          cur.day = Number(cur.day||1) + 1;
        }else if(payload.type === "retire"){
          cur.status = "retired";
          cur.lastReportedDate = today + "Ôºà„É™„Çø„Ç§„Ç¢Ôºâ";
        }

        if(cur.status === "active"){
          if(Number(cur.successDays||0) >= 5 && Number(cur.day||1) >= 7){
            const done = confirm("„ÇØ„É™„Ç¢„Å´„Åô„ÇãÔºü");
            if(done){
              cur.status = "cleared";
              cur.lastReportedDate = today + "Ôºà„ÇØ„É™„Ç¢Ôºâ";
            }
          }
        }

        cur.updatedAt = Date.now();
        items[idx] = cur;
        localStorage.setItem(key, JSON.stringify(items));
        await refreshTodayToasts();
        await refreshRecords();
        return;
      }

      try{
        const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
        const snap = await getDoc(ref);
        if(!snap.exists()) return;
        const cur = snap.data();

        const update = {};
        if(payload.type === "done"){
          update.successDays = Number(cur.successDays||0) + 1;
          update.lastReportedDate = today;
          update.streakMiss = 0;
          update.day = Number(cur.day||1) + 1;
          const diffObj = cur.difficulty || {easy:0,mid:0,hard:0};
          diffObj[payload.diff] = Number(diffObj[payload.diff]||0) + 1;
          update.difficulty = diffObj;
          incPlusOne();
        }else if(payload.type === "rest"){
          update.restDays = Number(cur.restDays||0) + 1;
          update.lastReportedDate = today + "Ôºà‰ºëÔºâ";
          update.streakMiss = 0;
          update.day = Number(cur.day||1) + 1;
        }else if(payload.type === "retire"){
          update.status = "retired";
          update.lastReportedDate = today + "Ôºà„É™„Çø„Ç§„Ç¢Ôºâ";
        }

        update.updatedAt = serverTimestamp();
        await updateDoc(ref, update);

        if((payload.type === "done" || payload.type === "rest") && (cur.status === "active")){
          const nextSuccess = (payload.type === "done") ? (Number(cur.successDays||0)+1) : Number(cur.successDays||0);
          const nextDay = Number(cur.day||1)+1;
          if(nextSuccess >= 5 && nextDay >= 7){
            const done = confirm("„ÇØ„É™„Ç¢„Å´„Åô„ÇãÔºü");
            if(done){
              await updateDoc(ref, { status:"cleared", lastReportedDate: today + "Ôºà„ÇØ„É™„Ç¢Ôºâ", updatedAt: serverTimestamp() });
            }
          }
        }

        // ‚òÖ ÊàêÂäüÁéá/Âπ≥ÂùáÁ∂ôÁ∂öÊó•Êï∞„Å™„Å©„ÅÆÁ∞°ÊòìÈõÜË®à„ÇíÊõ¥Êñ∞Ôºà„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈõÜË®àÔºâ
        await recomputeHabitStats(ch.habitId);

        await refreshTodayToasts();
        await refreshRecords();
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    // ====== 3Êó•ÈÄ£Á∂öÊú™Â†±Âëä Ëá™Âãï„É™„Çø„Ç§„Ç¢ ======
    async function autoRetireIfMissed(){
      if(!currentUser) return;
      const today = nowLocal();

      let active = [];
      try{
        const qs = await getDocs(query(
          collection(db, "userChallenges", currentUser.uid, "items"),
          where("status","==","active"),
          limit(50)
        ));
        qs.forEach(s=> active.push({ _id: s.id, ...s.data() }));
      }catch(e){ return; }

      const updates = [];
      for(const ch of active){
        const startD = parseYMD(ch.startDate);
        const lastD = parseYMD(ch.lastReportedDate);

        let miss = 0;

        if(lastD){
          const gap = daysBetween(lastD, today);
          // last„Åå‰ªäÊó•„Å™„Çâ0„ÄÅÊò®Êó•„Å™„Çâ0„ÄÅ2Êó•Ââç„Å™„Çâ1„ÄÅ3Êó•Ââç„Å™„Çâ2‚Ä¶
          miss = Math.max(0, gap - 1);
        }else if(startD){
          // ‰∏ÄÂ∫¶„ÇÇÂ†±Âëä„Åó„Å¶„Å™„ÅÑÔºöstart„Åã„Çâ‰ªäÊó•„Åæ„Åß„ÅÆÁµåÈÅéÊó•Êï∞ - 1 „ÇíÊú™Â†±ÂëäÈÄ£Á∂öÊâ±„ÅÑ
          const gap = daysBetween(startD, today);
          miss = Math.max(0, gap - 1);
        }else{
          miss = 0;
        }

        if(miss >= 3){
          updates.push(updateDoc(
            doc(db, "userChallenges", currentUser.uid, "items", ch.habitId),
            { status:"retired", streakMiss: miss, lastReportedDate: fmtDate(today) + "ÔºàËá™Âãï„É™„Çø„Ç§„Ç¢Ôºâ", updatedAt: serverTimestamp() }
          ));
        }else{
          // streakMiss„Å†„ÅëÊõ¥Êñ∞ÔºàË°®Á§∫/ÂÜÖÈÉ®Áî®Ôºâ
          updates.push(updateDoc(
            doc(db, "userChallenges", currentUser.uid, "items", ch.habitId),
            { streakMiss: miss, updatedAt: serverTimestamp() }
          ));
        }
      }
      try{ await Promise.allSettled(updates); }catch{}
    }

    // ====== Records ======
    async function refreshRecords(){
      const items = await loadAllChallengesForRecords();
      recordGrid.innerHTML = "";

      const order = (st)=> st==="active"?0 : st==="cleared"?1 : 2;
      items.sort((a,b)=> order(a.status)-order(b.status));

      for(const ch of items){
        recordGrid.appendChild(renderRecordCard(ch));
      }
    }

    async function loadAllChallengesForRecords(){
      if(!currentUser){
        return JSON.parse(localStorage.getItem("localChallenges") || "[]");
      }
      try{
        const qs = await getDocs(query(
          collection(db, "userChallenges", currentUser.uid, "items"),
          orderBy("updatedAt","desc"),
          limit(80)
        ));
        const arr = [];
        qs.forEach(s=> arr.push(s.data()));
        return arr;
      }catch(e){
        return [];
      }
    }

    function renderRecordCard(ch){
      const card = document.createElement("div");
      card.className = "recordCard";

      const st = ch.status;
      const stLabel = st==="active" ? "ÈÄ≤Ë°å‰∏≠" : st==="cleared" ? "„ÇØ„É™„Ç¢" : "„É™„Çø„Ç§„Ç¢";
      const stBadge = st==="active" ? "‚úÖ" : st==="cleared" ? "üèÅ" : "üè≥Ô∏è";

      const diff = ch.difficulty || {easy:0,mid:0,hard:0};
      const totalFeel = (diff.easy||0)+(diff.mid||0)+(diff.hard||0);
      const easyP = totalFeel ? Math.round((diff.easy||0)/totalFeel*100) : 0;
      const midP  = totalFeel ? Math.round((diff.mid||0)/totalFeel*100) : 0;
      const hardP = totalFeel ? Math.round((diff.hard||0)/totalFeel*100) : 0;

      card.innerHTML = `
        <div class="rTop">
          <div>
            <p class="rTitle">${stBadge} ${escapeHtml(ch.habitTitle || "ÁøíÊÖ£")}Ôºà${escapeHtml(stLabel)}Ôºâ</p>
            <div class="rSub">
              ${escapeHtml(ch.startDate || "‚Äî")} / ${Number(ch.day||1)}Êó•ÁõÆ / ÊàêÂäü:${Number(ch.successDays||0)} / ‰ºë:${Number(ch.restDays||0)}
              <br/>${escapeHtml(ch.lastReportedDate || "")}
            </div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
            ${st==="active" ? `<button class="btn small danger" data-act="retire">„É™„Çø„Ç§„Ç¢</button>` : `<button class="btn small" data-act="restart">ÂÜçÊåëÊà¶</button>`}
            ${currentUser && st!=="active" ? `<button class="btn small" data-act="remove">ÂâäÈô§</button>` : ""}
          </div>
        </div>

        <div class="stamps">
          <div class="stamp easy">üòä ${easyP}%</div>
          <div class="stamp mid">üôÇ ${midP}%</div>
          <div class="stamp hard">üòÖ ${hardP}%</div>
          ${st==="retired" ? `<div class="stamp fail">üè≥Ô∏è</div>` : ""}
        </div>
      `;

      const btnRet = card.querySelector('[data-act="retire"]');
      if(btnRet){
        btnRet.addEventListener("click", async ()=>{
          const ok = confirm("„É™„Çø„Ç§„Ç¢Ôºü");
          if(!ok) return;
          await applyReport(ch, { type:"retire" });
        });
      }

      const btnRestart = card.querySelector('[data-act="restart"]');
      if(btnRestart){
        btnRestart.addEventListener("click", async ()=>{
          const ok = confirm("ÂÜçÊåëÊà¶Ôºü");
          if(!ok) return;
          await restartChallenge(ch);
        });
      }

      const btnRemove = card.querySelector('[data-act="remove"]');
      if(btnRemove){
        btnRemove.addEventListener("click", async ()=>{
          const ok = confirm("ÂâäÈô§Ôºü");
          if(!ok) return;
          await removeChallenge(ch);
        });
      }

      return card;
    }

    async function restartChallenge(ch){
      const today = fmtDate(nowLocal());
      if(!currentUser){
        const key="localChallenges";
        const items = JSON.parse(localStorage.getItem(key) || "[]");
        const idx = items.findIndex(x=>x.habitId===ch.habitId);
        if(idx<0) return;
        items[idx].status="active";
        items[idx].startDate=today;
        items[idx].day=1;
        items[idx].lastReportedDate="";
        items[idx].streakMiss=0;
        items[idx].successDays=0;
        items[idx].restDays=0;
        items[idx].difficulty={easy:0,mid:0,hard:0};
        items[idx].updatedAt=Date.now();
        localStorage.setItem(key, JSON.stringify(items));
        await refreshTodayToasts();
        await refreshRecords();
        return;
      }
      try{
        const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
        await updateDoc(ref, {
          status:"active",
          startDate: today,
          day:1,
          lastReportedDate:"",
          streakMiss:0,
          successDays:0,
          restDays:0,
          difficulty:{easy:0,mid:0,hard:0},
          updatedAt: serverTimestamp()
        });
        await refreshTodayToasts();
        await refreshRecords();
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    async function removeChallenge(ch){
      if(!currentUser){
        const key="localChallenges";
        const items = JSON.parse(localStorage.getItem(key) || "[]");
        const next = items.filter(x=>x.habitId!==ch.habitId);
        localStorage.setItem(key, JSON.stringify(next));
        await refreshTodayToasts();
        await refreshRecords();
        return;
      }
      try{
        await deleteDoc(doc(db, "userChallenges", currentUser.uid, "items", ch.habitId));
        await refreshTodayToasts();
        await refreshRecords();
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    // ====== Ë©ï‰æ°Ôºàhabits/{id}/ratings/{uid}Ôºâ ======
    ratingClose.addEventListener("click", closeRatingModal);
    ratingBg.addEventListener("click", (e)=>{ if(e.target === ratingBg) closeRatingModal(); });

    function openRatingModal(h){
      if(h._source !== "remote"){
        alert("„É≠„Éº„Ç´„É´ÊäïÁ®ø„ÅØË©ï‰æ°ÂØæË±°Â§ñ");
        return;
      }
      if(!currentUser){
        alert("Ë©ï‰æ°„ÅØ„É≠„Ç∞„Ç§„É≥ÂøÖË¶Å");
        return;
      }
      ratingTargetHabit = h;
      ratingStars = 0;
      ratingLiked = false;
      commentBox.value = "";

      ratingHabitTitle.textContent = `‚≠ê ${h.title || "Ë©ï‰æ°"}`;
      ratingHabitMeta.textContent = `„Çø„Ç∞Ôºö${(h.tags||[]).slice(0,4).join(" / ") || "‚Äî"}`;

      myRankEl.textContent = String(myProfile?.ratingRank || 1);

      renderStars();
      likeToggle.classList.remove("active");
      likeToggle.onclick = ()=>{
        ratingLiked = !ratingLiked;
        likeToggle.classList.toggle("active", ratingLiked);
      };

      ratingDelete.onclick = async ()=>{
        const ok = confirm("ÂâäÈô§Ôºü");
        if(!ok) return;
        await deleteMyRating(h.id);
        await loadRatingsList(h.id);
        await recomputeHabitStats(h.id);
        await refreshHome();
      };

      ratingSave.onclick = async ()=>{
        if(ratingStars < 1){ alert("‚≠ê"); return; }
        await saveMyRating(h.id);
        await loadRatingsList(h.id);
        await recomputeHabitStats(h.id);
        await refreshHome();
      };

      ratingBg.classList.add("show");

      // Ëá™ÂàÜ„ÅÆÊó¢Â≠òË©ï‰æ°„Çí„É≠„Éº„Éâ
      loadMyRating(h.id).then(()=> loadRatingsList(h.id));
    }

    function closeRatingModal(){
      ratingBg.classList.remove("show");
      ratingTargetHabit = null;
    }

    function renderStars(){
      starsRow.innerHTML = "";
      for(let i=1;i<=5;i++){
        const b = document.createElement("button");
        b.className = "starBtn" + (i===ratingStars ? " active" : "");
        b.textContent = `‚≠ê ${i}`;
        b.addEventListener("click", ()=>{
          ratingStars = i;
          renderStars();
        });
        starsRow.appendChild(b);
      }
    }

    async function loadMyRating(habitId){
      if(!currentUser) return;
      try{
        const ref = doc(db, "habits", habitId, "ratings", currentUser.uid);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          ratingStars = 0;
          ratingLiked = false;
          commentBox.value = "";
          likeToggle.classList.remove("active");
          renderStars();
          return;
        }
        const data = snap.data();
        ratingStars = Number(data.stars || 0);
        ratingLiked = !!data.liked;
        commentBox.value = String(data.comment || "");
        likeToggle.classList.toggle("active", ratingLiked);
        renderStars();
      }catch(e){}
    }

    async function saveMyRating(habitId){
      if(!currentUser) return;

      const rank = Number(myProfile?.ratingRank || 1);
      const weight = rank === 3 ? 3 : rank === 2 ? 2 : 1;

      const data = {
        uid: currentUser.uid,
        displayName: currentUser.displayName || "„É¶„Éº„Ç∂„Éº",
        photoURL: currentUser.photoURL || "",
        stars: ratingStars,
        liked: ratingLiked,
        comment: (commentBox.value || "").trim().slice(0, 300),
        rank,
        weight,
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "habits", habitId, "ratings", currentUser.uid), data, { merge:true });
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    async function deleteMyRating(habitId){
      if(!currentUser) return;
      try{
        await deleteDoc(doc(db, "habits", habitId, "ratings", currentUser.uid));
      }catch(e){
        alert("Â§±ÊïóÔºö\n" + (e?.message ?? e));
      }
    }

    async function loadRatingsList(habitId){
      reviewList.innerHTML = "";
      try{
        const qs = await getDocs(query(
          collection(db, "habits", habitId, "ratings"),
          orderBy("updatedAt","desc"),
          limit(30)
        ));
        const arr = [];
        qs.forEach(s=> arr.push(s.data()));
        for(const r of arr){
          const box = document.createElement("div");
          box.className = "review";
          box.innerHTML = `
            <div class="reviewTop">
              <div class="reviewName">${escapeHtml(r.displayName || "„É¶„Éº„Ç∂„Éº")}</div>
              <div class="reviewMeta">‚≠ê ${Number(r.stars||0)} ${r.liked ? "‚ù§Ô∏è" : ""}ÔºàR${Number(r.rank||1)}Ôºâ</div>
            </div>
            <div class="reviewText">${escapeHtml(r.comment || "")}</div>
          `;
          reviewList.appendChild(box);
        }
      }catch(e){}
    }

    // ====== ÈõÜË®àÔºàÁ∞°ÊòìÔºöË©ï‰æ°+ÊåëÊà¶„Éá„Éº„Çø„Åã„Çâ habits „ÇíÊõ¥Êñ∞Ôºâ ======
    async function recomputeHabitStats(habitId){
      // Êú¨Áï™„ÅØCloud FunctionsÊé®Â•®Ôºà‰∏çÊ≠£Èò≤Ê≠¢ÔºÜÊï¥ÂêàÊÄßÔºâ
      // „Åì„Åì„Åß„ÅØ„ÄåÂãï„Åè„Äç„Åì„Å®ÂÑ™ÂÖà„Åß„ÄÅ„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈõÜË®à„Åô„Çã
      try{
        // 1) ratings ÈõÜË®àÔºàÈáç„Åø‰ªò„ÅçÂπ≥ÂùáÔºâ
        const ratingsSnap = await getDocs(query(collection(db, "habits", habitId, "ratings"), limit(500)));
        let wSum = 0;
        let swSum = 0;
        let ratingCount = 0;
        ratingsSnap.forEach(s=>{
          const r = s.data();
          const stars = Number(r.stars || 0);
          const w = Number(r.weight || 1);
          if(stars >= 1 && stars <= 5){
            wSum += w;
            swSum += stars * w;
            ratingCount += 1;
          }
        });
        const avgRating = wSum ? (swSum / wSum) : 0;

        // 2) userChallenges „ÅÆÈõÜË®àÔºàÂèÇÂä†ËÄÖÊï∞/ÊàêÂäüÁéá/Âπ≥ÂùáÁ∂ôÁ∂öÔºâ
        //   „Åì„Åì„ÅØÂÖ®„É¶„Éº„Ç∂„ÉºÂàÜ„ÅåÂøÖË¶Å„Å™„ÅÆ„ÅßÊú¨ÂΩì„ÅØFunctions„Åß„ÇÑ„Çã„Åπ„Åç
        //   „Åß„ÇÇÊúÄÂ∞è„Éá„É¢„Å®„Åó„Å¶ participantsCount / avgDays / successRate „ÅØ„Äå„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ä„ÅÆchallenges„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Äç„Çí‰Ωø„ÅÜ„Åã„ÄÅ
        //   „ÇÇ„Åó„Åè„ÅØ habits „Å´„Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„ÇãÂâçÊèê„Å´„Åó„Å¶„ÄÅ„Åì„Åì„Åß„ÅØ ratings„Å†„ÅëÊõ¥Êñ∞„Åó„Å¶„ÇÇOK„ÄÇ
        //   ‚Üí ‰ªäÂõû„ÅØ„ÄåÊàêÂäüÁéá/Âπ≥ÂùáÁ∂ôÁ∂ö„Äç„ÅØ habits„Å´Êó¢Â≠òÂÄ§„Åå„ÅÇ„Çå„Å∞Á∂≠ÊåÅ„ÄÅÁÑ°„Åë„Çå„Å∞0„ÅÆ„Åæ„Åæ
        const habitRef = doc(db, "habits", habitId);
        const habitSnap = await getDoc(habitRef);
        const cur = habitSnap.exists() ? habitSnap.data() : {};

        const patch = {
          avgRating: Number.isFinite(avgRating) ? avgRating : 0,
          ratingCount: ratingCount,
          // participantsCount / avgDays / successRate „ÅØÁèæÁä∂Á∂≠ÊåÅÔºàÊú¨Áï™„ÅØFunctions„ÅßÂÖ®‰ΩìÈõÜË®àÔºâ
          participantsCount: Number(cur.participantsCount || 0),
          avgDays: Number(cur.avgDays || 0),
          successRate: Number(cur.successRate || 0),
          updatedAt: serverTimestamp()
        };

        await updateDoc(habitRef, patch);
      }catch(e){}
    }

    // ====== Ëµ∑Âãï ======
    myCategory.textContent = localStorage.getItem("myCategory") || "Êú™Ë®≠ÂÆö";

    // ÂàùÊúüÊèèÁîª
    refreshHome();
    refreshRecords();
  </script>
</body>
</html>
