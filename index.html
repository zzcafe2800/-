<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÁøíÊÖ£„Åï„Åå„Åó</title>
  <style>
    :root{
      --bg:#071a2b;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(0,0,0,.14);
      --line: rgba(255,255,255,.12);
      --text:#eaf6ff;
      --muted: rgba(234,246,255,.75);
      --accent:#57c7ff;
      --ok:#7cffa6;
      --danger:#ff4d5e;
      --warn:#ffc94d;
      --r:16px;
      --gap:10px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 10% 0%, #103e63 0%, transparent 55%),
        radial-gradient(900px 600px at 95% 30%, #083a5a 0%, transparent 55%),
        linear-gradient(160deg, #061827, #0b2b45);
    }

    /* ËÉåÊôØ(ËñÑ„ÅÑÈ≠ö) */
    .bg{position:fixed; inset:0; pointer-events:none; opacity:.28; mix-blend-mode:screen}
    .fish{
      position:absolute; top:35%;
      width:240px; height:90px;
      background: radial-gradient(closest-side, rgba(120,220,255,.5), transparent 70%),
                  radial-gradient(closest-side, rgba(90,255,180,.35), transparent 72%);
      border-radius: 999px;
      filter: blur(10px);
      animation: swim 18s linear infinite;
    }
    .fish::before{
      content:""; position:absolute; right:-18px; top:26px;
      width:40px; height:40px;
      background: radial-gradient(circle at 30% 50%, rgba(120,220,255,.5), transparent 70%);
      border-radius: 8px 999px 999px 8px;
      transform: rotate(20deg);
      filter: blur(6px);
    }
    .fish.f2{top:18%; animation-duration:22s; opacity:.25}
    .fish.f3{top:62%; animation-duration:19s; opacity:.2}
    @keyframes swim{0%{left:-35vw}100%{left:120vw}}

    .app{
      position:relative;
      height:100%;
      display:grid;
      grid-template-columns: 260px 1fr;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .app{grid-template-columns: 84px 1fr; height:auto; min-height:100%}
      .nav{padding:10px 8px}
      .nav .label{display:none}
      .nav .navBtn{justify-content:center}
      .content{padding:14px}
      .topbar{grid-template-columns: 1fr; }
      .feedGrid{grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));}
      .composerGrid{grid-template-columns: 1fr}
    }

    .nav{
      padding:16px 14px;
      border-right:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(10,35,55,.65), rgba(10,30,48,.30));
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; padding:8px 8px 14px}
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, #7fe3ff, #1a6f9b 55%, #07314d);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .brand h1{font-size:15px; margin:0; letter-spacing:.06em}

    .navBtn{
      width:100%;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      margin:10px 0;
      transition: .12s transform, .12s background, .12s border-color;
    }
    .navBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .navBtn.active{
      border-color: rgba(87,199,255,.45);
      background: linear-gradient(180deg, rgba(87,199,255,.14), rgba(255,255,255,.04));
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
    }
    .navBtn .ico{font-size:20px; width:26px; text-align:center}
    .navBtn .label{font-weight:900; letter-spacing:.04em}

    .navFooter{
      position:sticky; bottom:14px;
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .userCard{
      display:flex; align-items:center; gap:10px;
      padding:10px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .avatar{
      width:34px; height:34px; border-radius:50%;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      flex:0 0 auto;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .userMeta{min-width:0}
    .userName{font-size:13px; font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .userSmall{font-size:11px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .authRow{display:flex; gap:10px; margin-top:10px}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.03em;
      transition:.12s transform, .12s background, .12s border-color;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.08)}
    .btn.primary{border-color: rgba(87,199,255,.55); background: rgba(87,199,255,.14)}
    .btn.danger{border-color: rgba(255,77,94,.55); background: rgba(255,77,94,.14)}
    .btn.small{padding:8px 10px; font-size:12px; border-radius:10px}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .content{
      padding:16px;
      overflow:auto;
      height:100%;
    }
    .panel{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:var(--gap);
      padding:12px;
      align-items:center;
    }
    .searchBox{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .searchBox input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .select{
      min-width: 160px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color:var(--text);
      padding:10px 12px;
      font-weight:900;
      outline:none;
    }

    .tagArea{padding: 0 12px 12px;}
    .tagGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:var(--gap);
    }
    .tagBlock{
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      min-height:56px;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid rgba(87,199,255,.25);
      background: rgba(87,199,255,.10);
      color: var(--text);
      padding:7px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
      transition:.12s transform, .12s background;
      user-select:none;
    }
    .chip:hover{transform: translateY(-1px); background: rgba(87,199,255,.14)}
    .chip.active{border-color: rgba(124,255,166,.55); background: rgba(124,255,166,.14)}

    .feedHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 8px 12px 0;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      font-size:12px;
      color: rgba(255,255,255,.88);
      font-weight:1000;
    }
    .pill b{font-weight:1100}

    /* ‚òÖ Ê≠£ÊñπÂΩ¢„Éª‰ΩôÁôΩÊúÄÂ∞è„Ç∞„É™„ÉÉ„Éâ */
    .feedGrid{
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: var(--gap);
      align-items:stretch;
    }
    .habitCard{
      position:relative;
      padding:10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.16), rgba(255,255,255,.03));
      overflow:hidden;
      aspect-ratio: 1 / 1; /* ‚òÖ Ê≠£ÊñπÂΩ¢ */
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:0;
    }
    .habitTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px; min-width:0;
    }
    .miniUser{display:flex; align-items:center; gap:8px; min-width:0}
    .miniAva{
      width:24px; height:24px; border-radius:50%;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
    }
    .miniAva img{width:100%; height:100%; object-fit:cover}
    .miniName{
      font-size:12px; font-weight:1000;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 140px;
    }
    .badgeRow{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}
    .badge{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.86);
      font-weight:1000;
      cursor:pointer;
    }
    .badge.cat{border-color: rgba(255,201,77,.28); background: rgba(255,201,77,.12)}
    .badge.tag{border-color: rgba(87,199,255,.28); background: rgba(87,199,255,.10)}

    .habitTitle{
      font-size:15px; font-weight:1100;
      letter-spacing:.03em;
      margin:2px 0 6px;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .habitDesc{
      color: rgba(234,246,255,.92);
      font-size:13px;
      line-height:1.45;
      margin:0 0 10px;
      white-space:pre-wrap;
      display:-webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow:hidden;
      opacity:.95;
    }

    .stats{display:flex; gap:8px; flex-wrap:wrap; font-size:12px; font-weight:1000}
    .stat{
      display:flex; align-items:center; gap:7px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:8px;
    }

    /* „Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥Ôºà„Éõ„Éê„Éº„ÅßÂêçÂâçÔºâ */
    .iconBtn{
      position:relative;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color:var(--text);
      border-radius: 12px;
      padding:10px 10px;
      font-weight:1100;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      min-width: 42px;
      user-select:none;
    }
    .iconBtn:hover{background: rgba(255,255,255,.06)}
    .iconBtn.danger{border-color: rgba(255,77,94,.45)}
    .iconBtn.ok{border-color: rgba(124,255,166,.45)}
    .iconBtn.warn{border-color: rgba(255,201,77,.45)}
    .iconBtn.primary{border-color: rgba(87,199,255,.45)}
    .iconBtn[data-tip]::after{
      content: attr(data-tip);
      position:absolute;
      bottom: calc(100% + 8px);
      left:50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.16);
      color: rgba(255,255,255,.92);
      padding:6px 8px;
      border-radius: 10px;
      font-size:11px;
      font-weight:1000;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease;
    }
    .iconBtn:hover::after{opacity:1; transform: translateX(-50%) translateY(-2px)}

    .tryBtn{
      background: linear-gradient(180deg, rgba(255,77,94,.95), rgba(255,77,94,.62));
      border:none;
      color:#fff;
      box-shadow: 0 12px 26px rgba(255,77,94,.18);
    }
    .tryBtn:hover{filter:brightness(1.03)}
    .tryBtn[data-tip]::after{ border-color: rgba(255,77,94,.25); }

    /* ‰ªäÊó•„ÅÆÈÄ≤Ë°å‰∏≠ÔºàÈÄöÁü•È¢®Ôºâ */
    .toastWrap{
      position:sticky;
      top:10px;
      z-index:20;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 0 0 10px;
    }
    .toast{
      border-radius: 16px;
      border:1px solid rgba(124,255,166,.25);
      background: linear-gradient(180deg, rgba(124,255,166,.14), rgba(0,0,0,.12));
      padding:12px;
      box-shadow: var(--shadow);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      animation: pop .18s ease-out;
    }
    @keyframes pop{from{transform: translateY(-6px); opacity:.0} to{transform: translateY(0); opacity:1}}
    .toast .left{display:flex; flex-direction:column; gap:4px; min-width:0}
    .toast .main{font-size:14px; font-weight:1100; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .toast .right{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .plusOne{
      position:fixed;
      right:22px;
      top: 92px;
      z-index:60;
      font-weight:1100;
      font-size:14px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(124,255,166,.35);
      background: rgba(124,255,166,.12);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      animation: floatUp .9s ease-out forwards;
    }
    @keyframes floatUp{
      0%{transform: translateY(8px); opacity:0}
      15%{opacity:1}
      100%{transform: translateY(-18px); opacity:0}
    }

    /* composer */
    .composer{
      position:sticky;
      bottom: 12px;
      z-index:10;
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,25,38,.78);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
    }
    .composerGrid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:var(--gap);
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    .field input, .field textarea, .field select{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    .field textarea{min-height: 74px; resize: vertical}
    .composerFooter{
      display:flex; align-items:center; justify-content:flex-end; gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .counter{
      font-family:var(--mono);
      font-size:11px;
      color: rgba(255,255,255,.7);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.14);
      margin-right:auto;
    }

    .view{display:none}
    .view.active{display:block}

    /* list screens */
    .listWrap{padding:12px}
    .simpleRow{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      margin:10px 0;
    }
    .rowTop{display:flex; align-items:flex-start; justify-content:space-between; gap:12px}
    .rowTitle{font-weight:1100; font-size:14px; margin:0}
    .rowSub{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.6}

    /* modals */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(720px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,25,38,.92);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h2{margin:0; font-size:16px; letter-spacing:.06em}
    .modalFooter{display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap}

    .catList{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .catBtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
    }
    .catBtn:hover{background: rgba(255,255,255,.06)}
    .catBtn.active{border-color: rgba(87,199,255,.55); background: rgba(87,199,255,.12)}

    .list{
      margin-top:12px;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:12px;
      display:flex; flex-direction:column; gap:10px;
      max-height: 320px;
      overflow:auto;
    }
    .review{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding:10px 12px;
    }
    .reviewTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .reviewName{font-weight:1000; font-size:12px; opacity:.95}
    .reviewMeta{font-size:12px; opacity:.9}
    .reviewText{margin-top:8px; font-size:13px; line-height:1.55; opacity:.95; white-space:pre-wrap}

    .starsRow{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0}
    .starBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1100;
      color:var(--text);
      display:flex; align-items:center; gap:8px;
    }
    .starBtn.active{border-color: rgba(255,201,77,.55); background: rgba(255,201,77,.14)}

    .toggle{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1000;
      color:var(--text);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .toggle.active{border-color: rgba(255,77,94,.55); background: rgba(255,77,94,.14)}
    .commentBox{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
      margin-top:10px;
      min-height: 88px;
      resize: vertical;
    }

    /* difficulty modal */
    .diffRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .diffBtn{
      flex:1 1 120px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding:14px 12px;
      cursor:pointer;
      font-weight:1100;
      color:var(--text);
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-size:18px;
    }
    .diffBtn:hover{background: rgba(255,255,255,.06)}
    .diffBtn.easy{border-color: rgba(124,255,166,.35); background: rgba(124,255,166,.10)}
    .diffBtn.mid{border-color: rgba(87,199,255,.35); background: rgba(87,199,255,.10)}
    .diffBtn.hard{border-color: rgba(255,201,77,.40); background: rgba(255,201,77,.10)}

    /* login gate */
    .gate{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:100;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .gate.show{display:flex}
    .gateCard{
      width:min(520px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,25,38,.92);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .gateTitle{margin:0; font-size:16px; font-weight:1100; letter-spacing:.06em}
    .gateActions{display:flex; justify-content:flex-end; gap:10px; margin-top:14px; flex-wrap:wrap}
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true">
    <div class="fish f2"></div>
    <div class="fish"></div>
    <div class="fish f3"></div>
  </div>

  <div class="plusOne" id="plusOne">‚ú® +1</div>

  <!-- „É≠„Ç∞„Ç§„É≥ÂøÖÈ†à„Ç≤„Éº„Éà -->
  <div class="gate" id="loginGate">
    <div class="gateCard">
      <p class="gateTitle">„É≠„Ç∞„Ç§„É≥</p>
      <div class="gateActions">
        <button class="btn primary" id="gateLoginBtn">Google„É≠„Ç∞„Ç§„É≥</button>
      </div>
    </div>
  </div>

  <div class="app">
    <aside class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div><h1>ÁøíÊÖ£„Åï„Åå„Åó</h1></div>
      </div>

      <div class="navSection">
        <button class="navBtn active" id="navHome"><div class="ico">üè†</div><div class="label">„Éõ„Éº„É†</div></button>
        <button class="navBtn" id="navRecords"><div class="ico">üìÖ</div><div class="label">ÈÅîÊàêË®òÈå≤</div></button>
        <button class="navBtn" id="navBookmarks"><div class="ico">üîñ</div><div class="label">‰øùÂ≠ò</div></button>
        <button class="navBtn" id="navProfile"><div class="ico">üë§</div><div class="label">„Éó„É≠„Éï„Ç£„Éº„É´</div></button>
      </div>

      <div class="navFooter">
        <div class="userCard">
          <div class="avatar" id="userAvatar">üë§</div>
          <div class="userMeta">
            <div class="userName" id="userName">‚Äî</div>
            <div class="userSmall" id="userSmall">‚Äî</div>
          </div>
        </div>

        <div class="authRow">
          <button class="btn primary" id="btnLogin">Google„É≠„Ç∞„Ç§„É≥</button>
          <button class="btn danger" id="btnLogout" disabled>„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
      </div>
    </aside>

    <main class="content">
      <section class="view active" id="viewHome">
        <div class="toastWrap" id="toastWrap"></div>

        <div class="panel">
          <div class="topbar">
            <div class="searchBox">
              <span style="opacity:.85">üîé</span>
              <input id="q" placeholder="Ê§úÁ¥¢" />
            </div>

            <select class="select" id="categoryFilter">
              <option value="">„Ç´„ÉÜ„Ç¥„É™Ôºà„Åô„Åπ„Å¶Ôºâ</option>
              <option>ÂÅ•Â∫∑</option><option>„É°„É≥„Çø„É´</option><option>ÂãâÂº∑</option><option>‰ªï‰∫ã</option>
              <option>ÁîüÊ¥ª</option><option>Áù°Áú†</option><option>ÈÅãÂãï</option><option>Ëã±Ë™û</option><option>„Åù„ÅÆ‰ªñ</option>
            </select>

            <select class="select" id="sortBy">
              <option value="new">üÜï Êñ∞ÁùÄ</option>
              <option value="rating">‚≠ê Ë©ï‰æ°</option>
              <option value="success">üéØ ÊàêÂäüÁéá</option>
              <option value="days">üìÖ Á∂ôÁ∂ö</option>
              <option value="favCreators">‚ù§Ô∏è „ÅäÊ∞ó„Å´ÂÖ•„Çä‰∏≠„ÅÆ‰∫∫</option>
            </select>

            <button class="btn small" id="btnClearTag">„Çø„Ç∞Ëß£Èô§</button>
          </div>

          <div class="tagArea">
            <div class="tagGrid">
              <div class="tagBlock"><div class="chips" id="chipsRecommend"></div></div>
              <div class="tagBlock"><div class="chips" id="chipsTop"></div></div>
            </div>
          </div>

          <div class="feedHeader">
            <div class="pill">‰ª∂Êï∞Ôºö<b id="countShown">0</b></div>
            <div class="pill">„Ç´„ÉÜ„Ç¥„É™Ôºö<b id="myCategory">Êú™Ë®≠ÂÆö</b> <button class="btn small" id="btnChangeMyCategory">Â§âÊõ¥</button></div>
            <div class="pill">‰æùÈ†ºÔºö<b id="activeCount">0</b> / 3</div>
          </div>

          <div class="feedGrid" id="feed"></div>

          <div class="composer" id="composer">
            <div class="counter" id="counterAction">0 / 40</div>

            <div class="composerGrid">
              <div class="field">
                <input id="newTitle" placeholder="„Çø„Ç§„Éà„É´" maxlength="40" />
              </div>
              <div class="field">
                <input id="newTags" placeholder="„Çø„Ç∞Ôºà‰æãÔºö‰∏çÂÆâ,ÂØù„Å§„ÅçÔºâ" />
              </div>
              <div class="field">
                <select id="newCategory">
                  <option value="">„Ç´„ÉÜ„Ç¥„É™Ôºà‰ªªÊÑèÔºâ</option>
                  <option>ÂÅ•Â∫∑</option><option>„É°„É≥„Çø„É´</option><option>ÂãâÂº∑</option><option>‰ªï‰∫ã</option>
                  <option>ÁîüÊ¥ª</option><option>Áù°Áú†</option><option>ÈÅãÂãï</option><option>Ëã±Ë™û</option><option>„Åù„ÅÆ‰ªñ</option>
                </select>
              </div>
              <div class="field">
                <textarea id="newAction" placeholder="5ÂàÜ„Åß„ÇÑ„Çã„Åì„Å®Ôºà40ÊñáÂ≠óÔºâ" maxlength="40"></textarea>
              </div>
            </div>

            <div class="composerFooter">
              <button class="btn primary" id="btnPost">ÊäïÁ®ø</button>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="viewRecords">
        <div class="panel">
          <div class="listWrap" id="recordList"></div>
        </div>
      </section>

      <section class="view" id="viewBookmarks">
        <div class="panel">
          <div class="feedHeader" style="padding:12px">
            <div class="pill">‰øùÂ≠òÔºö<b id="bmCount">0</b></div>
          </div>
          <div class="feedGrid" id="bmFeed"></div>
        </div>
      </section>

      <section class="view" id="viewProfile">
        <div class="panel">
          <div class="listWrap" id="profileList"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- ÂêçÂâçÁôªÈå≤ -->
  <div class="modalBg" id="nameBg">
    <div class="modal">
      <h2>ÂêçÂâç</h2>
      <div class="field" style="margin-top:12px">
        <input id="nameInput" placeholder="ÂêçÂâç" maxlength="16" />
      </div>
      <div class="modalFooter">
        <button class="btn primary" id="nameSave" disabled>‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- ÂàùÂõû„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <h2>„Ç´„ÉÜ„Ç¥„É™</h2>
      <div class="catList" id="catList"></div>
      <div class="modalFooter">
        <button class="btn" id="modalSkip">Èñâ„Åò„Çã</button>
        <button class="btn primary" id="modalSave" disabled>‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Èõ£ÊòìÂ∫¶Ôºà3ÊäûÔºâ -->
  <div class="modalBg" id="diffBg">
    <div class="modal">
      <h2 id="diffTitle">Èõ£ÊòìÂ∫¶</h2>
      <div class="diffRow">
        <button class="diffBtn easy" data-diff="easy">üòä</button>
        <button class="diffBtn mid" data-diff="mid">üôÇ</button>
        <button class="diffBtn hard" data-diff="hard">üòÖ</button>
      </div>
      <div class="modalFooter">
        <button class="btn" id="diffClose">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- Ë©ï‰æ°Ôºà‚≠ê/‚ù§Ô∏è/Âè£„Ç≥„ÉüÔºâ -->
  <div class="modalBg" id="ratingBg">
    <div class="modal">
      <h2 id="ratingHabitTitle">Ë©ï‰æ°</h2>

      <div class="starsRow" id="starsRow"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <button class="toggle" id="likeToggle">‚ù§Ô∏è</button>
        <div class="pill">R<b id="myRank">1</b></div>
      </div>

      <textarea class="commentBox" id="commentBox" placeholder="Âè£„Ç≥„ÉüÔºàÁü≠ÊñáÔºâ"></textarea>

      <div class="modalFooter">
        <button class="btn danger" id="ratingDelete">ÂâäÈô§</button>
        <button class="btn primary" id="ratingSave">‰øùÂ≠ò</button>
        <button class="btn" id="ratingClose">Èñâ„Åò„Çã</button>
      </div>

      <div class="list" id="reviewList"></div>
    </div>
  </div>

  <!-- Âè£„Ç≥„Éü‰∏ÄË¶ßÔºàÈñ≤Ë¶ßÂ∞ÇÁî®Ôºâ -->
  <div class="modalBg" id="reviewsBg">
    <div class="modal">
      <h2 id="reviewsTitle">Âè£„Ç≥„Éü</h2>
      <div class="list" id="reviewsList"></div>
      <div class="modalFooter">
        <button class="btn" id="reviewsClose">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <!-- Á∑®ÈõÜÔºàver‰øùÊåÅÔºÜÊ¥æÁîüÔºâ -->
  <div class="modalBg" id="editBg">
    <div class="modal">
      <h2 id="editTitle">Á∑®ÈõÜ</h2>

      <div class="composerGrid" style="margin-top:12px">
        <div class="field"><input id="editNewTitle" placeholder="„Çø„Ç§„Éà„É´" maxlength="40"></div>
        <div class="field"><input id="editNewTags" placeholder="„Çø„Ç∞Ôºà‰æãÔºö‰∏çÂÆâ,ÂØù„Å§„ÅçÔºâ"></div>
        <div class="field">
          <select id="editNewCategory">
            <option value="">„Ç´„ÉÜ„Ç¥„É™Ôºà‰ªªÊÑèÔºâ</option>
            <option>ÂÅ•Â∫∑</option><option>„É°„É≥„Çø„É´</option><option>ÂãâÂº∑</option><option>‰ªï‰∫ã</option>
            <option>ÁîüÊ¥ª</option><option>Áù°Áú†</option><option>ÈÅãÂãï</option><option>Ëã±Ë™û</option><option>„Åù„ÅÆ‰ªñ</option>
          </select>
        </div>
        <div class="field"><textarea id="editNewAction" placeholder="5ÂàÜ„Åß„ÇÑ„Çã„Åì„Å®Ôºà40ÊñáÂ≠óÔºâ" maxlength="40"></textarea></div>
      </div>

      <div class="modalFooter">
        <button class="btn" id="btnDerive">Ê¥æÁîü</button>
        <button class="btn primary" id="btnSaveEdit">‰øùÂ≠ò</button>
        <button class="btn" id="editClose">Èñâ„Åò„Çã</button>
      </div>

      <div class="list" id="versionsList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    import {
      getFirestore,
      collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      getDocs, query, orderBy, limit, serverTimestamp,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCvdaEW4o2y8rljlafXQJbGE-nuGQn9Q88",
      authDomain: "zuzutomo-d8fa0.firebaseapp.com",
      projectId: "zuzutomo-d8fa0",
      storageBucket: "zuzutomo-d8fa0.firebasestorage.app",
      messagingSenderId: "637121353766",
      appId: "1:637121353766:web:dbfb13f85bfaf521616ee7",
      measurementId: "G-C6K64YE13X"
    };

    const app = initializeApp(firebaseConfig);
    try{ getAnalytics(app); }catch{}
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

    const nowLocal = () => new Date();
    const fmtDate = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };
    const parseYMD = (s) => {
      const raw = String(s||"").slice(0,10);
      if(!/^\d{4}-\d{2}-\d{2}$/.test(raw)) return null;
      const [y,m,d] = raw.split("-").map(Number);
      return new Date(y, m-1, d);
    };
    const daysBetween = (a, b) => {
      const A = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
      const B = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
      return Math.round((B - A) / 86400000);
    };

    // nav/views
    const navHome = $("navHome");
    const navRecords = $("navRecords");
    const navBookmarks = $("navBookmarks");
    const navProfile = $("navProfile");

    const viewHome = $("viewHome");
    const viewRecords = $("viewRecords");
    const viewBookmarks = $("viewBookmarks");
    const viewProfile = $("viewProfile");

    // auth UI
    const btnLogin = $("btnLogin");
    const btnLogout = $("btnLogout");
    const gateLoginBtn = $("gateLoginBtn");
    const loginGate = $("loginGate");
    const userName = $("userName");
    const userSmall = $("userSmall");
    const userAvatar = $("userAvatar");

    // name modal
    const nameBg = $("nameBg");
    const nameInput = $("nameInput");
    const nameSave = $("nameSave");

    // home
    const qInput = $("q");
    const categoryFilter = $("categoryFilter");
    const sortBy = $("sortBy");
    const chipsRecommend = $("chipsRecommend");
    const chipsTop = $("chipsTop");
    const btnClearTag = $("btnClearTag");
    const feed = $("feed");
    const countShown = $("countShown");
    const myCategory = $("myCategory");
    const btnChangeMyCategory = $("btnChangeMyCategory");
    const activeCount = $("activeCount");

    // toast
    const toastWrap = $("toastWrap");
    const plusOne = $("plusOne");

    // composer
    const newTitle = $("newTitle");
    const newTags = $("newTags");
    const newCategory = $("newCategory");
    const newAction = $("newAction");
    const counterAction = $("counterAction");
    const btnPost = $("btnPost");

    // records/profile/bookmarks
    const recordList = $("recordList");
    const profileList = $("profileList");
    const bmFeed = $("bmFeed");
    const bmCount = $("bmCount");

    // category modal
    const modalBg = $("modalBg");
    const catList = $("catList");
    const modalSkip = $("modalSkip");
    const modalSave = $("modalSave");

    // difficulty modal
    const diffBg = $("diffBg");
    const diffTitle = $("diffTitle");
    const diffClose = $("diffClose");

    // rating modal
    const ratingBg = $("ratingBg");
    const ratingClose = $("ratingClose");
    const ratingHabitTitle = $("ratingHabitTitle");
    const starsRow = $("starsRow");
    const likeToggle = $("likeToggle");
    const myRankEl = $("myRank");
    const commentBox = $("commentBox");
    const ratingSave = $("ratingSave");
    const ratingDelete = $("ratingDelete");
    const reviewList = $("reviewList");

    // reviews view-only modal
    const reviewsBg = $("reviewsBg");
    const reviewsTitle = $("reviewsTitle");
    const reviewsList = $("reviewsList");
    const reviewsClose = $("reviewsClose");

    // edit modal
    const editBg = $("editBg");
    const editTitle = $("editTitle");
    const editNewTitle = $("editNewTitle");
    const editNewTags = $("editNewTags");
    const editNewCategory = $("editNewCategory");
    const editNewAction = $("editNewAction");
    const btnSaveEdit = $("btnSaveEdit");
    const btnDerive = $("btnDerive");
    const editClose = $("editClose");
    const versionsList = $("versionsList");

    let currentUser = null;
    let myProfile = null;

    let selectedTag = "";
    let selectedTopTags = [];
    let selectedRecoTags = [];

    // challenge state for difficulty modal
    let diffTargetChallenge = null;

    // rating state
    let ratingTargetHabit = null;
    let ratingStars = 0;
    let ratingLiked = false;

    // edit state
    let editTargetHabit = null;

    // caches
    let cachedFavCreators = new Set(); // creatorUid
    let cachedBookmarks = new Set();   // habitId

    const CATS = ["„É°„É≥„Çø„É´","Áù°Áú†","ÈÅãÂãï","ÂÅ•Â∫∑","ÁîüÊ¥ª","ÂãâÂº∑","Ëã±Ë™û","‰ªï‰∫ã","„Åù„ÅÆ‰ªñ"];
    let modalSelected = "";

    function showPlusOne(){
      plusOne.style.display = "block";
      plusOne.style.animation = "none";
      void plusOne.offsetWidth;
      plusOne.style.animation = "floatUp .9s ease-out forwards";
      setTimeout(()=> plusOne.style.display = "none", 950);
    }

    function setView(which){
      const home = which==="home";
      const records = which==="records";
      const bookmarks = which==="bookmarks";
      const profile = which==="profile";

      navHome.classList.toggle("active", home);
      navRecords.classList.toggle("active", records);
      navBookmarks.classList.toggle("active", bookmarks);
      navProfile.classList.toggle("active", profile);

      viewHome.classList.toggle("active", home);
      viewRecords.classList.toggle("active", records);
      viewBookmarks.classList.toggle("active", bookmarks);
      viewProfile.classList.toggle("active", profile);

      if(records) refreshRecords();
      if(bookmarks) refreshBookmarksView();
      if(profile) refreshProfile();
    }
    navHome.addEventListener("click", ()=> setView("home"));
    navRecords.addEventListener("click", ()=> setView("records"));
    navBookmarks.addEventListener("click", ()=> setView("bookmarks"));
    navProfile.addEventListener("click", ()=> setView("profile"));

    // ===== Auth =====
    async function login(){
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }
    btnLogin.addEventListener("click", async ()=>{ try{ await login(); }catch{ alert("„É≠„Ç∞„Ç§„É≥Â§±Êïó"); } });
    gateLoginBtn.addEventListener("click", async ()=>{ try{ await login(); }catch{ alert("„É≠„Ç∞„Ç§„É≥Â§±Êïó"); } });
    btnLogout.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch{ alert("„É≠„Ç∞„Ç¢„Ç¶„ÉàÂ§±Êïó"); }
    });

    // ===== Name modal =====
    function openNameModal(){
      nameInput.value = "";
      nameSave.disabled = true;
      nameBg.classList.add("show");
    }
    function closeNameModal(){ nameBg.classList.remove("show"); }
    nameInput.addEventListener("input", ()=>{
      nameSave.disabled = nameInput.value.trim().length < 1;
    });
    nameSave.addEventListener("click", async ()=>{
      const nm = nameInput.value.trim().slice(0,16);
      if(!nm) return;
      await updateDoc(doc(db,"users",currentUser.uid), { name: nm, updatedAt: serverTimestamp() });
      myProfile.name = nm;
      userName.textContent = nm;
      closeNameModal();
      // ÂêçÂâçÂæåÔºö„Ç´„ÉÜ„Ç¥„É™
      const pref = myProfile?.preferredCategory || "";
      if(!pref) openCategoryModal();
      await warmCaches();
      await autoRetireIfMissed();
      await refreshHome();
      await refreshRecords();
      await refreshProfile();
      await refreshBookmarksView();
    });

    // ===== Profile doc =====
    async function ensureProfile(){
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const initial = {
          name: "", // ‚òÖÂøÖ„ÅöÂÖ•Âäõ„Åï„Åõ„Çã
          photoURL: currentUser.photoURL || "",
          preferredCategory: "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          clearCount: 0,
          totalChallenges: 0,
          ratingRank: 1
        };
        await setDoc(ref, initial);
        myProfile = initial;
      }else{
        myProfile = snap.data();
      }
      myRankEl.textContent = String(myProfile?.ratingRank || 1);
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;

      if(!currentUser){
        loginGate.classList.add("show");
        btnLogout.disabled = true;

        userName.textContent = "‚Äî";
        userSmall.textContent = "‚Äî";
        userAvatar.innerHTML = "üë§";

        feed.innerHTML = "";
        toastWrap.innerHTML = "";
        recordList.innerHTML = "";
        profileList.innerHTML = "";
        bmFeed.innerHTML = "";
        bmCount.textContent = "0";
        cachedFavCreators = new Set();
        cachedBookmarks = new Set();
        return;
      }

      loginGate.classList.remove("show");
      btnLogout.disabled = false;

      userSmall.textContent = currentUser.email || "‚Äî";
      userAvatar.innerHTML = "";
      if(currentUser.photoURL){
        const img = document.createElement("img");
        img.src = currentUser.photoURL;
        img.alt = "avatar";
        userAvatar.appendChild(img);
      }else{
        userAvatar.textContent = "üë§";
      }

      await ensureProfile();

      // UI name
      const nm = (myProfile?.name || "").trim();
      userName.textContent = nm || "‚Äî";

      // ÂêçÂâç„ÅåÊú™Ë®≠ÂÆö„Å™„Çâ„Åì„Åì„ÅßÊ≠¢„ÇÅ„ÇãÔºàÂêçÂâç‚Üí„Ç´„ÉÜ„Ç¥„É™‚Üí„Éõ„Éº„É†Ôºâ
      if(!nm){
        openNameModal();
        return;
      }

      // „Ç´„ÉÜ„Ç¥„É™
      const pref = myProfile?.preferredCategory || "";
      myCategory.textContent = pref || "Êú™Ë®≠ÂÆö";
      if(!pref) openCategoryModal();

      await warmCaches();
      await autoRetireIfMissed();

      await refreshHome();
      await refreshRecords();
      await refreshProfile();
      await refreshBookmarksView();
    });

    // ===== Category modal =====
    function openCategoryModal(){
      modalSelected = "";
      modalSave.disabled = true;
      catList.innerHTML = "";
      for(const c of CATS){
        const b = document.createElement("button");
        b.className = "catBtn";
        b.textContent = c;
        b.addEventListener("click", ()=>{
          modalSelected = c;
          [...catList.querySelectorAll(".catBtn")].forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          modalSave.disabled = false;
        });
        catList.appendChild(b);
      }
      modalBg.classList.add("show");
    }
    function closeCategoryModal(){ modalBg.classList.remove("show"); }
    btnChangeMyCategory.addEventListener("click", openCategoryModal);
    modalSkip.addEventListener("click", closeCategoryModal);
    modalSave.addEventListener("click", async ()=>{
      if(!modalSelected) return;
      await updateDoc(doc(db,"users",currentUser.uid), {
        preferredCategory: modalSelected,
        updatedAt: serverTimestamp()
      });
      myProfile.preferredCategory = modalSelected;
      myCategory.textContent = modalSelected;
      closeCategoryModal();
      await refreshHome();
    });

    // ===== Composer =====
    function updateCounter(){
      counterAction.textContent = `${newAction.value.length} / 40`;
    }
    newAction.addEventListener("input", updateCounter);
    updateCounter();

    btnPost.addEventListener("click", async ()=>{
      const title = newTitle.value.trim();
      const tags = newTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(newCategory.value || "").trim();
      const action = newAction.value.trim();

      if(title.length < 2 || action.length < 2){ alert("Áü≠„Åô„Åé"); return; }
      if(action.length > 40){ alert("40ÊñáÂ≠ó‰ª•ÂÜÖ"); return; }

      const data = {
        title, action, tags, category,
        creatorUid: currentUser.uid,
        creatorName: myProfile?.name || (currentUser.displayName || "‰ΩúÊàêËÄÖ"),
        creatorPhoto: currentUser.photoURL || "",
        createdAt: serverTimestamp(),

        // ÈõÜË®àÔºàÂúüÂè∞Ôºâ
        avgRating: 0,
        ratingCount: 0,
        participantsCount: 0,
        avgDays: 0,
        successRate: 0,
        feelEasy: 0,
        feelMid: 0,
        feelHard: 0,

        // versioning
        baseHabitId: "",
        version: 1,
        updatedAt: serverTimestamp()
      };

      try{
        await addDoc(collection(db, "habits"), data);

        newTitle.value = "";
        newTags.value = "";
        newCategory.value = "";
        newAction.value = "";
        updateCounter();

        await refreshHome();
        await refreshProfile();
      }catch{
        alert("ÊäïÁ®øÂ§±Êïó");
      }
    });

    // ===== Filters =====
    function setSelectedTag(tag){
      selectedTag = tag || "";
      [...document.querySelectorAll(".chip")].forEach(ch=>{
        ch.classList.toggle("active", ch.dataset.tag === selectedTag);
      });
      refreshHome();
    }
    btnClearTag.addEventListener("click", ()=> setSelectedTag(""));
    qInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshHome(); });
    categoryFilter.addEventListener("change", refreshHome);
    sortBy.addEventListener("change", refreshHome);

    function renderChips(container, tags){
      container.innerHTML = "";
      for(const t of tags){
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.dataset.tag = t;
        chip.textContent = `#${t}`;
        chip.addEventListener("click", ()=> setSelectedTag(t));
        container.appendChild(chip);
      }
      [...container.querySelectorAll(".chip")].forEach(ch=>{
        ch.classList.toggle("active", ch.dataset.tag === selectedTag);
      });
    }

    // ===== Phase3 caches (no composite index) =====
    async function warmCaches(){
      cachedFavCreators = new Set();
      cachedBookmarks = new Set();

      // fav creators
      {
        const qs = await getDocs(query(
          collection(db, "userCreatorFavs", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(300)
        ));
        qs.forEach(s=> cachedFavCreators.add(s.id));
      }

      // bookmarks
      {
        const qs = await getDocs(query(
          collection(db, "userBookmarks", currentUser.uid, "items"),
          orderBy("createdAt","desc"),
          limit(500)
        ));
        qs.forEach(s=> cachedBookmarks.add(s.id));
      }
    }

    async function toggleCreatorFav(creatorUid){
      if(!creatorUid) return;
      const ref = doc(db, "userCreatorFavs", currentUser.uid, "items", creatorUid);
      if(cachedFavCreators.has(creatorUid)){
        await deleteDoc(ref);
        cachedFavCreators.delete(creatorUid);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedFavCreators.add(creatorUid);
      }
      await refreshProfile();
      await refreshHome();
    }

    async function toggleBookmark(habitId){
      if(!habitId) return;
      const ref = doc(db, "userBookmarks", currentUser.uid, "items", habitId);
      if(cachedBookmarks.has(habitId)){
        await deleteDoc(ref);
        cachedBookmarks.delete(habitId);
      }else{
        await setDoc(ref, { createdAt: serverTimestamp() });
        cachedBookmarks.add(habitId);
      }
      await refreshBookmarksView();
      await refreshHome(); // „Ç¢„Ç§„Ç≥„É≥ÂèçÊò†
      await refreshProfile();
    }

    // ===== Home =====
    async function refreshHome(){
      if(!currentUser) return;

      const keyword = qInput.value.trim().toLowerCase();
      const cat = categoryFilter.value.trim();
      const sort = sortBy.value;
      const prefCat = myProfile?.preferredCategory || "";

      myCategory.textContent = prefCat || "Êú™Ë®≠ÂÆö";

      // habits
      let habits = [];
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(220)));
      qs.forEach(docSnap=> habits.push({ id: docSnap.id, ...docSnap.data() }));

      // tag counts
      const tagCounts = new Map();
      for(const h of habits){
        (h.tags || []).forEach(t=>{
          const k = String(t || "").trim();
          if(!k) return;
          tagCounts.set(k, (tagCounts.get(k)||0)+1);
        });
      }
      selectedTopTags = [...tagCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
      renderChips(chipsTop, selectedTopTags);

      const recoPool = habits.filter(h=>{
        if(!prefCat) return true;
        return (h.category || "").trim() === prefCat;
      });
      const recoCounts = new Map();
      for(const h of recoPool){
        (h.tags||[]).forEach(t=>{
          const k = String(t||"").trim();
          if(!k) return;
          recoCounts.set(k, (recoCounts.get(k)||0)+1);
        });
      }
      selectedRecoTags = [...recoCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
      if(selectedRecoTags.length===0) selectedRecoTags = selectedTopTags;
      renderChips(chipsRecommend, selectedRecoTags);

      // filter
      let filtered = habits.filter(h=>{
        if(cat && (h.category || "").trim() !== cat) return false;
        if(selectedTag && !(h.tags || []).includes(selectedTag)) return false;
        if(keyword){
          const blob = [h.title, h.action, (h.tags||[]).join(" "), h.category, h.creatorName].join(" ").toLowerCase();
          if(!blob.includes(keyword)) return false;
        }
        // ‚ù§Ô∏è„ÅäÊ∞ó„Å´ÂÖ•„Çä‰∏≠„ÅÆ‰∫∫
        if(sort === "favCreators"){
          return cachedFavCreators.has(h.creatorUid);
        }
        return true;
      });

      // sort
      filtered.sort((a,b)=>{
        const ca = a.createdAt?.seconds ? a.createdAt.seconds : 0;
        const cb = b.createdAt?.seconds ? b.createdAt.seconds : 0;

        const ra = Number(a.avgRating||0);
        const rb = Number(b.avgRating||0);
        const sa = Number(a.successRate||0);
        const sb = Number(b.successRate||0);
        const da = Number(a.avgDays||0);
        const dbb = Number(b.avgDays||0);

        if(sort === "rating") return (rb - ra) || (cb - ca);
        if(sort === "success") return (sb - sa) || (cb - ca);
        if(sort === "days") return (dbb - da) || (cb - ca);
        if(sort === "favCreators") return (cb - ca);
        return (cb - ca);
      });

      countShown.textContent = String(filtered.length);

      // active count
      const actives = await loadActiveChallenges();
      activeCount.textContent = String(actives.length);

      // today toasts
      await refreshTodayToasts();

      // render
      feed.innerHTML = "";
      for(const h of filtered){
        feed.appendChild(renderHabitCard(h));
      }
    }

    function renderHabitCard(h){
      const card = document.createElement("div");
      card.className = "habitCard";

      const tags = (h.tags || []).slice(0,3);
      const cat = (h.category || "").trim();

      const avgRating = Number(h.avgRating||0);
      const avgDays = Number(h.avgDays||0);
      const successRate = Number(h.successRate||0);

      const isMine = h.creatorUid === currentUser.uid;
      const creatorFav = cachedFavCreators.has(h.creatorUid);
      const bookmarked = cachedBookmarks.has(h.id);

      card.innerHTML = `
        <div>
          <div class="habitTop">
            <div class="miniUser">
              <div class="miniAva">${h.creatorPhoto ? `<img src="${escapeHtml(h.creatorPhoto)}" alt=""/>` : ""}</div>
              <div class="miniName">${escapeHtml(h.creatorName || "‰ΩúÊàêËÄÖ")}</div>
            </div>
            <div class="badgeRow">
              ${cat ? `<span class="badge cat" data-cat="${escapeHtml(cat)}">${escapeHtml(cat)}</span>` : ""}
              ${tags.map(t=>`<span class="badge tag" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</span>`).join("")}
            </div>
          </div>

          <div class="habitTitle">${escapeHtml(h.title || "")}</div>
          <p class="habitDesc">${escapeHtml(h.action || "")}</p>
        </div>

        <div>
          <div class="stats">
            <div class="stat">‚≠ê ${avgRating ? avgRating.toFixed(1) : "‚Äî"}</div>
            <div class="stat">üìÖ ${avgDays ? avgDays.toFixed(1) : "‚Äî"}</div>
            <div class="stat">üéØ ${successRate ? successRate.toFixed(0) + "%" : "‚Äî"}</div>
          </div>

          <div class="actions">
            <button class="iconBtn ${bookmarked ? "ok":""}" data-act="bookmark" data-tip="‰øùÂ≠ò">üîñ</button>
            <button class="iconBtn ${creatorFav ? "ok":""}" data-act="creatorFav" data-tip="‰ΩúÊàêËÄÖ">üë§</button>
            <button class="iconBtn primary" data-act="rate" data-tip="Ë©ï‰æ°">‚≠ê</button>
            <button class="iconBtn" data-act="reviews" data-tip="Âè£„Ç≥„Éü">üí¨</button>
            ${isMine ? `<button class="iconBtn warn" data-act="edit" data-tip="Á∑®ÈõÜ">üõ†Ô∏è</button>` : ""}
            <button class="iconBtn tryBtn" data-act="try" data-tip="ÊåëÊà¶">‚ñ∂</button>
          </div>
        </div>
      `;

      card.querySelector('[data-act="try"]').addEventListener("click", ()=> startChallenge(h));
      card.querySelector('[data-act="rate"]').addEventListener("click", ()=> openRatingModal(h));
      card.querySelector('[data-act="reviews"]').addEventListener("click", ()=> openReviewsModal(h));
      card.querySelector('[data-act="bookmark"]').addEventListener("click", ()=> toggleBookmark(h.id));
      card.querySelector('[data-act="creatorFav"]').addEventListener("click", ()=> toggleCreatorFav(h.creatorUid));

      const editBtn = card.querySelector('[data-act="edit"]');
      if(editBtn) editBtn.addEventListener("click", ()=> openEditModal(h));

      card.querySelectorAll(".badge.tag").forEach(el=>{
        el.addEventListener("click", (e)=>{
          setSelectedTag(el.dataset.tag || el.textContent.trim());
          e.stopPropagation();
        });
      });
      card.querySelectorAll(".badge.cat").forEach(el=>{
        el.addEventListener("click", (e)=>{
          categoryFilter.value = el.dataset.cat || el.textContent.trim();
          refreshHome();
          e.stopPropagation();
        });
      });

      return card;
    }

    // ===== Challenge (‚òÖË§áÂêà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰∏çË¶ÅÁâà) =====
    async function loadActiveChallenges(){
      // orderBy„ÅÆ„Åø ‚Üí „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰∏çË¶Å
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(50)
      ));
      const arr = [];
      qs.forEach(s=> arr.push(s.data()));
      return arr.filter(x => x.status === "active").slice(0, 10);
    }

    async function startChallenge(h){
      const maxActive = 3;
      const actives = await loadActiveChallenges();
      if(actives.length >= maxActive){ alert("‰æùÈ†º„ÅØÊúÄÂ§ß3"); return; }

      const start = fmtDate(nowLocal());

      try{
        const ref = doc(db, "userChallenges", currentUser.uid, "items", h.id);
        const snap = await getDoc(ref);
        if(snap.exists() && snap.data()?.status === "active") return;

        await setDoc(ref, {
          habitId: h.id,
          habitTitle: h.title || "",
          status:"active",
          startDate: start,
          day: 1,
          lastReportedDate: "",
          streakMiss: 0,
          successDays: 0,
          restDays: 0,
          difficulty: { easy:0, mid:0, hard:0 },
          updatedAt: serverTimestamp()
        });

        // participantsCount +1
        await runTransaction(db, async (tx)=>{
          const href = doc(db, "habits", h.id);
          const hs = await tx.get(href);
          if(!hs.exists()) return;
          const cur = hs.data();
          const pc = Number(cur.participantsCount||0) + 1;
          tx.update(href, { participantsCount: pc, updatedAt: serverTimestamp() });
        });

        // user stats
        await runTransaction(db, async (tx)=>{
          const uref = doc(db, "users", currentUser.uid);
          const us = await tx.get(uref);
          if(!us.exists()) return;
          const cur = us.data();
          tx.update(uref, { totalChallenges: Number(cur.totalChallenges||0)+1, updatedAt: serverTimestamp() });
        });

        await refreshTodayToasts();
        await refreshRecords();
        await refreshHome();
        await refreshProfile();
      }catch{
        alert("ÊåëÊà¶Â§±Êïó");
      }
    }

    async function refreshTodayToasts(){
      toastWrap.innerHTML = "";
      const actives = await loadActiveChallenges();
      activeCount.textContent = String(actives.length);
      if(actives.length === 0) return;

      for(const ch of actives.slice(0,3)){
        const title = ch.habitTitle || "ÁøíÊÖ£";
        const day = Number(ch.day||1);
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.innerHTML = `
          <div class="left"><div class="main">üå± ${escapeHtml(title)}Ôºà${day}Êó•ÁõÆÔºâ</div></div>
          <div class="right">
            <button class="iconBtn ok" data-act="done" data-tip="„ÇÑ„Å£„Åü">‚úÖ</button>
            <button class="iconBtn warn" data-act="rest" data-tip="‰ºë„ÇÄ">üõå</button>
            <button class="iconBtn danger" data-act="retire" data-tip="„É™„Çø„Ç§„Ç¢">üè≥Ô∏è</button>
          </div>
        `;
        toast.querySelector('[data-act="done"]').addEventListener("click", ()=> openDiffModal(ch));
        toast.querySelector('[data-act="rest"]').addEventListener("click", ()=> applyReport(ch, { type:"rest" }));
        toast.querySelector('[data-act="retire"]').addEventListener("click", async ()=>{
          if(!confirm("„É™„Çø„Ç§„Ç¢Ôºü")) return;
          await applyReport(ch, { type:"retire" });
        });
        toastWrap.appendChild(toast);
      }
    }

    // ===== Difficulty modal =====
    function openDiffModal(ch){
      diffTargetChallenge = ch;
      diffTitle.textContent = ch.habitTitle || "Èõ£ÊòìÂ∫¶";
      diffBg.classList.add("show");
    }
    function closeDiffModal(){
      diffTargetChallenge = null;
      diffBg.classList.remove("show");
    }
    diffClose.addEventListener("click", closeDiffModal);
    diffBg.addEventListener("click", (e)=>{ if(e.target===diffBg) closeDiffModal(); });
    diffBg.querySelectorAll(".diffBtn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if(!diffTargetChallenge) return;
        const diff = btn.dataset.diff;
        await applyReport(diffTargetChallenge, { type:"done", diff });
        closeDiffModal();
      });
    });

    async function applyReport(ch, payload){
      const today = fmtDate(nowLocal());

      try{
        const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
        const snap = await getDoc(ref);
        if(!snap.exists()) return;
        const cur = snap.data();

        const update = {};
        if(payload.type === "done"){
          update.successDays = Number(cur.successDays||0) + 1;
          update.lastReportedDate = today;
          update.streakMiss = 0;
          update.day = Number(cur.day||1) + 1;

          const diffObj = cur.difficulty || {easy:0,mid:0,hard:0};
          diffObj[payload.diff] = Number(diffObj[payload.diff]||0) + 1;
          update.difficulty = diffObj;

          showPlusOne();
        }else if(payload.type === "rest"){
          update.restDays = Number(cur.restDays||0) + 1;
          update.lastReportedDate = today + "Ôºà‰ºëÔºâ";
          update.streakMiss = 0;
          update.day = Number(cur.day||1) + 1;
        }else if(payload.type === "retire"){
          update.status = "retired";
          update.lastReportedDate = today + "Ôºà„É™„Çø„Ç§„Ç¢Ôºâ";
        }

        update.updatedAt = serverTimestamp();
        await updateDoc(ref, update);

        // 7Êó•Âà∂ÔºöÊàêÂäü5„Åß„ÇØ„É™„Ç¢ÔºàdoneÊôÇ„Å†„ÅëÁ¢∫Ë™çÔºâ
        if(payload.type === "done" && cur.status === "active"){
          const nextSuccess = Number(cur.successDays||0)+1;
          const nextDay = Number(cur.day||1)+1;
          if(nextSuccess >= 5 && nextDay >= 7){
            if(confirm("„ÇØ„É™„Ç¢„Å´„Åô„ÇãÔºü")){
              await updateDoc(ref, { status:"cleared", lastReportedDate: today + "Ôºà„ÇØ„É™„Ç¢Ôºâ", updatedAt: serverTimestamp() });
              await runTransaction(db, async (tx)=>{
                const uref = doc(db, "users", currentUser.uid);
                const us = await tx.get(uref);
                if(!us.exists()) return;
                const u = us.data();
                tx.update(uref, { clearCount: Number(u.clearCount||0)+1, updatedAt: serverTimestamp() });
              });
            }
          }
        }

        // ÁøíÊÖ£ÂÅ¥„ÅÆÊúÄ‰ΩéÈôêÈõÜË®àÔºàÊú¨Áï™„ÅØCloud FunctionsÊé®Â•®Ôºâ
        await recomputeHabitStatsFromActions(ch.habitId, payload);

        await refreshTodayToasts();
        await refreshRecords();
        await refreshHome();
        await refreshProfile();
      }catch{
        alert("Â§±Êïó");
      }
    }

    async function recomputeHabitStatsFromActions(habitId, payload){
      try{
        await runTransaction(db, async (tx)=>{
          const href = doc(db, "habits", habitId);
          const hs = await tx.get(href);
          if(!hs.exists()) return;
          const h = hs.data();

          let feelEasy = Number(h.feelEasy||0);
          let feelMid  = Number(h.feelMid||0);
          let feelHard = Number(h.feelHard||0);

          let successRate = Number(h.successRate||0);
          let avgDays = Number(h.avgDays||0);
          const participants = Math.max(1, Number(h.participantsCount||0));

          if(payload.type === "done"){
            if(payload.diff === "easy") feelEasy++;
            if(payload.diff === "mid") feelMid++;
            if(payload.diff === "hard") feelHard++;

            const totalFeel = feelEasy + feelMid + feelHard;
            successRate = totalFeel ? (totalFeel / totalFeel) * 100 : successRate; // ÊúÄ‰ΩéÈôê(Ë°®Á§∫Áî®)
            avgDays = totalFeel ? (totalFeel / participants) : avgDays;
          }

          tx.update(href, {
            feelEasy, feelMid, feelHard,
            successRate: Number.isFinite(successRate) ? successRate : 0,
            avgDays: Number.isFinite(avgDays) ? avgDays : 0,
            updatedAt: serverTimestamp()
          });
        });
      }catch{}
    }

    // ===== Auto retire (‚òÖË§áÂêà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰∏çË¶ÅÁâà) =====
    async function autoRetireIfMissed(){
      const today = nowLocal();
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(200)
      ));
      const updates = [];
      qs.forEach(s=>{
        const ch = s.data();
        if(ch.status !== "active") return;

        const startD = parseYMD(ch.startDate);
        const lastD = parseYMD(ch.lastReportedDate);

        let miss = 0;
        if(lastD){
          const gap = daysBetween(lastD, today);
          miss = Math.max(0, gap - 1);
        }else if(startD){
          const gap = daysBetween(startD, today);
          miss = Math.max(0, gap - 1);
        }

        const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
        if(miss >= 3){
          updates.push(updateDoc(ref, {
            status:"retired",
            streakMiss: miss,
            lastReportedDate: fmtDate(today) + "ÔºàËá™Âãï„É™„Çø„Ç§„Ç¢Ôºâ",
            updatedAt: serverTimestamp()
          }));
        }else{
          updates.push(updateDoc(ref, { streakMiss: miss, updatedAt: serverTimestamp() }));
        }
      });
      await Promise.allSettled(updates);
    }

    // ===== Records =====
    async function refreshRecords(){
      const qs = await getDocs(query(
        collection(db, "userChallenges", currentUser.uid, "items"),
        orderBy("updatedAt","desc"),
        limit(120)
      ));
      const items = [];
      qs.forEach(s=> items.push(s.data()));

      const order = (st)=> st==="active"?0 : st==="cleared"?1 : 2;
      items.sort((a,b)=> order(a.status)-order(b.status));

      recordList.innerHTML = "";
      for(const ch of items){
        recordList.appendChild(renderRecordRow(ch));
      }
    }

    function renderRecordRow(ch){
      const card = document.createElement("div");
      card.className = "simpleRow";

      const st = ch.status;
      const stBadge = st==="active" ? "‚úÖ" : st==="cleared" ? "üèÅ" : "üè≥Ô∏è";
      const day = Number(ch.day||1);
      const success = Number(ch.successDays||0);
      const rest = Number(ch.restDays||0);

      card.innerHTML = `
        <div class="rowTop">
          <div>
            <p class="rowTitle">${stBadge} ${escapeHtml(ch.habitTitle||"")}</p>
            <div class="rowSub">${escapeHtml(ch.startDate||"‚Äî")} / ${day}Êó•ÁõÆ / ÊàêÂäü:${success} / ‰ºë:${rest}<br>${escapeHtml(ch.lastReportedDate||"")}</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
            ${st==="active"
              ? `<button class="btn small danger" data-act="retire">„É™„Çø„Ç§„Ç¢</button>`
              : `<button class="btn small" data-act="restart">ÂÜçÊåëÊà¶</button>`}
          </div>
        </div>
      `;

      const btnRet = card.querySelector('[data-act="retire"]');
      if(btnRet){
        btnRet.addEventListener("click", async ()=>{
          if(!confirm("„É™„Çø„Ç§„Ç¢Ôºü")) return;
          await applyReport(ch, { type:"retire" });
        });
      }
      const btnRestart = card.querySelector('[data-act="restart"]');
      if(btnRestart){
        btnRestart.addEventListener("click", async ()=>{
          if(!confirm("ÂÜçÊåëÊà¶Ôºü")) return;
          await restartChallenge(ch);
        });
      }
      return card;
    }

    async function restartChallenge(ch){
      const today = fmtDate(nowLocal());
      const ref = doc(db, "userChallenges", currentUser.uid, "items", ch.habitId);
      await updateDoc(ref, {
        status:"active",
        startDate: today,
        day:1,
        lastReportedDate:"",
        streakMiss:0,
        successDays:0,
        restDays:0,
        difficulty:{easy:0,mid:0,hard:0},
        updatedAt: serverTimestamp()
      });
      await refreshTodayToasts();
      await refreshRecords();
      await refreshHome();
      await refreshProfile();
    }

    // ===== Bookmarks view (Phase3) =====
    async function refreshBookmarksView(){
      if(!currentUser) return;
      bmFeed.innerHTML = "";
      bmCount.textContent = String(cachedBookmarks.size);

      if(cachedBookmarks.size === 0) return;

      // habits„Çí„Åæ„Å®„ÇÅ„Å¶Âèñ„Å£„Å¶Ë°®Á§∫ÔºàÊúÄÊñ∞„ÅÆ„ÅøÔºâ
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(250)));
      const habits = [];
      qs.forEach(s=> habits.push({id:s.id, ...s.data()}));
      const filtered = habits.filter(h => cachedBookmarks.has(h.id));

      bmCount.textContent = String(filtered.length);
      for(const h of filtered){
        bmFeed.appendChild(renderHabitCard(h));
      }
    }

    // ===== Profile (Phase3) =====
    async function refreshProfile(){
      const u = myProfile || {};

      // counts
      const myPostsCount = await countMyPosts();
      const favCreatorsCount = cachedFavCreators.size;
      const bookmarksCount = cachedBookmarks.size;

      // active count
      const actives = await loadActiveChallenges();

      profileList.innerHTML = `
        <div class="simpleRow">
          <div class="rowTop">
            <div>
              <p class="rowTitle">üë§ ${escapeHtml(u.name || "‚Äî")}</p>
              <div class="rowSub">
                üî• „ÇØ„É™„Ç¢ ${Number(u.clearCount||0)} / üå± ÊåëÊà¶‰∏≠ ${actives.length} / üìÖ Á∑èÊåëÊà¶ ${Number(u.totalChallenges||0)}<br>
                ‚ù§Ô∏è ‰ΩúÊàêËÄÖ ${favCreatorsCount} / üîñ ‰øùÂ≠ò ${bookmarksCount} / üß© ÊäïÁ®ø ${myPostsCount}<br>
                ‚≠ê Ë©ï‰æ°„É©„É≥„ÇØ R${Number(u.ratingRank||1)}
              </div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
              <button class="btn small" id="rankUp">R+1</button>
              <button class="btn small danger" id="rankDown">R-1</button>
              <button class="btn small" id="rename">ÂêçÂâçÂ§âÊõ¥</button>
            </div>
          </div>
        </div>
      `;

      const rankUp = $("rankUp");
      const rankDown = $("rankDown");
      const rename = $("rename");

      rankUp.addEventListener("click", async ()=>{
        const next = Math.min(3, Number(myProfile.ratingRank||1)+1);
        await updateDoc(doc(db,"users",currentUser.uid), { ratingRank: next, updatedAt: serverTimestamp() });
        myProfile.ratingRank = next;
        myRankEl.textContent = String(next);
        await refreshProfile();
      });
      rankDown.addEventListener("click", async ()=>{
        const next = Math.max(1, Number(myProfile.ratingRank||1)-1);
        await updateDoc(doc(db,"users",currentUser.uid), { ratingRank: next, updatedAt: serverTimestamp() });
        myProfile.ratingRank = next;
        myRankEl.textContent = String(next);
        await refreshProfile();
      });
      rename.addEventListener("click", ()=>{
        openNameModal();
      });
    }

    async function countMyPosts(){
      // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰∏çË¶Å„Å´„Åô„Çã„Åü„ÇÅ„ÄÅÊúÄÊñ∞„Åã„Çâ„Åñ„Å£„Åè„Çä„Ç´„Ç¶„É≥„ÉàÔºàÁ∞°ÊòìÔºâ
      const qs = await getDocs(query(collection(db,"habits"), orderBy("createdAt","desc"), limit(400)));
      let c = 0;
      qs.forEach(s=>{
        const h = s.data();
        if(h.creatorUid === currentUser.uid) c++;
      });
      return c;
    }

    // ===== Ratings (Phase2) =====
    function openRatingModal(h){
      ratingTargetHabit = h;
      ratingStars = 0;
      ratingLiked = false;
      commentBox.value = "";
      ratingHabitTitle.textContent = `‚≠ê ${h.title || ""}`;
      myRankEl.textContent = String(myProfile?.ratingRank || 1);

      renderStars();
      likeToggle.classList.remove("active");
      likeToggle.onclick = ()=>{
        ratingLiked = !ratingLiked;
        likeToggle.classList.toggle("active", ratingLiked);
      };

      ratingDelete.onclick = async ()=>{
        if(!confirm("ÂâäÈô§Ôºü")) return;
        await deleteMyRating(h.id);
        await recomputeRatingAgg(h.id);
        await loadRatingsList(h.id, reviewList);
        await refreshHome();
      };

      ratingSave.onclick = async ()=>{
        if(ratingStars < 1){ alert("‚≠ê"); return; }
        await saveMyRating(h.id);
        await recomputeRatingAgg(h.id);
        await loadRatingsList(h.id, reviewList);
        await refreshHome();
      };

      ratingBg.classList.add("show");
      loadMyRating(h.id).then(()=> loadRatingsList(h.id, reviewList));
    }
    function closeRatingModal(){
      ratingBg.classList.remove("show");
      ratingTargetHabit = null;
    }
    ratingClose.addEventListener("click", closeRatingModal);
    ratingBg.addEventListener("click", (e)=>{ if(e.target===ratingBg) closeRatingModal(); });

    function renderStars(){
      starsRow.innerHTML = "";
      for(let i=1;i<=5;i++){
        const b = document.createElement("button");
        b.className = "starBtn" + (i===ratingStars ? " active" : "");
        b.textContent = `‚≠ê ${i}`;
        b.addEventListener("click", ()=>{
          ratingStars = i;
          renderStars();
        });
        starsRow.appendChild(b);
      }
    }

    async function loadMyRating(habitId){
      const ref = doc(db, "habits", habitId, "ratings", currentUser.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        ratingStars = 0;
        ratingLiked = false;
        commentBox.value = "";
        likeToggle.classList.remove("active");
        renderStars();
        return;
      }
      const data = snap.data();
      ratingStars = Number(data.stars || 0);
      ratingLiked = !!data.liked;
      commentBox.value = String(data.comment || "");
      likeToggle.classList.toggle("active", ratingLiked);
      renderStars();
    }

    async function saveMyRating(habitId){
      const rank = Number(myProfile?.ratingRank || 1);
      const weight = rank === 3 ? 3 : rank === 2 ? 2 : 1;

      const data = {
        uid: currentUser.uid,
        displayName: myProfile?.name || currentUser.displayName || "„É¶„Éº„Ç∂„Éº",
        photoURL: currentUser.photoURL || "",
        stars: ratingStars,
        liked: ratingLiked,
        comment: (commentBox.value || "").trim().slice(0, 300),
        rank,
        weight,
        updatedAt: serverTimestamp()
      };
      await setDoc(doc(db, "habits", habitId, "ratings", currentUser.uid), data, { merge:true });
    }

    async function deleteMyRating(habitId){
      await deleteDoc(doc(db, "habits", habitId, "ratings", currentUser.uid));
    }

    async function loadRatingsList(habitId, container){
      container.innerHTML = "";
      const qs = await getDocs(query(
        collection(db, "habits", habitId, "ratings"),
        orderBy("updatedAt","desc"),
        limit(40)
      ));
      const arr = [];
      qs.forEach(s=> arr.push(s.data()));
      for(const r of arr){
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">${escapeHtml(r.displayName || "„É¶„Éº„Ç∂„Éº")}</div>
            <div class="reviewMeta">‚≠ê ${Number(r.stars||0)} ${r.liked ? "‚ù§Ô∏è" : ""}ÔºàR${Number(r.rank||1)}Ôºâ</div>
          </div>
          <div class="reviewText">${escapeHtml(r.comment || "")}</div>
        `;
        container.appendChild(box);
      }
    }

    async function recomputeRatingAgg(habitId){
      await runTransaction(db, async (tx)=>{
        const href = doc(db, "habits", habitId);
        const hs = await tx.get(href);
        if(!hs.exists()) return;

        // „Åì„Åì„ÅØ getDocs „Çí‰Ωø„ÅÜ„ÅÆ„Åß txÂ§ñÊâ±„ÅÑ„Å´Ëøë„ÅÑ„Åå„ÄÅÊúÄ‰ΩéÈôê„ÅÆ„Åü„ÇÅ„Å´Ë®±ÂÆπ
        // Êú¨Áï™„ÅØ Functions Êé®Â•®
        const rs = await getDocs(query(collection(db, "habits", habitId, "ratings"), limit(500)));
        let wSum = 0;
        let swSum = 0;
        let ratingCount = 0;

        rs.forEach(s=>{
          const r = s.data();
          const stars = Number(r.stars||0);
          const w = Number(r.weight||1);
          if(stars>=1 && stars<=5){
            wSum += w;
            swSum += stars*w;
            ratingCount += 1;
          }
        });
        const avgRating = wSum ? (swSum / wSum) : 0;

        tx.update(href, {
          ratingCount,
          avgRating: Number.isFinite(avgRating) ? avgRating : 0,
          updatedAt: serverTimestamp()
        });
      });
    }

    // reviews view-only
    function openReviewsModal(h){
      reviewsTitle.textContent = `üí¨ ${h.title || ""}`;
      reviewsList.innerHTML = "";
      reviewsBg.classList.add("show");
      loadRatingsList(h.id, reviewsList);
    }
    function closeReviewsModal(){ reviewsBg.classList.remove("show"); }
    reviewsClose.addEventListener("click", closeReviewsModal);
    reviewsBg.addEventListener("click", (e)=>{ if(e.target===reviewsBg) closeReviewsModal(); });

    // ===== Edit (Phase2) ver1-3 + derive =====
    function openEditModal(h){
      editTargetHabit = h;
      editTitle.textContent = `üõ†Ô∏è ${h.title || ""}`;
      editNewTitle.value = h.title || "";
      editNewTags.value = (h.tags || []).join(",");
      editNewCategory.value = h.category || "";
      editNewAction.value = h.action || "";
      versionsList.innerHTML = "";
      editBg.classList.add("show");

      loadVersions(h.id);
    }
    function closeEditModal(){
      editBg.classList.remove("show");
      editTargetHabit = null;
    }
    editClose.addEventListener("click", closeEditModal);
    editBg.addEventListener("click", (e)=>{ if(e.target===editBg) closeEditModal(); });

    async function loadVersions(habitId){
      versionsList.innerHTML = "";
      const qs = await getDocs(query(
        collection(db, "habits", habitId, "versions"),
        orderBy("createdAt","desc"),
        limit(3)
      ));
      qs.forEach(s=>{
        const v = s.data();
        const box = document.createElement("div");
        box.className = "review";
        box.innerHTML = `
          <div class="reviewTop">
            <div class="reviewName">ver${Number(v.version||1)}</div>
            <div class="reviewMeta"></div>
          </div>
          <div class="reviewText">${escapeHtml(v.title||"")}\n${escapeHtml(v.action||"")}</div>
        `;
        versionsList.appendChild(box);
      });
    }

    btnSaveEdit.addEventListener("click", async ()=>{
      if(!editTargetHabit) return;

      const title = editNewTitle.value.trim();
      const tags = editNewTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(editNewCategory.value||"").trim();
      const action = editNewAction.value.trim();

      if(title.length < 2 || action.length < 2){ alert("Áü≠„Åô„Åé"); return; }
      if(action.length > 40){ alert("40ÊñáÂ≠ó‰ª•ÂÜÖ"); return; }

      const habitId = editTargetHabit.id;

      await runTransaction(db, async (tx)=>{
        const href = doc(db, "habits", habitId);
        const hs = await tx.get(href);
        if(!hs.exists()) return;
        const cur = hs.data();

        // versions „Å´Êóß„Çí‰øùÂ≠ò
        const vref = doc(collection(db, "habits", habitId, "versions"));
        tx.set(vref, {
          version: Number(cur.version||1),
          title: cur.title||"",
          action: cur.action||"",
          tags: cur.tags||[],
          category: cur.category||"",
          createdAt: serverTimestamp()
        });

        // ver„ÅØÊúÄÂ§ß3ÔºàË°®Á§∫„ÅØversionsÂÅ¥„Åß3‰ª∂„Å´Âà∂ÈôêÔºâ
        const nextVer = Math.min(3, Number(cur.version||1) + 1);

        tx.update(href, {
          title, action, tags, category,
          version: nextVer,
          updatedAt: serverTimestamp()
        });
      });

      // versions„ÅåÂ¢ó„Åà„Åô„Åé„Åü„ÇâÂè§„ÅÑ„ÅÆ„ÇíÊ∂à„ÅôÔºà„Éô„Çπ„Éà„Ç®„Éï„Ç©„Éº„ÉàÔºâ
      try{
        const qs = await getDocs(query(collection(db, "habits", habitId, "versions"), orderBy("createdAt","desc"), limit(10)));
        const all = [];
        qs.forEach(s=> all.push({ref:s.ref}));
        const toDelete = all.slice(3);
        await Promise.allSettled(toDelete.map(x=>deleteDoc(x.ref)));
      }catch{}

      await loadVersions(habitId);
      await refreshHome();
    });

    btnDerive.addEventListener("click", async ()=>{
      if(!editTargetHabit) return;

      const title = editNewTitle.value.trim();
      const tags = editNewTags.value.split(",").map(s=>s.trim()).filter(Boolean).slice(0,8);
      const category = String(editNewCategory.value||"").trim();
      const action = editNewAction.value.trim();

      if(title.length < 2 || action.length < 2){ alert("Áü≠„Åô„Åé"); return; }
      if(action.length > 40){ alert("40ÊñáÂ≠ó‰ª•ÂÜÖ"); return; }

      await addDoc(collection(db, "habits"), {
        title, action, tags, category,
        creatorUid: currentUser.uid,
        creatorName: myProfile?.name || (currentUser.displayName || "‰ΩúÊàêËÄÖ"),
        creatorPhoto: currentUser.photoURL || "",
        createdAt: serverTimestamp(),

        avgRating: 0,
        ratingCount: 0,
        participantsCount: 0,
        avgDays: 0,
        successRate: 0,
        feelEasy: 0,
        feelMid: 0,
        feelHard: 0,

        baseHabitId: editTargetHabit.id,
        version: 1,
        updatedAt: serverTimestamp()
      });

      await refreshHome();
      closeEditModal();
      await refreshProfile();
    });

    // ===== UI events =====
    function setSelectedTagSafe(tag){ setSelectedTag(tag); }
    btnClearTag.addEventListener("click", ()=> setSelectedTagSafe(""));

    // ===== Init misc =====
    function updateAuthButtons(){
      btnLogout.disabled = !currentUser;
    }
    updateAuthButtons();

  </script>
</body>
</html>
